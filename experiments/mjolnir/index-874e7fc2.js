var Iu=Object.defineProperty;var Mu=(t,e,s)=>e in t?Iu(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var d=(t,e,s)=>(Mu(t,typeof e!="symbol"?e+"":e,s),s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function s(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(r){if(r.ep)return;r.ep=!0;const n=s(r);fetch(r.href,n)}})();function Qs(t,e){if(!t)throw new Error(e||"loader assertion failed.")}const On=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),uo=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);uo&&parseFloat(uo[1]);const ys=globalThis,ot=globalThis.process||{},Ou=globalThis.navigator||{};function Xc(t){var i,r;if(typeof window<"u"&&((i=window.process)==null?void 0:i.type)==="renderer"||typeof process<"u"&&((r=process.versions)!=null&&r.electron))return!0;const e=typeof navigator<"u"&&navigator.userAgent,s=t||e;return!!(s&&s.indexOf("Electron")>=0)}function st(){return!(typeof process=="object"&&String(process)==="[object process]"&&!(process!=null&&process.browser))||Xc()}function Nu(t){return!t&&!st()?"Node":Xc(t)?"Electron":(t||Ou.userAgent||"").indexOf("Edge")>-1?"Edge":globalThis.chrome?"Chrome":globalThis.safari?"Safari":globalThis.mozInnerScreenX?"Firefox":"Unknown"}const Yc="4.0.7";function ku(t){try{const e=window[t],s="__storage_test__";return e.setItem(s,s),e.removeItem(s),e}catch{return null}}class Fu{constructor(e,s,i="sessionStorage"){this.storage=ku(i),this.id=e,this.config=s,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){if(Object.assign(this.config,e),this.storage){const s=JSON.stringify(this.config);this.storage.setItem(this.id,s)}}_loadConfiguration(){let e={};if(this.storage){const s=this.storage.getItem(this.id);e=s?JSON.parse(s):{}}return Object.assign(this.config,e),this}}function Du(t){let e;return t<10?e=`${t.toFixed(2)}ms`:t<100?e=`${t.toFixed(1)}ms`:t<1e3?e=`${t.toFixed(0)}ms`:e=`${(t/1e3).toFixed(2)}s`,e}function Bu(t,e=8){const s=Math.max(e-t.length,0);return`${" ".repeat(s)}${t}`}var Gs;(function(t){t[t.BLACK=30]="BLACK",t[t.RED=31]="RED",t[t.GREEN=32]="GREEN",t[t.YELLOW=33]="YELLOW",t[t.BLUE=34]="BLUE",t[t.MAGENTA=35]="MAGENTA",t[t.CYAN=36]="CYAN",t[t.WHITE=37]="WHITE",t[t.BRIGHT_BLACK=90]="BRIGHT_BLACK",t[t.BRIGHT_RED=91]="BRIGHT_RED",t[t.BRIGHT_GREEN=92]="BRIGHT_GREEN",t[t.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",t[t.BRIGHT_BLUE=94]="BRIGHT_BLUE",t[t.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",t[t.BRIGHT_CYAN=96]="BRIGHT_CYAN",t[t.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(Gs||(Gs={}));const Uu=10;function fo(t){return typeof t!="string"?t:(t=t.toUpperCase(),Gs[t]||Gs.WHITE)}function Lu(t,e,s){return!st&&typeof t=="string"&&(e&&(t=`\x1B[${fo(e)}m${t}\x1B[39m`),s&&(t=`\x1B[${fo(s)+Uu}m${t}\x1B[49m`)),t}function Vu(t,e=["constructor"]){const s=Object.getPrototypeOf(t),i=Object.getOwnPropertyNames(s),r=t;for(const n of i){const o=r[n];typeof o=="function"&&(e.find(a=>n===a)||(r[n]=o.bind(t)))}}function Nn(t,e){if(!t)throw new Error(e||"Assertion failed")}function at(){var e,s,i;let t;if(st()&&ys.performance)t=(s=(e=ys==null?void 0:ys.performance)==null?void 0:e.now)==null?void 0:s.call(e);else if("hrtime"in ot){const r=(i=ot==null?void 0:ot.hrtime)==null?void 0:i.call(ot);t=r[0]*1e3+r[1]/1e6}else t=Date.now();return t}const ct={debug:st()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},zu={enabled:!0,level:0};function lt(){}const go={},po={once:!0};class fs{constructor({id:e}={id:""}){this.VERSION=Yc,this._startTs=at(),this._deltaTs=at(),this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=e,this.userData={},this._storage=new Fu(`__probe-${this.id}__`,zu),this.timeStamp(`${this.id} started`),Vu(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((at()-this._startTs).toPrecision(10))}getDelta(){return Number((at()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.setConfiguration({enabled:e}),this}setLevel(e){return this._storage.setConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,s){this._storage.setConfiguration({[e]:s})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,s){if(!e)throw new Error(s||"Assertion failed")}warn(e){return this._getLogFunction(0,e,ct.warn,arguments,po)}error(e){return this._getLogFunction(0,e,ct.error,arguments)}deprecated(e,s){return this.warn(`\`${e}\` is deprecated and will be removed in a later version. Use \`${s}\` instead`)}removed(e,s){return this.error(`\`${e}\` has been removed. Use \`${s}\` instead`)}probe(e,s){return this._getLogFunction(e,s,ct.log,arguments,{time:!0,once:!0})}log(e,s){return this._getLogFunction(e,s,ct.debug,arguments)}info(e,s){return this._getLogFunction(e,s,console.info,arguments)}once(e,s){return this._getLogFunction(e,s,ct.debug||ct.info,arguments,po)}table(e,s,i){return s?this._getLogFunction(e,s,console.table||lt,i&&[i],{tag:Hu(s)}):lt}time(e,s){return this._getLogFunction(e,s,console.time?console.time:console.info)}timeEnd(e,s){return this._getLogFunction(e,s,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,s){return this._getLogFunction(e,s,console.timeStamp||lt)}group(e,s,i={collapsed:!1}){const r=_o({logLevel:e,message:s,opts:i}),{collapsed:n}=i;return r.method=(n?console.groupCollapsed:console.group)||console.info,this._getLogFunction(r)}groupCollapsed(e,s,i={}){return this.group(e,s,Object.assign({},i,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||lt)}withGroup(e,s,i){this.group(e,s)();try{i()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=Kc(e)}_getLogFunction(e,s,i,r,n){if(this._shouldLog(e)){n=_o({logLevel:e,message:s,args:r,opts:n}),i=i||n.method,Nn(i),n.total=this.getTotal(),n.delta=this.getDelta(),this._deltaTs=at();const o=n.tag||n.message;if(n.once&&o)if(!go[o])go[o]=at();else return lt;return s=Wu(this.id,n.message,n),i.bind(console,s,...n.args)}return lt}}fs.VERSION=Yc;function Kc(t){if(!t)return 0;let e;switch(typeof t){case"number":e=t;break;case"object":e=t.logLevel||t.priority||0;break;default:return 0}return Nn(Number.isFinite(e)&&e>=0),e}function _o(t){const{logLevel:e,message:s}=t;t.logLevel=Kc(e);const i=t.args?Array.from(t.args):[];for(;i.length&&i.shift()!==s;);switch(typeof e){case"string":case"function":s!==void 0&&i.unshift(s),t.message=e;break;case"object":Object.assign(t,e);break}typeof t.message=="function"&&(t.message=t.message());const r=typeof t.message;return Nn(r==="string"||r==="object"),Object.assign(t,{args:i},t.opts)}function Wu(t,e,s){if(typeof e=="string"){const i=s.time?Bu(Du(s.total)):"";e=s.time?`${t}: ${i}  ${e}`:`${t}: ${e}`,e=Lu(e,s.color,s.background)}return e}function Hu(t){for(const e in t)for(const s in t[e])return s||"untitled";return"empty"}function ju(t,e){return qc(t||{},e)}function qc(t,e,s=0){if(s>3)return e;const i={...t};for(const[r,n]of Object.entries(e))n&&typeof n=="object"&&!Array.isArray(n)?i[r]=qc(i[r]||{},e[r],s+1):i[r]=e[r];return i}const $u="latest";function Xu(){var t;return(t=globalThis._loadersgl_)!=null&&t.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.2.1"),globalThis._loadersgl_.version}const Yu=Xu();function ze(t,e){if(!t)throw new Error(e||"loaders.gl assertion failed.")}const qe=typeof process!="object"||String(process)!=="[object process]"||process.browser,Ku=typeof window<"u"&&typeof window.orientation<"u",mo=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);mo&&parseFloat(mo[1]);class qu{constructor(e,s){d(this,"name");d(this,"workerThread");d(this,"isRunning",!0);d(this,"result");d(this,"_resolve",()=>{});d(this,"_reject",()=>{});this.name=e,this.workerThread=s,this.result=new Promise((i,r)=>{this._resolve=i,this._reject=r})}postMessage(e,s){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:s})}done(e){ze(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){ze(this.isRunning),this.isRunning=!1,this._reject(e)}}class qi{terminate(){}}const Zi=new Map;function Zu(t){ze(t.source&&!t.url||!t.source&&t.url);let e=Zi.get(t.source||t.url);return e||(t.url&&(e=Ju(t.url),Zi.set(t.url,e)),t.source&&(e=Zc(t.source),Zi.set(t.source,e))),ze(e),e}function Ju(t){if(!t.startsWith("http"))return t;const e=Qu(t);return Zc(e)}function Zc(t){const e=new Blob([t],{type:"application/javascript"});return URL.createObjectURL(e)}function Qu(t){return`try {
  importScripts('${t}');
} catch (error) {
  console.error(error);
  throw error;
}`}function Jc(t,e=!0,s){const i=s||new Set;if(t){if(yo(t))i.add(t);else if(yo(t.buffer))i.add(t.buffer);else if(!ArrayBuffer.isView(t)){if(e&&typeof t=="object")for(const r in t)Jc(t[r],e,i)}}return s===void 0?Array.from(i):[]}function yo(t){return t?t instanceof ArrayBuffer||typeof MessagePort<"u"&&t instanceof MessagePort||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas:!1}const Ji=()=>{};class Dr{constructor(e){d(this,"name");d(this,"source");d(this,"url");d(this,"terminated",!1);d(this,"worker");d(this,"onMessage");d(this,"onError");d(this,"_loadableURL","");const{name:s,source:i,url:r}=e;ze(i||r),this.name=s,this.source=i,this.url=r,this.onMessage=Ji,this.onError=n=>console.log(n),this.worker=qe?this._createBrowserWorker():this._createNodeWorker()}static isSupported(){return typeof Worker<"u"&&qe||typeof qi<"u"&&!qe}destroy(){this.onMessage=Ji,this.onError=Ji,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,s){s=s||Jc(e),this.worker.postMessage(e,s)}_getErrorFromErrorEvent(e){let s="Failed to load ";return s+=`worker ${this.name} from ${this.url}. `,e.message&&(s+=`${e.message} in `),e.lineno&&(s+=`:${e.lineno}:${e.colno}`),new Error(s)}_createBrowserWorker(){this._loadableURL=Zu({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=s=>{s.data?this.onMessage(s.data):this.onError(new Error("No data received"))},e.onerror=s=>{this.onError(this._getErrorFromErrorEvent(s)),this.terminated=!0},e.onmessageerror=s=>console.error(s),e}_createNodeWorker(){let e;if(this.url){const i=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;e=new qi(i,{eval:!1})}else if(this.source)e=new qi(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",s=>{this.onMessage(s)}),e.on("error",s=>{this.onError(s)}),e.on("exit",s=>{}),e}}class Gu{constructor(e){d(this,"name","unnamed");d(this,"source");d(this,"url");d(this,"maxConcurrency",1);d(this,"maxMobileConcurrency",1);d(this,"onDebug",()=>{});d(this,"reuseWorkers",!0);d(this,"props",{});d(this,"jobQueue",[]);d(this,"idleQueue",[]);d(this,"count",0);d(this,"isDestroyed",!1);this.source=e.source,this.url=e.url,this.setProps(e)}static isSupported(){return Dr.isSupported()}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,s=(r,n,o)=>r.done(o),i=(r,n)=>r.error(n)){const r=new Promise(n=>(this.jobQueue.push({name:e,onMessage:s,onError:i,onStart:n}),this));return this._startQueuedJob(),await r}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const s=this.jobQueue.shift();if(s){this.onDebug({message:"Starting job",name:s.name,workerThread:e,backlog:this.jobQueue.length});const i=new qu(s.name,e);e.onMessage=r=>s.onMessage(i,r.type,r.payload),e.onError=r=>s.onError(i,r),s.onStart(i);try{await i.result}catch(r){console.error(`Worker exception: ${r}`)}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!qe||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new Dr({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return Ku?this.maxMobileConcurrency:this.maxConcurrency}}const ef={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}},Fe=class Fe{constructor(e){d(this,"props");d(this,"workerPools",new Map);this.props={...ef},this.setProps(e),this.workerPools=new Map}static isSupported(){return Dr.isSupported()}static getWorkerFarm(e={}){return Fe._workerFarm=Fe._workerFarm||new Fe({}),Fe._workerFarm.setProps(e),Fe._workerFarm}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const s of this.workerPools.values())s.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:s,source:i,url:r}=e;let n=this.workerPools.get(s);return n||(n=new Gu({name:s,source:i,url:r}),n.setProps(this._getWorkerPoolProps()),this.workerPools.set(s,n)),n}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}};d(Fe,"_workerFarm");let ei=Fe;function tf(t,e={}){const s=e[t.id]||{},i=qe?`${t.id}-worker.js`:`${t.id}-worker-node.js`;let r=s.workerUrl;if(!r&&t.id==="compression"&&(r=e.workerUrl),e._workerType==="test"&&(qe?r=`modules/${t.module}/dist/${i}`:r=`modules/${t.module}/src/workers/${t.id}-worker-node.ts`),!r){let n=t.version;n==="latest"&&(n=$u);const o=n?`@${n}`:"";r=`https://unpkg.com/@loaders.gl/${t.module}${o}/dist/${i}`}return ze(r),r}function sf(t,e=Yu){ze(t,"no worker provided");const s=t.version;return!(!e||!s)}function rf(t,e){return!ei.isSupported()||!qe&&!(e!=null&&e._nodeWorkers)?!1:t.worker&&(e==null?void 0:e.worker)}async function nf(t,e,s,i,r){const n=t.id,o=tf(t,s),c=ei.getWorkerFarm(s).getWorkerPool({name:n,url:o});s=JSON.parse(JSON.stringify(s)),i=JSON.parse(JSON.stringify(i||{}));const l=await c.startJob("process-on-worker",of.bind(null,r));return l.postMessage("process",{input:e,options:s,context:i}),await(await l.result).result}async function of(t,e,s,i){switch(s){case"done":e.done(i);break;case"error":e.error(new Error(i.error));break;case"process":const{id:r,input:n,options:o}=i;try{const a=await t(n,o);e.postMessage("done",{id:r,result:a})}catch(a){const c=a instanceof Error?a.message:"unknown error";e.postMessage("error",{id:r,error:c})}break;default:console.warn(`parse-with-worker unknown message ${s}`)}}function af(t,e,s){if(s=s||t.byteLength,t.byteLength<s||e.byteLength<s)return!1;const i=new Uint8Array(t),r=new Uint8Array(e);for(let n=0;n<i.length;++n)if(i[n]!==r[n])return!1;return!0}function cf(...t){return lf(t)}function lf(t){const e=t.map(n=>n instanceof ArrayBuffer?new Uint8Array(n):n),s=e.reduce((n,o)=>n+o.byteLength,0),i=new Uint8Array(s);let r=0;for(const n of e)i.set(n,r),r+=n.byteLength;return i.buffer}async function hf(t){const e=[];for await(const s of t)e.push(s);return cf(...e)}function bo(){let t;if(typeof window<"u"&&window.performance)t=window.performance.now();else if(typeof process<"u"&&process.hrtime){const e=process.hrtime();t=e[0]*1e3+e[1]/1e6}else t=Date.now();return t}class To{constructor(e,s){this.sampleSize=1,this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this.name=e,this.type=s,this.reset()}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=bo(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(bo()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class zi{constructor(e){this.stats={},this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e,s="count"){return this._getOrCreate({name:e,type:s})}get size(){return Object.keys(this.stats).length}reset(){for(const e of Object.values(this.stats))e.reset();return this}forEach(e){for(const s of Object.values(this.stats))e(s)}getTable(){const e={};return this.forEach(s=>{e[s.name]={time:s.time||0,count:s.count||0,average:s.getAverageTime()||0,hz:s.getHz()||0}}),e}_initializeStats(e=[]){e.forEach(s=>this._getOrCreate(s))}_getOrCreate(e){const{name:s,type:i}=e;let r=this.stats[s];return r||(e instanceof To?r=e:r=new To(s,i),this.stats[s]=r),r}}let uf="";const Ao={};function ff(t){for(const e in Ao)if(t.startsWith(e)){const s=Ao[e];t=t.replace(e,s)}return!t.startsWith("http://")&&!t.startsWith("https://")&&(t=`${uf}${t}`),t}function df(t){return t&&typeof t=="object"&&t.isBuffer}function Qc(t){if(df(t))return t;if(t instanceof ArrayBuffer)return t;if(ArrayBuffer.isView(t))return t.byteOffset===0&&t.byteLength===t.buffer.byteLength?t.buffer:t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength);if(typeof t=="string"){const e=t;return new TextEncoder().encode(e).buffer}if(t&&typeof t=="object"&&t._toArrayBuffer)return t._toArrayBuffer();throw new Error("toArrayBuffer")}function Gc(t){const e=t?t.lastIndexOf("/"):-1;return e>=0?t.substr(e+1):""}function gf(t){const e=t?t.lastIndexOf("/"):-1;return e>=0?t.substr(0,e):""}const pf=t=>typeof t=="boolean",Kt=t=>typeof t=="function",ds=t=>t!==null&&typeof t=="object",wo=t=>ds(t)&&t.constructor==={}.constructor,_f=t=>!!t&&typeof t[Symbol.iterator]=="function",mf=t=>t&&typeof t[Symbol.asyncIterator]=="function",it=t=>typeof Response<"u"&&t instanceof Response||t&&t.arrayBuffer&&t.text&&t.json,rt=t=>typeof Blob<"u"&&t instanceof Blob,yf=t=>t&&typeof t=="object"&&t.isBuffer,bf=t=>typeof ReadableStream<"u"&&t instanceof ReadableStream||ds(t)&&Kt(t.tee)&&Kt(t.cancel)&&Kt(t.getReader),Tf=t=>ds(t)&&Kt(t.read)&&Kt(t.pipe)&&pf(t.readable),el=t=>bf(t)||Tf(t);class Af extends Error{constructor(s,i){super(s);d(this,"reason");d(this,"url");d(this,"response");this.reason=i.reason,this.url=i.url,this.response=i.response}}const wf=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,Sf=/^([-\w.]+\/[-\w.+]+)/;function So(t,e){return t.toLowerCase()===e.toLowerCase()}function Ef(t){const e=Sf.exec(t);return e?e[1]:t}function Eo(t){const e=wf.exec(t);return e?e[1]:""}const tl=/\?.*/;function vf(t){const e=t.match(tl);return e&&e[0]}function kn(t){return t.replace(tl,"")}function Rf(t){if(t.length<50)return t;const e=t.slice(t.length-15);return`${t.substr(0,32)}...${e}`}function Wi(t){return it(t)?t.url:rt(t)?t.name||"":typeof t=="string"?t:""}function Fn(t){if(it(t)){const e=t,s=e.headers.get("content-type")||"",i=kn(e.url);return Ef(s)||Eo(i)}return rt(t)?t.type||"":typeof t=="string"?Eo(t):""}function xf(t){return it(t)?t.headers["content-length"]||-1:rt(t)?t.size:typeof t=="string"?t.length:t instanceof ArrayBuffer||ArrayBuffer.isView(t)?t.byteLength:-1}async function sl(t){if(it(t))return t;const e={},s=xf(t);s>=0&&(e["content-length"]=String(s));const i=Wi(t),r=Fn(t);r&&(e["content-type"]=r);const n=await If(t);n&&(e["x-first-bytes"]=n),typeof t=="string"&&(t=new TextEncoder().encode(t));const o=new Response(t,{headers:e});return Object.defineProperty(o,"url",{value:i}),o}async function Pf(t){if(!t.ok)throw await Cf(t)}async function Cf(t){const e=Rf(t.url);let s=`Failed to fetch resource (${t.status}) ${t.statusText}: ${e}`;s=s.length>100?`${s.slice(0,100)}...`:s;const i={reason:t.statusText,url:t.url,response:t};try{const r=t.headers.get("Content-Type");i.reason=r!=null&&r.includes("application/json")?await t.json():t.text()}catch{}return new Af(s,i)}async function If(t){if(typeof t=="string")return`data:,${t.slice(0,5)}`;if(t instanceof Blob){const s=t.slice(0,5);return await new Promise(i=>{const r=new FileReader;r.onload=n=>{var o;return i((o=n==null?void 0:n.target)==null?void 0:o.result)},r.readAsDataURL(s)})}if(t instanceof ArrayBuffer){const s=t.slice(0,5);return`data:base64,${Mf(s)}`}return null}function Mf(t){let e="";const s=new Uint8Array(t);for(let i=0;i<s.byteLength;i++)e+=String.fromCharCode(s[i]);return btoa(e)}function Of(t){return!Nf(t)&&!kf(t)}function Nf(t){return t.startsWith("http:")||t.startsWith("https:")}function kf(t){return t.startsWith("data:")}async function vo(t,e){var s,i;if(typeof t=="string"){const r=ff(t);return Of(r)&&(s=globalThis.loaders)!=null&&s.fetchNode?(i=globalThis.loaders)==null?void 0:i.fetchNode(r,e):await fetch(r,e)}return await sl(t)}const Ro=new fs({id:"loaders.gl"});class Ff{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}class Df{constructor(){d(this,"console");this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}}const il={fetch:null,mimeType:void 0,nothrow:!1,log:new Df,useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:On,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},Bf={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function rl(){globalThis.loaders=globalThis.loaders||{};const{loaders:t}=globalThis;return t._state||(t._state={}),t._state}function nl(){const t=rl();return t.globalOptions=t.globalOptions||{...il},t.globalOptions}function Uf(t,e,s,i){return s=s||[],s=Array.isArray(s)?s:[s],Lf(t,s),zf(e,t,i)}function Lf(t,e){xo(t,null,il,Bf,e);for(const s of e){const i=t&&t[s.id]||{},r=s.options&&s.options[s.id]||{},n=s.deprecatedOptions&&s.deprecatedOptions[s.id]||{};xo(i,s.id,r,n,e)}}function xo(t,e,s,i,r){const n=e||"Top level",o=e?`${e}.`:"";for(const a in t){const c=!e&&ds(t[a]),l=a==="baseUri"&&!e,h=a==="workerUrl"&&e;if(!(a in s)&&!l&&!h){if(a in i)Ro.warn(`${n} loader option '${o}${a}' no longer supported, use '${i[a]}'`)();else if(!c){const u=Vf(a,r);Ro.warn(`${n} loader option '${o}${a}' not recognized. ${u}`)()}}}}function Vf(t,e){const s=t.toLowerCase();let i="";for(const r of e)for(const n in r.options){if(t===n)return`Did you mean '${r.id}.${n}'?`;const o=n.toLowerCase();(s.startsWith(o)||o.startsWith(s))&&(i=i||`Did you mean '${r.id}.${n}'?`)}return i}function zf(t,e,s){const r={...t.options||{}};return Wf(r,s),r.log===null&&(r.log=new Ff),Po(r,nl()),Po(r,e),r}function Po(t,e){for(const s in e)if(s in e){const i=e[s];wo(i)&&wo(t[s])?t[s]={...t[s],...e[s]}:t[s]=e[s]}}function Wf(t,e){e&&!("baseUri"in t)&&(t.baseUri=e)}function Dn(t){return t?(Array.isArray(t)&&(t=t[0]),Array.isArray(t==null?void 0:t.extensions)):!1}function Bn(t){Qs(t,"null loader"),Qs(Dn(t),"invalid loader");let e;return Array.isArray(t)&&(e=t[1],t=t[0],t={...t,options:{...t.options,...e}}),(t!=null&&t.parseTextSync||t!=null&&t.parseText)&&(t.text=!0),t.text||(t.binary=!0),t}const ol=()=>{const t=rl();return t.loaderRegistry=t.loaderRegistry||[],t.loaderRegistry};function Hf(t){const e=ol();t=Array.isArray(t)?t:[t];for(const s of t){const i=Bn(s);e.find(r=>i===r)||e.unshift(i)}}function jf(){return ol()}const $f=new fs({id:"loaders.gl"}),Xf=/\.([^.]+)$/;async function Yf(t,e=[],s,i){if(!al(t))return null;let r=Co(t,e,{...s,nothrow:!0},i);if(r)return r;if(rt(t)&&(t=await t.slice(0,10).arrayBuffer(),r=Co(t,e,s,i)),!r&&!(s!=null&&s.nothrow))throw new Error(cl(t));return r}function Co(t,e=[],s,i){if(!al(t))return null;if(e&&!Array.isArray(e))return Bn(e);let r=[];e&&(r=r.concat(e)),s!=null&&s.ignoreRegisteredLoaders||r.push(...jf()),qf(r);const n=Kf(t,r,s,i);if(!n&&!(s!=null&&s.nothrow))throw new Error(cl(t));return n}function Kf(t,e,s,i){const r=Wi(t),n=Fn(t),o=kn(r)||(i==null?void 0:i.url);let a=null,c="";return s!=null&&s.mimeType&&(a=Qi(e,s==null?void 0:s.mimeType),c=`match forced by supplied MIME type ${s==null?void 0:s.mimeType}`),a=a||Zf(e,o),c=c||(a?`matched url ${o}`:""),a=a||Qi(e,n),c=c||(a?`matched MIME type ${n}`:""),a=a||Qf(e,t),c=c||(a?`matched initial data ${ll(t)}`:""),s!=null&&s.fallbackMimeType&&(a=a||Qi(e,s==null?void 0:s.fallbackMimeType),c=c||(a?`matched fallback MIME type ${n}`:"")),c&&$f.log(1,`selectLoader selected ${a==null?void 0:a.name}: ${c}.`),a}function al(t){return!(t instanceof Response&&t.status===204)}function cl(t){const e=Wi(t),s=Fn(t);let i="No valid loader found (";i+=e?`${Gc(e)}, `:"no url provided, ",i+=`MIME type: ${s?`"${s}"`:"not provided"}, `;const r=t?ll(t):"";return i+=r?` first bytes: "${r}"`:"first bytes: not available",i+=")",i}function qf(t){for(const e of t)Bn(e)}function Zf(t,e){const s=e&&Xf.exec(e),i=s&&s[1];return i?Jf(t,i):null}function Jf(t,e){e=e.toLowerCase();for(const s of t)for(const i of s.extensions)if(i.toLowerCase()===e)return s;return null}function Qi(t,e){var s;for(const i of t)if((s=i.mimeTypes)!=null&&s.some(r=>So(e,r))||So(e,`application/x.${i.id}`))return i;return null}function Qf(t,e){if(!e)return null;for(const s of t)if(typeof e=="string"){if(Gf(e,s))return s}else if(ArrayBuffer.isView(e)){if(Io(e.buffer,e.byteOffset,s))return s}else if(e instanceof ArrayBuffer&&Io(e,0,s))return s;return null}function Gf(t,e){return e.testText?e.testText(t):(Array.isArray(e.tests)?e.tests:[e.tests]).some(i=>t.startsWith(i))}function Io(t,e,s){return(Array.isArray(s.tests)?s.tests:[s.tests]).some(r=>ed(t,e,s,r))}function ed(t,e,s,i){if(i instanceof ArrayBuffer)return af(i,t,i.byteLength);switch(typeof i){case"function":return i(t);case"string":const r=Br(t,e,i.length);return i===r;default:return!1}}function ll(t,e=5){return typeof t=="string"?t.slice(0,e):ArrayBuffer.isView(t)?Br(t.buffer,t.byteOffset,e):t instanceof ArrayBuffer?Br(t,0,e):""}function Br(t,e,s){if(t.byteLength<e+s)return"";const i=new DataView(t);let r="";for(let n=0;n<s;n++)r+=String.fromCharCode(i.getUint8(e+n));return r}const td=256*1024;function*sd(t,e){const s=(e==null?void 0:e.chunkSize)||td;let i=0;const r=new TextEncoder;for(;i<t.length;){const n=Math.min(t.length-i,s),o=t.slice(i,i+n);i+=n,yield r.encode(o)}}const id=256*1024;function*rd(t,e={}){const{chunkSize:s=id}=e;let i=0;for(;i<t.byteLength;){const r=Math.min(t.byteLength-i,s),n=new ArrayBuffer(r),o=new Uint8Array(t,i,r);new Uint8Array(n).set(o),i+=r,yield n}}const nd=1024*1024;async function*od(t,e){const s=(e==null?void 0:e.chunkSize)||nd;let i=0;for(;i<t.size;){const r=i+s,n=await t.slice(i,r).arrayBuffer();i=r,yield n}}function Mo(t,e){return On?ad(t,e):cd(t)}async function*ad(t,e){const s=t.getReader();let i;try{for(;;){const r=i||s.read();e!=null&&e._streamReadAhead&&(i=s.read());const{done:n,value:o}=await r;if(n)return;yield Qc(o)}}catch{s.releaseLock()}}async function*cd(t,e){for await(const s of t)yield Qc(s)}function ld(t,e){if(typeof t=="string")return sd(t,e);if(t instanceof ArrayBuffer)return rd(t,e);if(rt(t))return od(t,e);if(el(t))return Mo(t,e);if(it(t))return Mo(t.body,e);throw new Error("makeIterator")}const hl="Cannot convert supplied data type";function hd(t,e,s){if(e.text&&typeof t=="string")return t;if(yf(t)&&(t=t.buffer),t instanceof ArrayBuffer){const i=t;return e.text&&!e.binary?new TextDecoder("utf8").decode(i):i}if(ArrayBuffer.isView(t)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(t);let i=t.buffer;const r=t.byteLength||t.length;return(t.byteOffset!==0||r!==i.byteLength)&&(i=i.slice(t.byteOffset,t.byteOffset+r)),i}throw new Error(hl)}async function ud(t,e,s){const i=t instanceof ArrayBuffer||ArrayBuffer.isView(t);if(typeof t=="string"||i)return hd(t,e);if(rt(t)&&(t=await sl(t)),it(t)){const r=t;return await Pf(r),e.binary?await r.arrayBuffer():await r.text()}if(el(t)&&(t=ld(t,s)),_f(t)||mf(t))return hf(t);throw new Error(hl)}function ul(t,e){const s=nl(),i=t||s;return typeof i.fetch=="function"?i.fetch:ds(i.fetch)?r=>vo(r,i.fetch):e!=null&&e.fetch?e==null?void 0:e.fetch:vo}function fd(t,e,s){if(s)return s;const i={fetch:ul(e,t),...t};if(i.url){const r=kn(i.url);i.baseUrl=r,i.queryString=vf(i.url),i.filename=Gc(r),i.baseUrl=gf(r)}return Array.isArray(i.loaders)||(i.loaders=null),i}function dd(t,e){if(t&&!Array.isArray(t))return t;let s;if(t&&(s=Array.isArray(t)?t:[t]),e&&e.loaders){const i=Array.isArray(e.loaders)?e.loaders:[e.loaders];s=s?[...s,...i]:i}return s&&s.length?s:void 0}async function ti(t,e,s,i){e&&!Array.isArray(e)&&!Dn(e)&&(i=void 0,s=e,e=void 0),t=await t,s=s||{};const r=Wi(t),o=dd(e,i),a=await Yf(t,o,s);return a?(s=Uf(s,a,o,r),i=fd({url:r,_parse:ti,loaders:o},s,i||null),await gd(a,t,s,i)):null}async function gd(t,e,s,i){if(sf(t),s=ju(t.options,s),it(e)){const n=e,{ok:o,redirected:a,status:c,statusText:l,type:h,url:u}=n,f=Object.fromEntries(n.headers.entries());i.response={headers:f,ok:o,redirected:a,status:c,statusText:l,type:h,url:u}}e=await ud(e,t,s);const r=t;if(r.parseTextSync&&typeof e=="string")return r.parseTextSync(e,s,i);if(rf(t,s))return await nf(t,e,s,i,ti);if(r.parseText&&typeof e=="string")return await r.parseText(e,s,i);if(r.parse)return await r.parse(e,s,i);throw ze(!r.parseSync),new Error(`${t.id} loader - no parser found and worker is disabled`)}async function si(t,e,s,i){let r,n;!Array.isArray(e)&&!Dn(e)?(r=[],n=e):(r=e,n=s);const o=ul(n);let a=t;return typeof t=="string"&&(a=await o(t)),rt(t)&&(a=await o(t)),Array.isArray(r)?await ti(a,r,n):await ti(a,r,n)}const pd="4.2.1";var $c;const _d=($c=globalThis.loaders)==null?void 0:$c.parseImageNode,Ur=typeof Image<"u",Lr=typeof ImageBitmap<"u",md=!!_d,Vr=On?!0:md;function yd(t){switch(t){case"auto":return Lr||Ur||Vr;case"imagebitmap":return Lr;case"image":return Ur;case"data":return Vr;default:throw new Error(`@loaders.gl/images: image ${t} not supported in this environment`)}}function bd(){if(Lr)return"imagebitmap";if(Ur)return"image";if(Vr)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function Td(t){const e=wd(t);if(!e)throw new Error("Not an image");return e}function Ad(t){switch(Td(t)){case"data":return t;case"image":case"imagebitmap":const e=document.createElement("canvas"),s=e.getContext("2d");if(!s)throw new Error("getImageData");return e.width=t.width,e.height=t.height,s.drawImage(t,0,0),s.getImageData(0,0,t.width,t.height);default:throw new Error("getImageData")}}function wd(t){return typeof ImageBitmap<"u"&&t instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&t instanceof Image?"image":t&&typeof t=="object"&&t.data&&t.width&&t.height?"data":null}const Sd=/^data:image\/svg\+xml/,Ed=/\.svg((\?|#).*)?$/;function Un(t){return t&&(Sd.test(t)||Ed.test(t))}function vd(t,e){if(Un(e)){let i=new TextDecoder().decode(t);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(i=unescape(encodeURIComponent(i)))}catch(n){throw new Error(n.message)}return`data:image/svg+xml;base64,${btoa(i)}`}return fl(t,e)}function fl(t,e){if(Un(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(t)])}async function dl(t,e,s){const i=vd(t,s),r=self.URL||self.webkitURL,n=typeof i!="string"&&r.createObjectURL(i);try{return await Rd(n||i,e)}finally{n&&r.revokeObjectURL(n)}}async function Rd(t,e){const s=new Image;return s.src=t,e.image&&e.image.decode&&s.decode?(await s.decode(),s):await new Promise((i,r)=>{try{s.onload=()=>i(s),s.onerror=n=>{const o=n instanceof Error?n.message:"error";r(new Error(o))}}catch(n){r(n)}})}const xd={};let Oo=!0;async function Pd(t,e,s){let i;Un(s)?i=await dl(t,e,s):i=fl(t,s);const r=e&&e.imagebitmap;return await Cd(i,r)}async function Cd(t,e=null){if((Id(e)||!Oo)&&(e=null),e)try{return await createImageBitmap(t,e)}catch(s){console.warn(s),Oo=!1}return await createImageBitmap(t)}function Id(t){for(const e in t||xd)return!1;return!0}function Md(t){return!Fd(t,"ftyp",4)||!(t[8]&96)?null:Od(t)}function Od(t){switch(Nd(t,8,12).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}function Nd(t,e,s){return String.fromCharCode(...t.slice(e,s))}function kd(t){return[...t].map(e=>e.charCodeAt(0))}function Fd(t,e,s=0){const i=kd(e);for(let r=0;r<i.length;++r)if(i[r]!==t[r+s])return!1;return!0}const we=!1,qt=!0;function gl(t){const e=gs(t);return Bd(e)||Vd(e)||Ud(e)||Ld(e)||Dd(e)}function Dd(t){const e=new Uint8Array(t instanceof DataView?t.buffer:t),s=Md(e);return s?{mimeType:s.mimeType,width:0,height:0}:null}function Bd(t){const e=gs(t);return e.byteLength>=24&&e.getUint32(0,we)===2303741511?{mimeType:"image/png",width:e.getUint32(16,we),height:e.getUint32(20,we)}:null}function Ud(t){const e=gs(t);return e.byteLength>=10&&e.getUint32(0,we)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,qt),height:e.getUint16(8,qt)}:null}function Ld(t){const e=gs(t);return e.byteLength>=14&&e.getUint16(0,we)===16973&&e.getUint32(2,qt)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,qt),height:e.getUint32(22,qt)}:null}function Vd(t){const e=gs(t);if(!(e.byteLength>=3&&e.getUint16(0,we)===65496&&e.getUint8(2)===255))return null;const{tableMarkers:i,sofMarkers:r}=zd();let n=2;for(;n+9<e.byteLength;){const o=e.getUint16(n,we);if(r.has(o))return{mimeType:"image/jpeg",height:e.getUint16(n+5,we),width:e.getUint16(n+7,we)};if(!i.has(o))return null;n+=2,n+=e.getUint16(n,we)}return null}function zd(){const t=new Set([65499,65476,65484,65501,65534]);for(let s=65504;s<65520;++s)t.add(s);return{tableMarkers:t,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function gs(t){if(t instanceof DataView)return t;if(ArrayBuffer.isView(t))return new DataView(t.buffer);if(t instanceof ArrayBuffer)return new DataView(t);throw new Error("toDataView")}async function Wd(t,e){var r;const{mimeType:s}=gl(t)||{},i=(r=globalThis.loaders)==null?void 0:r.parseImageNode;return Qs(i),await i(t,s)}async function Hd(t,e,s){e=e||{};const r=(e.image||{}).type||"auto",{url:n}=s||{},o=jd(r);let a;switch(o){case"imagebitmap":a=await Pd(t,e,n);break;case"image":a=await dl(t,e,n);break;case"data":a=await Wd(t);break;default:Qs(!1)}return r==="data"&&(a=Ad(a)),a}function jd(t){switch(t){case"auto":case"data":return bd();default:return yd(t),t}}const $d=["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],Xd=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],Yd={image:{type:"auto",decode:!0}},Kd={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:pd,mimeTypes:Xd,extensions:$d,parse:Hd,tests:[t=>!!gl(new DataView(t))],options:Yd},qd=new fs({id:"deck"}),U=qd;let zr={};function Zd(t){zr=t}function re(t,e,s,i){U.level>0&&zr[t]&&zr[t].call(null,e,s,i)}function Jd(t){const e=t[0],s=t[t.length-1];return e==="{"&&s==="}"||e==="["&&s==="]"}const Qd={dataType:null,batchType:null,id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:Jd,parseTextSync:JSON.parse};function Gd(){const t=typeof __VERSION__<"u"?__VERSION__:globalThis.DECK_VERSION||"untranspiled source",e=globalThis.deck&&globalThis.deck.VERSION;if(e&&e!==t)throw new Error(`deck.gl - multiple versions detected: ${e} vs ${t}`);return e||(U.log(1,`deck.gl ${t}`)(),globalThis.deck={...globalThis.deck,VERSION:t,version:t,log:U,_registerLoggers:Zd},Hf([Qd,[Kd,{imagebitmap:{premultiplyAlpha:"none"}}]])),t}const eg=Gd();function Ln(t,e){if(!t)throw new Error(e||"shadertools: assertion failed.")}const Gi={number:{type:"number",validate(t,e){return Number.isFinite(t)&&typeof e=="object"&&(e.max===void 0||t<=e.max)&&(e.min===void 0||t>=e.min)}},array:{type:"array",validate(t,e){return Array.isArray(t)||ArrayBuffer.isView(t)}}};function tg(t){const e={};for(const[s,i]of Object.entries(t))e[s]=sg(i);return e}function sg(t){let e=No(t);if(e!=="object")return{value:t,...Gi[e],type:e};if(typeof t=="object")return t?t.type!==void 0?{...t,...Gi[t.type],type:t.type}:t.value===void 0?{type:"object",value:t}:(e=No(t.value),{...t,...Gi[e],type:e}):{type:"object",value:null};throw new Error("props")}function No(t){return Array.isArray(t)||ArrayBuffer.isView(t)?"array":typeof t}const ig=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,rg=`#ifdef MODULE_MATERIAL
  fragColor = material_filterColor(fragColor);
#endif

#ifdef MODULE_LIGHTING
  fragColor = lighting_filterColor(fragColor);
#endif

#ifdef MODULE_FOG
  fragColor = fog_filterColor(fragColor);
#endif

#ifdef MODULE_PICKING
  fragColor = picking_filterHighlightColor(fragColor);
  fragColor = picking_filterPickingColor(fragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`,ng={vertex:ig,fragment:rg},ko=/void\s+main\s*\([^)]*\)\s*\{\n?/,Fo=/}\n?[^{}]*$/,er=[],Hs="__LUMA_INJECT_DECLARATIONS__";function og(t){const e={vertex:{},fragment:{}};for(const s in t){let i=t[s];const r=ag(s);typeof i=="string"&&(i={order:0,injection:i}),e[r][s]=i}return e}function ag(t){const e=t.slice(0,2);switch(e){case"vs":return"vertex";case"fs":return"fragment";default:throw new Error(e)}}function ii(t,e,s,i=!1){const r=e==="vertex";for(const n in s){const o=s[n];o.sort((c,l)=>c.order-l.order),er.length=o.length;for(let c=0,l=o.length;c<l;++c)er[c]=o[c].injection;const a=`${er.join(`
`)}
`;switch(n){case"vs:#decl":r&&(t=t.replace(Hs,a));break;case"vs:#main-start":r&&(t=t.replace(ko,c=>c+a));break;case"vs:#main-end":r&&(t=t.replace(Fo,c=>a+c));break;case"fs:#decl":r||(t=t.replace(Hs,a));break;case"fs:#main-start":r||(t=t.replace(ko,c=>c+a));break;case"fs:#main-end":r||(t=t.replace(Fo,c=>a+c));break;default:t=t.replace(n,c=>c+a)}}return t=t.replace(Hs,""),i&&(t=t.replace(/\}\s*$/,n=>n+ng[e])),t}function ri(t){t.map(e=>cg(e))}function cg(t){if(t.instance)return;ri(t.dependencies||[]);const{propTypes:e={},deprecations:s=[],inject:i={}}=t,r={normalizedInjections:og(i),parsedDeprecations:lg(s)};e&&(r.propValidators=tg(e)),t.instance=r;let n={};e&&(n=Object.entries(e).reduce((o,[a,c])=>{const l=c==null?void 0:c.value;return l&&(o[a]=l),o},{})),t.defaultUniforms={...t.defaultUniforms,...n}}function pl(t,e,s){var i;(i=t.deprecations)==null||i.forEach(r=>{var n;(n=r.regex)!=null&&n.test(e)&&(r.deprecated?s.deprecated(r.old,r.new)():s.removed(r.old,r.new)())})}function lg(t){return t.forEach(e=>{switch(e.type){case"function":e.regex=new RegExp(`\\b${e.old}\\(`);break;default:e.regex=new RegExp(`${e.type} ${e.old};`)}}),t}function Vn(t){ri(t);const e={},s={};_l({modules:t,level:0,moduleMap:e,moduleDepth:s});const i=Object.keys(s).sort((r,n)=>s[n]-s[r]).map(r=>e[r]);return ri(i),i}function _l(t){const{modules:e,level:s,moduleMap:i,moduleDepth:r}=t;if(s>=5)throw new Error("Possible loop in shader dependency graph");for(const n of e)i[n.name]=n,(r[n.name]===void 0||r[n.name]<s)&&(r[n.name]=s);for(const n of e)n.dependencies&&_l({modules:n.dependencies,level:s+1,moduleMap:i,moduleDepth:r})}function hg(t){switch(t==null?void 0:t.gpu.toLowerCase()){case"apple":return`#define APPLE_GPU
// Apple optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Headless Chrome's software shader 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// If the GPU doesn't have full 32 bits precision, will causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function ug(t,e){var i;if(Number(((i=t.match(/^#version[ \t]+(\d+)/m))==null?void 0:i[1])||100)!==300)throw new Error("luma.gl v9 only supports GLSL 3.00 shader sources");switch(e){case"vertex":return t=Do(t,fg),t;case"fragment":return t=Do(t,dg),t;default:throw new Error(e)}}const ml=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],fg=[...ml,[Wr("attribute"),"in $1"],[Wr("varying"),"out $1"]],dg=[...ml,[Wr("varying"),"in $1"]];function Do(t,e){for(const[s,i]of e)t=t.replace(s,i);return t}function Wr(t){return new RegExp(`\\b${t}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}function yl(t,e){let s="";for(const i in t){const r=t[i];if(s+=`void ${r.signature} {
`,r.header&&(s+=`  ${r.header}`),e[i]){const n=e[i];n.sort((o,a)=>o.order-a.order);for(const o of n)s+=`  ${o.injection}
`}r.footer&&(s+=`  ${r.footer}`),s+=`}
`}return s}function bl(t){const e={vertex:{},fragment:{}};for(const s of t){let i,r;typeof s!="string"?(i=s,r=i.hook):(i={},r=s),r=r.trim();const[n,o]=r.split(":"),a=r.replace(/\(.+/,""),c=Object.assign(i,{signature:o});switch(n){case"vs":e.vertex[a]=c;break;case"fs":e.fragment[a]=c;break;default:throw new Error(n)}}return e}function gg(t,e){return{name:pg(t,e),language:"glsl",version:_g(t)}}function pg(t,e="unnamed"){const i=/#define[^\S\r\n]*SHADER_NAME[^\S\r\n]*([A-Za-z0-9_-]+)\s*/.exec(t);return i?i[1]:e}function _g(t){let e=100;const s=t.match(/[^\s]+/g);if(s&&s.length>=2&&s[0]==="#version"){const i=parseInt(s[1],10);Number.isFinite(i)&&(e=i)}if(e!==100&&e!==300)throw new Error(`Invalid GLSL version ${e}`);return e}const Tl=`

${Hs}
`,mg=`precision highp float;
`;function yg(t){const e=Vn(t.modules||[]);return{source:Tg(t.platformInfo,{...t,source:t.source,stage:"vertex",modules:e}),getUniforms:Al(e)}}function bg(t){const{vs:e,fs:s}=t,i=Vn(t.modules||[]);return{vs:Bo(t.platformInfo,{...t,source:e,stage:"vertex",modules:i}),fs:Bo(t.platformInfo,{...t,source:s,stage:"fragment",modules:i}),getUniforms:Al(i)}}function Tg(t,e){var m;const{source:s,stage:i,modules:r,hookFunctions:n=[],inject:o={},log:a}=e;Ln(typeof s=="string","shader source must be a string");const c=s;let l="";const h=bl(n),u={},f={},p={};for(const T in o){const S=typeof o[T]=="string"?{injection:o[T],order:0}:o[T],v=/^(v|f)s:(#)?([\w-]+)$/.exec(T);if(v){const w=v[2],E=v[3];w?E==="decl"?f[T]=[S]:p[T]=[S]:u[T]=[S]}else p[T]=[S]}const _=r;for(const T of _){a&&pl(T,c,a);const S=wl(T,"wgsl");l+=S;const v=((m=T.injections)==null?void 0:m[i])||{};for(const w in v){const E=/^(v|f)s:#([\w-]+)$/.exec(w);if(E){const P=E[2]==="decl"?f:p;P[w]=P[w]||[],P[w].push(v[w])}else u[w]=u[w]||[],u[w].push(v[w])}}return l+=Tl,l=ii(l,i,f),l+=yl(h[i],u),l+=c,l=ii(l,i,p),l}function Bo(t,e){var M;const{id:s,source:i,stage:r,language:n="glsl",modules:o,defines:a={},hookFunctions:c=[],inject:l={},prologue:h=!0,log:u}=e;Ln(typeof i=="string","shader source must be a string");const f=n==="glsl"?gg(i).version:-1,p=t.shaderLanguageVersion,_=f===100?"#version 100":"#version 300 es",T=i.split(`
`).slice(1).join(`
`),S={};o.forEach(C=>{Object.assign(S,C.defines)}),Object.assign(S,a);let v="";switch(n){case"wgsl":break;case"glsl":v=h?`${_}

// ----- PROLOGUE -------------------------
${Ag({id:s,source:i,stage:r})}
${`#define SHADER_TYPE_${r.toUpperCase()}`}

${hg(t)}
${r==="fragment"?mg:""}

// ----- APPLICATION DEFINES -------------------------

${wg(S)}

`:`${_}
`;break}const w=bl(c),E={},R={},P={};for(const C in l){const I=typeof l[C]=="string"?{injection:l[C],order:0}:l[C],k=/^(v|f)s:(#)?([\w-]+)$/.exec(C);if(k){const O=k[2],F=k[3];O?F==="decl"?R[C]=[I]:P[C]=[I]:E[C]=[I]}else P[C]=[I]}for(const C of o){u&&pl(C,T,u);const I=wl(C,r);v+=I;const k=((M=C.instance)==null?void 0:M.normalizedInjections[r])||{};for(const O in k){const F=/^(v|f)s:#([\w-]+)$/.exec(O);if(F){const B=F[2]==="decl"?R:P;B[O]=B[O]||[],B[O].push(k[O])}else E[O]=E[O]||[],E[O].push(k[O])}}return v+="// ----- MAIN SHADER SOURCE -------------------------",v+=Tl,v=ii(v,r,R),v+=yl(w[r],E),v+=T,v=ii(v,r,P),n==="glsl"&&f!==p&&(v=ug(v,r)),v.trim()}function Al(t){return function(s){var r;const i={};for(const n of t){const o=(r=n.getUniforms)==null?void 0:r.call(n,s,i);Object.assign(i,o)}return i}}function Ag(t){const{id:e,source:s,stage:i}=t;return e&&s.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME ${e}_${i}`:""}function wg(t={}){let e="";for(const s in t){const i=t[s];(i||Number.isFinite(i))&&(e+=`#define ${s.toUpperCase()} ${t[s]}
`)}return e}function wl(t,e){let s;switch(e){case"vertex":s=t.vs||"";break;case"fragment":s=t.fs||"";break;case"wgsl":s=t.source||"";break;default:Ln(!1)}if(!t.name)throw new Error("Shader module must have a name");const i=t.name.toUpperCase().replace(/[^0-9a-z]/gi,"_");let r=`// ----- MODULE ${t.name} ---------------

`;return e!=="wgsl"&&(r+=`#define MODULE_${i}
`),r+=`${s}
`,r}const Sg=/^\s*\#\s*ifdef\s*([a-zA-Z_]+)\s*$/,Eg=/^\s*\#\s*endif\s*$/;function vg(t,e){var o;const s=t.split(`
`),i=[];let r=!0,n=null;for(const a of s){const c=a.match(Sg),l=a.match(Eg);c?(n=c[1],r=!!((o=e==null?void 0:e.defines)!=null&&o[n])):l?r=!0:r&&i.push(a)}return i.join(`
`)}const Ye=class Ye{constructor(){d(this,"_hookFunctions",[]);d(this,"_defaultModules",[])}static getDefaultShaderAssembler(){return Ye.defaultShaderAssembler=Ye.defaultShaderAssembler||new Ye,Ye.defaultShaderAssembler}addDefaultModule(e){this._defaultModules.find(s=>s.name===(typeof e=="string"?e:e.name))||this._defaultModules.push(e)}removeDefaultModule(e){const s=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(i=>i.name!==s)}addShaderHook(e,s){s&&(e=Object.assign(s,{hook:e})),this._hookFunctions.push(e)}assembleWGSLShader(e){const s=this._getModuleList(e.modules),i=this._hookFunctions,{source:r,getUniforms:n}=yg({...e,source:e.source,modules:s,hookFunctions:i});return{source:e.platformInfo.shaderLanguage==="wgsl"?vg(r):r,getUniforms:n,modules:s}}assembleGLSLShaderPair(e){const s=this._getModuleList(e.modules),i=this._hookFunctions;return{...bg({...e,vs:e.vs,fs:e.fs,modules:s,hookFunctions:i}),modules:s}}_getModuleList(e=[]){const s=new Array(this._defaultModules.length+e.length),i={};let r=0;for(let n=0,o=this._defaultModules.length;n<o;++n){const a=this._defaultModules[n],c=a.name;s[r++]=a,i[c]=!0}for(let n=0,o=e.length;n<o;++n){const a=e[n],c=a.name;i[c]||(s[r++]=a,i[c]=!0)}return s.length=r,ri(s),s}};d(Ye,"defaultShaderAssembler");let ni=Ye;const Rg=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,xg=`#version 300 es
${Rg}`;function Pg(t){const{input:e,inputChannels:s,output:i}=t||{};if(!e)return xg;if(!s)throw new Error("inputChannels");const r=Cg(s),n=Ig(e,s);return`#version 300 es
in ${r} ${e};
out vec4 ${i};
void main() {
  ${i} = ${n};
}`}function Cg(t){switch(t){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`invalid channels: ${t}`)}}function Ig(t,e){switch(e){case 1:return`vec4(${t}, 0.0, 0.0, 1.0)`;case 2:return`vec4(${t}, 0.0, 1.0)`;case 3:return`vec4(${t}, 1.0)`;case 4:return t;default:throw new Error(`invalid channels: ${e}`)}}class Mg{constructor(){d(this,"stats",new Map)}getStats(e){return this.get(e)}get(e){return this.stats.has(e)||this.stats.set(e,new zi({id:e})),this.stats.get(e)}}const Sl=new Mg,x=new fs({id:"luma.gl"}),tr={};function zn(t="id"){tr[t]=tr[t]||1;const e=tr[t]++;return`${t}-${e}`}var Fr;let W=(Fr=class{constructor(e,s,i){d(this,"id");d(this,"props");d(this,"userData",{});d(this,"_device");d(this,"destroyed",!1);d(this,"allocatedBytes",0);d(this,"_attachedResources",new Set);if(!e)throw new Error("no device");this._device=e,this.props=Og(s,i);const r=this.props.id!=="undefined"?this.props.id:zn(this[Symbol.toStringTag]);this.props.id=r,this.id=r,this.userData=this.props.userData||{},this.addStats()}destroy(){this.destroyResource()}delete(){return this.destroy(),this}toString(){return`${this[Symbol.toStringTag]||this.constructor.name}(${this.id})`}getProps(){return this.props}attachResource(e){this._attachedResources.add(e)}detachResource(e){this._attachedResources.delete(e)}destroyAttachedResource(e){this._attachedResources.delete(e)&&e.destroy()}destroyAttachedResources(){for(const e of Object.values(this._attachedResources))e.destroy();this._attachedResources=new Set}destroyResource(){this.destroyAttachedResources(),this.removeStats(),this.destroyed=!0}removeStats(){const e=this._device.statsManager.getStats("Resource Counts"),s=this[Symbol.toStringTag];e.get(`${s}s Active`).decrementCount()}trackAllocatedMemory(e,s=this[Symbol.toStringTag]){const i=this._device.statsManager.getStats("Resource Counts");i.get("GPU Memory").addCount(e),i.get(`${s} Memory`).addCount(e),this.allocatedBytes=e}trackDeallocatedMemory(e=this[Symbol.toStringTag]){const s=this._device.statsManager.getStats("Resource Counts");s.get("GPU Memory").subtractCount(this.allocatedBytes),s.get(`${e} Memory`).subtractCount(this.allocatedBytes),this.allocatedBytes=0}addStats(){const e=this._device.statsManager.getStats("Resource Counts"),s=this[Symbol.toStringTag];e.get("Resources Created").incrementCount(),e.get(`${s}s Created`).incrementCount(),e.get(`${s}s Active`).incrementCount()}},d(Fr,"defaultProps",{id:"undefined",handle:void 0,userData:void 0}),Fr);function Og(t,e){const s={...e};for(const i in t)t[i]!==void 0&&(s[i]=t[i]);return s}const G=class G extends W{constructor(s,i){const r={...i};(i.usage||0)&G.INDEX&&!i.indexType&&(i.data instanceof Uint32Array?r.indexType="uint32":i.data instanceof Uint16Array&&(r.indexType="uint16")),delete r.data;super(s,r,G.defaultProps);d(this,"usage");d(this,"indexType");d(this,"updateTimestamp");d(this,"debugData",new ArrayBuffer(0));this.usage=r.usage||0,this.indexType=r.indexType,this.updateTimestamp=s.incrementTimestamp()}get[Symbol.toStringTag](){return"Buffer"}clone(s){return this.device.createBuffer({...this.props,...s})}readSyncWebGL(s,i){throw new Error("not implemented")}_setDebugData(s,i,r){const n=ArrayBuffer.isView(s)?s.buffer:s,o=Math.min(s?s.byteLength:r,G.DEBUG_DATA_MAX_LENGTH);n===null?this.debugData=new ArrayBuffer(o):i===0&&r===n.byteLength?this.debugData=n.slice(0,o):this.debugData=n.slice(i,i+o)}};d(G,"defaultProps",{...W.defaultProps,usage:0,byteLength:0,byteOffset:0,data:null,indexType:"uint16",mappedAtCreation:!1}),d(G,"MAP_READ",1),d(G,"MAP_WRITE",2),d(G,"COPY_SRC",4),d(G,"COPY_DST",8),d(G,"INDEX",16),d(G,"VERTEX",32),d(G,"UNIFORM",64),d(G,"STORAGE",128),d(G,"INDIRECT",256),d(G,"QUERY_RESOLVE",512),d(G,"DEBUG_DATA_MAX_LENGTH",32);let j=G;function El(t){const e=Uo[t],s=Ng(e),i=t.includes("norm"),r=!i&&!t.startsWith("float"),n=t.startsWith("s");return{dataType:Uo[t],byteLength:s,integer:r,signed:n,normalized:i}}function Ng(t){return kg[t]}const Uo={uint8:"uint8",sint8:"sint8",unorm8:"uint8",snorm8:"sint8",uint16:"uint16",sint16:"sint16",unorm16:"uint16",snorm16:"sint16",float16:"float16",float32:"float32",uint32:"uint32",sint32:"sint32"},kg={uint8:1,sint8:1,uint16:2,sint16:2,float16:2,float32:4,uint32:4,sint32:4},se="texture-compression-bc",V="texture-compression-astc",ye="texture-compression-etc2",Fg="texture-compression-etc1-webgl",bs="texture-compression-pvrtc-webgl",sr="texture-compression-atc-webgl",Ts="float32-renderable-webgl",ir="float16-renderable-webgl",Dg="rgb9e5ufloat_renderable-webgl",rr="snorm8-renderable-webgl",Dt="norm16-renderable-webgl",nr="snorm16-renderable-webgl",As="float32-filterable",Lo="float16-filterable-webgl",Bg={r8unorm:{bpp:1,c:1},r8snorm:{bpp:1,c:1,render:rr},r8uint:{bpp:1,c:1},r8sint:{bpp:1,c:1},rg8unorm:{bpp:2,c:2},rg8snorm:{bpp:2,c:2,render:rr},rg8uint:{bpp:2,c:2},rg8sint:{bpp:2,c:2},r16uint:{bpp:2,c:1},r16sint:{bpp:2,c:1},r16float:{bpp:2,c:1,render:ir,filter:"float16-filterable-webgl"},"r16unorm-webgl":{b:2,c:1,f:Dt},"r16snorm-webgl":{b:2,c:1,f:nr},"rgba4unorm-webgl":{channels:"rgba",bpp:2,bitsPerChannel:[4,4,4,4],packed:!0},"rgb565unorm-webgl":{channels:"rgb",bpp:2,bitsPerChannel:[5,6,5,0],packed:!0},"rgb5a1unorm-webgl":{channels:"rgba",bpp:2,bitsPerChannel:[5,5,5,1],packed:!0},"rgb8unorm-webgl":{bpp:3,c:3,wgpu:!1},"rgb8snorm-webgl":{bpp:3,c:3,wgpu:!1},rgba8unorm:{c:2,bpp:4,bitsPerChannel:[8,8,8,8]},"rgba8unorm-srgb":{c:4,bpp:4,bitsPerChannel:[8,8,8,8]},rgba8snorm:{bpp:4,c:4,bitsPerChannel:[8,8,8,8],render:rr},rgba8uint:{c:4,bpp:4,bitsPerChannel:[8,8,8,8]},rgba8sint:{c:4,bpp:4,bitsPerChannel:[8,8,8,8]},bgra8unorm:{bpp:4,c:4},"bgra8unorm-srgb":{bpp:4,c:4},rg16uint:{c:1,bpp:4},rg16sint:{c:2,bpp:4},rg16float:{c:2,bpp:4,render:ir,filter:Lo},"rg16unorm-webgl":{b:2,c:2,render:Dt},"rg16snorm-webgl":{b:2,c:2,render:nr},r32uint:{c:1,bpp:4},r32sint:{c:1,bpp:4},r32float:{c:1,bpp:4,render:Ts,filter:As},rgb9e5ufloat:{channels:"rgb",packed:!0,c:3,bpp:4,p:1,render:Dg},rg11b10ufloat:{channels:"rgb",c:3,bpp:4,bitsPerChannel:[11,11,10,0],packed:!0,p:1,render:Ts},rgb10a2unorm:{channels:"rgba",c:4,bpp:4,bitsPerChannel:[10,10,10,2],packed:!0,p:1},"rgb10a2uint-webgl":{channels:"rgba",c:4,bpp:4,bitsPerChannel:[10,10,10,2],packed:!0,p:1,wgpu:!1},"rgb16unorm-webgl":{b:2,c:3,f:Dt},"rgb16snorm-webgl":{b:2,c:3,f:Dt},rg32uint:{bpp:8,c:2,bitsPerChannel:[32,32,0,0]},rg32sint:{bpp:8,c:2,bitsPerChannel:[32,32,0,0]},rg32float:{bpp:8,c:2,bitsPerChannel:[32,32,0,0],render:!1,filter:As},rgba16uint:{bpp:8,c:4},rgba16sint:{bpp:8,c:4},rgba16float:{bpp:8,c:4,render:ir,filter:Lo},"rgba16unorm-webgl":{b:2,c:4,render:Dt},"rgba16snorm-webgl":{b:2,c:4,render:nr},"rgb32float-webgl":{render:Ts,filter:As},rgba32uint:{bpp:16,c:4},rgba32sint:{bpp:16,c:4},rgba32float:{bpp:16,c:4,render:Ts,filter:As},stencil8:{attachment:"stencil",c:1,bpp:1,components:1,bitsPerChannel:[8,0,0,0],dataType:"uint8"},depth16unorm:{attachment:"depth",c:1,bpp:2,components:1,bitsPerChannel:[16,0,0,0],dataType:"uint16"},depth24plus:{attachment:"depth",c:1,bpp:3,components:1,bitsPerChannel:[24,0,0,0],dataType:"uint32"},depth32float:{attachment:"depth",c:1,bpp:4,components:1,bitsPerChannel:[32,0,0,0],dataType:"float32"},"depth24plus-stencil8":{attachment:"depth-stencil",bpp:4,c:2,p:1,components:2,bitsPerChannel:[24,8,0,0],packed:!0},"depth32float-stencil8":{attachment:"depth-stencil",components:2,c:2,bpp:5,bitsPerChannel:[32,8,0,0],packed:!0},"bc1-rgb-unorm-webgl":{f:se},"bc1-rgb-unorm-srgb-webgl":{f:se},"bc1-rgba-unorm":{f:se},"bc1-rgba-unorm-srgb":{f:se},"bc2-rgba-unorm":{f:se},"bc2-rgba-unorm-srgb":{f:se},"bc3-rgba-unorm":{f:se},"bc3-rgba-unorm-srgb":{f:se},"bc4-r-unorm":{f:se},"bc4-r-snorm":{f:se},"bc5-rg-unorm":{f:se},"bc5-rg-snorm":{f:se},"bc6h-rgb-ufloat":{f:se},"bc6h-rgb-float":{f:se},"bc7-rgba-unorm":{f:se},"bc7-rgba-unorm-srgb":{f:se},"etc2-rgb8unorm":{f:ye},"etc2-rgb8unorm-srgb":{f:ye},"etc2-rgb8a1unorm":{f:ye},"etc2-rgb8a1unorm-srgb":{f:ye},"etc2-rgba8unorm":{f:ye},"etc2-rgba8unorm-srgb":{f:ye},"eac-r11unorm":{f:ye},"eac-r11snorm":{f:ye},"eac-rg11unorm":{f:ye},"eac-rg11snorm":{f:ye},"astc-4x4-unorm":{f:V},"astc-4x4-unorm-srgb":{f:V},"astc-5x4-unorm":{f:V},"astc-5x4-unorm-srgb":{f:V},"astc-5x5-unorm":{f:V},"astc-5x5-unorm-srgb":{f:V},"astc-6x5-unorm":{f:V},"astc-6x5-unorm-srgb":{f:V},"astc-6x6-unorm":{f:V},"astc-6x6-unorm-srgb":{f:V},"astc-8x5-unorm":{f:V},"astc-8x5-unorm-srgb":{f:V},"astc-8x6-unorm":{f:V},"astc-8x6-unorm-srgb":{f:V},"astc-8x8-unorm":{f:V},"astc-8x8-unorm-srgb":{f:V},"astc-10x5-unorm":{f:V},"astc-10x5-unorm-srgb":{f:V},"astc-10x6-unorm":{f:V},"astc-10x6-unorm-srgb":{f:V},"astc-10x8-unorm":{f:V},"astc-10x8-unorm-srgb":{f:V},"astc-10x10-unorm":{f:V},"astc-10x10-unorm-srgb":{f:V},"astc-12x10-unorm":{f:V},"astc-12x10-unorm-srgb":{f:V},"astc-12x12-unorm":{f:V},"astc-12x12-unorm-srgb":{f:V},"pvrtc-rgb4unorm-webgl":{f:bs},"pvrtc-rgba4unorm-webgl":{f:bs},"pvrtc-rbg2unorm-webgl":{f:bs},"pvrtc-rgba2unorm-webgl":{f:bs},"etc1-rbg-unorm-webgl":{f:Fg},"atc-rgb-unorm-webgl":{f:sr},"atc-rgba-unorm-webgl":{f:sr},"atc-rgbai-unorm-webgl":{f:sr}},Ug=["bc1","bc2","bc3","bc4","bc5","bc6","bc7","etc1","etc2","eac","atc","astc","pvrtc"],Lg=/^(r|rg|rgb|rgba|bgra)([0-9]*)([a-z]*)(-srgb)?(-webgl)?$/;function vl(t){return Ug.some(e=>t.startsWith(e))}function Rl(t){if(vl(t))return Vg(t);const e=Lg.exec(t);if(!e)return zg(t);const[,s,i,r,n,o]=e,a=`${r}${i}`,c=El(a),l=c.byteLength*8,h=s.length,u=[l,h>=2?l:0,h>=3?l:0,h>=4?l:0],f={format:t,channels:s,components:h,bitsPerChannel:u,bytesPerPixel:c.byteLength*s.length,dataType:c.dataType,integer:c.integer,signed:c.signed,normalized:c.normalized};return o==="-webgl"&&(f.webgl=!0),n==="-srgb"&&(f.srgb=!0),f}function Vg(t){const e={channels:"rgb",components:3,bytesPerPixel:1,srgb:!1,compressed:!0},s=Wg(t);return s&&(e.blockWidth=s.blockWidth,e.blockHeight=s.blockHeight),e}function zg(t){var i;const e=Bg[t];if(!e)throw new Error(`Unknown format ${t}`);const s={...e,channels:e.channels||"",components:e.components||((i=e.channels)==null?void 0:i.length)||1,bytesPerPixel:e.bytesPerPixel||1,srgb:!1};return e.packed&&(s.packed=e.packed),s}function Wg(t){const s=/.*-(\d+)x(\d+)-.*/.exec(t);if(s){const[,i,r]=s;return{blockWidth:Number(i),blockHeight:Number(r)}}return null}class Hg{}class jg{constructor(e=[],s){d(this,"features");d(this,"disabledFeatures");this.features=new Set(e),this.disabledFeatures=s||{}}*[Symbol.iterator](){yield*this.features}has(e){var s;return!((s=this.disabledFeatures)!=null&&s[e])&&this.features.has(e)}}const Ri=class Ri{constructor(e){d(this,"id");d(this,"props");d(this,"userData",{});d(this,"statsManager",Sl);d(this,"timestamp",0);d(this,"_lumaData",{});this.props={...Ri.defaultProps,...e},this.id=this.props.id||zn(this[Symbol.toStringTag].toLowerCase())}get[Symbol.toStringTag](){return"Device"}isTextureFormatCompressed(e){return vl(e)}loseDevice(){return!1}error(e){this.props.onError(e)}getDefaultCanvasContext(){if(!this.canvasContext)throw new Error("Device has no default CanvasContext. See props.createCanvasContext");return this.canvasContext}createCommandEncoder(e={}){throw new Error("not implemented")}incrementTimestamp(){return this.timestamp++}onError(e){this.props.onError(e)}getCanvasContext(){return this.getDefaultCanvasContext()}readPixelsToArrayWebGL(e,s){throw new Error("not implemented")}readPixelsToBufferWebGL(e,s){throw new Error("not implemented")}setParametersWebGL(e){throw new Error("not implemented")}getParametersWebGL(e){throw new Error("not implemented")}withParametersWebGL(e,s){throw new Error("not implemented")}clearWebGL(e){throw new Error("not implemented")}resetWebGL(){throw new Error("not implemented")}_normalizeBufferProps(e){(e instanceof ArrayBuffer||ArrayBuffer.isView(e))&&(e={data:e});const s={...e};return(e.usage||0)&j.INDEX&&!e.indexType&&(e.data instanceof Uint32Array?s.indexType="uint32":e.data instanceof Uint16Array?s.indexType="uint16":x.warn("indices buffer content must be of integer type")()),s}};d(Ri,"defaultProps",{id:null,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,createCanvasContext:void 0,onError:e=>x.error(e.message),_requestMaxLimits:!0,_factoryDestroyPolicy:"unused",_initializeFeatures:!0,_disabledFeatures:{"compilation-status-async-webgl":!0},_resourceDefaults:{},webgl:{},debug:x.get("debug")||void 0,debugShaders:x.get("debug-shaders")||void 0,debugFramebuffers:!!x.get("debug-framebuffers"),debugWebGL:!!x.get("debug-webgl"),debugSpectorJS:void 0,debugSpectorJSUrl:void 0,_handle:void 0});let Ze=Ri;const $g=st()&&typeof document<"u",Xg=()=>$g&&document.readyState==="complete",Yg="set luma.log.level=1 (or higher) to trace rendering",Vo="No matching device found. Ensure `@luma.gl/webgl` and/or `@luma.gl/webgpu` modules are imported.",De=class De{constructor(){d(this,"stats",Sl);d(this,"log",x);d(this,"VERSION","9.1.0-alpha.19");d(this,"spector");d(this,"preregisteredAdapters",new Map);if(globalThis.luma){if(globalThis.luma.VERSION!==this.VERSION)throw x.error(`Found luma.gl ${globalThis.luma.VERSION} while initialzing ${this.VERSION}`)(),x.error("'yarn why @luma.gl/core' can help identify the source of the conflict")(),new Error("luma.gl - multiple versions detected: see console log");x.error("This version of luma.gl has already been initialized")()}x.log(1,`${this.VERSION} - ${Yg}`)(),globalThis.luma=this}registerAdapters(e){for(const s of e)this.preregisteredAdapters.set(s.type,s)}getSupportedAdapters(e=[]){const s=this.getAdapterMap(e);return Array.from(s).map(([,i])=>i).filter(i=>{var r;return(r=i.isSupported)==null?void 0:r.call(i)}).map(i=>i.type)}getBestAvailableAdapter(e=[]){var i,r,n,o;const s=this.getAdapterMap(e);return(r=(i=s.get("webgpu"))==null?void 0:i.isSupported)!=null&&r.call(i)?"webgpu":(o=(n=s.get("webgl"))==null?void 0:n.isSupported)!=null&&o.call(n)?"webgl":null}setDefaultDeviceProps(e){Object.assign(De.defaultProps,e)}async createDevice(e={}){var a;e={...De.defaultProps,...e},e.waitForPageLoad&&await De.pageLoaded;const s=this.getAdapterMap(e.adapters);let i=e.type||"";i==="best-available"&&(i=this.getBestAvailableAdapter(e.adapters)||i);const n=(this.getAdapterMap(e.adapters)||s).get(i),o=await((a=n==null?void 0:n.create)==null?void 0:a.call(n,e));if(o)return o;throw new Error(Vo)}async attachDevice(e){var o;const s=this.getAdapterMap(e.adapters);let i="";e.handle instanceof WebGL2RenderingContext&&(i="webgl"),e.createCanvasContext&&await De.pageLoaded,e.handle===null&&(i="unknown");const r=s.get(i),n=await((o=r==null?void 0:r.attach)==null?void 0:o.call(r,null));if(n)return n;throw new Error(Vo)}enforceWebGL2(e=!0,s=[]){var n;const r=this.getAdapterMap(s).get("webgl");r||x.warn("enforceWebGL2: webgl adapter not found")(),(n=r==null?void 0:r.enforceWebGL2)==null||n.call(r,e)}getAdapterMap(e=[]){const s=new Map(this.preregisteredAdapters);for(const i of e)s.set(i.type,i);return s}registerDevices(e){x.warn("luma.registerDevices() is deprecated, use luma.registerAdapters() instead");for(const s of e){const i=s.adapter;i&&this.preregisteredAdapters.set(i.type,i)}}};d(De,"defaultProps",{...Ze.defaultProps,type:"best-available",adapters:void 0,waitForPageLoad:!0}),d(De,"pageLoaded",Kg().then(()=>{x.probe(2,"DOM is loaded")()}));let Hr=De;const jr=new Hr;function Kg(){return Xg()||typeof window>"u"?Promise.resolve():new Promise(t=>{window.addEventListener("load",()=>t())})}class qg{}const xi=class xi{constructor(e){d(this,"id");d(this,"props");d(this,"canvas");d(this,"htmlCanvas");d(this,"offscreenCanvas");d(this,"type");d(this,"width",1);d(this,"height",1);d(this,"resizeObserver");d(this,"_canvasSizeInfo",{clientWidth:0,clientHeight:0,devicePixelRatio:1});if(this.props={...xi.defaultProps,...e},e=this.props,!st()){this.id="node-canvas-context",this.type="node",this.width=this.props.width,this.height=this.props.height,this.canvas=null;return}if(e.canvas)typeof e.canvas=="string"?this.canvas=Jg(e.canvas):this.canvas=e.canvas;else{const s=Qg(e),i=Zg((e==null?void 0:e.container)||null);i.insertBefore(s,i.firstChild),this.canvas=s,e!=null&&e.visible||(this.canvas.style.visibility="hidden")}this.canvas instanceof HTMLCanvasElement?(this.id=this.canvas.id,this.type="html-canvas",this.htmlCanvas=this.canvas):(this.id="offscreen-canvas",this.type="offscreen-canvas",this.offscreenCanvas=this.canvas),this.canvas instanceof HTMLCanvasElement&&e.autoResize&&(this.resizeObserver=new ResizeObserver(s=>{for(const i of s)i.target===this.canvas&&this.update()}),this.resizeObserver.observe(this.canvas))}getDevicePixelRatio(e){return typeof OffscreenCanvas<"u"&&this.canvas instanceof OffscreenCanvas||(e=e===void 0?this.props.useDevicePixels:e,!e||e<=0)?1:e===!0?typeof window<"u"&&window.devicePixelRatio||1:e}getPixelSize(){switch(this.type){case"node":return[this.width,this.height];case"offscreen-canvas":return[this.canvas.width,this.canvas.height];case"html-canvas":const e=this.getDevicePixelRatio(),s=this.canvas;return s.parentElement?[s.clientWidth*e,s.clientHeight*e]:[this.canvas.width,this.canvas.height];default:throw new Error(this.type)}}getAspect(){const[e,s]=this.getPixelSize();return e/s}cssToDeviceRatio(){try{const[e]=this.getDrawingBufferSize(),{clientWidth:s}=this._canvasSizeInfo;return s?e/s:1}catch{return 1}}cssToDevicePixels(e,s=!0){const i=this.cssToDeviceRatio(),[r,n]=this.getDrawingBufferSize();return Gg(e,i,r,n,s)}setDevicePixelRatio(e,s={}){if(!this.htmlCanvas)return;let i="width"in s?s.width:this.htmlCanvas.clientWidth,r="height"in s?s.height:this.htmlCanvas.clientHeight;(!i||!r)&&(x.log(1,"Canvas clientWidth/clientHeight is 0")(),e=1,i=this.htmlCanvas.width||1,r=this.htmlCanvas.height||1);const n=this._canvasSizeInfo;if(n.clientWidth!==i||n.clientHeight!==r||n.devicePixelRatio!==e){let o=e;const a=Math.floor(i*o),c=Math.floor(r*o);if(this.htmlCanvas.width=a,this.htmlCanvas.height=c,this.device.gl){const[h,u]=this.getDrawingBufferSize();(h!==a||u!==c)&&(o=Math.min(h/i,u/r),this.htmlCanvas.width=Math.floor(i*o),this.htmlCanvas.height=Math.floor(r*o),x.warn("Device pixel ratio clamped")()),this._canvasSizeInfo.clientWidth=i,this._canvasSizeInfo.clientHeight=r,this._canvasSizeInfo.devicePixelRatio=e}}}getDrawingBufferSize(){const e=this.device.gl;if(!e)throw new Error("canvas size");return[e.drawingBufferWidth,e.drawingBufferHeight]}_setAutoCreatedCanvasId(e){var s;((s=this.htmlCanvas)==null?void 0:s.id)==="lumagl-auto-created-canvas"&&(this.htmlCanvas.id=e)}};d(xi,"defaultProps",{canvas:null,width:800,height:600,useDevicePixels:!0,autoResize:!0,container:null,visible:!0,alphaMode:"opaque",colorSpace:"srgb"});let $r=xi;function Zg(t){if(typeof t=="string"){const e=document.getElementById(t);if(!e)throw new Error(`${t} is not an HTML element`);return e}else if(t)return t;return document.body}function Jg(t){const e=document.getElementById(t);if(!(e instanceof HTMLCanvasElement))throw new Error("Object is not a canvas element");return e}function Qg(t){const{width:e,height:s}=t,i=document.createElement("canvas");return i.id="lumagl-auto-created-canvas",i.width=e||1,i.height=s||1,i.style.width=Number.isFinite(e)?`${e}px`:"100%",i.style.height=Number.isFinite(s)?`${s}px`:"100%",i}function Gg(t,e,s,i,r){const n=t,o=zo(n[0],e,s);let a=Wo(n[1],e,i,r),c=zo(n[0]+1,e,s);const l=c===s-1?c:c-1;c=Wo(n[1]+1,e,i,r);let h;return r?(c=c===0?c:c+1,h=a,a=c):h=c===i-1?c:c-1,{x:o,y:a,width:Math.max(l-o+1,1),height:Math.max(h-a+1,1)}}function zo(t,e,s){return Math.min(Math.round(t*e),s-1)}function Wo(t,e,s,i){return i?Math.max(0,s-1-Math.round(t*e)):Math.min(Math.round(t*e),s-1)}const ee=class ee extends W{constructor(s,i){i=ee.normalizeProps(s,i);super(s,i,ee.defaultProps);d(this,"dimension");d(this,"format");d(this,"width");d(this,"height");d(this,"depth");d(this,"mipLevels");d(this,"updateTimestamp");if(this.dimension=this.props.dimension,this.format=this.props.format,this.width=this.props.width,this.height=this.props.height,this.depth=this.props.depth,this.props.width===void 0||this.props.height===void 0){const r=ee.getTextureDataSize(this.props.data);this.width=(r==null?void 0:r.width)||1,this.height=(r==null?void 0:r.height)||1}this.props.mipmaps&&this.props.mipLevels===void 0&&(this.props.mipLevels="pyramid"),this.mipLevels=this.props.mipLevels==="pyramid"?ee.getMipLevelCount(this.width,this.height):this.props.mipLevels||1,this.updateTimestamp=s.incrementTimestamp()}get[Symbol.toStringTag](){return"Texture"}toString(){return`Texture(${this.id},${this.format},${this.width}x${this.height})`}clone(s){return this.device.createTexture({...this.props,...s})}static isExternalImage(s){return typeof ImageData<"u"&&s instanceof ImageData||typeof ImageBitmap<"u"&&s instanceof ImageBitmap||typeof HTMLImageElement<"u"&&s instanceof HTMLImageElement||typeof HTMLVideoElement<"u"&&s instanceof HTMLVideoElement||typeof VideoFrame<"u"&&s instanceof VideoFrame||typeof HTMLCanvasElement<"u"&&s instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas}static getExternalImageSize(s){if(typeof ImageData<"u"&&s instanceof ImageData||typeof ImageBitmap<"u"&&s instanceof ImageBitmap||typeof HTMLCanvasElement<"u"&&s instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas)return{width:s.width,height:s.height};if(typeof HTMLImageElement<"u"&&s instanceof HTMLImageElement)return{width:s.naturalWidth,height:s.naturalHeight};if(typeof HTMLVideoElement<"u"&&s instanceof HTMLVideoElement)return{width:s.videoWidth,height:s.videoHeight};if(typeof VideoFrame<"u"&&s instanceof VideoFrame)return{width:s.displayWidth,height:s.displayHeight};throw new Error("Unknown image type")}static isTextureLevelData(s){const i=s==null?void 0:s.data;return ArrayBuffer.isView(i)}static getTextureDataSize(s){if(!s||ArrayBuffer.isView(s))return null;if(Array.isArray(s))return ee.getTextureDataSize(s[0]);if(ee.isExternalImage(s))return ee.getExternalImageSize(s);if(s&&typeof s=="object"&&s.constructor===Object){const r=Object.values(s)[0];return{width:r.width,height:r.height}}throw new Error("texture size deduction failed")}static normalizeTextureData(s,i){let r;return ArrayBuffer.isView(s)?r=[{data:s,width:i.width,height:i.height}]:Array.isArray(s)?r=s:r=[s],r}static getMipLevelCount(s,i){return Math.floor(Math.log2(Math.max(s,i)))+1}static getCubeFaceDepth(s){switch(s){case"+X":return 0;case"-X":return 1;case"+Y":return 2;case"-Y":return 3;case"+Z":return 4;case"-Z":return 5;default:throw new Error(s)}}static normalizeProps(s,i){var c,l;const r={...i},n=((l=(c=s==null?void 0:s.props)==null?void 0:c._resourceDefaults)==null?void 0:l.texture)||{};Object.assign(r,n);const{width:o,height:a}=r;return typeof o=="number"&&(r.width=Math.max(1,Math.ceil(o))),typeof a=="number"&&(r.height=Math.max(1,Math.ceil(a))),r}};d(ee,"COPY_SRC",1),d(ee,"COPY_DST",2),d(ee,"TEXTURE",4),d(ee,"STORAGE",8),d(ee,"RENDER_ATTACHMENT",16),d(ee,"CubeFaces",["+X","-X","+Y","-Y","+Z","-Z"]),d(ee,"defaultProps",{...W.defaultProps,data:null,dimension:"2d",format:"rgba8unorm",width:void 0,height:void 0,depth:1,mipmaps:!1,compressed:!1,usage:0,mipLevels:void 0,samples:void 0,sampler:{},view:void 0,flipY:void 0}),d(ee,"defaultCopyExternalImageOptions",{image:void 0,sourceX:0,sourceY:0,width:void 0,height:void 0,depth:1,mipLevel:0,x:0,y:0,z:0,aspect:"all",colorSpace:"srgb",premultipliedAlpha:!1,flipY:!1});let K=ee;const Pi=class Pi extends W{get[Symbol.toStringTag](){return"TextureView"}constructor(e,s){super(e,s,Pi.defaultProps)}};d(Pi,"defaultProps",{...W.defaultProps,format:void 0,dimension:void 0,aspect:"all",baseMipLevel:0,mipLevelCount:void 0,baseArrayLayer:0,arrayLayerCount:void 0});let oi=Pi;function ep(t,e,s){let i="";const r=e.split(/\r?\n/),n=t.slice().sort((o,a)=>o.lineNum-a.lineNum);switch((s==null?void 0:s.showSourceCode)||"no"){case"all":let o=0;for(let a=1;a<=r.length;a++)for(i+=xl(r[a-1],a,s);n.length>o&&n[o].lineNum===a;){const c=n[o++];i+=Ho(c,r,c.lineNum,{...s,inlineSource:!1})}return i;case"issues":case"no":for(const a of t)i+=Ho(a,r,a.lineNum,{inlineSource:(s==null?void 0:s.showSourceCode)!=="no"});return i}}function Ho(t,e,s,i){if(i!=null&&i.inlineSource){const n=tp(e,s),o=t.linePos>0?`${" ".repeat(t.linePos+5)}^^^
`:"";return`
${n}${o}${t.type.toUpperCase()}: ${t.message}

`}const r=t.type==="error"?"red":"#8B4000";return i!=null&&i.html?`<div class='luma-compiler-log-error' style="color:${r};"><b> ${t.type.toUpperCase()}: ${t.message}</b></div>`:`${t.type.toUpperCase()}: ${t.message}`}function tp(t,e,s){let i="";for(let r=e-2;r<=e;r++){const n=t[r-1];n!==void 0&&(i+=xl(n,e,s))}return i}function xl(t,e,s){const i=s!=null&&s.html?ip(t):t;return`${sp(String(e),4)}: ${i}${s!=null&&s.html?"<br/>":`
`}`}function sp(t,e){let s="";for(let i=t.length;i<e;++i)s+=" ";return s+t}function ip(t){return t.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const Ci=class Ci extends W{constructor(s,i){i={...i,debugShaders:i.debugShaders||s.props.debugShaders||"errors"};super(s,{id:rp(i),...i},Ci.defaultProps);d(this,"stage");d(this,"source");d(this,"compilationStatus","pending");this.stage=this.props.stage,this.source=this.props.source}get[Symbol.toStringTag](){return"Shader"}getCompilationInfoSync(){return null}getTranslatedSource(){return null}async debugShader(){const s=this.props.debugShaders;switch(s){case"never":return;case"errors":if(this.compilationStatus==="success")return;break}const i=await this.getCompilationInfo();s==="warnings"&&(i==null?void 0:i.length)===0||this._displayShaderLog(i)}_displayShaderLog(s){var l;if(typeof document>"u"||!(document!=null&&document.createElement))return;const i=Pl(this.source),r=`${this.stage} ${i}`;let n=ep(s,this.source,{showSourceCode:"all",html:!0});const o=this.getTranslatedSource();o&&(n+=`<br /><br /><h1>Translated Source</h1><br /><br /><code style="user-select:text;"><pre>${o}</pre></code>`);const a=document.createElement("Button");a.innerHTML=`
<h1>Shader Compilation Error in ${r}</h1><br /><br />
<code style="user-select:text;"><pre>
${n}
</pre></code>`,a.style.top="10px",a.style.left="10px",a.style.position="absolute",a.style.zIndex="9999",a.style.width="100%",a.style.textAlign="left",document.body.appendChild(a),(l=document.getElementsByClassName("luma-compiler-log-error")[0])==null||l.scrollIntoView(),a.onclick=()=>{const h=`data:text/plain,${encodeURIComponent(this.source)}`;navigator.clipboard.writeText(h)}}};d(Ci,"defaultProps",{...W.defaultProps,language:"auto",stage:void 0,source:"",sourceMap:null,entryPoint:"main",debugShaders:void 0});let ai=Ci;function rp(t){return Pl(t.source)||t.id||zn(`unnamed ${t.stage}-shader`)}function Pl(t,e="unnamed"){const i=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/.exec(t);return i?i[1]:e}const ts=class ts extends W{get[Symbol.toStringTag](){return"Sampler"}constructor(e,s){s=ts.normalizeProps(e,s),super(e,s,ts.defaultProps)}static normalizeProps(e,s){var n,o;const i=((o=(n=e==null?void 0:e.props)==null?void 0:n._resourceDefaults)==null?void 0:o.sampler)||{};return{...s,...i}}};d(ts,"defaultProps",{...W.defaultProps,type:"color-sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"none",lodMinClamp:0,lodMaxClamp:32,compare:"less-equal",maxAnisotropy:1});let ci=ts;const Ii=class Ii extends W{constructor(s,i={}){super(s,i,Ii.defaultProps);d(this,"width");d(this,"height");this.width=this.props.width,this.height=this.props.height}get[Symbol.toStringTag](){return"Framebuffer"}clone(s){const i=this.colorAttachments.map(n=>n.texture.clone(s)),r=this.depthStencilAttachment&&this.depthStencilAttachment.texture.clone(s);return this.device.createFramebuffer({...this.props,colorAttachments:i,depthStencilAttachment:r})}resize(s){let i=!s;if(s){const[r,n]=Array.isArray(s)?s:[s.width,s.height];i=i||n!==this.height||r!==this.width,this.width=r,this.height=n}i&&(x.log(2,`Resizing framebuffer ${this.id} to ${this.width}x${this.height}`)(),this.resizeAttachments(this.width,this.height))}autoCreateAttachmentTextures(){if(this.props.colorAttachments.length===0&&!this.props.depthStencilAttachment)throw new Error("Framebuffer has noattachments");this.colorAttachments=this.props.colorAttachments.map((i,r)=>{if(typeof i=="string"){const n=this.createColorTexture(i,r);return this.attachResource(n),n.view}return i instanceof K?i.view:i});const s=this.props.depthStencilAttachment;if(s)if(typeof s=="string"){const i=this.createDepthStencilTexture(s);this.attachResource(i),this.depthStencilAttachment=i.view}else s instanceof K?this.depthStencilAttachment=s.view:this.depthStencilAttachment=s}createColorTexture(s,i){return this.device.createTexture({id:`${this.id}-color-attachment-${i}`,usage:K.RENDER_ATTACHMENT,format:s,width:this.width,height:this.height,sampler:{magFilter:"linear",minFilter:"linear"}})}createDepthStencilTexture(s){return this.device.createTexture({id:`${this.id}-depth-stencil-attachment`,usage:K.RENDER_ATTACHMENT,format:s,width:this.width,height:this.height,mipmaps:!1})}resizeAttachments(s,i){for(let r=0;r<this.colorAttachments.length;++r)if(this.colorAttachments[r]){const n=this.colorAttachments[r].texture.clone({width:s,height:i});this.destroyAttachedResource(this.colorAttachments[r]),this.colorAttachments[r]=n.view,this.attachResource(n.view)}if(this.depthStencilAttachment){const r=this.depthStencilAttachment.texture.clone({width:s,height:i});this.destroyAttachedResource(this.depthStencilAttachment),this.depthStencilAttachment=r.view,this.attachResource(r)}this.updateAttachments()}};d(Ii,"defaultProps",{...W.defaultProps,width:1,height:1,colorAttachments:[],depthStencilAttachment:null});let li=Ii;const Mi=class Mi extends W{constructor(s,i){super(s,i,Mi.defaultProps);d(this,"shaderLayout");d(this,"bufferLayout");d(this,"linkStatus","pending");d(this,"hash","");this.shaderLayout=this.props.shaderLayout,this.bufferLayout=this.props.bufferLayout||[]}get[Symbol.toStringTag](){return"RenderPipeline"}setUniformsWebGL(s){throw new Error("Use uniform blocks")}};d(Mi,"defaultProps",{...W.defaultProps,vs:null,vertexEntryPoint:"vertexMain",vsConstants:{},fs:null,fragmentEntryPoint:"fragmentMain",fsConstants:{},shaderLayout:null,bufferLayout:[],topology:"triangle-list",parameters:{},bindings:{},uniforms:{}});let St=Mi;const de=class de extends W{get[Symbol.toStringTag](){return"RenderPass"}constructor(e,s){s=de.normalizeProps(e,s),super(e,s,de.defaultProps)}static normalizeProps(e,s){var n;return{...(n=e.props._resourceDefaults)==null?void 0:n.renderPass,...s}}};d(de,"defaultClearColor",[0,0,0,1]),d(de,"defaultClearDepth",1),d(de,"defaultClearStencil",0),d(de,"defaultProps",{...W.defaultProps,framebuffer:null,parameters:void 0,clearColor:de.defaultClearColor,clearColors:void 0,clearDepth:de.defaultClearDepth,clearStencil:de.defaultClearStencil,depthReadOnly:!1,stencilReadOnly:!1,discard:!1,occlusionQuerySet:void 0,timestampQuerySet:void 0,beginTimestampIndex:void 0,endTimestampIndex:void 0});let Xr=de;const Oi=class Oi extends W{constructor(s,i){super(s,i,Oi.defaultProps);d(this,"hash","");d(this,"shaderLayout");this.shaderLayout=i.shaderLayout}get[Symbol.toStringTag](){return"ComputePipeline"}};d(Oi,"defaultProps",{...W.defaultProps,shader:void 0,entryPoint:void 0,constants:{},shaderLayout:void 0});let hi=Oi;const Ni=class Ni extends W{get[Symbol.toStringTag](){return"CommandEncoder"}constructor(e,s){super(e,s,Ni.defaultProps)}};d(Ni,"defaultProps",{...W.defaultProps,measureExecutionTime:void 0});let Yr=Ni;const ki=class ki extends W{get[Symbol.toStringTag](){return"CommandBuffer"}constructor(e,s){super(e,s,ki.defaultProps)}};d(ki,"defaultProps",{...W.defaultProps});let Kr=ki;function np(t){const[e,s]=ap[t],i=e==="i32"||e==="u32",r=e!=="u32",n=cp[e]*s,o=op(e,s);return{dataType:e,components:s,defaultVertexFormat:o,byteLength:n,integer:i,signed:r}}function op(t,e){let s;switch(t){case"f32":s="float32";break;case"i32":s="sint32";break;case"u32":s="uint32";break;case"f16":return e<=2?"float16x2":"float16x4"}return e===1?s:`${s}x${e}`}const ap={f32:["f32",1],"vec2<f32>":["f32",2],"vec3<f32>":["f32",3],"vec4<f32>":["f32",4],f16:["f16",1],"vec2<f16>":["f16",2],"vec3<f16>":["f16",3],"vec4<f16>":["f16",4],i32:["i32",1],"vec2<i32>":["i32",2],"vec3<i32>":["i32",3],"vec4<i32>":["i32",4],u32:["u32",1],"vec2<u32>":["u32",2],"vec3<u32>":["u32",3],"vec4<u32>":["u32",4]},cp={f32:4,f16:2,i32:4,u32:4};function Cl(t){let e;t.endsWith("-webgl")&&(t.replace("-webgl",""),e=!0);const[s,i]=t.split("x"),r=s,n=i?parseInt(i):1,o=El(r),a={type:r,components:n,byteLength:o.byteLength*n,integer:o.integer,signed:o.signed,normalized:o.normalized};return e&&(a.webglOnly=!0),a}function Il(t,e){const s={};for(const i of t.attributes){const r=hp(t,e,i.name);r&&(s[i.name]=r)}return s}function lp(t,e,s=16){const i=Il(t,e),r=new Array(s).fill(null);for(const n of Object.values(i))r[n.location]=n;return r}function hp(t,e,s){const i=up(t,s),r=fp(e,s);if(!i)return null;const n=np(i.type),o=(r==null?void 0:r.vertexFormat)||n.defaultVertexFormat,a=Cl(o);return{attributeName:(r==null?void 0:r.attributeName)||i.name,bufferName:(r==null?void 0:r.bufferName)||i.name,location:i.location,shaderType:i.type,shaderDataType:n.dataType,shaderComponents:n.components,vertexFormat:o,bufferDataType:a.type,bufferComponents:a.components,normalized:a.normalized,integer:n.integer,stepMode:(r==null?void 0:r.stepMode)||i.stepMode||"vertex",byteOffset:(r==null?void 0:r.byteOffset)||0,byteStride:(r==null?void 0:r.byteStride)||0}}function up(t,e){const s=t.attributes.find(i=>i.name===e);return s||x.warn(`shader layout attribute "${e}" not present in shader`),s||null}function fp(t,e){dp(t);let s=gp(t,e);return s||(s=pp(t,e),s)?s:(x.warn(`layout for attribute "${e}" not present in buffer layout`),null)}function dp(t){for(const e of t)(e.attributes&&e.format||!e.attributes&&!e.format)&&x.warn(`BufferLayout ${name} must have either 'attributes' or 'format' field`)}function gp(t,e){for(const s of t)if(s.format&&s.name===e)return{attributeName:s.name,bufferName:e,stepMode:s.stepMode,vertexFormat:s.format,byteOffset:0,byteStride:s.byteStride||0};return null}function pp(t,e){var s;for(const i of t){let r=i.byteStride;if(typeof i.byteStride!="number")for(const o of i.attributes||[]){const a=Cl(o.format);r+=a.byteLength}const n=(s=i.attributes)==null?void 0:s.find(o=>o.attribute===e);if(n)return{attributeName:n.attribute,bufferName:i.name,stepMode:i.stepMode,vertexFormat:n.format,byteOffset:n.byteOffset,byteStride:r}}return null}const Fi=class Fi extends W{constructor(s,i){super(s,i,Fi.defaultProps);d(this,"maxVertexAttributes");d(this,"attributeInfos");d(this,"indexBuffer",null);d(this,"attributes");this.maxVertexAttributes=s.limits.maxVertexAttributes,this.attributes=new Array(this.maxVertexAttributes).fill(null);const{shaderLayout:r,bufferLayout:n}=i.renderPipeline||{};if(!r||!n)throw new Error("VertexArray");this.attributeInfos=lp(r,n,this.maxVertexAttributes)}get[Symbol.toStringTag](){return"VertexArray"}setConstantWebGL(s,i){throw new Error("constant attributes not supported")}};d(Fi,"defaultProps",{...W.defaultProps,renderPipeline:null});let qr=Fi;const Di=class Di extends W{get[Symbol.toStringTag](){return"TransformFeedback"}constructor(e,s){super(e,s,Di.defaultProps)}};d(Di,"defaultProps",{...W.defaultProps,layout:void 0,buffers:{}});let Zr=Di;const Bi=class Bi extends W{get[Symbol.toStringTag](){return"QuerySet"}constructor(e,s){super(e,s,Bi.defaultProps)}};d(Bi,"defaultProps",{...W.defaultProps,type:void 0,count:void 0});let Jr=Bi;const _p={f32:{type:"f32",components:1},i32:{type:"i32",components:1},u32:{type:"u32",components:1},"vec2<f32>":{type:"f32",components:2},"vec3<f32>":{type:"f32",components:3},"vec4<f32>":{type:"f32",components:4},"vec2<i32>":{type:"i32",components:2},"vec3<i32>":{type:"i32",components:3},"vec4<i32>":{type:"i32",components:4},"vec2<u32>":{type:"u32",components:2},"vec3<u32>":{type:"u32",components:3},"vec4<u32>":{type:"u32",components:4},"mat2x2<f32>":{type:"f32",components:4},"mat2x3<f32>":{type:"f32",components:6},"mat2x4<f32>":{type:"f32",components:8},"mat3x2<f32>":{type:"f32",components:6},"mat3x3<f32>":{type:"f32",components:9},"mat3x4<f32>":{type:"f32",components:12},"mat4x2<f32>":{type:"f32",components:8},"mat4x3<f32>":{type:"f32",components:12},"mat4x4<f32>":{type:"f32",components:16}};function mp(t){return _p[t]}function yp(t,e){switch(e){case 1:return t;case 2:return t+t%2;default:return t+(4-t%4)%4}}let ws;function Ml(t){return(!ws||ws.byteLength<t)&&(ws=new ArrayBuffer(t)),ws}function bp(t,e){const s=Ml(t.BYTES_PER_ELEMENT*e);return new t(s,0,e)}function Tp(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)}function ui(t){return Array.isArray(t)?t.length===0||typeof t[0]=="number":Tp(t)}const jo=1024;class Ap{constructor(e){d(this,"layout",{});d(this,"byteLength");let s=0;for(const[r,n]of Object.entries(e)){const o=mp(n),{type:a,components:c}=o;s=yp(s,c);const l=s;s+=c,this.layout[r]={type:a,size:c,offset:l}}s+=(4-s%4)%4;const i=s*4;this.byteLength=Math.max(i,jo)}getData(e){const s=Math.max(this.byteLength,jo),i=Ml(s),r={i32:new Int32Array(i),u32:new Uint32Array(i),f32:new Float32Array(i),f16:new Uint16Array(i)};for(const[n,o]of Object.entries(e)){const a=this.layout[n];if(!a){x.warn(`Supplied uniform value ${n} not present in uniform block layout`)();continue}const{type:c,size:l,offset:h}=a,u=r[c];if(l===1){if(typeof o!="number"&&typeof o!="boolean"){x.warn(`Supplied value for single component uniform ${n} is not a number: ${o}`)();continue}u[h]=Number(o)}else{if(!ui(o)){x.warn(`Supplied value for multi component / array uniform ${n} is not a numeric array: ${o}`)();continue}u.set(o,h)}}return new Uint8Array(i)}has(e){return!!this.layout[e]}get(e){return this.layout[e]}}function wp(t,e,s=16){if(t!==e)return!1;const i=t,r=e;if(!ui(i))return!1;if(ui(r)&&i.length===r.length){for(let n=0;n<i.length;++n)if(r[n]!==i[n])return!1}return!0}function Sp(t){return ui(t)?t.slice():t}class Ep{constructor(e){d(this,"name");d(this,"uniforms",{});d(this,"modifiedUniforms",{});d(this,"modified",!0);d(this,"bindingLayout",{});d(this,"needsRedraw","initialized");var s;if(this.name=(e==null?void 0:e.name)||"unnamed",e!=null&&e.name&&(e!=null&&e.shaderLayout)){const i=(s=e==null?void 0:e.shaderLayout.bindings)==null?void 0:s.find(n=>n.type==="uniform"&&n.name===(e==null?void 0:e.name));if(!i)throw new Error(e==null?void 0:e.name);const r=i;for(const n of r.uniforms||[])this.bindingLayout[n.name]=n}}setUniforms(e){for(const[s,i]of Object.entries(e))this._setUniform(s,i),this.needsRedraw||this.setNeedsRedraw(`${this.name}.${s}=${i}`)}setNeedsRedraw(e){this.needsRedraw=this.needsRedraw||e}getAllUniforms(){return this.modifiedUniforms={},this.needsRedraw=!1,this.uniforms||{}}_setUniform(e,s){wp(this.uniforms[e],s)||(this.uniforms[e]=Sp(s),this.modifiedUniforms[e]=!0,this.modified=!0)}}class vp{constructor(e){d(this,"uniformBlocks",new Map);d(this,"uniformBufferLayouts",new Map);d(this,"uniformBuffers",new Map);for(const[s,i]of Object.entries(e)){const r=s,n=new Ap(i.uniformTypes||{});this.uniformBufferLayouts.set(r,n);const o=new Ep({name:s});o.setUniforms(i.defaultUniforms||{}),this.uniformBlocks.set(r,o)}}destroy(){for(const e of this.uniformBuffers.values())e.destroy()}setUniforms(e){var s;for(const[i,r]of Object.entries(e))(s=this.uniformBlocks.get(i))==null||s.setUniforms(r);this.updateUniformBuffers()}getUniformBufferByteLength(e){var s;return((s=this.uniformBufferLayouts.get(e))==null?void 0:s.byteLength)||0}getUniformBufferData(e){var i,r;const s=((i=this.uniformBlocks.get(e))==null?void 0:i.getAllUniforms())||{};return(r=this.uniformBufferLayouts.get(e))==null?void 0:r.getData(s)}createUniformBuffer(e,s,i){i&&this.setUniforms(i);const r=this.getUniformBufferByteLength(s),n=e.createBuffer({usage:j.UNIFORM|j.COPY_DST,byteLength:r}),o=this.getUniformBufferData(s);return n.write(o),n}getManagedUniformBuffer(e,s){if(!this.uniformBuffers.get(s)){const i=this.getUniformBufferByteLength(s),r=e.createBuffer({usage:j.UNIFORM|j.COPY_DST,byteLength:i});this.uniformBuffers.set(s,r)}return this.uniformBuffers.get(s)}updateUniformBuffers(){let e=!1;for(const s of this.uniformBlocks.keys()){const i=this.updateUniformBuffer(s);e||(e=i)}return e&&x.log(3,`UniformStore.updateUniformBuffers(): ${e}`)(),e}updateUniformBuffer(e){var n;const s=this.uniformBlocks.get(e);let i=this.uniformBuffers.get(e),r=!1;if(i&&(s!=null&&s.needsRedraw)){r||(r=s.needsRedraw);const o=this.getUniformBufferData(e);i=this.uniformBuffers.get(e),i==null||i.write(o);const a=(n=this.uniformBlocks.get(e))==null?void 0:n.getAllUniforms();x.log(4,`Writing to uniform buffer ${String(e)}`,o,a)()}return r}}function Ol(t){const e=ArrayBuffer.isView(t)?t.constructor:t;switch(e){case Float32Array:return"float32";case Uint16Array:return"uint16";case Uint32Array:return"uint32";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int8Array:return"sint8";case Int16Array:return"sint16";case Int32Array:return"sint32";default:throw new Error(e.constructor.name)}}function Nl(t){switch(t){case"float32":return Float32Array;case"uint32":return Uint32Array;case"sint32":return Int32Array;case"uint16":case"unorm16":return Uint16Array;case"sint16":case"snorm16":return Int16Array;case"uint8":case"unorm8":return Uint8Array;case"sint8":case"snorm8":return Int8Array;default:throw new Error(t)}}function Rp(t,e,s){if(!e||e>4)throw new Error(`size ${e}`);const i=e;let r=Ol(t);if(r==="uint8"&&s&&i===1)return"unorm8-webgl";if(r==="uint8"&&s&&i===3)return"unorm8x3-webgl";if(r==="uint8"||r==="sint8"){if(i===1||i===3)throw new Error(`size: ${e}`);return s&&(r=r.replace("int","norm")),`${r}x${i}`}if(r==="uint16"||r==="sint16"){if(i===1||i===3)throw new Error(`size: ${e}`);return s&&(r=r.replace("int","norm")),`${r}x${i}`}return i===1?r:`${r}x${i}`}class or{constructor(e){d(this,"bufferLayouts");this.bufferLayouts=e}getBufferLayout(e){return this.bufferLayouts.find(s=>s.name===e)||null}getAttributeNamesForBuffer(e){var s;return e.attributes?(s=e.attributes)==null?void 0:s.map(i=>i.attribute):[e.name]}mergeBufferLayouts(e,s){const i=[...e];for(const r of s){const n=i.findIndex(o=>o.name===r.name);n<0?i.push(r):i[n]=r}return i}}class xp{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}let Pe=class{constructor(){}get isAstNode(){return!0}get astNodeType(){return""}evaluate(e){throw new Error("Cannot evaluate node")}evaluateString(e){return this.evaluate(e).toString()}search(e){}searchBlock(e,s){if(e){s(fi.instance);for(const i of e)i instanceof Array?this.searchBlock(i,s):i.search(s);s(di.instance)}}};class fi extends Pe{}fi.instance=new fi;class di extends Pe{}di.instance=new di;class $ extends Pe{constructor(){super()}}class Qr extends ${constructor(e,s,i,r,n,o){super(),this.calls=new Set,this.name=e,this.args=s,this.returnType=i,this.body=r,this.startLine=n,this.endLine=o}get astNodeType(){return"function"}search(e){this.searchBlock(this.body,e)}}class Pp extends ${constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class Cp extends ${constructor(e,s){super(),this.condition=e,this.body=s}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Ip extends ${constructor(e){super(),this.body=e}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class Mp extends ${constructor(e,s,i,r){super(),this.init=e,this.condition=s,this.increment=i,this.body=r}get astNodeType(){return"for"}search(e){var s,i,r;(s=this.init)===null||s===void 0||s.search(e),(i=this.condition)===null||i===void 0||i.search(e),(r=this.increment)===null||r===void 0||r.search(e),this.searchBlock(this.body,e)}}class Xe extends ${constructor(e,s,i,r,n){super(),this.name=e,this.type=s,this.storage=i,this.access=r,this.value=n}get astNodeType(){return"var"}search(e){var s;e(this),(s=this.value)===null||s===void 0||s.search(e)}}class kl extends ${constructor(e,s,i){super(),this.name=e,this.type=s,this.value=i}get astNodeType(){return"override"}search(e){var s;(s=this.value)===null||s===void 0||s.search(e)}}class Gr extends ${constructor(e,s,i,r,n){super(),this.name=e,this.type=s,this.storage=i,this.access=r,this.value=n}get astNodeType(){return"let"}search(e){var s;e(this),(s=this.value)===null||s===void 0||s.search(e)}}class $o extends ${constructor(e,s,i,r,n){super(),this.name=e,this.type=s,this.storage=i,this.access=r,this.value=n}get astNodeType(){return"const"}evaluate(e){return this.value.evaluate(e)}search(e){var s;e(this),(s=this.value)===null||s===void 0||s.search(e)}}var Et;(function(t){t.increment="++",t.decrement="--"})(Et||(Et={}));(function(t){function e(s){const i=s;if(i=="parse")throw new Error("Invalid value for IncrementOperator");return t[i]}t.parse=e})(Et||(Et={}));class Op extends ${constructor(e,s){super(),this.operator=e,this.variable=s}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}var is;(function(t){t.assign="=",t.addAssign="+=",t.subtractAssin="-=",t.multiplyAssign="*=",t.divideAssign="/=",t.moduloAssign="%=",t.andAssign="&=",t.orAssign="|=",t.xorAssign="^=",t.shiftLeftAssign="<<=",t.shiftRightAssign=">>="})(is||(is={}));(function(t){function e(s){const i=s;if(i=="parse")throw new Error("Invalid value for AssignOperator");return i}t.parse=e})(is||(is={}));class Np extends ${constructor(e,s,i){super(),this.operator=e,this.variable=s,this.value=i}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}}class Fl extends ${constructor(e,s){super(),this.name=e,this.args=s}get astNodeType(){return"call"}search(e){for(const s of this.args)s.search(e);e(this)}}class kp extends ${constructor(e,s){super(),this.body=e,this.continuing=s}get astNodeType(){return"loop"}}class Fp extends ${constructor(e,s){super(),this.condition=e,this.body=s}get astNodeType(){return"body"}}class Dp extends ${constructor(e,s,i,r){super(),this.condition=e,this.body=s,this.elseif=i,this.else=r}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class Bp extends ${constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var s;(s=this.value)===null||s===void 0||s.search(e)}}class Up extends ${constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class Lp extends ${constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}}class Vp extends ${constructor(e,s){super(),this.severity=e,this.rule=s}get astNodeType(){return"diagnostic"}}class Dl extends ${constructor(e,s){super(),this.name=e,this.type=s}get astNodeType(){return"alias"}}class zp extends ${constructor(){super()}get astNodeType(){return"discard"}}class Wp extends ${constructor(){super()}get astNodeType(){return"break"}}class Hp extends ${constructor(){super()}get astNodeType(){return"continue"}}class nt extends ${constructor(e){super(),this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}}class $e extends nt{constructor(e,s,i,r){super(e),this.members=s,this.startLine=i,this.endLine=r}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let s=0;s<this.members.length;s++)if(this.members[s].name==e)return s;return-1}}class Bl extends nt{constructor(e,s,i){super(e),this.format=s,this.access=i}get astNodeType(){return"template"}}class jp extends nt{constructor(e,s,i,r){super(e),this.storage=s,this.type=i,this.access=r}get astNodeType(){return"pointer"}}class Ul extends nt{constructor(e,s,i,r){super(e),this.attributes=s,this.format=i,this.count=r}get astNodeType(){return"array"}get isArray(){return!0}}class Wt extends nt{constructor(e,s,i){super(e),this.format=s,this.access=i}get astNodeType(){return"sampler"}}class me extends Pe{constructor(){super()}}class Xo extends me{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}evaluateString(){return this.value}}class gt extends me{constructor(e,s){super(),this.type=e,this.args=s}get astNodeType(){return"createExpr"}search(e){e(this);for(const s of this.args)s.search(e)}}class Ll extends me{constructor(e,s){super(),this.name=e,this.args=s}get astNodeType(){return"callExpr"}evaluate(e){switch(this.name){case"abs":return Math.abs(this.args[0].evaluate(e));case"acos":return Math.acos(this.args[0].evaluate(e));case"acosh":return Math.acosh(this.args[0].evaluate(e));case"asin":return Math.asin(this.args[0].evaluate(e));case"asinh":return Math.asinh(this.args[0].evaluate(e));case"atan":return Math.atan(this.args[0].evaluate(e));case"atan2":return Math.atan2(this.args[0].evaluate(e),this.args[1].evaluate(e));case"atanh":return Math.atanh(this.args[0].evaluate(e));case"ceil":return Math.ceil(this.args[0].evaluate(e));case"clamp":return Math.min(Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e)),this.args[2].evaluate(e));case"cos":return Math.cos(this.args[0].evaluate(e));case"degrees":return this.args[0].evaluate(e)*180/Math.PI;case"distance":return Math.sqrt(Math.pow(this.args[0].evaluate(e)-this.args[1].evaluate(e),2));case"dot":case"exp":return Math.exp(this.args[0].evaluate(e));case"exp2":return Math.pow(2,this.args[0].evaluate(e));case"floor":return Math.floor(this.args[0].evaluate(e));case"fma":return this.args[0].evaluate(e)*this.args[1].evaluate(e)+this.args[2].evaluate(e);case"fract":return this.args[0].evaluate(e)-Math.floor(this.args[0].evaluate(e));case"inverseSqrt":return 1/Math.sqrt(this.args[0].evaluate(e));case"log":return Math.log(this.args[0].evaluate(e));case"log2":return Math.log2(this.args[0].evaluate(e));case"max":return Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e));case"min":return Math.min(this.args[0].evaluate(e),this.args[1].evaluate(e));case"mix":return this.args[0].evaluate(e)*(1-this.args[2].evaluate(e))+this.args[1].evaluate(e)*this.args[2].evaluate(e);case"modf":return this.args[0].evaluate(e)-Math.floor(this.args[0].evaluate(e));case"pow":return Math.pow(this.args[0].evaluate(e),this.args[1].evaluate(e));case"radians":return this.args[0].evaluate(e)*Math.PI/180;case"round":return Math.round(this.args[0].evaluate(e));case"sign":return Math.sign(this.args[0].evaluate(e));case"sin":return Math.sin(this.args[0].evaluate(e));case"sinh":return Math.sinh(this.args[0].evaluate(e));case"saturate":return Math.min(Math.max(this.args[0].evaluate(e),0),1);case"smoothstep":return this.args[0].evaluate(e)*this.args[0].evaluate(e)*(3-2*this.args[0].evaluate(e));case"sqrt":return Math.sqrt(this.args[0].evaluate(e));case"step":return this.args[0].evaluate(e)<this.args[1].evaluate(e)?0:1;case"tan":return Math.tan(this.args[0].evaluate(e));case"tanh":return Math.tanh(this.args[0].evaluate(e));case"trunc":return Math.trunc(this.args[0].evaluate(e));default:throw new Error("Non const function: "+this.name)}}search(e){for(const s of this.args)s.search(e);e(this)}}class en extends me{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}evaluate(e){const s=e.constants.get(this.name);if(!s)throw new Error("Cannot evaluate node");return s.evaluate(e)}}class Yo extends me{constructor(e,s){super(),this.name=e,this.initializer=s}get astNodeType(){return"constExpr"}evaluate(e){var s,i;if(this.initializer instanceof gt){const r=(s=this.postfix)===null||s===void 0?void 0:s.evaluateString(e),n=(i=this.initializer.type)===null||i===void 0?void 0:i.name,o=e.structs.get(n),a=o==null?void 0:o.getMemberIndex(r);if(a!=-1)return this.initializer.args[a].evaluate(e);console.log(a)}return this.initializer.evaluate(e)}search(e){this.initializer.search(e)}}class Ko extends me{constructor(e){super(),this.value=e}get astNodeType(){return"literalExpr"}evaluate(){return this.value}}class $p extends me{constructor(e,s){super(),this.type=e,this.value=s}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class Xp extends me{constructor(e,s){super(),this.type=e,this.args=s}get astNodeType(){return"typecastExpr"}evaluate(e){return this.args[0].evaluate(e)}search(e){this.searchBlock(this.args,e)}}class qo extends me{constructor(e){super(),this.contents=e}get astNodeType(){return"groupExpr"}evaluate(e){return this.contents[0].evaluate(e)}search(e){this.searchBlock(this.contents,e)}}class Yp extends me{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class Vl extends me{constructor(){super()}}class Kp extends Vl{constructor(e,s){super(),this.operator=e,this.right=s}get astNodeType(){return"unaryOp"}evaluate(e){switch(this.operator){case"+":return this.right.evaluate(e);case"-":return-this.right.evaluate(e);case"!":return this.right.evaluate(e)?0:1;case"~":return~this.right.evaluate(e);default:throw new Error("Unknown unary operator: "+this.operator)}}search(e){this.right.search(e)}}class be extends Vl{constructor(e,s,i){super(),this.operator=e,this.left=s,this.right=i}get astNodeType(){return"binaryOp"}evaluate(e){switch(this.operator){case"+":return this.left.evaluate(e)+this.right.evaluate(e);case"-":return this.left.evaluate(e)-this.right.evaluate(e);case"*":return this.left.evaluate(e)*this.right.evaluate(e);case"/":return this.left.evaluate(e)/this.right.evaluate(e);case"%":return this.left.evaluate(e)%this.right.evaluate(e);case"==":return this.left.evaluate(e)==this.right.evaluate(e)?1:0;case"!=":return this.left.evaluate(e)!=this.right.evaluate(e)?1:0;case"<":return this.left.evaluate(e)<this.right.evaluate(e)?1:0;case">":return this.left.evaluate(e)>this.right.evaluate(e)?1:0;case"<=":return this.left.evaluate(e)<=this.right.evaluate(e)?1:0;case">=":return this.left.evaluate(e)>=this.right.evaluate(e)?1:0;case"&&":return this.left.evaluate(e)&&this.right.evaluate(e)?1:0;case"||":return this.left.evaluate(e)||this.right.evaluate(e)?1:0;default:throw new Error(`Unknown operator ${this.operator}`)}}search(e){this.left.search(e),this.right.search(e)}}class zl extends Pe{constructor(){super()}}class qp extends zl{constructor(e,s){super(),this.selector=e,this.body=s}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class Zp extends zl{constructor(e){super(),this.body=e}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class Jp extends Pe{constructor(e,s,i){super(),this.name=e,this.type=s,this.attributes=i}get astNodeType(){return"argument"}}class Qp extends Pe{constructor(e,s){super(),this.condition=e,this.body=s}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Gp extends Pe{constructor(e,s,i){super(),this.name=e,this.type=s,this.attributes=i}get astNodeType(){return"member"}}let e_=class extends Pe{constructor(e,s){super(),this.name=e,this.value=s}get astNodeType(){return"attribute"}};var A,y;(function(t){t[t.token=0]="token",t[t.keyword=1]="keyword",t[t.reserved=2]="reserved"})(y||(y={}));class b{constructor(e,s,i){this.name=e,this.type=s,this.rule=i}toString(){return this.name}}class g{}A=g;g.none=new b("",y.reserved,"");g.eof=new b("EOF",y.token,"");g.reserved={asm:new b("asm",y.reserved,"asm"),bf16:new b("bf16",y.reserved,"bf16"),do:new b("do",y.reserved,"do"),enum:new b("enum",y.reserved,"enum"),f16:new b("f16",y.reserved,"f16"),f64:new b("f64",y.reserved,"f64"),handle:new b("handle",y.reserved,"handle"),i8:new b("i8",y.reserved,"i8"),i16:new b("i16",y.reserved,"i16"),i64:new b("i64",y.reserved,"i64"),mat:new b("mat",y.reserved,"mat"),premerge:new b("premerge",y.reserved,"premerge"),regardless:new b("regardless",y.reserved,"regardless"),typedef:new b("typedef",y.reserved,"typedef"),u8:new b("u8",y.reserved,"u8"),u16:new b("u16",y.reserved,"u16"),u64:new b("u64",y.reserved,"u64"),unless:new b("unless",y.reserved,"unless"),using:new b("using",y.reserved,"using"),vec:new b("vec",y.reserved,"vec"),void:new b("void",y.reserved,"void")};g.keywords={array:new b("array",y.keyword,"array"),atomic:new b("atomic",y.keyword,"atomic"),bool:new b("bool",y.keyword,"bool"),f32:new b("f32",y.keyword,"f32"),i32:new b("i32",y.keyword,"i32"),mat2x2:new b("mat2x2",y.keyword,"mat2x2"),mat2x3:new b("mat2x3",y.keyword,"mat2x3"),mat2x4:new b("mat2x4",y.keyword,"mat2x4"),mat3x2:new b("mat3x2",y.keyword,"mat3x2"),mat3x3:new b("mat3x3",y.keyword,"mat3x3"),mat3x4:new b("mat3x4",y.keyword,"mat3x4"),mat4x2:new b("mat4x2",y.keyword,"mat4x2"),mat4x3:new b("mat4x3",y.keyword,"mat4x3"),mat4x4:new b("mat4x4",y.keyword,"mat4x4"),ptr:new b("ptr",y.keyword,"ptr"),sampler:new b("sampler",y.keyword,"sampler"),sampler_comparison:new b("sampler_comparison",y.keyword,"sampler_comparison"),struct:new b("struct",y.keyword,"struct"),texture_1d:new b("texture_1d",y.keyword,"texture_1d"),texture_2d:new b("texture_2d",y.keyword,"texture_2d"),texture_2d_array:new b("texture_2d_array",y.keyword,"texture_2d_array"),texture_3d:new b("texture_3d",y.keyword,"texture_3d"),texture_cube:new b("texture_cube",y.keyword,"texture_cube"),texture_cube_array:new b("texture_cube_array",y.keyword,"texture_cube_array"),texture_multisampled_2d:new b("texture_multisampled_2d",y.keyword,"texture_multisampled_2d"),texture_storage_1d:new b("texture_storage_1d",y.keyword,"texture_storage_1d"),texture_storage_2d:new b("texture_storage_2d",y.keyword,"texture_storage_2d"),texture_storage_2d_array:new b("texture_storage_2d_array",y.keyword,"texture_storage_2d_array"),texture_storage_3d:new b("texture_storage_3d",y.keyword,"texture_storage_3d"),texture_depth_2d:new b("texture_depth_2d",y.keyword,"texture_depth_2d"),texture_depth_2d_array:new b("texture_depth_2d_array",y.keyword,"texture_depth_2d_array"),texture_depth_cube:new b("texture_depth_cube",y.keyword,"texture_depth_cube"),texture_depth_cube_array:new b("texture_depth_cube_array",y.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new b("texture_depth_multisampled_2d",y.keyword,"texture_depth_multisampled_2d"),texture_external:new b("texture_external",y.keyword,"texture_external"),u32:new b("u32",y.keyword,"u32"),vec2:new b("vec2",y.keyword,"vec2"),vec3:new b("vec3",y.keyword,"vec3"),vec4:new b("vec4",y.keyword,"vec4"),bitcast:new b("bitcast",y.keyword,"bitcast"),block:new b("block",y.keyword,"block"),break:new b("break",y.keyword,"break"),case:new b("case",y.keyword,"case"),continue:new b("continue",y.keyword,"continue"),continuing:new b("continuing",y.keyword,"continuing"),default:new b("default",y.keyword,"default"),diagnostic:new b("diagnostic",y.keyword,"diagnostic"),discard:new b("discard",y.keyword,"discard"),else:new b("else",y.keyword,"else"),enable:new b("enable",y.keyword,"enable"),fallthrough:new b("fallthrough",y.keyword,"fallthrough"),false:new b("false",y.keyword,"false"),fn:new b("fn",y.keyword,"fn"),for:new b("for",y.keyword,"for"),function:new b("function",y.keyword,"function"),if:new b("if",y.keyword,"if"),let:new b("let",y.keyword,"let"),const:new b("const",y.keyword,"const"),loop:new b("loop",y.keyword,"loop"),while:new b("while",y.keyword,"while"),private:new b("private",y.keyword,"private"),read:new b("read",y.keyword,"read"),read_write:new b("read_write",y.keyword,"read_write"),return:new b("return",y.keyword,"return"),requires:new b("requires",y.keyword,"requires"),storage:new b("storage",y.keyword,"storage"),switch:new b("switch",y.keyword,"switch"),true:new b("true",y.keyword,"true"),alias:new b("alias",y.keyword,"alias"),type:new b("type",y.keyword,"type"),uniform:new b("uniform",y.keyword,"uniform"),var:new b("var",y.keyword,"var"),override:new b("override",y.keyword,"override"),workgroup:new b("workgroup",y.keyword,"workgroup"),write:new b("write",y.keyword,"write"),r8unorm:new b("r8unorm",y.keyword,"r8unorm"),r8snorm:new b("r8snorm",y.keyword,"r8snorm"),r8uint:new b("r8uint",y.keyword,"r8uint"),r8sint:new b("r8sint",y.keyword,"r8sint"),r16uint:new b("r16uint",y.keyword,"r16uint"),r16sint:new b("r16sint",y.keyword,"r16sint"),r16float:new b("r16float",y.keyword,"r16float"),rg8unorm:new b("rg8unorm",y.keyword,"rg8unorm"),rg8snorm:new b("rg8snorm",y.keyword,"rg8snorm"),rg8uint:new b("rg8uint",y.keyword,"rg8uint"),rg8sint:new b("rg8sint",y.keyword,"rg8sint"),r32uint:new b("r32uint",y.keyword,"r32uint"),r32sint:new b("r32sint",y.keyword,"r32sint"),r32float:new b("r32float",y.keyword,"r32float"),rg16uint:new b("rg16uint",y.keyword,"rg16uint"),rg16sint:new b("rg16sint",y.keyword,"rg16sint"),rg16float:new b("rg16float",y.keyword,"rg16float"),rgba8unorm:new b("rgba8unorm",y.keyword,"rgba8unorm"),rgba8unorm_srgb:new b("rgba8unorm_srgb",y.keyword,"rgba8unorm_srgb"),rgba8snorm:new b("rgba8snorm",y.keyword,"rgba8snorm"),rgba8uint:new b("rgba8uint",y.keyword,"rgba8uint"),rgba8sint:new b("rgba8sint",y.keyword,"rgba8sint"),bgra8unorm:new b("bgra8unorm",y.keyword,"bgra8unorm"),bgra8unorm_srgb:new b("bgra8unorm_srgb",y.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new b("rgb10a2unorm",y.keyword,"rgb10a2unorm"),rg11b10float:new b("rg11b10float",y.keyword,"rg11b10float"),rg32uint:new b("rg32uint",y.keyword,"rg32uint"),rg32sint:new b("rg32sint",y.keyword,"rg32sint"),rg32float:new b("rg32float",y.keyword,"rg32float"),rgba16uint:new b("rgba16uint",y.keyword,"rgba16uint"),rgba16sint:new b("rgba16sint",y.keyword,"rgba16sint"),rgba16float:new b("rgba16float",y.keyword,"rgba16float"),rgba32uint:new b("rgba32uint",y.keyword,"rgba32uint"),rgba32sint:new b("rgba32sint",y.keyword,"rgba32sint"),rgba32float:new b("rgba32float",y.keyword,"rgba32float"),static_assert:new b("static_assert",y.keyword,"static_assert")};g.tokens={decimal_float_literal:new b("decimal_float_literal",y.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?f?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+f?)|([0-9]+f)/),hex_float_literal:new b("hex_float_literal",y.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+f?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+f?))/),int_literal:new b("int_literal",y.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new b("uint_literal",y.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),ident:new b("ident",y.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new b("and",y.token,"&"),and_and:new b("and_and",y.token,"&&"),arrow:new b("arrow ",y.token,"->"),attr:new b("attr",y.token,"@"),forward_slash:new b("forward_slash",y.token,"/"),bang:new b("bang",y.token,"!"),bracket_left:new b("bracket_left",y.token,"["),bracket_right:new b("bracket_right",y.token,"]"),brace_left:new b("brace_left",y.token,"{"),brace_right:new b("brace_right",y.token,"}"),colon:new b("colon",y.token,":"),comma:new b("comma",y.token,","),equal:new b("equal",y.token,"="),equal_equal:new b("equal_equal",y.token,"=="),not_equal:new b("not_equal",y.token,"!="),greater_than:new b("greater_than",y.token,">"),greater_than_equal:new b("greater_than_equal",y.token,">="),shift_right:new b("shift_right",y.token,">>"),less_than:new b("less_than",y.token,"<"),less_than_equal:new b("less_than_equal",y.token,"<="),shift_left:new b("shift_left",y.token,"<<"),modulo:new b("modulo",y.token,"%"),minus:new b("minus",y.token,"-"),minus_minus:new b("minus_minus",y.token,"--"),period:new b("period",y.token,"."),plus:new b("plus",y.token,"+"),plus_plus:new b("plus_plus",y.token,"++"),or:new b("or",y.token,"|"),or_or:new b("or_or",y.token,"||"),paren_left:new b("paren_left",y.token,"("),paren_right:new b("paren_right",y.token,")"),semicolon:new b("semicolon",y.token,";"),star:new b("star",y.token,"*"),tilde:new b("tilde",y.token,"~"),underscore:new b("underscore",y.token,"_"),xor:new b("xor",y.token,"^"),plus_equal:new b("plus_equal",y.token,"+="),minus_equal:new b("minus_equal",y.token,"-="),times_equal:new b("times_equal",y.token,"*="),division_equal:new b("division_equal",y.token,"/="),modulo_equal:new b("modulo_equal",y.token,"%="),and_equal:new b("and_equal",y.token,"&="),or_equal:new b("or_equal",y.token,"|="),xor_equal:new b("xor_equal",y.token,"^="),shift_right_equal:new b("shift_right_equal",y.token,">>="),shift_left_equal:new b("shift_left_equal",y.token,"<<=")};g.simpleTokens={"@":A.tokens.attr,"{":A.tokens.brace_left,"}":A.tokens.brace_right,":":A.tokens.colon,",":A.tokens.comma,"(":A.tokens.paren_left,")":A.tokens.paren_right,";":A.tokens.semicolon};g.literalTokens={"&":A.tokens.and,"&&":A.tokens.and_and,"->":A.tokens.arrow,"/":A.tokens.forward_slash,"!":A.tokens.bang,"[":A.tokens.bracket_left,"]":A.tokens.bracket_right,"=":A.tokens.equal,"==":A.tokens.equal_equal,"!=":A.tokens.not_equal,">":A.tokens.greater_than,">=":A.tokens.greater_than_equal,">>":A.tokens.shift_right,"<":A.tokens.less_than,"<=":A.tokens.less_than_equal,"<<":A.tokens.shift_left,"%":A.tokens.modulo,"-":A.tokens.minus,"--":A.tokens.minus_minus,".":A.tokens.period,"+":A.tokens.plus,"++":A.tokens.plus_plus,"|":A.tokens.or,"||":A.tokens.or_or,"*":A.tokens.star,"~":A.tokens.tilde,_:A.tokens.underscore,"^":A.tokens.xor,"+=":A.tokens.plus_equal,"-=":A.tokens.minus_equal,"*=":A.tokens.times_equal,"/=":A.tokens.division_equal,"%=":A.tokens.modulo_equal,"&=":A.tokens.and_equal,"|=":A.tokens.or_equal,"^=":A.tokens.xor_equal,">>=":A.tokens.shift_right_equal,"<<=":A.tokens.shift_left_equal};g.regexTokens={decimal_float_literal:A.tokens.decimal_float_literal,hex_float_literal:A.tokens.hex_float_literal,int_literal:A.tokens.int_literal,uint_literal:A.tokens.uint_literal,ident:A.tokens.ident};g.storage_class=[A.keywords.function,A.keywords.private,A.keywords.workgroup,A.keywords.uniform,A.keywords.storage];g.access_mode=[A.keywords.read,A.keywords.write,A.keywords.read_write];g.sampler_type=[A.keywords.sampler,A.keywords.sampler_comparison];g.sampled_texture_type=[A.keywords.texture_1d,A.keywords.texture_2d,A.keywords.texture_2d_array,A.keywords.texture_3d,A.keywords.texture_cube,A.keywords.texture_cube_array];g.multisampled_texture_type=[A.keywords.texture_multisampled_2d];g.storage_texture_type=[A.keywords.texture_storage_1d,A.keywords.texture_storage_2d,A.keywords.texture_storage_2d_array,A.keywords.texture_storage_3d];g.depth_texture_type=[A.keywords.texture_depth_2d,A.keywords.texture_depth_2d_array,A.keywords.texture_depth_cube,A.keywords.texture_depth_cube_array,A.keywords.texture_depth_multisampled_2d];g.texture_external_type=[A.keywords.texture_external];g.any_texture_type=[...A.sampled_texture_type,...A.multisampled_texture_type,...A.storage_texture_type,...A.depth_texture_type,...A.texture_external_type];g.texel_format=[A.keywords.r8unorm,A.keywords.r8snorm,A.keywords.r8uint,A.keywords.r8sint,A.keywords.r16uint,A.keywords.r16sint,A.keywords.r16float,A.keywords.rg8unorm,A.keywords.rg8snorm,A.keywords.rg8uint,A.keywords.rg8sint,A.keywords.r32uint,A.keywords.r32sint,A.keywords.r32float,A.keywords.rg16uint,A.keywords.rg16sint,A.keywords.rg16float,A.keywords.rgba8unorm,A.keywords.rgba8unorm_srgb,A.keywords.rgba8snorm,A.keywords.rgba8uint,A.keywords.rgba8sint,A.keywords.bgra8unorm,A.keywords.bgra8unorm_srgb,A.keywords.rgb10a2unorm,A.keywords.rg11b10float,A.keywords.rg32uint,A.keywords.rg32sint,A.keywords.rg32float,A.keywords.rgba16uint,A.keywords.rgba16sint,A.keywords.rgba16float,A.keywords.rgba32uint,A.keywords.rgba32sint,A.keywords.rgba32float];g.const_literal=[A.tokens.int_literal,A.tokens.uint_literal,A.tokens.decimal_float_literal,A.tokens.hex_float_literal,A.keywords.true,A.keywords.false];g.literal_or_ident=[A.tokens.ident,A.tokens.int_literal,A.tokens.uint_literal,A.tokens.decimal_float_literal,A.tokens.hex_float_literal];g.element_count_expression=[A.tokens.int_literal,A.tokens.uint_literal,A.tokens.ident];g.template_types=[A.keywords.vec2,A.keywords.vec3,A.keywords.vec4,A.keywords.mat2x2,A.keywords.mat2x3,A.keywords.mat2x4,A.keywords.mat3x2,A.keywords.mat3x3,A.keywords.mat3x4,A.keywords.mat4x2,A.keywords.mat4x3,A.keywords.mat4x4,A.keywords.atomic,A.keywords.bitcast,...A.any_texture_type];g.attribute_name=[A.tokens.ident,A.keywords.block,A.keywords.diagnostic];g.assignment_operators=[A.tokens.equal,A.tokens.plus_equal,A.tokens.minus_equal,A.tokens.times_equal,A.tokens.division_equal,A.tokens.modulo_equal,A.tokens.and_equal,A.tokens.or_equal,A.tokens.xor_equal,A.tokens.shift_right_equal,A.tokens.shift_left_equal];g.increment_operators=[A.tokens.plus_plus,A.tokens.minus_minus];class Zo{constructor(e,s,i){this.type=e,this.lexeme=s,this.line=i}toString(){return this.lexeme}isTemplateType(){return g.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==g.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class t_{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=e??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new Zo(g.eof,"",this._line)),this._tokens}scanToken(){let e=this._advance();if(e==`
`)return this._line++,!0;if(this._isWhitespace(e))return!0;if(e=="/"){if(this._peekAhead()=="/"){for(;e!=`
`;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}else if(this._peekAhead()=="*"){this._advance();let o=1;for(;o>0;){if(this._isAtEnd())return!0;if(e=this._advance(),e==`
`)this._line++;else if(e=="*"){if(this._peekAhead()=="/"&&(this._advance(),o--,o==0))return!0}else e=="/"&&this._peekAhead()=="*"&&(this._advance(),o++)}return!0}}const s=g.simpleTokens[e];if(s)return this._addToken(s),!0;let i=g.none;const r=this._isAlpha(e),n=e==="_";if(this._isAlphaNumeric(e)){let o=this._peekAhead();for(;this._isAlphaNumeric(o);)e+=this._advance(),o=this._peekAhead()}if(r){const o=g.keywords[e];if(o)return this._addToken(o),!0}if(r||n)return this._addToken(g.tokens.ident),!0;for(;;){let o=this._findType(e);const a=this._peekAhead();if(e==">"&&(a==">"||a=="=")){let c=!1,l=this._tokens.length-1;for(let h=0;h<5&&l>=0&&g.assignment_operators.indexOf(this._tokens[l].type)===-1;++h,--l)if(this._tokens[l].type===g.tokens.less_than){l>0&&this._tokens[l-1].isArrayOrTemplateType()&&(c=!0);break}if(c)return this._addToken(o),!0}if(o===g.none){let c=e,l=0;const h=2;for(let u=0;u<h;++u)if(c+=this._peekAhead(u),o=this._findType(c),o!==g.none){l=u;break}if(o===g.none)return i===g.none?!1:(this._current--,this._addToken(i),!0);e=c,this._current+=l+1}if(i=o,this._isAtEnd())break;e+=this._advance()}return i===g.none?!1:(this._addToken(i),!0)}_findType(e){for(const i in g.regexTokens){const r=g.regexTokens[i];if(this._match(e,r.rule))return r}const s=g.literalTokens[e];return s||g.none}_match(e,s){const i=s.exec(e);return i&&i.index==0&&i[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"}_isAlphaNumeric(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e=="_"||e>="0"&&e<="9"}_isWhitespace(e){return e==" "||e=="	"||e=="\r"}_advance(e=0){let s=this._source[this._current];return e=e||0,e++,this._current+=e,s}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const s=this._source.substring(this._start,this._current);this._tokens.push(new Zo(e,s,this._line))}}class s_{constructor(){this._tokens=[],this._current=0,this._currentLine=0,this._context=new xp,this._deferArrayCountEval=[]}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;const s=[];for(;!this._isAtEnd();){const i=this._global_decl_or_directive();if(!i)break;s.push(i)}if(this._deferArrayCountEval.length>0){for(const i of this._deferArrayCountEval){const r=i.arrayType,n=i.countNode;if(n instanceof en){const a=n.name,c=this._context.constants.get(a);if(c)try{const l=c.evaluate(this._context);r.count=l}catch{}}}this._deferArrayCountEval.length=0}return s}_initialize(e){if(e)if(typeof e=="string"){const s=new t_(e);this._tokens=s.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_error(e,s){return{token:e,message:s,toString:function(){return`${s}`}}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==g.eof}_match(e){if(e instanceof b)return this._check(e)?(this._advance(),!0):!1;for(let s=0,i=e.length;s<i;++s){const r=e[s];if(this._check(r))return this._advance(),!0}return!1}_consume(e,s){if(this._check(e))return this._advance();throw this._error(this._peek(),s)}_check(e){if(this._isAtEnd())return!1;const s=this._peek();if(e instanceof Array){const i=s.type;return e.indexOf(i)!=-1}return s.type==e}_advance(){var e,s;return this._currentLine=(s=(e=this._peek())===null||e===void 0?void 0:e.line)!==null&&s!==void 0?s:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(g.tokens.semicolon)&&!this._isAtEnd(););if(this._match(g.keywords.alias)){const s=this._type_alias();return this._consume(g.tokens.semicolon,"Expected ';'"),s}if(this._match(g.keywords.diagnostic)){const s=this._diagnostic();return this._consume(g.tokens.semicolon,"Expected ';'"),s}if(this._match(g.keywords.requires)){const s=this._requires_directive();return this._consume(g.tokens.semicolon,"Expected ';'"),s}if(this._match(g.keywords.enable)){const s=this._enable_directive();return this._consume(g.tokens.semicolon,"Expected ';'"),s}const e=this._attribute();if(this._check(g.keywords.var)){const s=this._global_variable_decl();return s!=null&&(s.attributes=e),this._consume(g.tokens.semicolon,"Expected ';'."),s}if(this._check(g.keywords.override)){const s=this._override_variable_decl();return s!=null&&(s.attributes=e),this._consume(g.tokens.semicolon,"Expected ';'."),s}if(this._check(g.keywords.let)){const s=this._global_let_decl();return s!=null&&(s.attributes=e),this._consume(g.tokens.semicolon,"Expected ';'."),s}if(this._check(g.keywords.const)){const s=this._global_const_decl();return s!=null&&(s.attributes=e),this._consume(g.tokens.semicolon,"Expected ';'."),s}if(this._check(g.keywords.struct)){const s=this._struct_decl();return s!=null&&(s.attributes=e),s}if(this._check(g.keywords.fn)){const s=this._function_decl();return s!=null&&(s.attributes=e),s}return null}_function_decl(){if(!this._match(g.keywords.fn))return null;const e=this._currentLine,s=this._consume(g.tokens.ident,"Expected function name.").toString();this._consume(g.tokens.paren_left,"Expected '(' for function arguments.");const i=[];if(!this._check(g.tokens.paren_right))do{if(this._check(g.tokens.paren_right))break;const a=this._attribute(),c=this._consume(g.tokens.ident,"Expected argument name.").toString();this._consume(g.tokens.colon,"Expected ':' for argument type.");const l=this._attribute(),h=this._type_decl();h!=null&&(h.attributes=l,i.push(new Jp(c,h,a)))}while(this._match(g.tokens.comma));this._consume(g.tokens.paren_right,"Expected ')' after function arguments.");let r=null;if(this._match(g.tokens.arrow)){const a=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=a)}const n=this._compound_statement(),o=this._currentLine;return new Qr(s,i,r,n,e,o)}_compound_statement(){const e=[];for(this._consume(g.tokens.brace_left,"Expected '{' for block.");!this._check(g.tokens.brace_right);){const s=this._statement();s!==null&&e.push(s)}return this._consume(g.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(g.tokens.semicolon)&&!this._isAtEnd(););if(this._check(g.tokens.attr)&&this._attribute(),this._check(g.keywords.if))return this._if_statement();if(this._check(g.keywords.switch))return this._switch_statement();if(this._check(g.keywords.loop))return this._loop_statement();if(this._check(g.keywords.for))return this._for_statement();if(this._check(g.keywords.while))return this._while_statement();if(this._check(g.keywords.continuing))return this._continuing_statement();if(this._check(g.keywords.static_assert))return this._static_assert_statement();if(this._check(g.tokens.brace_left))return this._compound_statement();let e=null;return this._check(g.keywords.return)?e=this._return_statement():this._check([g.keywords.var,g.keywords.let,g.keywords.const])?e=this._variable_statement():this._match(g.keywords.discard)?e=new zp:this._match(g.keywords.break)?e=new Wp:this._match(g.keywords.continue)?e=new Hp:e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement(),e!=null&&this._consume(g.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(g.keywords.static_assert))return null;const e=this._optional_paren_expression();return new Pp(e)}_while_statement(){if(!this._match(g.keywords.while))return null;const e=this._optional_paren_expression();this._check(g.tokens.attr)&&this._attribute();const s=this._compound_statement();return new Cp(e,s)}_continuing_statement(){if(!this._match(g.keywords.continuing))return null;const e=this._compound_statement();return new Ip(e)}_for_statement(){if(!this._match(g.keywords.for))return null;this._consume(g.tokens.paren_left,"Expected '('.");const e=this._check(g.tokens.semicolon)?null:this._for_init();this._consume(g.tokens.semicolon,"Expected ';'.");const s=this._check(g.tokens.semicolon)?null:this._short_circuit_or_expression();this._consume(g.tokens.semicolon,"Expected ';'.");const i=this._check(g.tokens.paren_right)?null:this._for_increment();this._consume(g.tokens.paren_right,"Expected ')'."),this._check(g.tokens.attr)&&this._attribute();const r=this._compound_statement();return new Mp(e,s,i,r)}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(g.keywords.var)){const e=this._variable_decl();if(e===null)throw this._error(this._peek(),"Variable declaration expected.");let s=null;return this._match(g.tokens.equal)&&(s=this._short_circuit_or_expression()),new Xe(e.name,e.type,e.storage,e.access,s)}if(this._match(g.keywords.let)){const e=this._consume(g.tokens.ident,"Expected name for let.").toString();let s=null;if(this._match(g.tokens.colon)){const r=this._attribute();s=this._type_decl(),s!=null&&(s.attributes=r)}this._consume(g.tokens.equal,"Expected '=' for let.");const i=this._short_circuit_or_expression();return new Gr(e,s,null,null,i)}if(this._match(g.keywords.const)){const e=this._consume(g.tokens.ident,"Expected name for const.").toString();let s=null;if(this._match(g.tokens.colon)){const r=this._attribute();s=this._type_decl(),s!=null&&(s.attributes=r)}this._consume(g.tokens.equal,"Expected '=' for const.");const i=this._short_circuit_or_expression();return new $o(e,s,null,null,i)}return null}_increment_decrement_statement(){const e=this._current,s=this._unary_expression();if(s==null)return null;if(!this._check(g.increment_operators))return this._current=e,null;const i=this._consume(g.increment_operators,"Expected increment operator");return new Op(i.type===g.tokens.plus_plus?Et.increment:Et.decrement,s)}_assignment_statement(){let e=null;if(this._check(g.tokens.brace_right))return null;let s=this._match(g.tokens.underscore);if(s||(e=this._unary_expression()),!s&&e==null)return null;const i=this._consume(g.assignment_operators,"Expected assignment operator."),r=this._short_circuit_or_expression();return new Np(is.parse(i.lexeme),e,r)}_func_call_statement(){if(!this._check(g.tokens.ident))return null;const e=this._current,s=this._consume(g.tokens.ident,"Expected function name."),i=this._argument_expression_list();return i===null?(this._current=e,null):new Fl(s.lexeme,i)}_loop_statement(){if(!this._match(g.keywords.loop))return null;this._check(g.tokens.attr)&&this._attribute(),this._consume(g.tokens.brace_left,"Expected '{' for loop.");const e=[];let s=this._statement();for(;s!==null;){if(Array.isArray(s))for(let r of s)e.push(r);else e.push(s);s=this._statement()}let i=null;return this._match(g.keywords.continuing)&&(i=this._compound_statement()),this._consume(g.tokens.brace_right,"Expected '}' for loop."),new kp(e,i)}_switch_statement(){if(!this._match(g.keywords.switch))return null;const e=this._optional_paren_expression();this._check(g.tokens.attr)&&this._attribute(),this._consume(g.tokens.brace_left,"Expected '{' for switch.");const s=this._switch_body();if(s==null||s.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(g.tokens.brace_right,"Expected '}' for switch."),new Fp(e,s)}_switch_body(){const e=[];if(this._match(g.keywords.case)){const s=this._case_selectors();this._match(g.tokens.colon),this._check(g.tokens.attr)&&this._attribute(),this._consume(g.tokens.brace_left,"Exected '{' for switch case.");const i=this._case_body();this._consume(g.tokens.brace_right,"Exected '}' for switch case."),e.push(new qp(s,i))}if(this._match(g.keywords.default)){this._match(g.tokens.colon),this._check(g.tokens.attr)&&this._attribute(),this._consume(g.tokens.brace_left,"Exected '{' for switch default.");const s=this._case_body();this._consume(g.tokens.brace_right,"Exected '}' for switch default."),e.push(new Zp(s))}if(this._check([g.keywords.default,g.keywords.case])){const s=this._switch_body();e.push(s[0])}return e}_case_selectors(){const e=[this._shift_expression()];for(;this._match(g.tokens.comma);)e.push(this._shift_expression());return e}_case_body(){if(this._match(g.keywords.fallthrough))return this._consume(g.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(e==null)return[];e instanceof Array||(e=[e]);const s=this._case_body();return s.length==0?e:[...e,s[0]]}_if_statement(){if(!this._match(g.keywords.if))return null;const e=this._optional_paren_expression();this._check(g.tokens.attr)&&this._attribute();const s=this._compound_statement();let i=[];this._match_elseif()&&(this._check(g.tokens.attr)&&this._attribute(),i=this._elseif_statement(i));let r=null;return this._match(g.keywords.else)&&(this._check(g.tokens.attr)&&this._attribute(),r=this._compound_statement()),new Dp(e,s,i,r)}_match_elseif(){return this._tokens[this._current].type===g.keywords.else&&this._tokens[this._current+1].type===g.keywords.if?(this._advance(),this._advance(),!0):!1}_elseif_statement(e=[]){const s=this._optional_paren_expression(),i=this._compound_statement();return e.push(new Qp(s,i)),this._match_elseif()&&(this._check(g.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(g.keywords.return))return null;const e=this._short_circuit_or_expression();return new Bp(e)}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(g.tokens.or_or);)e=new be(this._previous().toString(),e,this._short_circuit_and_expr());return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(g.tokens.and_and);)e=new be(this._previous().toString(),e,this._inclusive_or_expression());return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(g.tokens.or);)e=new be(this._previous().toString(),e,this._exclusive_or_expression());return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(g.tokens.xor);)e=new be(this._previous().toString(),e,this._and_expression());return e}_and_expression(){let e=this._equality_expression();for(;this._match(g.tokens.and);)e=new be(this._previous().toString(),e,this._equality_expression());return e}_equality_expression(){const e=this._relational_expression();return this._match([g.tokens.equal_equal,g.tokens.not_equal])?new be(this._previous().toString(),e,this._relational_expression()):e}_relational_expression(){let e=this._shift_expression();for(;this._match([g.tokens.less_than,g.tokens.greater_than,g.tokens.less_than_equal,g.tokens.greater_than_equal]);)e=new be(this._previous().toString(),e,this._shift_expression());return e}_shift_expression(){let e=this._additive_expression();for(;this._match([g.tokens.shift_left,g.tokens.shift_right]);)e=new be(this._previous().toString(),e,this._additive_expression());return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([g.tokens.plus,g.tokens.minus]);)e=new be(this._previous().toString(),e,this._multiplicative_expression());return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([g.tokens.star,g.tokens.forward_slash,g.tokens.modulo]);)e=new be(this._previous().toString(),e,this._unary_expression());return e}_unary_expression(){return this._match([g.tokens.minus,g.tokens.bang,g.tokens.tilde,g.tokens.star,g.tokens.and])?new Kp(this._previous().toString(),this._unary_expression()):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),s=this._postfix_expression();return s&&(e.postfix=s),e}_postfix_expression(){if(this._match(g.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(g.tokens.bracket_right,"Expected ']'.");const s=new Yp(e),i=this._postfix_expression();return i&&(s.postfix=i),s}if(this._match(g.tokens.period)){const e=this._consume(g.tokens.ident,"Expected member name."),s=this._postfix_expression(),i=new Xo(e.lexeme);return s&&(i.postfix=s),i}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_primary_expression(){if(this._match(g.tokens.ident)){const i=this._previous().toString();if(this._check(g.tokens.paren_left)){const r=this._argument_expression_list(),n=this._getStruct(i);return n!=null?new gt(n,r):new Ll(i,r)}if(this._context.constants.has(i)){const r=this._context.constants.get(i);return new Yo(i,r.value)}return new en(i)}if(this._match(g.const_literal))return new Ko(parseFloat(this._previous().toString()));if(this._check(g.tokens.paren_left))return this._paren_expression();if(this._match(g.keywords.bitcast)){this._consume(g.tokens.less_than,"Expected '<'.");const i=this._type_decl();this._consume(g.tokens.greater_than,"Expected '>'.");const r=this._paren_expression();return new $p(i,r)}const e=this._type_decl(),s=this._argument_expression_list();return new Xp(e,s)}_argument_expression_list(){if(!this._match(g.tokens.paren_left))return null;const e=[];do{if(this._check(g.tokens.paren_right))break;const s=this._short_circuit_or_expression();e.push(s)}while(this._match(g.tokens.comma));return this._consume(g.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(g.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(g.tokens.paren_right),new qo([e])}_paren_expression(){this._consume(g.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(g.tokens.paren_right,"Expected ')'."),new qo([e])}_struct_decl(){if(!this._match(g.keywords.struct))return null;const e=this._currentLine,s=this._consume(g.tokens.ident,"Expected name for struct.").toString();this._consume(g.tokens.brace_left,"Expected '{' for struct body.");const i=[];for(;!this._check(g.tokens.brace_right);){const o=this._attribute(),a=this._consume(g.tokens.ident,"Expected variable name.").toString();this._consume(g.tokens.colon,"Expected ':' for struct member type.");const c=this._attribute(),l=this._type_decl();l!=null&&(l.attributes=c),this._check(g.tokens.brace_right)?this._match(g.tokens.comma):this._consume(g.tokens.comma,"Expected ',' for struct member."),i.push(new Gp(a,l,o))}this._consume(g.tokens.brace_right,"Expected '}' after struct body.");const r=this._currentLine,n=new $e(s,i,e,r);return this._context.structs.set(s,n),n}_global_variable_decl(){const e=this._variable_decl();return e&&this._match(g.tokens.equal)&&(e.value=this._const_expression()),e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(g.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){if(!this._match(g.keywords.const))return null;const e=this._consume(g.tokens.ident,"Expected variable name");let s=null;if(this._match(g.tokens.colon)){const n=this._attribute();s=this._type_decl(),s!=null&&(s.attributes=n)}let i=null;if(this._match(g.tokens.equal)){const n=this._short_circuit_or_expression();if(n instanceof gt)i=n;else if(n instanceof Yo&&n.initializer instanceof gt)i=n.initializer;else try{const o=n.evaluate(this._context);i=new Ko(o)}catch{i=n}}const r=new $o(e.toString(),s,"","",i);return this._context.constants.set(r.name,r),r}_global_let_decl(){if(!this._match(g.keywords.let))return null;const e=this._consume(g.tokens.ident,"Expected variable name");let s=null;if(this._match(g.tokens.colon)){const r=this._attribute();s=this._type_decl(),s!=null&&(s.attributes=r)}let i=null;return this._match(g.tokens.equal)&&(i=this._const_expression()),new Gr(e.toString(),s,"","",i)}_const_expression(){if(this._match(g.const_literal))return new Xo(this._previous().toString());const e=this._type_decl();this._consume(g.tokens.paren_left,"Expected '('.");let s=[];for(;!this._check(g.tokens.paren_right)&&(s.push(this._const_expression()),!!this._check(g.tokens.comma));)this._advance();return this._consume(g.tokens.paren_right,"Expected ')'."),new gt(e,s)}_variable_decl(){if(!this._match(g.keywords.var))return null;let e="",s="";this._match(g.tokens.less_than)&&(e=this._consume(g.storage_class,"Expected storage_class.").toString(),this._match(g.tokens.comma)&&(s=this._consume(g.access_mode,"Expected access_mode.").toString()),this._consume(g.tokens.greater_than,"Expected '>'."));const i=this._consume(g.tokens.ident,"Expected variable name");let r=null;if(this._match(g.tokens.colon)){const n=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=n)}return new Xe(i.toString(),r,e,s,null)}_override_decl(){if(!this._match(g.keywords.override))return null;const e=this._consume(g.tokens.ident,"Expected variable name");let s=null;if(this._match(g.tokens.colon)){const i=this._attribute();s=this._type_decl(),s!=null&&(s.attributes=i)}return new kl(e.toString(),s,null)}_diagnostic(){this._consume(g.tokens.paren_left,"Expected '('");const e=this._consume(g.tokens.ident,"Expected severity control name.");this._consume(g.tokens.comma,"Expected ','");const s=this._consume(g.tokens.ident,"Expected diagnostic rule name.");return this._consume(g.tokens.paren_right,"Expected ')'"),new Vp(e.toString(),s.toString())}_enable_directive(){const e=this._consume(g.tokens.ident,"identity expected.");return new Up(e.toString())}_requires_directive(){const e=[this._consume(g.tokens.ident,"identity expected.").toString()];for(;this._match(g.tokens.comma);){const s=this._consume(g.tokens.ident,"identity expected.");e.push(s.toString())}return new Lp(e)}_type_alias(){const e=this._consume(g.tokens.ident,"identity expected.");this._consume(g.tokens.equal,"Expected '=' for type alias.");let s=this._type_decl();if(s===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(s.name)&&(s=this._context.aliases.get(s.name).type);const i=new Dl(e.toString(),s);return this._context.aliases.set(i.name,i),i}_type_decl(){if(this._check([g.tokens.ident,...g.texel_format,g.keywords.bool,g.keywords.f32,g.keywords.i32,g.keywords.u32])){const i=this._advance(),r=i.toString();return this._context.structs.has(r)?this._context.structs.get(r):this._context.aliases.has(r)?this._context.aliases.get(r).type:new nt(i.toString())}let e=this._texture_sampler_types();if(e)return e;if(this._check(g.template_types)){let i=this._advance().toString(),r=null,n=null;return this._match(g.tokens.less_than)&&(r=this._type_decl(),n=null,this._match(g.tokens.comma)&&(n=this._consume(g.access_mode,"Expected access_mode for pointer").toString()),this._consume(g.tokens.greater_than,"Expected '>' for type.")),new Bl(i,r,n)}if(this._match(g.keywords.ptr)){let i=this._previous().toString();this._consume(g.tokens.less_than,"Expected '<' for pointer.");const r=this._consume(g.storage_class,"Expected storage_class for pointer");this._consume(g.tokens.comma,"Expected ',' for pointer.");const n=this._type_decl();let o=null;return this._match(g.tokens.comma)&&(o=this._consume(g.access_mode,"Expected access_mode for pointer").toString()),this._consume(g.tokens.greater_than,"Expected '>' for pointer."),new jp(i,r.toString(),n,o)}const s=this._attribute();if(this._match(g.keywords.array)){let i=null,r=-1;const n=this._previous();let o=null;if(this._match(g.tokens.less_than)){i=this._type_decl(),this._context.aliases.has(i.name)&&(i=this._context.aliases.get(i.name).type);let c="";if(this._match(g.tokens.comma)){o=this._shift_expression();try{c=o.evaluate(this._context).toString(),o=null}catch{c="1"}}this._consume(g.tokens.greater_than,"Expected '>' for array."),r=c?parseInt(c):0}const a=new Ul(n.toString(),s,i,r);return o&&this._deferArrayCountEval.push({arrayType:a,countNode:o}),a}return null}_texture_sampler_types(){if(this._match(g.sampler_type))return new Wt(this._previous().toString(),null,null);if(this._match(g.depth_texture_type))return new Wt(this._previous().toString(),null,null);if(this._match(g.sampled_texture_type)||this._match(g.multisampled_texture_type)){const e=this._previous();this._consume(g.tokens.less_than,"Expected '<' for sampler type.");const s=this._type_decl();return this._consume(g.tokens.greater_than,"Expected '>' for sampler type."),new Wt(e.toString(),s,null)}if(this._match(g.storage_texture_type)){const e=this._previous();this._consume(g.tokens.less_than,"Expected '<' for sampler type.");const s=this._consume(g.texel_format,"Invalid texel format.").toString();this._consume(g.tokens.comma,"Expected ',' after texel format.");const i=this._consume(g.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(g.tokens.greater_than,"Expected '>' for sampler type."),new Wt(e.toString(),s,i)}return null}_attribute(){let e=[];for(;this._match(g.tokens.attr);){const s=this._consume(g.attribute_name,"Expected attribute name"),i=new e_(s.toString(),null);if(this._match(g.tokens.paren_left)){if(i.value=this._consume(g.literal_or_ident,"Expected attribute value").toString(),this._check(g.tokens.comma)){this._advance();do{const r=this._consume(g.literal_or_ident,"Expected attribute value").toString();i.value instanceof Array||(i.value=[i.value]),i.value.push(r)}while(this._match(g.tokens.comma))}this._consume(g.tokens.paren_right,"Expected ')'")}e.push(i)}return e.length==0?null:e}}class bt{constructor(e,s){this.name=e,this.attributes=s,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}}class Jo{constructor(e,s,i){this.name=e,this.type=s,this.attributes=i,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray?this.type.format:this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class Ss extends bt{constructor(e,s){super(e,s),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class ar extends bt{constructor(e,s){super(e,s),this.count=0,this.stride=0}get isArray(){return!0}}class Qo extends bt{constructor(e,s,i,r){super(e,i),this.format=s,this.access=r}get isTemplate(){return!0}}var ke;(function(t){t[t.Uniform=0]="Uniform",t[t.Storage=1]="Storage",t[t.Texture=2]="Texture",t[t.Sampler=3]="Sampler",t[t.StorageTexture=4]="StorageTexture"})(ke||(ke={}));class Es{constructor(e,s,i,r,n,o,a){this.name=e,this.type=s,this.group=i,this.binding=r,this.attributes=n,this.resourceType=o,this.access=a}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray?this.type.format:this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class i_{constructor(e,s){this.name=e,this.type=s}}class vs{constructor(e,s){this.align=e,this.size=s}}class r_{constructor(e,s,i,r){this.name=e,this.type=s,this.locationType=i,this.location=r,this.interpolation=null}}class Go{constructor(e,s,i,r){this.name=e,this.type=s,this.locationType=i,this.location=r}}class n_{constructor(e,s=null){this.stage=null,this.inputs=[],this.outputs=[],this.resources=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=s}}class o_{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}class a_{constructor(e,s,i,r){this.name=e,this.type=s,this.attributes=i,this.id=r}}class c_{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class Re{constructor(e){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new o_,this.functions=[],this._types=new Map,this._functions=new Map,e&&this.update(e)}_isStorageTexture(e){return e.name=="texture_storage_1d"||e.name=="texture_storage_2d"||e.name=="texture_storage_2d_array"||e.name=="texture_storage_3d"}update(e){const i=new s_().parse(e);for(const r of i)r instanceof Qr&&this._functions.set(r.name,new c_(r));for(const r of i)if(r instanceof $e){const n=this._getTypeInfo(r,null);n instanceof Ss&&this.structs.push(n)}for(const r of i){if(r instanceof Dl){this.aliases.push(this._getAliasInfo(r));continue}if(r instanceof kl){const n=r,o=this._getAttributeNum(n.attributes,"id",0),a=n.type!=null?this._getTypeInfo(n.type,n.attributes):null;this.overrides.push(new a_(n.name,a,n.attributes,o));continue}if(this._isUniformVar(r)){const n=r,o=this._getAttributeNum(n.attributes,"group",0),a=this._getAttributeNum(n.attributes,"binding",0),c=this._getTypeInfo(n.type,n.attributes),l=new Es(n.name,c,o,a,n.attributes,ke.Uniform,n.access);this.uniforms.push(l);continue}if(this._isStorageVar(r)){const n=r,o=this._getAttributeNum(n.attributes,"group",0),a=this._getAttributeNum(n.attributes,"binding",0),c=this._getTypeInfo(n.type,n.attributes),l=this._isStorageTexture(c),h=new Es(n.name,c,o,a,n.attributes,l?ke.StorageTexture:ke.Storage,n.access);this.storage.push(h);continue}if(this._isTextureVar(r)){const n=r,o=this._getAttributeNum(n.attributes,"group",0),a=this._getAttributeNum(n.attributes,"binding",0),c=this._getTypeInfo(n.type,n.attributes),l=this._isStorageTexture(c),h=new Es(n.name,c,o,a,n.attributes,l?ke.StorageTexture:ke.Texture,n.access);l?this.storage.push(h):this.textures.push(h);continue}if(this._isSamplerVar(r)){const n=r,o=this._getAttributeNum(n.attributes,"group",0),a=this._getAttributeNum(n.attributes,"binding",0),c=this._getTypeInfo(n.type,n.attributes),l=new Es(n.name,c,o,a,n.attributes,ke.Sampler,n.access);this.samplers.push(l);continue}if(r instanceof Qr){const n=this._getAttribute(r,"vertex"),o=this._getAttribute(r,"fragment"),a=this._getAttribute(r,"compute"),c=n||o||a,l=new n_(r.name,c==null?void 0:c.name);l.startLine=r.startLine,l.endLine=r.endLine,this.functions.push(l),this._functions.get(r.name).info=l,c&&(this._functions.get(r.name).inUse=!0,l.inUse=!0,l.resources=this._findResources(r,!!c),l.inputs=this._getInputs(r.args),l.outputs=this._getOutputs(r.returnType),this.entry[c.name].push(l));continue}}for(const r of this._functions.values())r.info&&(r.info.inUse=r.inUse,this._addCalls(r.node,r.info.calls));for(const r of this.uniforms)this._markStructsInUse(r.type);for(const r of this.storage)this._markStructsInUse(r.type)}_markStructsInUse(e){if(e.isStruct){e.inUse=!0;for(const s of e.members)this._markStructsInUse(s.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)this._markStructsInUse(e.format);else{const s=this._getAlias(e.name);s&&this._markStructsInUse(s)}}_addCalls(e,s){var i;for(const r of e.calls){const n=(i=this._functions.get(r.name))===null||i===void 0?void 0:i.info;n&&s.add(n)}}findResource(e,s){for(const i of this.uniforms)if(i.group==e&&i.binding==s)return i;for(const i of this.storage)if(i.group==e&&i.binding==s)return i;for(const i of this.textures)if(i.group==e&&i.binding==s)return i;for(const i of this.samplers)if(i.group==e&&i.binding==s)return i;return null}_findResource(e){for(const s of this.uniforms)if(s.name==e)return s;for(const s of this.storage)if(s.name==e)return s;for(const s of this.textures)if(s.name==e)return s;for(const s of this.samplers)if(s.name==e)return s;return null}_markStructsFromAST(e){const s=this._getTypeInfo(e,null);this._markStructsInUse(s)}_findResources(e,s){const i=[],r=this,n=[];return e.search(o=>{if(o instanceof fi)n.push({});else if(o instanceof di)n.pop();else if(o instanceof Xe){const a=o;s&&a.type!==null&&this._markStructsFromAST(a.type),n.length>0&&(n[n.length-1][a.name]=a)}else if(o instanceof gt){const a=o;s&&a.type!==null&&this._markStructsFromAST(a.type)}else if(o instanceof Gr){const a=o;s&&a.type!==null&&this._markStructsFromAST(a.type),n.length>0&&(n[n.length-1][a.name]=a)}else if(o instanceof en){const a=o;if(n.length>0&&n[n.length-1][a.name])return;const c=r._findResource(a.name);c&&i.push(c)}else if(o instanceof Ll){const a=o,c=r._functions.get(a.name);c&&(s&&(c.inUse=!0),e.calls.add(c.node),c.resources===null&&(c.resources=r._findResources(c.node,s)),i.push(...c.resources))}else if(o instanceof Fl){const a=o,c=r._functions.get(a.name);c&&(s&&(c.inUse=!0),e.calls.add(c.node),c.resources===null&&(c.resources=r._findResources(c.node,s)),i.push(...c.resources))}}),[...new Map(i.map(o=>[o.name,o])).values()]}getBindGroups(){const e=[];function s(i,r){i>=e.length&&(e.length=i+1),e[i]===void 0&&(e[i]=[]),r>=e[i].length&&(e[i].length=r+1)}for(const i of this.uniforms){s(i.group,i.binding);const r=e[i.group];r[i.binding]=i}for(const i of this.storage){s(i.group,i.binding);const r=e[i.group];r[i.binding]=i}for(const i of this.textures){s(i.group,i.binding);const r=e[i.group];r[i.binding]=i}for(const i of this.samplers){s(i.group,i.binding);const r=e[i.group];r[i.binding]=i}return e}_getOutputs(e,s=void 0){if(s===void 0&&(s=[]),e instanceof $e)this._getStructOutputs(e,s);else{const i=this._getOutputInfo(e);i!==null&&s.push(i)}return s}_getStructOutputs(e,s){for(const i of e.members)if(i.type instanceof $e)this._getStructOutputs(i.type,s);else{const r=this._getAttribute(i,"location")||this._getAttribute(i,"builtin");if(r!==null){const n=this._getTypeInfo(i.type,i.type.attributes),o=this._parseInt(r.value),a=new Go(i.name,n,r.name,o);s.push(a)}}}_getOutputInfo(e){const s=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(s!==null){const i=this._getTypeInfo(e,e.attributes),r=this._parseInt(s.value);return new Go("",i,s.name,r)}return null}_getInputs(e,s=void 0){s===void 0&&(s=[]);for(const i of e)if(i.type instanceof $e)this._getStructInputs(i.type,s);else{const r=this._getInputInfo(i);r!==null&&s.push(r)}return s}_getStructInputs(e,s){for(const i of e.members)if(i.type instanceof $e)this._getStructInputs(i.type,s);else{const r=this._getInputInfo(i);r!==null&&s.push(r)}}_getInputInfo(e){const s=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(s!==null){const i=this._getAttribute(e,"interpolation"),r=this._getTypeInfo(e.type,e.attributes),n=this._parseInt(s.value),o=new r_(e.name,r,s.name,n);return i!==null&&(o.interpolation=this._parseString(i.value)),o}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const s=parseInt(e);return isNaN(s)?e:s}_getAlias(e){for(const s of this.aliases)if(s.name==e)return s.type;return null}_getAliasInfo(e){return new i_(e.name,this._getTypeInfo(e.type,null))}_getTypeInfo(e,s){if(this._types.has(e))return this._types.get(e);if(e instanceof Ul){const r=e,n=this._getTypeInfo(r.format,r.attributes),o=new ar(r.name,s);return o.format=n,o.count=r.count,this._types.set(e,o),this._updateTypeInfo(o),o}if(e instanceof $e){const r=e,n=new Ss(r.name,s);n.startLine=r.startLine,n.endLine=r.endLine;for(const o of r.members){const a=this._getTypeInfo(o.type,o.attributes);n.members.push(new Jo(o.name,a,o.attributes))}return this._types.set(e,n),this._updateTypeInfo(n),n}if(e instanceof Wt){const r=e,n=r.format instanceof nt,o=r.format?n?this._getTypeInfo(r.format,null):new bt(r.format,null):null,a=new Qo(r.name,o,s,r.access);return this._types.set(e,a),this._updateTypeInfo(a),a}if(e instanceof Bl){const r=e,n=r.format?this._getTypeInfo(r.format,null):null,o=new Qo(r.name,n,s,r.access);return this._types.set(e,o),this._updateTypeInfo(o),o}const i=new bt(e.name,s);return this._types.set(e,i),this._updateTypeInfo(i),i}_updateTypeInfo(e){var s,i;const r=this._getTypeSize(e);if(e.size=(s=r==null?void 0:r.size)!==null&&s!==void 0?s:0,e instanceof ar){const n=this._getTypeSize(e.format);e.stride=(i=n==null?void 0:n.size)!==null&&i!==void 0?i:0,this._updateTypeInfo(e.format)}e instanceof Ss&&this._updateStructInfo(e)}_updateStructInfo(e){var s;let i=0,r=0,n=0,o=0;for(let a=0,c=e.members.length;a<c;++a){const l=e.members[a],h=this._getTypeSize(l);if(!h)continue;(s=this._getAlias(l.type.name))!==null&&s!==void 0||l.type;const u=h.align,f=h.size;i=this._roundUp(u,i+r),r=f,n=i,o=Math.max(o,u),l.offset=i,l.size=f,this._updateTypeInfo(l.type)}e.size=this._roundUp(o,n+r),e.align=o}_getTypeSize(e){var s;if(e==null)return null;const i=this._getAttributeNum(e.attributes,"size",0),r=this._getAttributeNum(e.attributes,"align",0);if(e instanceof Jo&&(e=e.type),e instanceof bt){const n=this._getAlias(e.name);n!==null&&(e=n)}{const n=Re._typeInfo[e.name];if(n!==void 0){const o=e.format==="f16"?2:1;return new vs(Math.max(r,n.align/o),Math.max(i,n.size/o))}}{const n=Re._typeInfo[e.name.substring(0,e.name.length-1)];if(n){const o=e.name[e.name.length-1]==="h"?2:1;return new vs(Math.max(r,n.align/o),Math.max(i,n.size/o))}}if(e instanceof ar){let n=e,o=8,a=8;const c=this._getTypeSize(n.format);c!==null&&(a=c.size,o=c.align);const l=n.count,h=this._getAttributeNum((s=e==null?void 0:e.attributes)!==null&&s!==void 0?s:null,"stride",this._roundUp(o,a));return a=l*h,i&&(a=i),new vs(Math.max(r,o),Math.max(i,a))}if(e instanceof Ss){let n=0,o=0,a=0,c=0,l=0;for(const h of e.members){const u=this._getTypeSize(h.type);u!==null&&(n=Math.max(u.align,n),a=this._roundUp(u.align,a+c),c=u.size,l=a)}return o=this._roundUp(n,l+c),new vs(Math.max(r,n),Math.max(i,o))}return null}_isUniformVar(e){return e instanceof Xe&&e.storage=="uniform"}_isStorageVar(e){return e instanceof Xe&&e.storage=="storage"}_isTextureVar(e){return e instanceof Xe&&e.type!==null&&Re._textureTypes.indexOf(e.type.name)!=-1}_isSamplerVar(e){return e instanceof Xe&&e.type!==null&&Re._samplerTypes.indexOf(e.type.name)!=-1}_getAttribute(e,s){const i=e;if(!i||!i.attributes)return null;const r=i.attributes;for(let n of r)if(n.name==s)return n;return null}_getAttributeNum(e,s,i){if(e===null)return i;for(let r of e)if(r.name==s){let n=r!==null&&r.value!==null?r.value:i;return n instanceof Array&&(n=n[0]),typeof n=="number"?n:typeof n=="string"?parseInt(n):i}return i}_roundUp(e,s){return Math.ceil(s/e)*e}}Re._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}};Re._textureTypes=g.any_texture_type.map(t=>t.name);Re._samplerTypes=g.sampler_type.map(t=>t.name);function l_(t){var n;const e={attributes:[],bindings:[]};let s;try{s=h_(t)}catch(o){return x.error(o.message)(),e}for(const o of s.uniforms){const a=[];for(const c of((n=o.type)==null?void 0:n.members)||[])a.push({name:c.name,type:ea(c.type)});e.bindings.push({type:"uniform",name:o.name,location:o.binding,group:o.group,members:a})}const i=s.entry.vertex[0],r=(i==null?void 0:i.inputs.length)||0;for(let o=0;o<r;o++){const a=i.inputs[o];if(a.locationType==="location"){const c=ea(a.type);e.attributes.push({name:a.name,location:Number(a.location),type:c})}}return e}function ea(t){return t.format?`${t.name}<${t.format.name}>`:t.name}function h_(t){try{return new Re(t)}catch(e){if(e instanceof Error)throw e;let s="WGSL parse error";throw typeof e=="object"&&(e!=null&&e.message)&&(s+=`: ${e.message} `),typeof e=="object"&&(e!=null&&e.token)&&(s+=e.token.line||""),new Error(s,{cause:e})}}const u_={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1};globalThis.mathgl=globalThis.mathgl||{config:{...u_}};const ce=globalThis.mathgl.config;function f_(t,{precision:e=ce.precision}={}){return t=d_(t),`${parseFloat(t.toPrecision(e))}`}function vt(t){return Array.isArray(t)||ArrayBuffer.isView(t)&&!(t instanceof DataView)}function Be(t,e,s){return p_(t,i=>Math.max(e,Math.min(s,i)))}function gi(t,e,s){return vt(t)?t.map((i,r)=>gi(i,e[r],s)):s*e+(1-s)*t}function rs(t,e,s){const i=ce.EPSILON;s&&(ce.EPSILON=s);try{if(t===e)return!0;if(vt(t)&&vt(e)){if(t.length!==e.length)return!1;for(let r=0;r<t.length;++r)if(!rs(t[r],e[r]))return!1;return!0}return t&&t.equals?t.equals(e):e&&e.equals?e.equals(t):typeof t=="number"&&typeof e=="number"?Math.abs(t-e)<=ce.EPSILON*Math.max(1,Math.abs(t),Math.abs(e)):!1}finally{ce.EPSILON=i}}function d_(t){return Math.round(t/ce.EPSILON)*ce.EPSILON}function g_(t){return t.clone?t.clone():new Array(t.length)}function p_(t,e,s){if(vt(t)){const i=t;s=s||g_(i);for(let r=0;r<s.length&&r<i.length;++r){const n=typeof t=="number"?t:t[r];s[r]=e(n,r,s)}return s}return e(t)}class Wl extends Array{clone(){return new this.constructor().copy(this)}fromArray(e,s=0){for(let i=0;i<this.ELEMENTS;++i)this[i]=e[i+s];return this.check()}toArray(e=[],s=0){for(let i=0;i<this.ELEMENTS;++i)e[s+i]=this[i];return e}toObject(e){return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:vt(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(ce)}formatString(e){let s="";for(let i=0;i<this.ELEMENTS;++i)s+=(i>0?", ":"")+f_(this[i],e);return`${e.printTypes?this.constructor.name:""}[${s}]`}equals(e){if(!e||this.length!==e.length)return!1;for(let s=0;s<this.ELEMENTS;++s)if(!rs(this[s],e[s]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let s=0;s<this.ELEMENTS;++s)if(this[s]!==e[s])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,s,i){if(i===void 0)return this.lerp(this,e,s);for(let r=0;r<this.ELEMENTS;++r){const n=e[r],o=typeof s=="number"?s:s[r];this[r]=n+i*(o-n)}return this.check()}min(e){for(let s=0;s<this.ELEMENTS;++s)this[s]=Math.min(e[s],this[s]);return this.check()}max(e){for(let s=0;s<this.ELEMENTS;++s)this[s]=Math.max(e[s],this[s]);return this.check()}clamp(e,s){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e[i]),s[i]);return this.check()}add(...e){for(const s of e)for(let i=0;i<this.ELEMENTS;++i)this[i]+=s[i];return this.check()}subtract(...e){for(const s of e)for(let i=0;i<this.ELEMENTS;++i)this[i]-=s[i];return this.check()}scale(e){if(typeof e=="number")for(let s=0;s<this.ELEMENTS;++s)this[s]*=e;else for(let s=0;s<this.ELEMENTS&&s<e.length;++s)this[s]*=e[s];return this.check()}multiplyByScalar(e){for(let s=0;s<this.ELEMENTS;++s)this[s]*=e;return this.check()}check(){if(ce.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let e=this.length===this.ELEMENTS;for(let s=0;s<this.ELEMENTS;++s)e=e&&Number.isFinite(this[s]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let s=0;s<this.ELEMENTS;++s)this[s]=e;return this.check()}addScalar(e){for(let s=0;s<this.ELEMENTS;++s)this[s]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let s=0;s<this.ELEMENTS;++s)this[s]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,s){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e),s);return this.check()}get elements(){return this}}function __(t,e){if(t.length!==e)return!1;for(let s=0;s<t.length;++s)if(!Number.isFinite(t[s]))return!1;return!0}function oe(t){if(!Number.isFinite(t))throw new Error(`Invalid number ${JSON.stringify(t)}`);return t}function cr(t,e,s=""){if(ce.debug&&!__(t,e))throw new Error(`math.gl: ${s} some fields set to invalid numbers'`);return t}function ta(t,e){if(!t)throw new Error(`math.gl assertion ${e}`)}class m_ extends Wl{get x(){return this[0]}set x(e){this[0]=oe(e)}get y(){return this[1]}set y(e){this[1]=oe(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let s=0;s<this.ELEMENTS;++s)e+=this[s]*this[s];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let s=0;for(let i=0;i<this.ELEMENTS;++i){const r=this[i]-e[i];s+=r*r}return oe(s)}dot(e){let s=0;for(let i=0;i<this.ELEMENTS;++i)s+=this[i]*e[i];return oe(s)}normalize(){const e=this.magnitude();if(e!==0)for(let s=0;s<this.ELEMENTS;++s)this[s]/=e;return this.check()}multiply(...e){for(const s of e)for(let i=0;i<this.ELEMENTS;++i)this[i]*=s[i];return this.check()}divide(...e){for(const s of e)for(let i=0;i<this.ELEMENTS;++i)this[i]/=s[i];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return ta(e>=0&&e<this.ELEMENTS,"index is out of range"),oe(this[e])}setComponent(e,s){return ta(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=s,this.check()}addVectors(e,s){return this.copy(e).add(s)}subVectors(e,s){return this.copy(e).subtract(s)}multiplyVectors(e,s){return this.copy(e).multiply(s)}addScaledVector(e,s){return this.add(new this.constructor(e).multiplyScalar(s))}}const js=1e-6;let Rt=typeof Float32Array<"u"?Float32Array:Array;function y_(){const t=new Rt(2);return Rt!=Float32Array&&(t[0]=0,t[1]=0),t}function sa(t,e,s){return t[0]=e[0]+s[0],t[1]=e[1]+s[1],t}function b_(t,e){return t[0]=-e[0],t[1]=-e[1],t}function Hl(t,e,s,i){const r=e[0],n=e[1];return t[0]=r+i*(s[0]-r),t[1]=n+i*(s[1]-n),t}function T_(t,e,s){const i=e[0],r=e[1];return t[0]=s[0]*i+s[4]*r+s[12],t[1]=s[1]*i+s[5]*r+s[13],t}(function(){const t=y_();return function(e,s,i,r,n,o){let a,c;for(s||(s=2),i||(i=0),r?c=Math.min(r*s+i,e.length):c=e.length,a=i;a<c;a+=s)t[0]=e[a],t[1]=e[a+1],n(t,t,o),e[a]=t[0],e[a+1]=t[1];return e}})();function A_(t,e,s){const i=e[0],r=e[1],n=s[3]*i+s[7]*r||1;return t[0]=(s[0]*i+s[4]*r)/n,t[1]=(s[1]*i+s[5]*r)/n,t}function jl(t,e,s){const i=e[0],r=e[1],n=e[2],o=s[3]*i+s[7]*r+s[11]*n||1;return t[0]=(s[0]*i+s[4]*r+s[8]*n)/o,t[1]=(s[1]*i+s[5]*r+s[9]*n)/o,t[2]=(s[2]*i+s[6]*r+s[10]*n)/o,t}function w_(t,e,s){const i=e[0],r=e[1];return t[0]=s[0]*i+s[2]*r,t[1]=s[1]*i+s[3]*r,t[2]=e[2],t}function S_(){const t=new Rt(3);return Rt!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function E_(t,e,s){return t[0]=e[0]-s[0],t[1]=e[1]-s[1],t[2]=e[2]-s[2],t}function v_(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t}function R_(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function x_(t,e,s){const i=e[0],r=e[1],n=e[2],o=s[0],a=s[1],c=s[2];return t[0]=r*c-n*a,t[1]=n*o-i*c,t[2]=i*a-r*o,t}function $l(t,e,s){const i=e[0],r=e[1],n=e[2];let o=s[3]*i+s[7]*r+s[11]*n+s[15];return o=o||1,t[0]=(s[0]*i+s[4]*r+s[8]*n+s[12])/o,t[1]=(s[1]*i+s[5]*r+s[9]*n+s[13])/o,t[2]=(s[2]*i+s[6]*r+s[10]*n+s[14])/o,t}function P_(t,e,s){const i=e[0],r=e[1],n=e[2];return t[0]=i*s[0]+r*s[3]+n*s[6],t[1]=i*s[1]+r*s[4]+n*s[7],t[2]=i*s[2]+r*s[5]+n*s[8],t}function C_(t,e,s){const i=s[0],r=s[1],n=s[2],o=s[3],a=e[0],c=e[1],l=e[2];let h=r*l-n*c,u=n*a-i*l,f=i*c-r*a,p=r*f-n*u,_=n*h-i*f,m=i*u-r*h;const T=o*2;return h*=T,u*=T,f*=T,p*=2,_*=2,m*=2,t[0]=a+h+p,t[1]=c+u+_,t[2]=l+f+m,t}function I_(t,e,s,i){const r=[],n=[];return r[0]=e[0]-s[0],r[1]=e[1]-s[1],r[2]=e[2]-s[2],n[0]=r[0],n[1]=r[1]*Math.cos(i)-r[2]*Math.sin(i),n[2]=r[1]*Math.sin(i)+r[2]*Math.cos(i),t[0]=n[0]+s[0],t[1]=n[1]+s[1],t[2]=n[2]+s[2],t}function M_(t,e,s,i){const r=[],n=[];return r[0]=e[0]-s[0],r[1]=e[1]-s[1],r[2]=e[2]-s[2],n[0]=r[2]*Math.sin(i)+r[0]*Math.cos(i),n[1]=r[1],n[2]=r[2]*Math.cos(i)-r[0]*Math.sin(i),t[0]=n[0]+s[0],t[1]=n[1]+s[1],t[2]=n[2]+s[2],t}function O_(t,e,s,i){const r=[],n=[];return r[0]=e[0]-s[0],r[1]=e[1]-s[1],r[2]=e[2]-s[2],n[0]=r[0]*Math.cos(i)-r[1]*Math.sin(i),n[1]=r[0]*Math.sin(i)+r[1]*Math.cos(i),n[2]=r[2],t[0]=n[0]+s[0],t[1]=n[1]+s[1],t[2]=n[2]+s[2],t}function N_(t,e){const s=t[0],i=t[1],r=t[2],n=e[0],o=e[1],a=e[2],c=Math.sqrt((s*s+i*i+r*r)*(n*n+o*o+a*a)),l=c&&R_(t,e)/c;return Math.acos(Math.min(Math.max(l,-1),1))}const k_=E_;(function(){const t=S_();return function(e,s,i,r,n,o){let a,c;for(s||(s=3),i||(i=0),r?c=Math.min(r*s+i,e.length):c=e.length,a=i;a<c;a+=s)t[0]=e[a],t[1]=e[a+1],t[2]=e[a+2],n(t,t,o),e[a]=t[0],e[a+1]=t[1],e[a+2]=t[2];return e}})();const lr=[0,0,0];let Rs;class Ee extends m_{static get ZERO(){return Rs||(Rs=new Ee(0,0,0),Object.freeze(Rs)),Rs}constructor(e=0,s=0,i=0){super(-0,-0,-0),arguments.length===1&&vt(e)?this.copy(e):(ce.debug&&(oe(e),oe(s),oe(i)),this[0]=e,this[1]=s,this[2]=i)}set(e,s,i){return this[0]=e,this[1]=s,this[2]=i,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return ce.debug&&(oe(e.x),oe(e.y),oe(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=oe(e)}angle(e){return N_(this,e)}cross(e){return x_(this,this,e),this.check()}rotateX({radians:e,origin:s=lr}){return I_(this,this,s,e),this.check()}rotateY({radians:e,origin:s=lr}){return M_(this,this,s,e),this.check()}rotateZ({radians:e,origin:s=lr}){return O_(this,this,s,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return $l(this,this,e),this.check()}transformAsVector(e){return jl(this,this,e),this.check()}transformByMatrix3(e){return P_(this,this,e),this.check()}transformByMatrix2(e){return w_(this,this,e),this.check()}transformByQuaternion(e){return C_(this,this,e),this.check()}}class F_ extends Wl{toString(){let e="[";if(ce.printRowMajor){e+="row-major:";for(let s=0;s<this.RANK;++s)for(let i=0;i<this.RANK;++i)e+=` ${this[i*this.RANK+s]}`}else{e+="column-major:";for(let s=0;s<this.ELEMENTS;++s)e+=` ${this[s]}`}return e+="]",e}getElementIndex(e,s){return s*this.RANK+e}getElement(e,s){return this[s*this.RANK+e]}setElement(e,s,i){return this[s*this.RANK+e]=oe(i),this}getColumn(e,s=new Array(this.RANK).fill(-0)){const i=e*this.RANK;for(let r=0;r<this.RANK;++r)s[r]=this[i+r];return s}setColumn(e,s){const i=e*this.RANK;for(let r=0;r<this.RANK;++r)this[i+r]=s[r];return this}}function D_(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function B_(t,e){if(t===e){const s=e[1],i=e[2],r=e[3],n=e[6],o=e[7],a=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=s,t[6]=e[9],t[7]=e[13],t[8]=i,t[9]=n,t[11]=e[14],t[12]=r,t[13]=o,t[14]=a}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}function tn(t,e){const s=e[0],i=e[1],r=e[2],n=e[3],o=e[4],a=e[5],c=e[6],l=e[7],h=e[8],u=e[9],f=e[10],p=e[11],_=e[12],m=e[13],T=e[14],S=e[15],v=s*a-i*o,w=s*c-r*o,E=s*l-n*o,R=i*c-r*a,P=i*l-n*a,M=r*l-n*c,C=h*m-u*_,I=h*T-f*_,k=h*S-p*_,O=u*T-f*m,F=u*S-p*m,D=f*S-p*T;let B=v*D-w*F+E*O+R*k-P*I+M*C;return B?(B=1/B,t[0]=(a*D-c*F+l*O)*B,t[1]=(r*F-i*D-n*O)*B,t[2]=(m*M-T*P+S*R)*B,t[3]=(f*P-u*M-p*R)*B,t[4]=(c*k-o*D-l*I)*B,t[5]=(s*D-r*k+n*I)*B,t[6]=(T*E-_*M-S*w)*B,t[7]=(h*M-f*E+p*w)*B,t[8]=(o*F-a*k+l*C)*B,t[9]=(i*k-s*F-n*C)*B,t[10]=(_*P-m*E+S*v)*B,t[11]=(u*E-h*P-p*v)*B,t[12]=(a*I-o*O-c*C)*B,t[13]=(s*O-i*I+r*C)*B,t[14]=(m*w-_*R-T*v)*B,t[15]=(h*R-u*w+f*v)*B,t):null}function U_(t){const e=t[0],s=t[1],i=t[2],r=t[3],n=t[4],o=t[5],a=t[6],c=t[7],l=t[8],h=t[9],u=t[10],f=t[11],p=t[12],_=t[13],m=t[14],T=t[15],S=e*o-s*n,v=e*a-i*n,w=s*a-i*o,E=l*_-h*p,R=l*m-u*p,P=h*m-u*_,M=e*P-s*R+i*E,C=n*P-o*R+a*E,I=l*w-h*v+u*S,k=p*w-_*v+m*S;return c*M-r*C+T*I-f*k}function Je(t,e,s){const i=e[0],r=e[1],n=e[2],o=e[3],a=e[4],c=e[5],l=e[6],h=e[7],u=e[8],f=e[9],p=e[10],_=e[11],m=e[12],T=e[13],S=e[14],v=e[15];let w=s[0],E=s[1],R=s[2],P=s[3];return t[0]=w*i+E*a+R*u+P*m,t[1]=w*r+E*c+R*f+P*T,t[2]=w*n+E*l+R*p+P*S,t[3]=w*o+E*h+R*_+P*v,w=s[4],E=s[5],R=s[6],P=s[7],t[4]=w*i+E*a+R*u+P*m,t[5]=w*r+E*c+R*f+P*T,t[6]=w*n+E*l+R*p+P*S,t[7]=w*o+E*h+R*_+P*v,w=s[8],E=s[9],R=s[10],P=s[11],t[8]=w*i+E*a+R*u+P*m,t[9]=w*r+E*c+R*f+P*T,t[10]=w*n+E*l+R*p+P*S,t[11]=w*o+E*h+R*_+P*v,w=s[12],E=s[13],R=s[14],P=s[15],t[12]=w*i+E*a+R*u+P*m,t[13]=w*r+E*c+R*f+P*T,t[14]=w*n+E*l+R*p+P*S,t[15]=w*o+E*h+R*_+P*v,t}function pi(t,e,s){const i=s[0],r=s[1],n=s[2];let o,a,c,l,h,u,f,p,_,m,T,S;return e===t?(t[12]=e[0]*i+e[4]*r+e[8]*n+e[12],t[13]=e[1]*i+e[5]*r+e[9]*n+e[13],t[14]=e[2]*i+e[6]*r+e[10]*n+e[14],t[15]=e[3]*i+e[7]*r+e[11]*n+e[15]):(o=e[0],a=e[1],c=e[2],l=e[3],h=e[4],u=e[5],f=e[6],p=e[7],_=e[8],m=e[9],T=e[10],S=e[11],t[0]=o,t[1]=a,t[2]=c,t[3]=l,t[4]=h,t[5]=u,t[6]=f,t[7]=p,t[8]=_,t[9]=m,t[10]=T,t[11]=S,t[12]=o*i+h*r+_*n+e[12],t[13]=a*i+u*r+m*n+e[13],t[14]=c*i+f*r+T*n+e[14],t[15]=l*i+p*r+S*n+e[15]),t}function Wn(t,e,s){const i=s[0],r=s[1],n=s[2];return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function L_(t,e,s,i){let r=i[0],n=i[1],o=i[2],a=Math.sqrt(r*r+n*n+o*o),c,l,h,u,f,p,_,m,T,S,v,w,E,R,P,M,C,I,k,O,F,D,B,le;return a<js?null:(a=1/a,r*=a,n*=a,o*=a,l=Math.sin(s),c=Math.cos(s),h=1-c,u=e[0],f=e[1],p=e[2],_=e[3],m=e[4],T=e[5],S=e[6],v=e[7],w=e[8],E=e[9],R=e[10],P=e[11],M=r*r*h+c,C=n*r*h+o*l,I=o*r*h-n*l,k=r*n*h-o*l,O=n*n*h+c,F=o*n*h+r*l,D=r*o*h+n*l,B=n*o*h-r*l,le=o*o*h+c,t[0]=u*M+m*C+w*I,t[1]=f*M+T*C+E*I,t[2]=p*M+S*C+R*I,t[3]=_*M+v*C+P*I,t[4]=u*k+m*O+w*F,t[5]=f*k+T*O+E*F,t[6]=p*k+S*O+R*F,t[7]=_*k+v*O+P*F,t[8]=u*D+m*B+w*le,t[9]=f*D+T*B+E*le,t[10]=p*D+S*B+R*le,t[11]=_*D+v*B+P*le,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)}function Xl(t,e,s){const i=Math.sin(s),r=Math.cos(s),n=e[4],o=e[5],a=e[6],c=e[7],l=e[8],h=e[9],u=e[10],f=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=n*r+l*i,t[5]=o*r+h*i,t[6]=a*r+u*i,t[7]=c*r+f*i,t[8]=l*r-n*i,t[9]=h*r-o*i,t[10]=u*r-a*i,t[11]=f*r-c*i,t}function V_(t,e,s){const i=Math.sin(s),r=Math.cos(s),n=e[0],o=e[1],a=e[2],c=e[3],l=e[8],h=e[9],u=e[10],f=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*r-l*i,t[1]=o*r-h*i,t[2]=a*r-u*i,t[3]=c*r-f*i,t[8]=n*i+l*r,t[9]=o*i+h*r,t[10]=a*i+u*r,t[11]=c*i+f*r,t}function Yl(t,e,s){const i=Math.sin(s),r=Math.cos(s),n=e[0],o=e[1],a=e[2],c=e[3],l=e[4],h=e[5],u=e[6],f=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*r+l*i,t[1]=o*r+h*i,t[2]=a*r+u*i,t[3]=c*r+f*i,t[4]=l*r-n*i,t[5]=h*r-o*i,t[6]=u*r-a*i,t[7]=f*r-c*i,t}function z_(t,e){const s=e[0],i=e[1],r=e[2],n=e[3],o=s+s,a=i+i,c=r+r,l=s*o,h=i*o,u=i*a,f=r*o,p=r*a,_=r*c,m=n*o,T=n*a,S=n*c;return t[0]=1-u-_,t[1]=h+S,t[2]=f-T,t[3]=0,t[4]=h-S,t[5]=1-l-_,t[6]=p+m,t[7]=0,t[8]=f+T,t[9]=p-m,t[10]=1-l-u,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function W_(t,e,s,i,r,n,o){const a=1/(s-e),c=1/(r-i),l=1/(n-o);return t[0]=n*2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n*2*c,t[6]=0,t[7]=0,t[8]=(s+e)*a,t[9]=(r+i)*c,t[10]=(o+n)*l,t[11]=-1,t[12]=0,t[13]=0,t[14]=o*n*2*l,t[15]=0,t}function H_(t,e,s,i,r){const n=1/Math.tan(e/2);if(t[0]=n/s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,r!=null&&r!==1/0){const o=1/(i-r);t[10]=(r+i)*o,t[14]=2*r*i*o}else t[10]=-1,t[14]=-2*i;return t}const j_=H_;function $_(t,e,s,i,r,n,o){const a=1/(e-s),c=1/(i-r),l=1/(n-o);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*c,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*l,t[11]=0,t[12]=(e+s)*a,t[13]=(r+i)*c,t[14]=(o+n)*l,t[15]=1,t}const X_=$_;function Y_(t,e,s,i){let r,n,o,a,c,l,h,u,f,p;const _=e[0],m=e[1],T=e[2],S=i[0],v=i[1],w=i[2],E=s[0],R=s[1],P=s[2];return Math.abs(_-E)<js&&Math.abs(m-R)<js&&Math.abs(T-P)<js?D_(t):(u=_-E,f=m-R,p=T-P,r=1/Math.sqrt(u*u+f*f+p*p),u*=r,f*=r,p*=r,n=v*p-w*f,o=w*u-S*p,a=S*f-v*u,r=Math.sqrt(n*n+o*o+a*a),r?(r=1/r,n*=r,o*=r,a*=r):(n=0,o=0,a=0),c=f*a-p*o,l=p*n-u*a,h=u*o-f*n,r=Math.sqrt(c*c+l*l+h*h),r?(r=1/r,c*=r,l*=r,h*=r):(c=0,l=0,h=0),t[0]=n,t[1]=c,t[2]=u,t[3]=0,t[4]=o,t[5]=l,t[6]=f,t[7]=0,t[8]=a,t[9]=h,t[10]=p,t[11]=0,t[12]=-(n*_+o*m+a*T),t[13]=-(c*_+l*m+h*T),t[14]=-(u*_+f*m+p*T),t[15]=1,t)}function K_(){const t=new Rt(4);return Rt!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function q_(t,e,s){return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t}function ps(t,e,s){const i=e[0],r=e[1],n=e[2],o=e[3];return t[0]=s[0]*i+s[4]*r+s[8]*n+s[12]*o,t[1]=s[1]*i+s[5]*r+s[9]*n+s[13]*o,t[2]=s[2]*i+s[6]*r+s[10]*n+s[14]*o,t[3]=s[3]*i+s[7]*r+s[11]*n+s[15]*o,t}(function(){const t=K_();return function(e,s,i,r,n,o){let a,c;for(s||(s=4),i||(i=0),r?c=Math.min(r*s+i,e.length):c=e.length,a=i;a<c;a+=s)t[0]=e[a],t[1]=e[a+1],t[2]=e[a+2],t[3]=e[a+3],n(t,t,o),e[a]=t[0],e[a+1]=t[1],e[a+2]=t[2],e[a+3]=t[3];return e}})();var sn;(function(t){t[t.COL0ROW0=0]="COL0ROW0",t[t.COL0ROW1=1]="COL0ROW1",t[t.COL0ROW2=2]="COL0ROW2",t[t.COL0ROW3=3]="COL0ROW3",t[t.COL1ROW0=4]="COL1ROW0",t[t.COL1ROW1=5]="COL1ROW1",t[t.COL1ROW2=6]="COL1ROW2",t[t.COL1ROW3=7]="COL1ROW3",t[t.COL2ROW0=8]="COL2ROW0",t[t.COL2ROW1=9]="COL2ROW1",t[t.COL2ROW2=10]="COL2ROW2",t[t.COL2ROW3=11]="COL2ROW3",t[t.COL3ROW0=12]="COL3ROW0",t[t.COL3ROW1=13]="COL3ROW1",t[t.COL3ROW2=14]="COL3ROW2",t[t.COL3ROW3=15]="COL3ROW3"})(sn||(sn={}));const Z_=45*Math.PI/180,J_=1,hr=.1,ur=500,Q_=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class ve extends F_{static get IDENTITY(){return em()}static get ZERO(){return G_()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return sn}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,s,i,r,n,o,a,c,l,h,u,f,p,_,m,T){return this[0]=e,this[1]=s,this[2]=i,this[3]=r,this[4]=n,this[5]=o,this[6]=a,this[7]=c,this[8]=l,this[9]=h,this[10]=u,this[11]=f,this[12]=p,this[13]=_,this[14]=m,this[15]=T,this.check()}setRowMajor(e,s,i,r,n,o,a,c,l,h,u,f,p,_,m,T){return this[0]=e,this[1]=n,this[2]=l,this[3]=p,this[4]=s,this[5]=o,this[6]=h,this[7]=_,this[8]=i,this[9]=a,this[10]=u,this[11]=m,this[12]=r,this[13]=c,this[14]=f,this[15]=T,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(Q_)}fromObject(e){return this.check()}fromQuaternion(e){return z_(this,e),this.check()}frustum(e){const{left:s,right:i,bottom:r,top:n,near:o=hr,far:a=ur}=e;return a===1/0?tm(this,s,i,r,n,o):W_(this,s,i,r,n,o,a),this.check()}lookAt(e){const{eye:s,center:i=[0,0,0],up:r=[0,1,0]}=e;return Y_(this,s,i,r),this.check()}ortho(e){const{left:s,right:i,bottom:r,top:n,near:o=hr,far:a=ur}=e;return X_(this,s,i,r,n,o,a),this.check()}orthographic(e){const{fovy:s=Z_,aspect:i=J_,focalDistance:r=1,near:n=hr,far:o=ur}=e;ia(s);const a=s/2,c=r*Math.tan(a),l=c*i;return this.ortho({left:-l,right:l,bottom:-c,top:c,near:n,far:o})}perspective(e){const{fovy:s=45*Math.PI/180,aspect:i=1,near:r=.1,far:n=500}=e;return ia(s),j_(this,s,i,r,n),this.check()}determinant(){return U_(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,s){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],s=s||[-0,-0,-0];const i=this.getScale(s),r=1/i[0],n=1/i[1],o=1/i[2];return e[0]=this[0]*r,e[1]=this[1]*n,e[2]=this[2]*o,e[3]=0,e[4]=this[4]*r,e[5]=this[5]*n,e[6]=this[6]*o,e[7]=0,e[8]=this[8]*r,e[9]=this[9]*n,e[10]=this[10]*o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,s){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],s=s||[-0,-0,-0];const i=this.getScale(s),r=1/i[0],n=1/i[1],o=1/i[2];return e[0]=this[0]*r,e[1]=this[1]*n,e[2]=this[2]*o,e[3]=this[4]*r,e[4]=this[5]*n,e[5]=this[6]*o,e[6]=this[8]*r,e[7]=this[9]*n,e[8]=this[10]*o,e}transpose(){return B_(this,this),this.check()}invert(){return tn(this,this),this.check()}multiplyLeft(e){return Je(this,e,this),this.check()}multiplyRight(e){return Je(this,this,e),this.check()}rotateX(e){return Xl(this,this,e),this.check()}rotateY(e){return V_(this,this,e),this.check()}rotateZ(e){return Yl(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,s){return L_(this,this,e,s),this.check()}scale(e){return Wn(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return pi(this,this,e),this.check()}transform(e,s){return e.length===4?(s=ps(s||[-0,-0,-0,-0],e,this),cr(s,4),s):this.transformAsPoint(e,s)}transformAsPoint(e,s){const{length:i}=e;let r;switch(i){case 2:r=T_(s||[-0,-0],e,this);break;case 3:r=$l(s||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return cr(r,e.length),r}transformAsVector(e,s){let i;switch(e.length){case 2:i=A_(s||[-0,-0],e,this);break;case 3:i=jl(s||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return cr(i,e.length),i}transformPoint(e,s){return this.transformAsPoint(e,s)}transformVector(e,s){return this.transformAsPoint(e,s)}transformDirection(e,s){return this.transformAsVector(e,s)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,s,i){return this.identity().translate([e,s,i])}}let xs,Ps;function G_(){return xs||(xs=new ve([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(xs)),xs}function em(){return Ps||(Ps=new ve,Object.freeze(Ps)),Ps}function ia(t){if(t>Math.PI*2)throw Error("expected radians")}function tm(t,e,s,i,r,n){const o=2*n/(s-e),a=2*n/(r-i),c=(s+e)/(s-e),l=(r+i)/(r-i),h=-1,u=-1,f=-2*n;return t[0]=o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=c,t[9]=l,t[10]=h,t[11]=u,t[12]=0,t[13]=0,t[14]=f,t[15]=0,t}function Kl(t,e=[],s=0){const i=Math.fround(t),r=t-i;return e[s]=i,e[s+1]=r,e}function sm(t){return t-Math.fround(t)}function im(t){const e=new Float32Array(32);for(let s=0;s<4;++s)for(let i=0;i<4;++i){const r=s*4+i;Kl(t[i*4+s],e,r*2)}return e}const rm=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND

// All these functions are for substituting tan() function from Intel GPU only
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01; // 1/3!
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03; // 1/5!
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04; // 1/7!
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06; // 1/9!

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }

    // 2pi range reduction
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,nm={name:"fp32",vs:rm},om=[0,1,1,1],am=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

out vec4 picking_vRGBcolor_Avalid;

// Normalize unsigned byte color to 0-1 range
vec3 picking_normalizeColor(vec3 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

// Normalize unsigned byte color to 0-1 range
vec4 picking_normalizeColor(vec4 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

bool picking_isColorZero(vec3 color) {
  return dot(color, vec3(1.0)) < 0.00001;
}

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.00001;
}

// Check if this vertex is highlighted 
bool isVertexHighlighted(vec3 vertexColor) {
  vec3 highlightedObjectColor = picking_normalizeColor(picking.highlightedObjectColor);
  return
    bool(picking.isHighlightActive) && picking_isColorZero(abs(vertexColor - highlightedObjectColor));
}

// Set the current picking color
void picking_setPickingColor(vec3 pickingColor) {
  pickingColor = picking_normalizeColor(pickingColor);

  if (bool(picking.isActive)) {
    // Use alpha as the validity flag. If pickingColor is [0, 0, 0] fragment is non-pickable
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!bool(picking.isAttribute)) {
      // Stores the picking color so that the fragment shader can render it during picking
      picking_vRGBcolor_Avalid.rgb = pickingColor;
    }
  } else {
    // Do the comparison with selected item color in vertex shader as it should mean fewer compares
    picking_vRGBcolor_Avalid.a = float(isVertexHighlighted(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.r = value;
  }
}

void picking_setPickingAttribute(vec2 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}

void picking_setPickingAttribute(vec3 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,cm=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

in vec4 picking_vRGBcolor_Avalid;

/*
 * Returns highlight color if this item is selected.
 */
vec4 picking_filterHighlightColor(vec4 color) {
  // If we are still picking, we don't highlight
  if (picking.isActive > 0.5) {
    return color;
  }

  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    // Blend in highlight color based on its alpha value
    float highLightAlpha = picking.highlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking.highlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}

/*
 * Returns picking color if picking enabled else unmodified argument.
 */
vec4 picking_filterPickingColor(vec4 color) {
  if (bool(picking.isActive)) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}

/*
 * Returns picking color if picking is enabled if not
 * highlight color if this item is selected, otherwise unmodified argument.
 */
vec4 picking_filterColor(vec4 color) {
  vec4 highlightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highlightColor);
}
`,ra={props:{},uniforms:{},name:"picking",uniformTypes:{isActive:"f32",isAttribute:"f32",isHighlightActive:"f32",useFloatColors:"f32",highlightedObjectColor:"vec3<f32>",highlightColor:"vec4<f32>"},defaultUniforms:{isActive:!1,isAttribute:!1,isHighlightActive:!1,useFloatColors:!0,highlightedObjectColor:[0,0,0],highlightColor:om},vs:am,fs:cm,getUniforms:lm};function lm(t={},e){const s={};if(t.highlightedObjectColor!==void 0)if(t.highlightedObjectColor===null)s.isHighlightActive=!1;else{s.isHighlightActive=!0;const i=t.highlightedObjectColor.slice(0,3);s.highlightedObjectColor=i}if(t.highlightColor){const i=Array.from(t.highlightColor,r=>r/255);Number.isFinite(i[3])||(i[3]=1),s.highlightColor=i}return t.isActive!==void 0&&(s.isActive=!!t.isActive,s.isAttribute=!!t.isAttribute),t.useFloatColors!==void 0&&(s.useFloatColors=!!t.useFloatColors),s}const na=`precision highp int;

// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  vec3 color;
};

struct PointLight {
  vec3 color;
  vec3 position;
  vec3 attenuation; // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  vec3 color;
  vec3 direction;
};

uniform lightingUniforms {
  int enabled;
  int lightType;

  int directionalLightCount;
  int pointLightCount;

  vec3 ambientColor;

  vec3 lightColor0;
  vec3 lightPosition0;
  vec3 lightDirection0;
  vec3 lightAttenuation0;

  vec3 lightColor1;
  vec3 lightPosition1;
  vec3 lightDirection1;
  vec3 lightAttenuation1;

  vec3 lightColor2;
  vec3 lightPosition2;
  vec3 lightDirection2;
  vec3 lightAttenuation2;
} lighting;

PointLight lighting_getPointLight(int index) {
  switch (index) {
    case 0:
      return PointLight(lighting.lightColor0, lighting.lightPosition0, lighting.lightAttenuation0);
    case 1:
      return PointLight(lighting.lightColor1, lighting.lightPosition1, lighting.lightAttenuation1);
    case 2:
    default:  
      return PointLight(lighting.lightColor2, lighting.lightPosition2, lighting.lightAttenuation2);
  }
}

DirectionalLight lighting_getDirectionalLight(int index) {
  switch (index) {
    case 0:
      return DirectionalLight(lighting.lightColor0, lighting.lightDirection0);
    case 1:
      return DirectionalLight(lighting.lightColor1, lighting.lightDirection1);
    case 2:
    default:   
      return DirectionalLight(lighting.lightColor2, lighting.lightDirection2);
  }
} 

float getPointLightAttenuation(PointLight pointLight, float distance) {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}

// #endif
`,hm=`// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  color: vec3<f32>,
};

struct PointLight {
  color: vec3<f32>,
  position: vec3<f32>,
  attenuation: vec3<f32>, // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  color: vec3<f32>,
  direction: vec3<f32>,
};

struct lightingUniforms {
  enabled: i32,
  poightCount: i32,
  directionalLightCount: i32,

  ambientColor: vec3<f32>,

  // TODO - support multiple lights by uncommenting arrays below
  lightType: i32,
  lightColor: vec3<f32>,
  lightDirection: vec3<f32>,
  lightPosition: vec3<f32>,
  lightAttenuation: vec3<f32>,

  // AmbientLight ambientLight;
  // PointLight pointLight[MAX_LIGHTS];
  // DirectionalLight directionalLight[MAX_LIGHTS];
};

// Binding 0:1 is reserved for lighting (Note: could go into separate bind group as it is stable across draw calls)
@binding(1) @group(0) var<uniform> lighting : lightingUniforms;

fn lighting_getPointLight(index: i32) -> PointLight {
  return PointLight(lighting.lightColor, lighting.lightPosition, lighting.lightAttenuation);
}

fn lighting_getDirectionalLight(index: i32) -> DirectionalLight {
  return DirectionalLight(lighting.lightColor, lighting.lightDirection);
} 

fn getPointLightAttenuation(pointLight: PointLight, distance: f32) -> f32 {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}
`,ql=3,um=255;var ns;(function(t){t[t.POINT=0]="POINT",t[t.DIRECTIONAL=1]="DIRECTIONAL"})(ns||(ns={}));const $s={props:{},uniforms:{},name:"lighting",defines:{MAX_LIGHTS:ql},uniformTypes:{enabled:"i32",lightType:"i32",directionalLightCount:"i32",pointLightCount:"i32",ambientLightColor:"vec3<f32>",lightColor0:"vec3<f32>",lightPosition0:"vec3<f32>",lightDirection0:"vec3<f32>",lightAttenuation0:"vec3<f32>",lightColor1:"vec3<f32>",lightPosition1:"vec3<f32>",lightDirection1:"vec3<f32>",lightAttenuation1:"vec3<f32>",lightColor2:"vec3<f32>",lightPosition2:"vec3<f32>",lightDirection2:"vec3<f32>",lightAttenuation2:"vec3<f32>"},defaultUniforms:{enabled:1,lightType:ns.POINT,directionalLightCount:0,pointLightCount:0,ambientLightColor:[.1,.1,.1],lightColor0:[1,1,1],lightPosition0:[1,1,2],lightDirection0:[1,1,1],lightAttenuation0:[1,0,0],lightColor1:[1,1,1],lightPosition1:[1,1,2],lightDirection1:[1,1,1],lightAttenuation1:[1,0,0],lightColor2:[1,1,1],lightPosition2:[1,1,2],lightDirection2:[1,1,1],lightAttenuation2:[1,0,0]},source:hm,vs:na,fs:na,getUniforms:fm};function fm(t,e={}){if(t=t&&{...t},!t)return{...$s.defaultUniforms};t.lights&&(t={...t,...gm(t.lights),lights:void 0});const{ambientLight:s,pointLights:i,directionalLights:r}=t||{};if(!(s||i&&i.length>0||r&&r.length>0))return{...$s.defaultUniforms,enabled:0};const o={...$s.defaultUniforms,...e,...dm({ambientLight:s,pointLights:i,directionalLights:r})};return t.enabled!==void 0&&(o.enabled=t.enabled?1:0),o}function dm({ambientLight:t,pointLights:e=[],directionalLights:s=[]}){const i={};i.ambientLightColor=fr(t);let r=0;for(const n of e){i.lightType=ns.POINT;const o=r;i[`lightColor${o}`]=fr(n),i[`lightPosition${o}`]=n.position,i[`lightAttenuation${o}`]=n.attenuation||[1,0,0],r++}for(const n of s){i.lightType=ns.DIRECTIONAL;const o=r;i[`lightColor${o}`]=fr(n),i[`lightDirection${o}`]=n.direction,r++}return r>ql&&x.warn("MAX_LIGHTS exceeded")(),i.directionalLightCount=s.length,i.pointLightCount=e.length,i}function gm(t){var s,i;const e={pointLights:[],directionalLights:[]};for(const r of t||[])switch(r.type){case"ambient":e.ambientLight=r;break;case"directional":(s=e.directionalLights)==null||s.push(r);break;case"point":(i=e.pointLights)==null||i.push(r);break}return e}function fr(t={}){const{color:e=[0,0,0],intensity:s=1}=t;return e.map(i=>i*s/um)}const pm=`uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;
`,_m=`uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {
  vec3 halfway_direction = normalize(light_direction + view_direction);
  float lambertian = dot(light_direction, normal_worldspace);
  float specular = 0.0;
  if (lambertian > 0.0) {
    float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
    specular = pow(specular_angle, material.shininess);
  }
  lambertian = max(lambertian, 0.0);
  return (lambertian * material.diffuse * surfaceColor + specular * material.specularColor) * color;
}

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = surfaceColor;

  if (lighting.enabled == 0) {
    return lightColor;
  }

  vec3 view_direction = normalize(cameraPosition - position_worldspace);
  lightColor = material.ambient * surfaceColor * lighting.ambientColor;

  for (int i = 0; i < lighting.pointLightCount; i++) {
    PointLight pointLight = lighting_getPointLight(i);
    vec3 light_position_worldspace = pointLight.position;
    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
    float light_attenuation = getPointLightAttenuation(pointLight, distance(light_position_worldspace, position_worldspace));
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color / light_attenuation);
  }

  int totalLights = min(MAX_LIGHTS, lighting.pointLightCount + lighting.directionalLightCount);
  for (int i = lighting.pointLightCount; i < totalLights; i++) {
    DirectionalLight directionalLight = lighting_getDirectionalLight(i);
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  
  return lightColor;
}
`,Zl={props:{},name:"gouraudMaterial",vs:_m.replace("phongMaterial","gouraudMaterial"),fs:pm.replace("phongMaterial","gouraudMaterial"),defines:{LIGHTING_VERTEX:1},dependencies:[$s],uniformTypes:{ambient:"f32",diffuse:"f32",shininess:"f32",specularColor:"vec3<f32>"},defaultUniforms:{ambient:.35,diffuse:.6,shininess:32,specularColor:[.15,.15,.15]},getUniforms(t){const e={...t};return e.specularColor&&(e.specularColor=e.specularColor.map(s=>s/255)),{...Zl.defaultUniforms,...e}}},mm=`uniform float ONE;

/*
About LUMA_FP64_CODE_ELIMINATION_WORKAROUND

The purpose of this workaround is to prevent shader compilers from
optimizing away necessary arithmetic operations by swapping their sequences
or transform the equation to some 'equivalent' form.

The method is to multiply an artifical variable, ONE, which will be known to
the compiler to be 1 only at runtime. The whole expression is then represented
as a polynomial with respective to ONE. In the coefficients of all terms, only one a
and one b should appear

err = (a + b) * ONE^6 - a * ONE^5 - (a + b) * ONE^4 + a * ONE^3 - b - (a + b) * ONE^2 + a * ONE
*/

// Divide float number to high and low floats to extend fraction bits
vec2 split(float a) {
  const float SPLIT = 4097.0;
  float t = a * SPLIT;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float a_hi = t * ONE - (t - a);
  float a_lo = a * ONE - a_hi;
#else
  float a_hi = t - (t - a);
  float a_lo = a - a_hi;
#endif
  return vec2(a_hi, a_lo);
}

// Divide float number again when high float uses too many fraction bits
vec2 split2(vec2 a) {
  vec2 b = split(a.x);
  b.y += a.y;
  return b;
}

// Special sum operation when a > b
vec2 quickTwoSum(float a, float b) {
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float sum = (a + b) * ONE;
  float err = b - (sum - a) * ONE;
#else
  float sum = a + b;
  float err = b - (sum - a);
#endif
  return vec2(sum, err);
}

// General sum operation
vec2 twoSum(float a, float b) {
  float s = (a + b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * ONE - a) * ONE;
  float err = (a - (s - v) * ONE) * ONE * ONE * ONE + (b - v);
#else
  float v = s - a;
  float err = (a - (s - v)) + (b - v);
#endif
  return vec2(s, err);
}

vec2 twoSub(float a, float b) {
  float s = (a - b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * ONE - a) * ONE;
  float err = (a - (s - v) * ONE) * ONE * ONE * ONE - (b + v);
#else
  float v = s - a;
  float err = (a - (s - v)) - (b + v);
#endif
  return vec2(s, err);
}

vec2 twoSqr(float a) {
  float prod = a * a;
  vec2 a_fp64 = split(a);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float err = ((a_fp64.x * a_fp64.x - prod) * ONE + 2.0 * a_fp64.x *
    a_fp64.y * ONE * ONE) + a_fp64.y * a_fp64.y * ONE * ONE * ONE;
#else
  float err = ((a_fp64.x * a_fp64.x - prod) + 2.0 * a_fp64.x * a_fp64.y) + a_fp64.y * a_fp64.y;
#endif
  return vec2(prod, err);
}

vec2 twoProd(float a, float b) {
  float prod = a * b;
  vec2 a_fp64 = split(a);
  vec2 b_fp64 = split(b);
  float err = ((a_fp64.x * b_fp64.x - prod) + a_fp64.x * b_fp64.y +
    a_fp64.y * b_fp64.x) + a_fp64.y * b_fp64.y;
  return vec2(prod, err);
}

vec2 sum_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSum(a.x, b.x);
  t = twoSum(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 sub_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSub(a.x, b.x);
  t = twoSub(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 mul_fp64(vec2 a, vec2 b) {
  vec2 prod = twoProd(a.x, b.x);
  // y component is for the error
  prod.y += a.x * b.y;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  prod.y += a.y * b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  return prod;
}

vec2 div_fp64(vec2 a, vec2 b) {
  float xn = 1.0 / b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  vec2 yn = mul_fp64(a, vec2(xn, 0));
#else
  vec2 yn = a * xn;
#endif
  float diff = (sub_fp64(a, mul_fp64(b, yn))).x;
  vec2 prod = twoProd(xn, diff);
  return sum_fp64(yn, prod);
}

vec2 sqrt_fp64(vec2 a) {
  if (a.x == 0.0 && a.y == 0.0) return vec2(0.0, 0.0);
  if (a.x < 0.0) return vec2(0.0 / 0.0, 0.0 / 0.0);

  float x = 1.0 / sqrt(a.x);
  float yn = a.x * x;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  vec2 yn_sqr = twoSqr(yn) * ONE;
#else
  vec2 yn_sqr = twoSqr(yn);
#endif
  float diff = sub_fp64(a, yn_sqr).x;
  vec2 prod = twoProd(x * 0.5, diff);
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  return sum_fp64(split(yn), prod);
#else
  return sum_fp64(vec2(yn, 0.0), prod);
#endif
}
`,ym={ONE:1};function bm(){return ym}const Tm={name:"fp64-arithmetic",vs:mm,getUniforms:bm,fp64ify:Kl,fp64LowPart:sm,fp64ifyMatrix4:im},oa=`uniform layerUniforms {
  uniform float opacity;
} layer;
`,Am={name:"layer",vs:oa,fs:oa,uniformTypes:{opacity:"f32"}},Jl="#define SMOOTH_EDGE_RADIUS 0.5",wm=`
${Jl}

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`,Sm=`
${Jl}

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,Ql={name:"geometry",vs:wm,fs:Sm},Em=25;var Z;(function(t){t[t.Start=1]="Start",t[t.Move=2]="Move",t[t.End=4]="End",t[t.Cancel=8]="Cancel"})(Z||(Z={}));var J;(function(t){t[t.None=0]="None",t[t.Left=1]="Left",t[t.Right=2]="Right",t[t.Up=4]="Up",t[t.Down=8]="Down",t[t.Horizontal=3]="Horizontal",t[t.Vertical=12]="Vertical",t[t.All=15]="All"})(J||(J={}));var N;(function(t){t[t.Possible=1]="Possible",t[t.Began=2]="Began",t[t.Changed=4]="Changed",t[t.Ended=8]="Ended",t[t.Recognized=8]="Recognized",t[t.Cancelled=16]="Cancelled",t[t.Failed=32]="Failed"})(N||(N={}));const vm="compute",Rm="auto",rn="manipulation",Xs="none",nn="pan-x",on="pan-y";function xm(t){if(t.includes(Xs))return Xs;const e=t.includes(nn),s=t.includes(on);return e&&s?Xs:e||s?e?nn:on:t.includes(rn)?rn:Rm}class Pm{constructor(e,s){this.actions="",this.manager=e,this.set(s)}set(e){e===vm&&(e=this.compute()),this.manager.element&&(this.manager.element.style.touchAction=e,this.actions=e)}update(){this.set(this.manager.options.touchAction)}compute(){let e=[];for(const s of this.manager.recognizers)s.options.enable&&(e=e.concat(s.getTouchAction()));return xm(e.join(" "))}}function _i(t){return t.trim().split(/\s+/g)}function dr(t,e,s){if(t)for(const i of _i(e))t.addEventListener(i,s,!1)}function gr(t,e,s){if(t)for(const i of _i(e))t.removeEventListener(i,s,!1)}function aa(t){return(t.ownerDocument||t).defaultView}function Cm(t,e){let s=t;for(;s;){if(s===e)return!0;s=t.parentNode}return!1}function Gl(t){const e=t.length;if(e===1)return{x:Math.round(t[0].clientX),y:Math.round(t[0].clientY)};let s=0,i=0,r=0;for(;r<e;)s+=t[r].clientX,i+=t[r].clientY,r++;return{x:Math.round(s/e),y:Math.round(i/e)}}function ca(t){const e=[];let s=0;for(;s<t.pointers.length;)e[s]={clientX:Math.round(t.pointers[s].clientX),clientY:Math.round(t.pointers[s].clientY)},s++;return{timeStamp:Date.now(),pointers:e,center:Gl(e),deltaX:t.deltaX,deltaY:t.deltaY}}function eh(t,e){const s=e.x-t.x,i=e.y-t.y;return Math.sqrt(s*s+i*i)}function la(t,e){const s=e.clientX-t.clientX,i=e.clientY-t.clientY;return Math.sqrt(s*s+i*i)}function Im(t,e){const s=e.x-t.x,i=e.y-t.y;return Math.atan2(i,s)*180/Math.PI}function ha(t,e){const s=e.clientX-t.clientX,i=e.clientY-t.clientY;return Math.atan2(i,s)*180/Math.PI}function th(t,e){return t===e?J.None:Math.abs(t)>=Math.abs(e)?t<0?J.Left:J.Right:e<0?J.Up:J.Down}function Mm(t,e){const s=e.center;let i=t.offsetDelta,r=t.prevDelta;const n=t.prevInput;return(e.eventType===Z.Start||(n==null?void 0:n.eventType)===Z.End)&&(r=t.prevDelta={x:(n==null?void 0:n.deltaX)||0,y:(n==null?void 0:n.deltaY)||0},i=t.offsetDelta={x:s.x,y:s.y}),{deltaX:r.x+(s.x-i.x),deltaY:r.y+(s.y-i.y)}}function sh(t,e,s){return{x:e/t||0,y:s/t||0}}function Om(t,e){return la(e[0],e[1])/la(t[0],t[1])}function Nm(t,e){return ha(e[1],e[0])-ha(t[1],t[0])}function km(t,e){const s=t.lastInterval||e,i=e.timeStamp-s.timeStamp;let r,n,o,a;if(e.eventType!==Z.Cancel&&(i>Em||s.velocity===void 0)){const c=e.deltaX-s.deltaX,l=e.deltaY-s.deltaY,h=sh(i,c,l);n=h.x,o=h.y,r=Math.abs(h.x)>Math.abs(h.y)?h.x:h.y,a=th(c,l),t.lastInterval=e}else r=s.velocity,n=s.velocityX,o=s.velocityY,a=s.direction;e.velocity=r,e.velocityX=n,e.velocityY=o,e.direction=a}function Fm(t,e){const{session:s}=t,{pointers:i}=e,{length:r}=i;s.firstInput||(s.firstInput=ca(e)),r>1&&!s.firstMultiple?s.firstMultiple=ca(e):r===1&&(s.firstMultiple=!1);const{firstInput:n,firstMultiple:o}=s,a=o?o.center:n.center,c=e.center=Gl(i);e.timeStamp=Date.now(),e.deltaTime=e.timeStamp-n.timeStamp,e.angle=Im(a,c),e.distance=eh(a,c);const{deltaX:l,deltaY:h}=Mm(s,e);e.deltaX=l,e.deltaY=h,e.offsetDirection=th(e.deltaX,e.deltaY);const u=sh(e.deltaTime,e.deltaX,e.deltaY);e.overallVelocityX=u.x,e.overallVelocityY=u.y,e.overallVelocity=Math.abs(u.x)>Math.abs(u.y)?u.x:u.y,e.scale=o?Om(o.pointers,i):1,e.rotation=o?Nm(o.pointers,i):0,e.maxPointers=s.prevInput?e.pointers.length>s.prevInput.maxPointers?e.pointers.length:s.prevInput.maxPointers:e.pointers.length;let f=t.element;return Cm(e.srcEvent.target,f)&&(f=e.srcEvent.target),e.target=f,km(s,e),e}function Dm(t,e,s){const i=s.pointers.length,r=s.changedPointers.length,n=e&Z.Start&&i-r===0,o=e&(Z.End|Z.Cancel)&&i-r===0;s.isFirst=!!n,s.isFinal=!!o,n&&(t.session={}),s.eventType=e;const a=Fm(t,s);t.emit("hammer.input",a),t.recognize(a),t.session.prevInput=a}let Bm=class{constructor(e){this.evEl="",this.evWin="",this.evTarget="",this.domHandler=s=>{this.manager.options.enable&&this.handler(s)},this.manager=e,this.element=e.element,this.target=e.options.inputTarget||e.element}callback(e,s){Dm(this.manager,e,s)}init(){dr(this.element,this.evEl,this.domHandler),dr(this.target,this.evTarget,this.domHandler),dr(aa(this.element),this.evWin,this.domHandler)}destroy(){gr(this.element,this.evEl,this.domHandler),gr(this.target,this.evTarget,this.domHandler),gr(aa(this.element),this.evWin,this.domHandler)}};const Um={pointerdown:Z.Start,pointermove:Z.Move,pointerup:Z.End,pointercancel:Z.Cancel,pointerout:Z.Cancel},Lm="pointerdown",Vm="pointermove pointerup pointercancel";class zm extends Bm{constructor(e){super(e),this.evEl=Lm,this.evWin=Vm,this.store=this.manager.session.pointerEvents=[],this.init()}handler(e){const{store:s}=this;let i=!1;const r=Um[e.type],n=e.pointerType,o=n==="touch";let a=s.findIndex(c=>c.pointerId===e.pointerId);r&Z.Start&&(e.buttons||o)?a<0&&(s.push(e),a=s.length-1):r&(Z.End|Z.Cancel)&&(i=!0),!(a<0)&&(s[a]=e,this.callback(r,{pointers:s,changedPointers:[e],eventType:r,pointerType:n,srcEvent:e}),i&&s.splice(a,1))}}const Wm=["","webkit","Moz","MS","ms","o"];function Hm(t,e){const s=e[0].toUpperCase()+e.slice(1);for(const i of Wm){const r=i?i+s:e;if(r in t)return r}}const jm=1,ua=2,fa={touchAction:"compute",enable:!0,inputTarget:null,cssProps:{userSelect:"none",userDrag:"none",touchCallout:"none",tapHighlightColor:"rgba(0,0,0,0)"}};class $m{constructor(e,s){this.options={...fa,...s,cssProps:{...fa.cssProps,...s.cssProps},inputTarget:s.inputTarget||e},this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=e,this.input=new zm(this),this.touchAction=new Pm(this,this.options.touchAction),this.toggleCssProps(!0)}set(e){return Object.assign(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this}stop(e){this.session.stopped=e?ua:jm}recognize(e){const{session:s}=this;if(s.stopped)return;this.session.prevented&&e.srcEvent.preventDefault();let i;const{recognizers:r}=this;let{curRecognizer:n}=s;(!n||n&&n.state&N.Recognized)&&(n=s.curRecognizer=null);let o=0;for(;o<r.length;)i=r[o],s.stopped!==ua&&(!n||i===n||i.canRecognizeWith(n))?i.recognize(e):i.reset(),!n&&i.state&(N.Began|N.Changed|N.Ended)&&(n=s.curRecognizer=i),o++}get(e){const{recognizers:s}=this;for(let i=0;i<s.length;i++)if(s[i].options.event===e)return s[i];return null}add(e){if(Array.isArray(e)){for(const i of e)this.add(i);return this}const s=this.get(e.options.event);return s&&this.remove(s),this.recognizers.push(e),e.manager=this,this.touchAction.update(),e}remove(e){if(Array.isArray(e)){for(const i of e)this.remove(i);return this}const s=typeof e=="string"?this.get(e):e;if(s){const{recognizers:i}=this,r=i.indexOf(s);r!==-1&&(i.splice(r,1),this.touchAction.update())}return this}on(e,s){if(!e||!s)return;const{handlers:i}=this;for(const r of _i(e))i[r]=i[r]||[],i[r].push(s)}off(e,s){if(!e)return;const{handlers:i}=this;for(const r of _i(e))s?i[r]&&i[r].splice(i[r].indexOf(s),1):delete i[r]}emit(e,s){const i=this.handlers[e]&&this.handlers[e].slice();if(!i||!i.length)return;const r=s;r.type=e,r.preventDefault=function(){s.srcEvent.preventDefault()};let n=0;for(;n<i.length;)i[n](r),n++}destroy(){this.toggleCssProps(!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}toggleCssProps(e){const{element:s}=this;if(s){for(const[i,r]of Object.entries(this.options.cssProps)){const n=Hm(s.style,i);e?(this.oldCssProps[n]=s.style[n],s.style[n]=r):s.style[n]=this.oldCssProps[n]||""}e||(this.oldCssProps={})}}}let Xm=1;function Ym(){return Xm++}function da(t){return t&N.Cancelled?"cancel":t&N.Ended?"end":t&N.Changed?"move":t&N.Began?"start":""}class ih{constructor(e){this.options=e,this.id=Ym(),this.state=N.Possible,this.simultaneous={},this.requireFail=[]}set(e){return Object.assign(this.options,e),this.manager.touchAction.update(),this}recognizeWith(e){if(Array.isArray(e)){for(const r of e)this.recognizeWith(r);return this}let s;if(typeof e=="string"){if(s=this.manager.get(e),!s)throw new Error(`Cannot find recognizer ${e}`)}else s=e;const{simultaneous:i}=this;return i[s.id]||(i[s.id]=s,s.recognizeWith(this)),this}dropRecognizeWith(e){if(Array.isArray(e)){for(const i of e)this.dropRecognizeWith(i);return this}let s;return typeof e=="string"?s=this.manager.get(e):s=e,s&&delete this.simultaneous[s.id],this}requireFailure(e){if(Array.isArray(e)){for(const r of e)this.requireFailure(r);return this}let s;if(typeof e=="string"){if(s=this.manager.get(e),!s)throw new Error(`Cannot find recognizer ${e}`)}else s=e;const{requireFail:i}=this;return i.indexOf(s)===-1&&(i.push(s),s.requireFailure(this)),this}dropRequireFailure(e){if(Array.isArray(e)){for(const i of e)this.dropRequireFailure(i);return this}let s;if(typeof e=="string"?s=this.manager.get(e):s=e,s){const i=this.requireFail.indexOf(s);i>-1&&this.requireFail.splice(i,1)}return this}hasRequireFailures(){return!!this.requireFail.find(e=>e.options.enable)}canRecognizeWith(e){return!!this.simultaneous[e.id]}emit(e){if(!e)return;const{state:s}=this;s<N.Ended&&this.manager.emit(this.options.event+da(s),e),this.manager.emit(this.options.event,e),e.additionalEvent&&this.manager.emit(e.additionalEvent,e),s>=N.Ended&&this.manager.emit(this.options.event+da(s),e)}tryEmit(e){this.canEmit()?this.emit(e):this.state=N.Failed}canEmit(){let e=0;for(;e<this.requireFail.length;){if(!(this.requireFail[e].state&(N.Failed|N.Possible)))return!1;e++}return!0}recognize(e){const s={...e};if(!this.options.enable){this.reset(),this.state=N.Failed;return}this.state&(N.Recognized|N.Cancelled|N.Failed)&&(this.state=N.Possible),this.state=this.process(s),this.state&(N.Began|N.Changed|N.Ended|N.Cancelled)&&this.tryEmit(s)}getEventNames(){return[this.options.event]}reset(){}}class rh extends ih{attrTest(e){const s=this.options.pointers;return s===0||e.pointers.length===s}process(e){const{state:s}=this,{eventType:i}=e,r=s&(N.Began|N.Changed),n=this.attrTest(e);return r&&(i&Z.Cancel||!n)?s|N.Cancelled:r||n?i&Z.End?s|N.Ended:s&N.Began?s|N.Changed:N.Began:N.Failed}}class ga extends ih{constructor(e={}){super({enable:!0,event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10,...e}),this.pTime=null,this.pCenter=null,this._timer=null,this._input=null,this.count=0}getTouchAction(){return[rn]}process(e){const{options:s}=this,i=e.pointers.length===s.pointers,r=e.distance<s.threshold,n=e.deltaTime<s.time;if(this.reset(),e.eventType&Z.Start&&this.count===0)return this.failTimeout();if(r&&n&&i){if(e.eventType!==Z.End)return this.failTimeout();const o=this.pTime?e.timeStamp-this.pTime<s.interval:!0,a=!this.pCenter||eh(this.pCenter,e.center)<s.posThreshold;if(this.pTime=e.timeStamp,this.pCenter=e.center,!a||!o?this.count=1:this.count+=1,this._input=e,this.count%s.taps===0)return this.hasRequireFailures()?(this._timer=setTimeout(()=>{this.state=N.Recognized,this.tryEmit(this._input)},s.interval),N.Began):N.Recognized}return N.Failed}failTimeout(){return this._timer=setTimeout(()=>{this.state=N.Failed},this.options.interval),N.Failed}reset(){clearTimeout(this._timer)}emit(e){this.state===N.Recognized&&(e.tapCount=this.count,this.manager.emit(this.options.event,e))}}const Km=["","start","move","end","cancel","up","down","left","right"];class pa extends rh{constructor(e={}){super({enable:!0,pointers:1,event:"pan",threshold:10,direction:J.All,...e}),this.pX=null,this.pY=null}getTouchAction(){const{options:{direction:e}}=this,s=[];return e&J.Horizontal&&s.push(on),e&J.Vertical&&s.push(nn),s}getEventNames(){return Km.map(e=>this.options.event+e)}directionTest(e){const{options:s}=this;let i=!0,{distance:r}=e,{direction:n}=e;const o=e.deltaX,a=e.deltaY;return n&s.direction||(s.direction&J.Horizontal?(n=o===0?J.None:o<0?J.Left:J.Right,i=o!==this.pX,r=Math.abs(e.deltaX)):(n=a===0?J.None:a<0?J.Up:J.Down,i=a!==this.pY,r=Math.abs(e.deltaY))),e.direction=n,i&&r>s.threshold&&!!(n&s.direction)}attrTest(e){return super.attrTest(e)&&(!!(this.state&N.Began)||!(this.state&N.Began)&&this.directionTest(e))}emit(e){this.pX=e.deltaX,this.pY=e.deltaY;const s=J[e.direction].toLowerCase();s&&(e.additionalEvent=this.options.event+s),super.emit(e)}}const qm=["","start","move","end","cancel","in","out"];class Zm extends rh{constructor(e={}){super({enable:!0,event:"pinch",threshold:0,pointers:2,...e})}getTouchAction(){return[Xs]}getEventNames(){return qm.map(e=>this.options.event+e)}attrTest(e){return super.attrTest(e)&&(Math.abs(e.scale-1)>this.options.threshold||!!(this.state&N.Began))}emit(e){if(e.scale!==1){const s=e.scale<1?"in":"out";e.additionalEvent=this.options.event+s}super.emit(e)}}class Hi{constructor(e,s,i){this.element=e,this.callback=s,this.options=i}}const Jm=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",Qm=Jm.indexOf("firefox")!==-1,_a=4.000244140625,Gm=40,ey=.25;class ty extends Hi{constructor(e,s,i){super(e,s,{enable:!0,...i}),this.handleEvent=r=>{if(!this.options.enable)return;let n=r.deltaY;globalThis.WheelEvent&&(Qm&&r.deltaMode===globalThis.WheelEvent.DOM_DELTA_PIXEL&&(n/=globalThis.devicePixelRatio),r.deltaMode===globalThis.WheelEvent.DOM_DELTA_LINE&&(n*=Gm)),n!==0&&n%_a===0&&(n=Math.floor(n/_a)),r.shiftKey&&n&&(n=n*ey),this.callback({type:"wheel",center:{x:r.clientX,y:r.clientY},delta:-n,srcEvent:r,pointerType:"mouse",target:r.target})},e.addEventListener("wheel",this.handleEvent,{passive:!1})}destroy(){this.element.removeEventListener("wheel",this.handleEvent)}enableEventType(e,s){e==="wheel"&&(this.options.enable=s)}}const ma=["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"];class sy extends Hi{constructor(e,s,i){super(e,s,{enable:!0,...i}),this.handleEvent=n=>{this.handleOverEvent(n),this.handleOutEvent(n),this.handleEnterEvent(n),this.handleLeaveEvent(n),this.handleMoveEvent(n)},this.pressed=!1;const{enable:r}=this.options;this.enableMoveEvent=r,this.enableLeaveEvent=r,this.enableEnterEvent=r,this.enableOutEvent=r,this.enableOverEvent=r,ma.forEach(n=>e.addEventListener(n,this.handleEvent))}destroy(){ma.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,s){switch(e){case"pointermove":this.enableMoveEvent=s;break;case"pointerover":this.enableOverEvent=s;break;case"pointerout":this.enableOutEvent=s;break;case"pointerenter":this.enableEnterEvent=s;break;case"pointerleave":this.enableLeaveEvent=s;break}}handleOverEvent(e){this.enableOverEvent&&e.type==="mouseover"&&this._emit("pointerover",e)}handleOutEvent(e){this.enableOutEvent&&e.type==="mouseout"&&this._emit("pointerout",e)}handleEnterEvent(e){this.enableEnterEvent&&e.type==="mouseenter"&&this._emit("pointerenter",e)}handleLeaveEvent(e){this.enableLeaveEvent&&e.type==="mouseleave"&&this._emit("pointerleave",e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":e.buttons===0&&(this.pressed=!1),this.pressed||this._emit("pointermove",e);break;case"mouseup":this.pressed=!1;break}}_emit(e,s){this.callback({type:e,center:{x:s.clientX,y:s.clientY},srcEvent:s,pointerType:"mouse",target:s.target})}}const ya=["keydown","keyup"];class iy extends Hi{constructor(e,s,i){super(e,s,{enable:!0,tabIndex:0,...i}),this.handleEvent=r=>{const n=r.target||r.srcElement;n.tagName==="INPUT"&&n.type==="text"||n.tagName==="TEXTAREA"||(this.enableDownEvent&&r.type==="keydown"&&this.callback({type:"keydown",srcEvent:r,key:r.key,target:r.target}),this.enableUpEvent&&r.type==="keyup"&&this.callback({type:"keyup",srcEvent:r,key:r.key,target:r.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,e.tabIndex=this.options.tabIndex,e.style.outline="none",ya.forEach(r=>e.addEventListener(r,this.handleEvent))}destroy(){ya.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,s){e==="keydown"&&(this.enableDownEvent=s),e==="keyup"&&(this.enableUpEvent=s)}}class ry extends Hi{constructor(e,s,i){super(e,s,i),this.handleEvent=r=>{this.options.enable&&this.callback({type:"contextmenu",center:{x:r.clientX,y:r.clientY},srcEvent:r,pointerType:"mouse",target:r.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,s){e==="contextmenu"&&(this.options.enable=s)}}const ba=1,an=2,Ta=4,ny={pointerdown:ba,pointermove:an,pointerup:Ta,mousedown:ba,mousemove:an,mouseup:Ta},oy=0,ay=1,cy=2,ly=1,hy=2,uy=4;function fy(t){const e=ny[t.srcEvent.type];if(!e)return null;const{buttons:s,button:i}=t.srcEvent;let r=!1,n=!1,o=!1;return e===an?(r=!!(s&ly),n=!!(s&uy),o=!!(s&hy)):(r=i===oy,n=i===ay,o=i===cy),{leftButton:r,middleButton:n,rightButton:o}}function dy(t,e){const s=t.center;if(!s)return null;const i=e.getBoundingClientRect(),r=i.width/e.offsetWidth||1,n=i.height/e.offsetHeight||1,o={x:(s.x-i.left-e.clientLeft)/r,y:(s.y-i.top-e.clientTop)/n};return{center:s,offsetCenter:o}}const gy={srcElement:"root",priority:0};class py{constructor(e,s){this.handleEvent=i=>{if(this.isEmpty())return;const r=this._normalizeEvent(i);let n=i.srcEvent.target;for(;n&&n!==r.rootElement;){if(this._emit(r,n),r.handled)return;n=n.parentNode}this._emit(r,"root")},this.eventManager=e,this.recognizerName=s,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,s,i,r=!1,n=!1){const{handlers:o,handlersByElement:a}=this,c={...gy,...i};let l=a.get(c.srcElement);l||(l=[],a.set(c.srcElement,l));const h={type:e,handler:s,srcElement:c.srcElement,priority:c.priority};r&&(h.once=!0),n&&(h.passive=!0),o.push(h),this._active=this._active||!h.passive;let u=l.length-1;for(;u>=0&&!(l[u].priority>=h.priority);)u--;l.splice(u+1,0,h)}remove(e,s){const{handlers:i,handlersByElement:r}=this;for(let n=i.length-1;n>=0;n--){const o=i[n];if(o.type===e&&o.handler===s){i.splice(n,1);const a=r.get(o.srcElement);a.splice(a.indexOf(o),1),a.length===0&&r.delete(o.srcElement)}}this._active=i.some(n=>!n.passive)}_emit(e,s){const i=this.handlersByElement.get(s);if(i){let r=!1;const n=()=>{e.handled=!0},o=()=>{e.handled=!0,r=!0},a=[];for(let c=0;c<i.length;c++){const{type:l,handler:h,once:u}=i[c];if(h({...e,type:l,stopPropagation:n,stopImmediatePropagation:o}),u&&a.push(i[c]),r)break}for(let c=0;c<a.length;c++){const{type:l,handler:h}=a[c];this.remove(l,h)}}}_normalizeEvent(e){const s=this.eventManager.getElement();return{...e,...fy(e),...dy(e,s),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:s}}}function _y(t){if("recognizer"in t)return t;let e;const s=Array.isArray(t)?[...t]:[t];if(typeof s[0]=="function"){const i=s.shift(),r=s.shift()||{};e=new i(r)}else e=s.shift();return{recognizer:e,recognizeWith:typeof s[0]=="string"?[s[0]]:s[0],requireFailure:typeof s[1]=="string"?[s[1]]:s[1]}}class my{constructor(e=null,s={}){if(this._onBasicInput=i=>{this.manager.emit(i.srcEvent.type,i)},this._onOtherEvent=i=>{this.manager.emit(i.type,i)},this.options={recognizers:[],events:{},touchAction:"compute",tabIndex:0,cssProps:{},...s},this.events=new Map,this.element=e,!!e){this.manager=new $m(e,this.options);for(const i of this.options.recognizers){const{recognizer:r,recognizeWith:n,requireFailure:o}=_y(i);this.manager.add(r),n&&r.recognizeWith(n),o&&r.requireFailure(o)}this.manager.on("hammer.input",this._onBasicInput),this.wheelInput=new ty(e,this._onOtherEvent,{enable:!1}),this.moveInput=new sy(e,this._onOtherEvent,{enable:!1}),this.keyInput=new iy(e,this._onOtherEvent,{enable:!1,tabIndex:s.tabIndex}),this.contextmenuInput=new ry(e,this._onOtherEvent,{enable:!1}),this.on(this.options.events)}}getElement(){return this.element}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy())}on(e,s,i){this._addEventHandler(e,s,i,!1)}once(e,s,i){this._addEventHandler(e,s,i,!0)}watch(e,s,i){this._addEventHandler(e,s,i,!1,!0)}off(e,s){this._removeEventHandler(e,s)}_toggleRecognizer(e,s){var n,o,a,c;const{manager:i}=this;if(!i)return;const r=i.get(e);r&&(r.set({enable:s}),i.touchAction.update()),(n=this.wheelInput)==null||n.enableEventType(e,s),(o=this.moveInput)==null||o.enableEventType(e,s),(a=this.keyInput)==null||a.enableEventType(e,s),(c=this.contextmenuInput)==null||c.enableEventType(e,s)}_addEventHandler(e,s,i,r,n){if(typeof e!="string"){i=s;for(const[l,h]of Object.entries(e))this._addEventHandler(l,h,i,r,n);return}const{manager:o,events:a}=this;if(!o)return;let c=a.get(e);if(!c){const l=this._getRecognizerName(e)||e;c=new py(this,l),a.set(e,c),o&&o.on(e,c.handleEvent)}c.add(e,s,i,r,n),c.isEmpty()||this._toggleRecognizer(c.recognizerName,!0)}_removeEventHandler(e,s){if(typeof e!="string"){for(const[n,o]of Object.entries(e))this._removeEventHandler(n,o);return}const{events:i}=this,r=i.get(e);if(r&&(r.remove(e,s),r.isEmpty())){const{recognizerName:n}=r;let o=!1;for(const a of i.values())if(a.recognizerName===n&&!a.isEmpty()){o=!0;break}o||this._toggleRecognizer(n,!1)}}_getRecognizerName(e){var s;return(s=this.manager.recognizers.find(i=>i.getEventNames().includes(e)))==null?void 0:s.options.event}}const L={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(L,"IDENTITY",{get:()=>(U.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});const Se={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},We={common:0,meters:1,pixels:2},cn={click:{handler:"onClick"},panstart:{handler:"onDragStart"},panmove:{handler:"onDrag"},panend:{handler:"onDragEnd"}},Aa={dblpan:[pa,{threshold:10,direction:J.Vertical,pointers:2}],pinch:[Zm,{},null,["dblpan"]],pan:[pa,{threshold:1},["pinch"],["dblpan"]],dblclick:[ga,{taps:2}],click:[ga,{},null,["dblclick"]]},yy=Object.keys(L).map(t=>`const int COORDINATE_SYSTEM_${t} = ${L[t]};`).join(""),by=Object.keys(Se).map(t=>`const int PROJECTION_MODE_${t} = ${Se[t]};`).join(""),Ty=Object.keys(We).map(t=>`const int UNIT_${t.toUpperCase()} = ${We[t]};`).join(""),Ay=`${yy}
${by}
${Ty}

uniform projectUniforms {
  bool wrapLongitude;
  int coordinateSystem;
  vec3 commonUnitsPerMeter;
  int projectionMode;
  float scale;
  vec3 commonUnitsPerWorldUnit;
  vec3 commonUnitsPerWorldUnit2;
  vec4 center;
  mat4 modelMatrix;
  mat4 viewProjectionMatrix;
  vec2 viewportSize;
  float devicePixelRatio;
  float focalDistance;
  vec3 cameraPosition;
  vec3 coordinateOrigin;
  vec3 commonOrigin;
  bool pseudoMeters;
} project;


const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0; // meters
const float GLOBE_RADIUS = 256.0;

// returns an adjustment factor for uCommonUnitsPerMeter
float project_size_at_latitude(float lat) {
  float y = clamp(lat, -89.9, 89.9);
  return 1.0 / cos(radians(y));
}

float project_size() {
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
    project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
    project.pseudoMeters == false) {

    // uCommonUnitsPerMeter in low-zoom Web Mercator is non-linear
    // Adjust by 1 / cos(latitude)
    // If geometry.position (vertex in common space) is populated, use it
    // Otherwise use geometry.worldPosition (anchor in world space)
    
    if (geometry.position.w == 0.0) {
      return project_size_at_latitude(geometry.worldPosition.y);
    }

    // latitude from common y: 2.0 * (atan(exp(y / TILE_SIZE * 2.0 * PI - PI)) - PI / 4.0)
    // Taylor series of 1 / cos(latitude)
    // Max error < 0.003
  
    float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    float y2 = y * y;
    float y4 = y2 * y2;
    float y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}

float project_size_at_latitude(float meters, float lat) {
  return meters * project.commonUnitsPerMeter.z * project_size_at_latitude(lat);
}

//
// Scaling offsets - scales meters to "world distance"
// Note the scalar version of project_size is for scaling the z component only
//
float project_size(float meters) {
  // For scatter relevant
  return meters * project.commonUnitsPerMeter.z * project_size();
}

vec2 project_size(vec2 meters) {
  return meters * project.commonUnitsPerMeter.xy * project_size();
}

vec3 project_size(vec3 meters) {
  return meters * project.commonUnitsPerMeter * project_size();
}

vec4 project_size(vec4 meters) {
  return vec4(meters.xyz * project.commonUnitsPerMeter, meters.w);
}

// Get rotation matrix that aligns the z axis with the given up vector
// Find 3 unit vectors ux, uy, uz that are perpendicular to each other and uz == up
mat3 project_get_orientation_matrix(vec3 up) {
  vec3 uz = normalize(up);
  // Tangent on XY plane
  vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
  vec3 uy = cross(uz, ux);
  return mat3(ux, uy, uz);
}

bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    transform = project_get_orientation_matrix(commonPosition);
    return true;
  }
  return false;
}

//
// Projecting normal - transform deltas from current coordinate system to
// normals in the worldspace
//
vec3 project_normal(vec3 vector) {
  // Apply model matrix
  vec4 normal_modelspace = project.modelMatrix * vec4(vector, 0.0);
  vec3 n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
  mat3 rotation;
  if (project_needs_rotation(geometry.position.xyz, rotation)) {
    n = rotation * n;
  }
  return n;
}

vec4 project_offset_(vec4 offset) {
  float dy = offset.y;
  vec3 commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
  return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

//
// Projecting positions - non-linear projection: lnglats => unit tile [0-1, 0-1]
//
vec2 project_mercator_(vec2 lnglat) {
  float x = lnglat.x;
  if (project.wrapLongitude) {
    x = mod(x + 180., 360.0) - 180.;
  }
  float y = clamp(lnglat.y, -89.9, 89.9);
  return vec2(
    radians(x) + PI,
    PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

vec3 project_globe_(vec3 lnglatz) {
  float lambda = radians(lnglatz.x);
  float phi = radians(lnglatz.y);
  float cosPhi = cos(phi);
  float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;

  return vec3(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

//
// Projects positions (defined by project.coordinateSystem) to common space (defined by project.projectionMode)
//
vec4 project_position(vec4 position, vec3 position64Low) {
  vec4 position_world = project.modelMatrix * position;

  // Work around for a Mac+NVIDIA bug https://github.com/visgl/deck.gl/issues/4145
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_mercator_(position_world.xy),
        project_size_at_latitude(position_world.z, position_world.y),
        position_world.w
      );
    }
    if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world.xyz += project.coordinateOrigin;
    }
  }
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
        // Too far from the projection center for offset mode to be accurate
        // Only use high parts
        return vec4(
          project_mercator_(position_world.xy) - project.commonOrigin.xy,
          project_size(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
    (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
    (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
     project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    // Subtract high part of 64 bit value. Convert remainder to float32, preserving precision.
    position_world.xyz -= project.coordinateOrigin;
  }

  // Translation is already added to the high parts
  return project_offset_(position_world) + project_offset_(project.modelMatrix * vec4(position64Low, 0.0));
}

vec4 project_position(vec4 position) {
  return project_position(position, ZERO_64_LOW);
}

vec3 project_position(vec3 position, vec3 position64Low) {
  vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
  return projected_position.xyz;
}

vec3 project_position(vec3 position) {
  vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

vec2 project_position(vec2 position) {
  vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
  return viewProjectionMatrix * position + center;
}

//
// Projects from common space coordinates to clip space.
// Uses project.viewProjectionMatrix
//
vec4 project_common_position_to_clipspace(vec4 position) {
  return project_common_position_to_clipspace(position, project.viewProjectionMatrix, project.center);
}

// Returns a clip space offset that corresponds to a given number of screen pixels
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
  vec2 offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
  return offset * project.focalDistance;
}

float project_size_to_pixel(float meters) {
  return project_size(meters) * project.scale;
}
float project_size_to_pixel(float size, int unit) {
  if (unit == UNIT_METERS) return project_size_to_pixel(size);
  if (unit == UNIT_COMMON) return size * project.scale;
  // UNIT_PIXELS
  return size;
}
float project_pixel_size(float pixels) {
  return pixels / project.scale;
}
vec2 project_pixel_size(vec2 pixels) {
  return pixels / project.scale;
}
`;function wy(t,e){if(t===e)return!0;if(Array.isArray(t)){const s=t.length;if(!e||e.length!==s)return!1;for(let i=0;i<s;i++)if(t[i]!==e[i])return!1;return!0}return!1}function _s(t){let e={},s;return i=>{for(const r in i)if(!wy(i[r],e[r])){s=t(i),e=i;break}return s}}const wa=[0,0,0,0],Sy=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],nh=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Ey=[0,0,0],oh=[0,0,0],vy=_s(Py);function ah(t,e,s=oh){s.length<3&&(s=[s[0],s[1],0]);let i=s,r,n=!0;switch(e===L.LNGLAT_OFFSETS||e===L.METER_OFFSETS?r=s:r=t.isGeospatial?[Math.fround(t.longitude),Math.fround(t.latitude),0]:null,t.projectionMode){case Se.WEB_MERCATOR:(e===L.LNGLAT||e===L.CARTESIAN)&&(r=[0,0,0],n=!1);break;case Se.WEB_MERCATOR_AUTO_OFFSET:e===L.LNGLAT?i=r:e===L.CARTESIAN&&(i=[Math.fround(t.center[0]),Math.fround(t.center[1]),0],r=t.unprojectPosition(i),i[0]-=s[0],i[1]-=s[1],i[2]-=s[2]);break;case Se.IDENTITY:i=t.position.map(Math.fround),i[2]=i[2]||0;break;case Se.GLOBE:n=!1,r=null;break;default:n=!1}return{geospatialOrigin:r,shaderCoordinateOrigin:i,offsetMode:n}}function Ry(t,e,s){const{viewMatrixUncentered:i,projectionMatrix:r}=t;let{viewMatrix:n,viewProjectionMatrix:o}=t,a=wa,c=wa,l=t.cameraPosition;const{geospatialOrigin:h,shaderCoordinateOrigin:u,offsetMode:f}=ah(t,e,s);return f&&(c=t.projectPosition(h||u),l=[l[0]-c[0],l[1]-c[1],l[2]-c[2]],c[3]=1,a=ps([],c,o),n=i||n,o=Je([],r,n),o=Je([],o,Sy)),{viewMatrix:n,viewProjectionMatrix:o,projectionCenter:a,originCommon:c,cameraPosCommon:l,shaderCoordinateOrigin:u,geospatialOrigin:h}}function xy({viewport:t,devicePixelRatio:e=1,modelMatrix:s=null,coordinateSystem:i=L.DEFAULT,coordinateOrigin:r=oh,autoWrapLongitude:n=!1}){i===L.DEFAULT&&(i=t.isGeospatial?L.LNGLAT:L.CARTESIAN);const o=vy({viewport:t,devicePixelRatio:e,coordinateSystem:i,coordinateOrigin:r});return o.wrapLongitude=n,o.modelMatrix=s||nh,o}function Py({viewport:t,devicePixelRatio:e,coordinateSystem:s,coordinateOrigin:i}){const{projectionCenter:r,viewProjectionMatrix:n,originCommon:o,cameraPosCommon:a,shaderCoordinateOrigin:c,geospatialOrigin:l}=Ry(t,s,i),h=t.getDistanceScales(),u=[t.width*e,t.height*e],f=ps([],[0,0,-t.focalDistance,1],t.projectionMatrix)[3]||1,p={coordinateSystem:s,projectionMode:t.projectionMode,coordinateOrigin:c,commonOrigin:o.slice(0,3),center:r,pseudoMeters:!!t._pseudoMeters,viewportSize:u,devicePixelRatio:e,focalDistance:f,commonUnitsPerMeter:h.unitsPerMeter,commonUnitsPerWorldUnit:h.unitsPerMeter,commonUnitsPerWorldUnit2:Ey,scale:t.scale,wrapLongitude:!1,viewProjectionMatrix:n,modelMatrix:nh,cameraPosition:a};if(l){const _=t.getDistanceScales(l);switch(s){case L.METER_OFFSETS:p.commonUnitsPerWorldUnit=_.unitsPerMeter,p.commonUnitsPerWorldUnit2=_.unitsPerMeter2;break;case L.LNGLAT:case L.LNGLAT_OFFSETS:t._pseudoMeters||(p.commonUnitsPerMeter=_.unitsPerMeter),p.commonUnitsPerWorldUnit=_.unitsPerDegree,p.commonUnitsPerWorldUnit2=_.unitsPerDegree2;break;case L.CARTESIAN:p.commonUnitsPerWorldUnit=[1,1,_.unitsPerMeter[2]],p.commonUnitsPerWorldUnit2=[0,0,_.unitsPerMeter2[2]];break}}return p}const Cy={};function Iy(t=Cy){return"viewport"in t?xy(t):{}}const Hn={name:"project",dependencies:[nm,Ql],vs:Ay,getUniforms:Iy,uniformTypes:{wrapLongitude:"f32",coordinateSystem:"i32",commonUnitsPerMeter:"vec3<f32>",projectionMode:"i32",scale:"f32",commonUnitsPerWorldUnit:"vec3<f32>",commonUnitsPerWorldUnit2:"vec3<f32>",center:"vec4<f32>",modelMatrix:"mat4x4<f32>",viewProjectionMatrix:"mat4x4<f32>",viewportSize:"vec2<f32>",devicePixelRatio:"f32",focalDistance:"f32",cameraPosition:"vec3<f32>",coordinateOrigin:"vec3<f32>",commonOrigin:"vec3<f32>",pseudoMeters:"f32"}},My=`
vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,Nt={name:"project32",dependencies:[Hn],vs:My};function Oy(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function Tt(t,e){const s=ps([],e,t);return q_(s,s,1/s[3]),s}function Sa(t,e){const s=t%e;return s<0?e+s:s}function ln(t,e,s){return t<e?e:t>s?s:t}function Ny(t){return Math.log(t)*Math.LOG2E}const jn=Math.log2||Ny;function xe(t,e){if(!t)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}const ge=Math.PI,ch=ge/4,he=ge/180,hn=180/ge,xt=512,mi=4003e4,Cs=85.051129,ky=1.5;function Fy(t){return jn(t)}function yi(t){const[e,s]=t;xe(Number.isFinite(e)),xe(Number.isFinite(s)&&s>=-90&&s<=90,"invalid latitude");const i=e*he,r=s*he,n=xt*(i+ge)/(2*ge),o=xt*(ge+Math.log(Math.tan(ch+r*.5)))/(2*ge);return[n,o]}function Pt(t){const[e,s]=t,i=e/xt*(2*ge)-ge,r=2*(Math.atan(Math.exp(s/xt*(2*ge)-ge))-ch);return[i*hn,r*hn]}function Dy(t){const{latitude:e}=t;xe(Number.isFinite(e));const s=Math.cos(e*he);return Fy(mi*s)-9}function pr(t){const e=Math.cos(t*he);return xt/mi/e}function un(t){const{latitude:e,longitude:s,highPrecision:i=!1}=t;xe(Number.isFinite(e)&&Number.isFinite(s));const r=xt,n=Math.cos(e*he),o=r/360,a=o/n,c=r/mi/n,l={unitsPerMeter:[c,c,c],metersPerUnit:[1/c,1/c,1/c],unitsPerDegree:[o,a,c],degreesPerUnit:[1/o,1/a,1/c]};if(i){const h=he*Math.tan(e*he)/n,u=o*h/2,f=r/mi*h,p=f/a*c;l.unitsPerDegree2=[0,u,f],l.unitsPerMeter2=[p,0,p]}return l}function lh(t,e){const[s,i,r]=t,[n,o,a]=e,{unitsPerMeter:c,unitsPerMeter2:l}=un({longitude:s,latitude:i,highPrecision:!0}),h=yi(t);h[0]+=n*(c[0]+l[0]*o),h[1]+=o*(c[1]+l[1]*o);const u=Pt(h),f=(r||0)+(a||0);return Number.isFinite(r)||Number.isFinite(a)?[u[0],u[1],f]:u}function By(t){const{height:e,pitch:s,bearing:i,altitude:r,scale:n,center:o}=t,a=Oy();pi(a,a,[0,0,-r]),Xl(a,a,-s*he),Yl(a,a,i*he);const c=n/e;return Wn(a,a,[c,c,c]),o&&pi(a,a,v_([],o)),a}function Uy(t){const{width:e,height:s,altitude:i,pitch:r=0,offset:n,center:o,scale:a,nearZMultiplier:c=1,farZMultiplier:l=1}=t;let{fovy:h=bi(ky)}=t;i!==void 0&&(h=bi(i));const u=h*he,f=r*he,p=hh(h);let _=p;o&&(_+=o[2]*a/Math.cos(f)/s);const m=u*(.5+(n?n[1]:0)/s),T=Math.sin(m)*_/Math.sin(ln(Math.PI/2-f-m,.01,Math.PI-.01)),S=Math.sin(f)*T+_,v=_*10,w=Math.min(S*l,v);return{fov:u,aspect:e/s,focalDistance:p,near:c,far:w}}function bi(t){return 2*Math.atan(.5/t)*hn}function hh(t){return .5/Math.tan(.5*t*he)}function uh(t,e){const[s,i,r=0]=t;return xe(Number.isFinite(s)&&Number.isFinite(i)&&Number.isFinite(r)),Tt(e,[s,i,r,1])}function $n(t,e,s=0){const[i,r,n]=t;if(xe(Number.isFinite(i)&&Number.isFinite(r),"invalid pixel coordinate"),Number.isFinite(n))return Tt(e,[i,r,n,1]);const o=Tt(e,[i,r,0,1]),a=Tt(e,[i,r,1,1]),c=o[2],l=a[2],h=c===l?0:((s||0)-c)/(l-c);return Hl([],o,a,h)}function Ly(t){const{width:e,height:s,bounds:i,minExtent:r=0,maxZoom:n=24,offset:o=[0,0]}=t,[[a,c],[l,h]]=i,u=Vy(t.padding),f=yi([a,ln(h,-Cs,Cs)]),p=yi([l,ln(c,-Cs,Cs)]),_=[Math.max(Math.abs(p[0]-f[0]),r),Math.max(Math.abs(p[1]-f[1]),r)],m=[e-u.left-u.right-Math.abs(o[0])*2,s-u.top-u.bottom-Math.abs(o[1])*2];xe(m[0]>0&&m[1]>0);const T=m[0]/_[0],S=m[1]/_[1],v=(u.right-u.left)/2/T,w=(u.top-u.bottom)/2/S,E=[(p[0]+f[0])/2+v,(p[1]+f[1])/2+w],R=Pt(E),P=Math.min(n,jn(Math.abs(Math.min(T,S))));return xe(Number.isFinite(P)),{longitude:R[0],latitude:R[1],zoom:P}}function Vy(t=0){return typeof t=="number"?{top:t,bottom:t,left:t,right:t}:(xe(Number.isFinite(t.top)&&Number.isFinite(t.bottom)&&Number.isFinite(t.left)&&Number.isFinite(t.right)),t)}const Ea=Math.PI/180;function zy(t,e=0){const{width:s,height:i,unproject:r}=t,n={targetZ:e},o=r([0,i],n),a=r([s,i],n);let c,l;const h=t.fovy?.5*t.fovy*Ea:Math.atan(.5/t.altitude),u=(90-t.pitch)*Ea;return h>u-.01?(c=va(t,0,e),l=va(t,s,e)):(c=r([0,0],n),l=r([s,0],n)),[o,a,l,c]}function va(t,e,s){const{pixelUnprojectionMatrix:i}=t,r=Tt(i,[e,0,1,1]),n=Tt(i,[e,t.height,1,1]),a=(s*t.distanceScales.unitsPerMeter[2]-r[2])/(n[2]-r[2]),c=Hl([],r,n,a),l=Pt(c);return l.push(s),l}const Ra=512;function Wy(t){const{width:e,height:s,pitch:i=0}=t;let{longitude:r,latitude:n,zoom:o,bearing:a=0}=t;(r<-180||r>180)&&(r=Sa(r+180,360)-180),(a<-180||a>180)&&(a=Sa(a+180,360)-180);const c=jn(s/Ra);if(o<=c)o=c,n=0;else{const l=s/2/Math.pow(2,o),h=Pt([0,l])[1];if(n<h)n=h;else{const u=Pt([0,Ra-l])[1];n>u&&(n=u)}}return{width:e,height:s,longitude:r,latitude:n,zoom:o,pitch:i,bearing:a}}const fh=`
uniform shadowUniforms {
  bool drawShadowMap;
  bool useShadowMap;
  vec4 color;
  highp int lightId;
  float lightCount;
  mat4 viewProjectionMatrix0;
  mat4 viewProjectionMatrix1;
  vec4 projectCenter0;
  vec4 projectCenter1;
} shadow;
`,Hy=`
const int max_lights = 2;

out vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  mat4 viewProjectionMatrices[max_lights];
  viewProjectionMatrices[0] = shadow.viewProjectionMatrix0;
  viewProjectionMatrices[1] = shadow.viewProjectionMatrix1;
  vec4 projectCenters[max_lights];
  projectCenters[0] = shadow.projectCenter0;
  projectCenters[1] = shadow.projectCenter1;

  if (shadow.drawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[shadow.lightId], projectCenters[shadow.lightId]);
  }
  if (shadow.useShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow.lightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[i], projectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,jy=`
${fh}
${Hy}
`,$y=`
const int max_lights = 2;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;

in vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow.drawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow.useShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow.lightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow.color.a / shadow.lightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow.color.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,Xy=`
${fh}
${$y}
`,Yy=_s(Qy),Ky=_s(Gy),qy=[0,0,0,1],Zy=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function Jy(t,e){const[s,i,r]=t,n=$n([s,i,r],e);return Number.isFinite(r)?n:[n[0],n[1],0]}function Qy({viewport:t,center:e}){return new ve(t.viewProjectionMatrix).invert().transform(e)}function Gy({viewport:t,shadowMatrices:e}){const s=[],i=t.pixelUnprojectionMatrix,r=t.isGeospatial?void 0:1,n=[[0,0,r],[t.width,0,r],[0,t.height,r],[t.width,t.height,r],[0,0,-1],[t.width,0,-1],[0,t.height,-1],[t.width,t.height,-1]].map(o=>Jy(o,i));for(const o of e){const a=o.clone().translate(new Ee(t.center).negate()),c=n.map(h=>a.transform(h)),l=new ve().ortho({left:Math.min(...c.map(h=>h[0])),right:Math.max(...c.map(h=>h[0])),bottom:Math.min(...c.map(h=>h[1])),top:Math.max(...c.map(h=>h[1])),near:Math.min(...c.map(h=>-h[2])),far:Math.max(...c.map(h=>-h[2]))});s.push(l.multiplyRight(o))}return s}function eb(t){const{shadowEnabled:e=!0}=t;if(!e||!t.shadowMatrices||!t.shadowMatrices.length)return{drawShadowMap:!1,useShadowMap:!1,shadow_uShadowMap0:t.dummyShadowMap,shadow_uShadowMap1:t.dummyShadowMap};const s=Hn.getUniforms(t),i=Yy({viewport:t.viewport,center:s.center}),r=[],n=Ky({shadowMatrices:t.shadowMatrices,viewport:t.viewport}).slice();for(let a=0;a<t.shadowMatrices.length;a++){const c=n[a],l=c.clone().translate(new Ee(t.viewport.center).negate());s.coordinateSystem===L.LNGLAT&&s.projectionMode===Se.WEB_MERCATOR?(n[a]=l,r[a]=i):(n[a]=c.clone().multiplyRight(Zy),r[a]=l.transform(i))}const o={drawShadowMap:!!t.drawToShadowMap,useShadowMap:t.shadowMaps?t.shadowMaps.length>0:!1,color:t.shadowColor||qy,lightId:t.shadowLightId||0,lightCount:t.shadowMatrices.length,shadow_uShadowMap0:t.dummyShadowMap,shadow_uShadowMap1:t.dummyShadowMap};for(let a=0;a<n.length;a++)o[`viewProjectionMatrix${a}`]=n[a],o[`projectCenter${a}`]=r[a];for(let a=0;a<2;a++)o[`shadow_uShadowMap${a}`]=t.shadowMaps&&t.shadowMaps[a]||t.dummyShadowMap;return o}const xa={name:"shadow",dependencies:[Hn],vs:jy,fs:Xy,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:(t={},e={})=>"viewport"in t&&(t.drawToShadowMap||t.shadowMaps&&t.shadowMaps.length>0)?eb(t):{},uniformTypes:{drawShadowMap:"f32",useShadowMap:"f32",color:"vec4<f32>",lightId:"i32",lightCount:"f32",viewProjectionMatrix0:"mat4x4<f32>",viewProjectionMatrix1:"mat4x4<f32>",projectCenter0:"vec4<f32>",projectCenter1:"vec4<f32>"}},kt={...ra,defaultUniforms:{...ra.defaultUniforms,useFloatColors:!1},inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}}},tb=[Ql],sb=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"];function ib(){const t=ni.getDefaultShaderAssembler();for(const e of tb)t.addDefaultModule(e);for(const e of sb)t.addShaderHook(e);return t}const rb=[255,255,255],nb=1;let ob=0;class ab{constructor(e={}){this.type="ambient";const{color:s=rb}=e,{intensity:i=nb}=e;this.id=e.id||`ambient-${ob++}`,this.color=s,this.intensity=i}}const cb=[255,255,255],lb=1,hb=[0,0,-1];let ub=0;class Pa{constructor(e={}){this.type="directional";const{color:s=cb}=e,{intensity:i=lb}=e,{direction:r=hb}=e,{_shadow:n=!1}=e;this.id=e.id||`directional-${ub++}`,this.color=s,this.intensity=i,this.type="directional",this.direction=new Ee(r).normalize().toArray(),this.shadow=n}getProjectedLight(e){return this}}class fb{constructor(e,s={id:"pass"}){const{id:i}=s;this.id=i,this.device=e,this.props={...s}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}}class Xn extends fb{constructor(){super(...arguments),this._lastRenderIndex=-1}render(e){const[s,i]=this.device.canvasContext.getDrawingBufferSize(),r=e.clearCanvas??!0,n=e.clearColor??(r?[0,0,0,0]:!1),o=r?1:!1,a=r?0:!1,c=e.colorMask??15,l={viewport:[0,0,s,i]};e.colorMask&&(l.colorMask=c),e.scissorRect&&(l.scissorRect=e.scissorRect);const h=this.device.beginRenderPass({framebuffer:e.target,parameters:l,clearColor:n,clearDepth:o,clearStencil:a});try{return this._drawLayers(h,e)}finally{h.end()}}_drawLayers(e,s){const{target:i,moduleParameters:r,viewports:n,views:o,onViewportActive:a,clearStack:c=!0}=s;s.pass=s.pass||"unknown",c&&(this._lastRenderIndex=-1);const l=[];for(const h of n){const u=o&&o[h.id];a==null||a(h);const f=this._getDrawLayerParams(h,s),p=h.subViewports||[h];for(const _ of p){const m=this._drawLayersInViewport(e,{target:i,moduleParameters:r,viewport:_,view:u,pass:s.pass,layers:s.layers},f);l.push(m)}}return l}_getDrawLayerParams(e,{layers:s,pass:i,isPicking:r=!1,layerFilter:n,cullRect:o,effects:a,moduleParameters:c},l=!1){var _;const h=[],u=dh(this._lastRenderIndex+1),f={layer:s[0],viewport:e,isPicking:r,renderPass:i,cullRect:o},p={};for(let m=0;m<s.length;m++){const T=s[m],S=this._shouldDrawLayer(T,f,n,p),v={shouldDrawLayer:S};S&&!l&&(v.layerRenderIndex=u(T,S),v.moduleParameters=this._getModuleParameters(T,a,i,c),v.layerParameters={...(_=T.context.deck)==null?void 0:_.props.parameters,...this.getLayerParameters(T,m,e)}),h[m]=v}return h}_drawLayersInViewport(e,{layers:s,moduleParameters:i,pass:r,target:n,viewport:o,view:a},c){const l=db(this.device,{moduleParameters:i,target:n,viewport:o});if(a&&a.props.clear){const u=a.props.clear===!0?{color:!0,depth:!0}:a.props.clear;this.device.withParametersWebGL({scissorTest:!0,scissor:l},()=>this.device.clearWebGL(u))}const h={totalCount:s.length,visibleCount:0,compositeCount:0,pickableCount:0};e.setParameters({viewport:l});for(let u=0;u<s.length;u++){const f=s[u],{shouldDrawLayer:p,layerRenderIndex:_,moduleParameters:m,layerParameters:T}=c[u];if(p&&f.props.pickable&&h.pickableCount++,f.isComposite&&h.compositeCount++,f.isDrawable&&p){h.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,_),m.viewport=o,f.context.renderPass=e;try{f._drawLayer({renderPass:e,moduleParameters:m,uniforms:{layerIndex:_},parameters:T})}catch(S){f.raiseError(S,`drawing ${f} to ${r}`)}}}return h}shouldDrawLayer(e){return!0}getModuleParameters(e,s){return null}getLayerParameters(e,s,i){return e.props.parameters}_shouldDrawLayer(e,s,i,r){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;s.layer=e;let o=e.parent;for(;o;){if(!o.props.visible||!o.filterSubLayer(s))return!1;s.layer=o,o=o.parent}if(i){const a=s.layer.id;if(a in r||(r[a]=i(s)),!r[a])return!1}return e.activateViewport(s.viewport),!0}_getModuleParameters(e,s,i,r){var a,c;const n=this.device.canvasContext.cssToDeviceRatio(),o=Object.assign(Object.create(((a=e.internalState)==null?void 0:a.propsInTransition)||e.props),{autoWrapLongitude:e.wrapLongitude,viewport:e.context.viewport,mousePosition:e.context.mousePosition,picking:{isActive:0},devicePixelRatio:n});if(s)for(const l of s)Object.assign(o,(c=l.getModuleParameters)==null?void 0:c.call(l,e));return Object.assign(o,this.getModuleParameters(e,s),r)}}function dh(t=0,e={}){const s={},i=(r,n)=>{const o=r.props._offset,a=r.id,c=r.parent&&r.parent.id;let l;if(c&&!(c in e)&&i(r.parent,!1),c in s){const h=s[c]=s[c]||dh(e[c],e);l=h(r,n),s[a]=h}else Number.isFinite(o)?(l=o+(e[c]||0),s[a]=null):l=t;return n&&l>=t&&(t=l+1),e[a]=l,l};return i}function db(t,{moduleParameters:e,target:s,viewport:i}){const r=e&&e.devicePixelRatio||t.canvasContext.cssToDeviceRatio(),[,n]=t.canvasContext.getDrawingBufferSize(),o=s?s.height:n,a=i;return[a.x*r,o-(a.y+a.height)*r,a.width*r,a.height*r]}class gb extends Xn{constructor(e,s){super(e,s);const i=e.createTexture({format:"rgba8unorm",width:1,height:1,sampler:{minFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},mipmaps:!0}),r=e.createTexture({format:"depth16unorm",width:1,height:1,mipmaps:!1});this.fbo=e.createFramebuffer({id:"shadowmap",width:1,height:1,colorAttachments:[i],depthStencilAttachment:r})}delete(){this.fbo&&(this.fbo.destroy(),this.fbo=null)}getShadowMap(){return this.fbo.colorAttachments[0].texture}render(e){const s=this.fbo,i=this.device.canvasContext.cssToDeviceRatio(),r=e.viewports[0],n=r.width*i,o=r.height*i,a=[1,1,1,1];(n!==s.width||o!==s.height)&&s.resize({width:n,height:o}),super.render({...e,clearColor:a,target:s,pass:"shadow"})}getLayerParameters(e,s,i){return{...e.props.parameters,blend:!1,depthRange:[0,1],depthTest:!0}}shouldDrawLayer(e){return e.props.shadowEnabled!==!1}getModuleParameters(){return{drawToShadowMap:!0}}}const pb={color:[255,255,255],intensity:1},Ca=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],_b=[0,0,0,200/255];class gh{constructor(e={}){this.id="lighting-effect",this.shadowColor=_b,this.shadow=!1,this.directionalLights=[],this.pointLights=[],this.shadowPasses=[],this.dummyShadowMap=null,this.setProps(e)}setup(e){this.context=e;const{device:s,deck:i}=e;this.shadow&&!this.dummyShadowMap&&(this._createShadowPasses(s),i._addDefaultShaderModule(xa),this.dummyShadowMap=s.createTexture({width:1,height:1}))}setProps(e){this.ambientLight=void 0,this.directionalLights=[],this.pointLights=[];for(const s in e){const i=e[s];switch(i.type){case"ambient":this.ambientLight=i;break;case"directional":this.directionalLights.push(i);break;case"point":this.pointLights.push(i);break}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(s=>s.shadow),this.context&&this.setup(this.context),this.props=e}preRender({layers:e,layerFilter:s,viewports:i,onViewportActive:r,views:n}){if(this.shadow){this.shadowMatrices=this._calculateMatrices();for(let o=0;o<this.shadowPasses.length;o++)this.shadowPasses[o].render({layers:e,layerFilter:s,viewports:i,onViewportActive:r,views:n,moduleParameters:{shadowLightId:o,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}})}}getModuleParameters(e){const s=this.shadow?{shadowMaps:this.shadowPasses.map(i=>i.getShadowMap()),dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{};return s.lightSources={enabled:!0,ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(i=>i.getProjectedLight({layer:e})),pointLights:this.pointLights.map(i=>i.getProjectedLight({layer:e}))},s}cleanup(e){for(const s of this.shadowPasses)s.delete();this.shadowPasses.length=0,this.dummyShadowMap&&(this.dummyShadowMap.destroy(),this.dummyShadowMap=null,e.deck._removeDefaultShaderModule(xa))}_calculateMatrices(){const e=[];for(const s of this.directionalLights){const i=new ve().lookAt({eye:new Ee(s.direction).negate()});e.push(i)}return e}_createShadowPasses(e){for(let s=0;s<this.directionalLights.length;s++){const i=new gb(e);this.shadowPasses[s]=i}}_applyDefaultLights(){const{ambientLight:e,pointLights:s,directionalLights:i}=this;!e&&s.length===0&&i.length===0&&(this.ambientLight=new ab(pb),this.directionalLights.push(new Pa(Ca[0]),new Pa(Ca[1])))}}class mb{constructor(e={}){this._pool=[],this.opts={overAlloc:2,poolSize:100},this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,s,{size:i=1,type:r,padding:n=0,copy:o=!1,initialize:a=!1,maxCount:c}){const l=r||e&&e.constructor||Float32Array,h=s*i+n;if(ArrayBuffer.isView(e)){if(h<=e.length)return e;if(h*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new l(e.buffer,0,h)}let u=1/0;c&&(u=c*i+n);const f=this._allocate(l,h,a,u);return e&&o?f.set(e):a||f.fill(0,0,4),this._release(e),f}release(e){this._release(e)}_allocate(e,s,i,r){let n=Math.max(Math.ceil(s*this.opts.overAlloc),1);n>r&&(n=r);const o=this._pool,a=e.BYTES_PER_ELEMENT*n,c=o.findIndex(l=>l.byteLength>=a);if(c>=0){const l=new e(o.splice(c,1)[0],0,n);return i&&l.fill(0),l}return new e(n)}_release(e){if(!ArrayBuffer.isView(e))return;const s=this._pool,{buffer:i}=e,{byteLength:r}=i,n=s.findIndex(o=>o.byteLength>=r);n<0?s.push(i):(n>0||s.length<this.opts.poolSize)&&s.splice(n,0,i),s.length>this.opts.poolSize&&s.shift()}}const Ct=new mb;function Ht(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function yb(t){return[t[12],t[13],t[14]]}function bb(t){return{left:ht(t[3]+t[0],t[7]+t[4],t[11]+t[8],t[15]+t[12]),right:ht(t[3]-t[0],t[7]-t[4],t[11]-t[8],t[15]-t[12]),bottom:ht(t[3]+t[1],t[7]+t[5],t[11]+t[9],t[15]+t[13]),top:ht(t[3]-t[1],t[7]-t[5],t[11]-t[9],t[15]-t[13]),near:ht(t[3]+t[2],t[7]+t[6],t[11]+t[10],t[15]+t[14]),far:ht(t[3]-t[2],t[7]-t[6],t[11]-t[10],t[15]-t[14])}}const Ia=new Ee;function ht(t,e,s,i){Ia.set(t,e,s);const r=Ia.len();return{distance:i/r,normal:new Ee(-t/r,-e/r,-s/r)}}function Tb(t){return t-Math.fround(t)}let Bt;function _r(t,e){const{size:s=1,startIndex:i=0}=e,r=e.endIndex!==void 0?e.endIndex:t.length,n=(r-i)/s;Bt=Ct.allocate(Bt,n,{type:Float32Array,size:s*2});let o=i,a=0;for(;o<r;){for(let c=0;c<s;c++){const l=t[o++];Bt[a+c]=l,Bt[a+c+s]=Tb(l)}a+=s*2}return Bt.subarray(0,n*s*2)}function Ab(t){let e=null,s=!1;for(const i of t)i&&(e?(s||(e=[[e[0][0],e[0][1]],[e[1][0],e[1][1]]],s=!0),e[0][0]=Math.min(e[0][0],i[0][0]),e[0][1]=Math.min(e[0][1],i[0][1]),e[1][0]=Math.max(e[1][0],i[1][0]),e[1][1]=Math.max(e[1][1],i[1][1])):e=i);return e}const wb=Math.PI/180,Sb=Ht(),Ma=[0,0,0],Eb={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function vb({width:t,height:e,orthographic:s,fovyRadians:i,focalDistance:r,padding:n,near:o,far:a}){const c=t/e,l=s?new ve().orthographic({fovy:i,aspect:c,focalDistance:r,near:o,far:a}):new ve().perspective({fovy:i,aspect:c,near:o,far:a});if(n){const{left:h=0,right:u=0,top:f=0,bottom:p=0}=n,_=Be((h+t-u)/2,0,t)-t/2,m=Be((f+e-p)/2,0,e)-e/2;l[8]-=_*2/t,l[9]+=m*2/e}return l}const ph=class _h{constructor(e={}){this._frustumPlanes={},this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||Eb,this.focalDistance=e.focalDistance||1,this.position=e.position||Ma,this.modelMatrix=e.modelMatrix||null;const{longitude:s,latitude:i}=e;this.isGeospatial=Number.isFinite(i)&&Number.isFinite(s),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?Se.WEB_MERCATOR:Se.WEB_MERCATOR_AUTO_OFFSET:Se.IDENTITY}equals(e){return e instanceof _h?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&rs(e.projectionMatrix,this.projectionMatrix)&&rs(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:s=!0}={}){const i=this.projectPosition(e),r=uh(i,this.pixelProjectionMatrix),[n,o]=r,a=s?o:this.height-o;return e.length===2?[n,a]:[n,a,r[2]]}unproject(e,{topLeft:s=!0,targetZ:i}={}){const[r,n,o]=e,a=s?n:this.height-n,c=i&&i*this.distanceScales.unitsPerMeter[2],l=$n([r,a,o],this.pixelUnprojectionMatrix,c),[h,u,f]=this.unprojectPosition(l);return Number.isFinite(o)?[h,u,f]:Number.isFinite(i)?[h,u,i]:[h,u]}projectPosition(e){const[s,i]=this.projectFlat(e),r=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[s,i,r]}unprojectPosition(e){const[s,i]=this.unprojectFlat(e),r=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[s,i,r]}projectFlat(e){if(this.isGeospatial){const s=yi(e);return s[1]=Be(s[1],-318,830),s}return e}unprojectFlat(e){return this.isGeospatial?Pt(e):e}getBounds(e={}){const s={targetZ:e.z||0},i=this.unproject([0,0],s),r=this.unproject([this.width,0],s),n=this.unproject([0,this.height],s),o=this.unproject([this.width,this.height],s);return[Math.min(i[0],r[0],n[0],o[0]),Math.min(i[1],r[1],n[1],o[1]),Math.max(i[0],r[0],n[0],o[0]),Math.max(i[1],r[1],n[1],o[1])]}getDistanceScales(e){return e&&this.isGeospatial?un({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:s,width:i=1,height:r=1}){return e<this.x+this.width&&this.x<e+i&&s<this.y+this.height&&this.y<s+r}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,bb(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,s){return null}_initProps(e){const s=e.longitude,i=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=Dy({latitude:i})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||un({latitude:i,longitude:s}));const r=Math.pow(2,this.zoom);this.scale=r;const{position:n,modelMatrix:o}=e;let a=Ma;if(n&&(a=o?new ve(o).transformAsVector(n,[]):n),this.isGeospatial){const c=this.projectPosition([s,i,0]);this.center=new Ee(a).scale(this.distanceScales.unitsPerMeter).add(c)}else this.center=this.projectPosition(a)}_initMatrices(e){const{viewMatrix:s=Sb,projectionMatrix:i=null,orthographic:r=!1,fovyRadians:n,fovy:o=75,near:a=.1,far:c=1e3,padding:l=null,focalDistance:h=1}=e;this.viewMatrixUncentered=s,this.viewMatrix=new ve().multiplyRight(s).translate(new Ee(this.center).negate()),this.projectionMatrix=i||vb({width:this.width,height:this.height,orthographic:r,fovyRadians:n||o*wb,focalDistance:h,padding:l,near:a,far:c});const u=Ht();Je(u,u,this.projectionMatrix),Je(u,u,this.viewMatrix),this.viewProjectionMatrix=u,this.viewMatrixInverse=tn([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=yb(this.viewMatrixInverse);const f=Ht(),p=Ht();Wn(f,f,[this.width/2,-this.height/2,1]),pi(f,f,[1,-1,0]),Je(p,f,this.viewProjectionMatrix),this.pixelProjectionMatrix=p,this.pixelUnprojectionMatrix=tn(Ht(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||U.warn("Pixel project matrix not invertible")()}};ph.displayName="Viewport";let mh=ph;const yh=class fn extends mh{constructor(e={}){const{latitude:s=0,longitude:i=0,zoom:r=0,pitch:n=0,bearing:o=0,nearZMultiplier:a=.1,farZMultiplier:c=1.01,nearZ:l,farZ:h,orthographic:u=!1,projectionMatrix:f,repeat:p=!1,worldOffset:_=0,position:m,padding:T,legacyMeterSizes:S=!1}=e;let{width:v,height:w,altitude:E=1.5}=e;const R=Math.pow(2,r);v=v||1,w=w||1;let P,M=null;if(f)E=f[5]/2,P=bi(E);else{e.fovy?(P=e.fovy,E=hh(P)):P=bi(E);let I;if(T){const{top:k=0,bottom:O=0}=T;I=[0,Be((k+w-O)/2,0,w)-w/2]}M=Uy({width:v,height:w,scale:R,center:m&&[0,0,m[2]*pr(s)],offset:I,pitch:n,fovy:P,nearZMultiplier:a,farZMultiplier:c}),Number.isFinite(l)&&(M.near=l),Number.isFinite(h)&&(M.far=h)}let C=By({height:w,pitch:n,bearing:o,scale:R,altitude:E});_&&(C=new ve().translate([512*_,0,0]).multiplyLeft(C)),super({...e,width:v,height:w,viewMatrix:C,longitude:i,latitude:s,zoom:r,...M,fovy:P,focalDistance:E}),this.latitude=s,this.longitude=i,this.zoom=r,this.pitch=n,this.bearing=o,this.altitude=E,this.fovy=P,this.orthographic=u,this._subViewports=p?[]:null,this._pseudoMeters=S,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){const e=this.getBounds(),s=Math.floor((e[0]+180)/360),i=Math.ceil((e[2]-180)/360);for(let r=s;r<=i;r++){const n=r?new fn({...this,worldOffset:r}):this;this._subViewports.push(n)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);const[s,i]=this.projectFlat(e),r=(e[2]||0)*pr(e[1]);return[s,i,r]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);const[s,i]=this.unprojectFlat(e),r=(e[2]||0)/pr(i);return[s,i,r]}addMetersToLngLat(e,s){return lh(e,s)}panByPosition(e,s){const i=$n(s,this.pixelUnprojectionMatrix),r=this.projectFlat(e),n=sa([],r,b_([],i)),o=sa([],this.center,n),[a,c]=this.unprojectFlat(o);return{longitude:a,latitude:c}}getBounds(e={}){const s=zy(this,e.z||0);return[Math.min(s[0][0],s[1][0],s[2][0],s[3][0]),Math.min(s[0][1],s[1][1],s[2][1],s[3][1]),Math.max(s[0][0],s[1][0],s[2][0],s[3][0]),Math.max(s[0][1],s[1][1],s[2][1],s[3][1])]}fitBounds(e,s={}){const{width:i,height:r}=this,{longitude:n,latitude:o,zoom:a}=Ly({width:i,height:r,bounds:e,...s});return new fn({width:i,height:r,longitude:n,latitude:o,zoom:a})}};yh.displayName="WebMercatorViewport";let bh=yh;const Oa=[0,0,0];function mr(t,e,s=!1){const i=e.projectPosition(t);if(s&&e instanceof bh){const[r,n,o=0]=t,a=e.getDistanceScales([r,n]);i[2]=o*a.unitsPerMeter[2]}return i}function Rb(t){const{viewport:e,modelMatrix:s,coordinateOrigin:i}=t;let{coordinateSystem:r,fromCoordinateSystem:n,fromCoordinateOrigin:o}=t;return r===L.DEFAULT&&(r=e.isGeospatial?L.LNGLAT:L.CARTESIAN),n===void 0&&(n=r),o===void 0&&(o=i),{viewport:e,coordinateSystem:r,coordinateOrigin:i,modelMatrix:s,fromCoordinateSystem:n,fromCoordinateOrigin:o}}function Th(t,{viewport:e,modelMatrix:s,coordinateSystem:i,coordinateOrigin:r,offsetMode:n}){let[o,a,c=0]=t;switch(s&&([o,a,c]=ps([],[o,a,c,1],s)),i){case L.LNGLAT:return mr([o,a,c],e,n);case L.LNGLAT_OFFSETS:return mr([o+r[0],a+r[1],c+(r[2]||0)],e,n);case L.METER_OFFSETS:return mr(lh(r,[o,a,c]),e,n);case L.CARTESIAN:default:return e.isGeospatial?[o+r[0],a+r[1],c+r[2]]:e.projectPosition([o,a,c])}}function xb(t,e){const{viewport:s,coordinateSystem:i,coordinateOrigin:r,modelMatrix:n,fromCoordinateSystem:o,fromCoordinateOrigin:a}=Rb(e),{autoOffset:c=!0}=e,{geospatialOrigin:l=Oa,shaderCoordinateOrigin:h=Oa,offsetMode:u=!1}=c?ah(s,i,r):{},f=Th(t,{viewport:s,modelMatrix:n,coordinateSystem:o,coordinateOrigin:a,offsetMode:u});if(u){const p=s.projectPosition(l||h);k_(f,f,p)}return f}let Pb=1,Cb=1;class Ah{constructor(){d(this,"time",0);d(this,"channels",new Map);d(this,"animations",new Map);d(this,"playing",!1);d(this,"lastEngineTime",-1)}addChannel(e){const{delay:s=0,duration:i=Number.POSITIVE_INFINITY,rate:r=1,repeat:n=1}=e,o=Pb++,a={time:0,delay:s,duration:i,rate:r,repeat:n};return this._setChannelTime(a,this.time),this.channels.set(o,a),o}removeChannel(e){this.channels.delete(e);for(const[s,i]of this.animations)i.channel===e&&this.detachAnimation(s)}isFinished(e){const s=this.channels.get(e);return s===void 0?!1:this.time>=s.delay+s.duration*s.repeat}getTime(e){if(e===void 0)return this.time;const s=this.channels.get(e);return s===void 0?-1:s.time}setTime(e){this.time=Math.max(0,e);const s=this.channels.values();for(const r of s)this._setChannelTime(r,this.time);const i=this.animations.values();for(const r of i){const{animation:n,channel:o}=r;n.setTime(this.getTime(o))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,s){const i=Cb++;return this.animations.set(i,{animation:e,channel:s}),e.setTime(this.getTime(s)),i}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,s){const i=s-e.delay,r=e.duration*e.repeat;i>=r?e.time=e.duration*e.rate:(e.time=Math.max(0,i)%e.duration,e.time*=e.rate)}}function Ib(t){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(t):setTimeout(t,1e3/60)}function Mb(t){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(t):clearTimeout(t)}let Ob=0;const Nb={device:null,onAddHTML:()=>"",onInitialize:async()=>null,onRender:()=>{},onFinalize:()=>{},onError:t=>console.error(t),stats:jr.stats.get(`animation-loop-${Ob++}`),useDevicePixels:!0,autoResizeViewport:!1,autoResizeDrawingBuffer:!1};class kb{constructor(e){d(this,"device",null);d(this,"canvas",null);d(this,"props");d(this,"animationProps",null);d(this,"timeline",null);d(this,"stats");d(this,"cpuTime");d(this,"gpuTime");d(this,"frameRate");d(this,"display");d(this,"needsRedraw","initialized");d(this,"_initialized",!1);d(this,"_running",!1);d(this,"_animationFrameId",null);d(this,"_nextFramePromise",null);d(this,"_resolveNextFrame",null);d(this,"_cpuStartTime",0);d(this,"_error",null);if(this.props={...Nb,...e},e=this.props,!e.device)throw new Error("No device provided");const{useDevicePixels:s=!0}=this.props;this.stats=e.stats||new zi({id:"animation-loop-stats"}),this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this.setProps({autoResizeViewport:e.autoResizeViewport,autoResizeDrawingBuffer:e.autoResizeDrawingBuffer,useDevicePixels:s}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}destroy(){this.stop(),this._setDisplay(null)}delete(){this.destroy()}setError(e){var i,r;if(this.props.onError(e),this._error=Error(),((r=(i=this.device)==null?void 0:i.canvasContext)==null?void 0:r.canvas)instanceof HTMLCanvasElement){const n=document.createElement("h1");n.innerHTML=e.message,n.style.position="absolute",n.style.top="20%",n.style.left="10px",n.style.color="black",n.style.backgroundColor="red",document.body.appendChild(n)}}setNeedsRedraw(e){return this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.props.autoResizeViewport=e.autoResizeViewport||!1),"autoResizeDrawingBuffer"in e&&(this.props.autoResizeDrawingBuffer=e.autoResizeDrawingBuffer||!1),"useDevicePixels"in e&&(this.props.useDevicePixels=e.useDevicePixels||!1),this}async start(){if(this._running)return this;this._running=!0;try{let e;return this._initialized||(this._initialized=!0,await this._initDevice(),this._initialize(),await this.props.onInitialize(this._getAnimationProps())),this._running?(e!==!1&&(this._cancelAnimationFrame(),this._requestAnimationFrame()),this):null}catch(e){const s=e instanceof Error?e:new Error("Unknown error");throw this.props.onError(s),s}}stop(){return this._running&&(this.animationProps&&!this._error&&this.props.onFinalize(this.animationProps),this._cancelAnimationFrame(),this._nextFramePromise=null,this._resolveNextFrame=null,this._running=!1),this}redraw(){var e;return(e=this.device)!=null&&e.isLost||this._error?this:(this._beginFrameTimers(),this._setupFrame(),this._updateAnimationProps(),this._renderFrame(this._getAnimationProps()),this._clearNeedsRedraw(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endFrameTimers(),this)}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(e=>{this._resolveNextFrame=e})),this._nextFramePromise}async toDataURL(){if(this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.canvas instanceof HTMLCanvasElement)return this.canvas.toDataURL();throw new Error("OffscreenCanvas")}_initialize(){this._startEventHandling(),this._initializeAnimationProps(),this._updateAnimationProps(),this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_setDisplay(e){this.display&&(this.display.destroy(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_requestAnimationFrame(){this._running&&(this._animationFrameId=Ib(this._animationFrame.bind(this)))}_cancelAnimationFrame(){this._animationFrameId!==null&&(Mb(this._animationFrameId),this._animationFrameId=null)}_animationFrame(){this._running&&(this.redraw(),this._requestAnimationFrame())}_renderFrame(e){var s;if(this.display){this.display._renderFrame(e);return}this.props.onRender(this._getAnimationProps()),(s=this.device)==null||s.submit()}_clearNeedsRedraw(){this.needsRedraw=!1}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_initializeAnimationProps(){var s,i;const e=(i=(s=this.device)==null?void 0:s.canvasContext)==null?void 0:i.canvas;if(!this.device||!e)throw new Error("loop");this.animationProps={animationLoop:this,device:this.device,canvas:e,timeline:this.timeline,useDevicePixels:this.props.useDevicePixels,needsRedraw:!1,width:1,height:1,aspect:1,time:0,startTime:Date.now(),engineTime:0,tick:0,tock:0,_mousePosition:null}}_getAnimationProps(){if(!this.animationProps)throw new Error("animationProps");return this.animationProps}_updateAnimationProps(){if(!this.animationProps)return;const{width:e,height:s,aspect:i}=this._getSizeAndAspect();(e!==this.animationProps.width||s!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),i!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=s,this.animationProps.aspect=i,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime}async _initDevice(){var e;if(this.device=await this.props.device,!this.device)throw new Error("No device provided");this.canvas=((e=this.device.canvasContext)==null?void 0:e.canvas)||null}_createInfoDiv(){if(this.canvas&&this.props.onAddHTML){const e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";const s=document.createElement("div");s.style.position="absolute",s.style.left="10px",s.style.bottom="10px",s.style.width="300px",s.style.background="white",this.canvas instanceof HTMLCanvasElement&&e.appendChild(this.canvas),e.appendChild(s);const i=this.props.onAddHTML(s);i&&(s.innerHTML=i)}}_getSizeAndAspect(){var n,o,a,c;if(!this.device)return{width:1,height:1,aspect:1};const[e,s]=((o=(n=this.device)==null?void 0:n.canvasContext)==null?void 0:o.getPixelSize())||[1,1];let i=1;const r=(c=(a=this.device)==null?void 0:a.canvasContext)==null?void 0:c.canvas;return r&&r.clientHeight?i=r.clientWidth/r.clientHeight:e>0&&s>0&&(i=e/s),{width:e,height:s,aspect:i}}_resizeViewport(){this.props.autoResizeViewport&&this.device.gl&&this.device.gl.viewport(0,0,this.device.gl.drawingBufferWidth,this.device.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){var e,s;this.props.autoResizeDrawingBuffer&&((s=(e=this.device)==null?void 0:e.canvasContext)==null||s.resize({useDevicePixels:this.props.useDevicePixels}))}_beginFrameTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this.cpuTime.timeStart()}_endFrameTimers(){this.cpuTime.timeEnd()}_startEventHandling(){this.canvas&&(this.canvas.addEventListener("mousemove",this._onMousemove.bind(this)),this.canvas.addEventListener("mouseleave",this._onMouseleave.bind(this)))}_onMousemove(e){e instanceof MouseEvent&&(this._getAnimationProps()._mousePosition=[e.offsetX,e.offsetY])}_onMouseleave(e){this._getAnimationProps()._mousePosition=null}}const yr={};function Yn(t="id"){yr[t]=yr[t]||1;const e=yr[t]++;return`${t}-${e}`}class Na{constructor(e){d(this,"id");d(this,"userData",{});d(this,"topology");d(this,"bufferLayout",[]);d(this,"vertexCount");d(this,"indices");d(this,"attributes");if(this.id=e.id||Yn("geometry"),this.topology=e.topology,this.indices=e.indices||null,this.attributes=e.attributes,this.vertexCount=e.vertexCount,this.bufferLayout=e.bufferLayout||[],this.indices&&!(this.indices.usage&j.INDEX))throw new Error("Index buffer must have INDEX usage")}destroy(){var e;(e=this.indices)==null||e.destroy();for(const s of Object.values(this.attributes))s.destroy()}getVertexCount(){return this.vertexCount}getAttributes(){return this.attributes}getIndexes(){return this.indices||null}_calculateVertexCount(e){return e.byteLength/12}}function Fb(t,e){if(e instanceof Na)return e;const s=Db(t,e),{attributes:i,bufferLayout:r}=Bb(t,e);return new Na({topology:e.topology||"triangle-list",bufferLayout:r,vertexCount:e.vertexCount,indices:s,attributes:i})}function Db(t,e){if(!e.indices)return;const s=e.indices.value;return t.createBuffer({usage:j.INDEX,data:s})}function Bb(t,e){const s=[],i={};for(const[n,o]of Object.entries(e.attributes)){let a=n;switch(n){case"POSITION":a="positions";break;case"NORMAL":a="normals";break;case"TEXCOORD_0":a="texCoords";break;case"COLOR_0":a="colors";break}if(o){i[a]=t.createBuffer({data:o.value,id:`${n}-buffer`});const{value:c,size:l,normalized:h}=o;s.push({name:a,format:Rp(c,l,h)})}}const r=e._calculateVertexCount(e.attributes,e.indices);return{attributes:i,bufferLayout:s,vertexCount:r}}const Ui=class Ui{constructor(e){d(this,"device");d(this,"destroyPolicy");d(this,"_hashCounter",0);d(this,"_hashes",{});d(this,"_renderPipelineCache",{});d(this,"_computePipelineCache",{});this.device=e,this.destroyPolicy=e.props._factoryDestroyPolicy}static getDefaultPipelineFactory(e){return e._lumaData.defaultPipelineFactory=e._lumaData.defaultPipelineFactory||new Ui(e),e._lumaData.defaultPipelineFactory}createRenderPipeline(e){const s={...St.defaultProps,...e},i=this._hashRenderPipeline(s);if(!this._renderPipelineCache[i]){const r=this.device.createRenderPipeline({...s,id:s.id?`${s.id}-cached`:void 0});r.hash=i,this._renderPipelineCache[i]={pipeline:r,useCount:0}}return this._renderPipelineCache[i].useCount++,this._renderPipelineCache[i].pipeline}createComputePipeline(e){const s={...hi.defaultProps,...e},i=this._hashComputePipeline(s);if(!this._computePipelineCache[i]){const r=this.device.createComputePipeline({...s,id:s.id?`${s.id}-cached`:void 0});r.hash=i,this._computePipelineCache[i]={pipeline:r,useCount:0}}return this._computePipelineCache[i].useCount++,this._computePipelineCache[i].pipeline}release(e){const s=e.hash,i=e instanceof hi?this._computePipelineCache:this._renderPipelineCache;i[s].useCount--,i[s].useCount===0&&this.destroyPolicy==="unused"&&(i[s].pipeline.destroy(),delete i[s])}_hashComputePipeline(e){return`${this._getHash(e.shader.source)}`}_hashRenderPipeline(e){const s=e.vs?this._getHash(e.vs.source):0,i=e.fs?this._getHash(e.fs.source):0,r="-",n=this._getHash(JSON.stringify(e.bufferLayout));switch(this.device.type){case"webgl":return`${s}/${i}V${r}BL${n}`;default:const o=this._getHash(JSON.stringify(e.parameters));return`${s}/${i}V${r}T${e.topology}P${o}BL${n}`}}_getHash(e){return this._hashes[e]===void 0&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}};d(Ui,"defaultProps",{...St.defaultProps});let dn=Ui;const Li=class Li{constructor(e){d(this,"device");d(this,"destroyPolicy");d(this,"_cache",{});this.device=e,this.destroyPolicy=e.props._factoryDestroyPolicy}static getDefaultShaderFactory(e){var s;return(s=e._lumaData).defaultShaderFactory||(s.defaultShaderFactory=new Li(e)),e._lumaData.defaultShaderFactory}createShader(e){const s=this._hashShader(e);let i=this._cache[s];if(!i){const r=this.device.createShader({...e,id:e.id?`${e.id}-cached`:void 0});this._cache[s]=i={shader:r,useCount:0}}return i.useCount++,i.shader}release(e){const s=this._hashShader(e),i=this._cache[s];i&&(i.useCount--,i.useCount===0&&this.destroyPolicy==="unused"&&(delete this._cache[s],i.shader.destroy()))}_hashShader(e){return`${e.stage}:${e.source}`}};d(Li,"defaultProps",{...ai.defaultProps});let gn=Li;function Ub(t,e){var r;const s={},i="Values";if(t.attributes.length===0&&!((r=t.varyings)!=null&&r.length))return{"No attributes or varyings":{[i]:"N/A"}};for(const n of t.attributes)if(n){const o=`${n.location} ${n.name}: ${n.type}`;s[`in ${o}`]={[i]:n.stepMode||"vertex"}}for(const n of t.varyings||[]){const o=`${n.location} ${n.name}`;s[`out ${o}`]={[i]:JSON.stringify(n)}}return s}let Q=null,He=null;function Lb(t,{id:e,minimap:s,opaque:i,top:r="0",left:n="0",rgbaScale:o=1}){Q||(Q=document.createElement("canvas"),Q.id=e,Q.title=e,Q.style.zIndex="100",Q.style.position="absolute",Q.style.top=r,Q.style.left=n,Q.style.border="blue 5px solid",Q.style.transform="scaleY(-1)",document.body.appendChild(Q),He=Q.getContext("2d")),(Q.width!==t.width||Q.height!==t.height)&&(Q.width=t.width/2,Q.height=t.height/2,Q.style.width="400px",Q.style.height="400px");const a=t.device.readPixelsToArrayWebGL(t),c=He==null?void 0:He.createImageData(t.width,t.height);if(c){for(let h=0;h<a.length;h+=4)c.data[0+h+0]=a[h+0]*o,c.data[0+h+1]=a[h+1]*o,c.data[0+h+2]=a[h+2]*o,c.data[0+h+3]=i?255:a[h+3]*o;He==null||He.putImageData(c,0,0)}}function pn(t,e,s){if(t===e)return!0;if(!s||!t||!e)return!1;if(Array.isArray(t)){if(!Array.isArray(e)||t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(!pn(t[i],e[i],s-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof t=="object"&&typeof e=="object"){const i=Object.keys(t),r=Object.keys(e);if(i.length!==r.length)return!1;for(const n of i)if(!e.hasOwnProperty(n)||!pn(t[n],e[n],s-1))return!1;return!0}return!1}function Vb(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)}function zb(t){return Array.isArray(t)?t.length===0||typeof t[0]=="number":!1}function wh(t){return Vb(t)||zb(t)}function Wb(t){return wh(t)||typeof t=="number"||typeof t=="boolean"}function Sh(t){const e={bindings:{},uniforms:{}};return Object.keys(t).forEach(s=>{const i=t[s];Wb(i)?e.uniforms[s]=i:e.bindings[s]=i}),e}class Hb{constructor(e){d(this,"modules");d(this,"moduleUniforms");d(this,"moduleBindings");const s=Vn(Object.values(e).filter(i=>i.dependencies));for(const i of s)e[i.name]=i;x.log(1,"Creating ShaderInputs with modules",Object.keys(e))(),this.modules=e,this.moduleUniforms={},this.moduleBindings={};for(const[i,r]of Object.entries(e))this._addModule(r),r.name&&i!==r.name&&x.warn(`Module name: ${i} vs ${r.name}`)()}destroy(){}setProps(e){var s;for(const i of Object.keys(e)){const r=i,n=e[r]||{},o=this.modules[r];if(!o){x.warn(`Module ${i} not found`)();continue}const a=this.moduleUniforms[r],c=this.moduleBindings[r],l=((s=o.getUniforms)==null?void 0:s.call(o,n,a))||n,{uniforms:h,bindings:u}=Sh(l);this.moduleUniforms[r]={...a,...h},this.moduleBindings[r]={...c,...u}}}getModules(){return Object.values(this.modules)}getUniformValues(){return this.moduleUniforms}getBindingValues(){const e={};for(const s of Object.values(this.moduleBindings))Object.assign(e,s);return e}getDebugTable(){var s;const e={};for(const[i,r]of Object.entries(this.moduleUniforms))for(const[n,o]of Object.entries(r))e[`${i}.${n}`]={type:(s=this.modules[i].uniformTypes)==null?void 0:s[n],value:String(o)};return e}_addModule(e){const s=e.name;this.moduleUniforms[s]=e.defaultUniforms||{},this.moduleBindings[s]={}}}let jb="";async function $b(t,e){const s=new Image;return s.crossOrigin=(e==null?void 0:e.crossOrigin)||"anonymous",s.src=t.startsWith("http")?t:jb+t,await s.decode(),e?await createImageBitmap(s,e):await createImageBitmap(s)}class ka{constructor(e,s){d(this,"device");d(this,"texture");d(this,"sampler");d(this,"view");d(this,"ready");d(this,"isReady",!1);d(this,"destroyed",!1);d(this,"resolveReady",()=>{});d(this,"rejectReady",()=>{});this.device=e,typeof(s==null?void 0:s.data)=="string"&&s.dimension==="2d"&&(s={...s,data:$b(s.data)}),this.ready=new Promise((i,r)=>{this.resolveReady=()=>{this.isReady=!0,i()},this.rejectReady=r}),this.initAsync(s)}async initAsync(e){let s,i;const r=e.data,n=await Eh(r).then(s,i);if(this.destroyed)return;const o={...e,data:n};this.texture=this.device.createTexture(o),this.sampler=this.texture.sampler,this.view=this.texture.view,this.isReady=!0}destroy(){this.texture&&(this.texture.destroy(),this.texture=null),this.destroyed=!0}resize(e){if(!this.isReady)throw new Error("Cannot resize texture before it is ready");if(e.width===this.texture.width&&e.height===this.texture.height)return!1;if(this.texture){const s=this.texture;this.texture=s.clone(e),s.destroy()}return!0}}async function Eh(t){if(t=await t,Array.isArray(t))return await Promise.all(t.map(Eh));if(t&&typeof t=="object"&&t.constructor===Object){const e=t,s=await Promise.all(Object.values(e)),i=Object.keys(e),r={};for(let n=0;n<i.length;n++)r[i[n]]=s[n];return r}return t}const ut=2,Xb=1e4,Vi=class Vi{constructor(e,s){d(this,"device");d(this,"id");d(this,"source");d(this,"vs");d(this,"fs");d(this,"pipelineFactory");d(this,"shaderFactory");d(this,"userData",{});d(this,"parameters");d(this,"topology");d(this,"bufferLayout");d(this,"isInstanced");d(this,"instanceCount",0);d(this,"vertexCount");d(this,"indexBuffer",null);d(this,"bufferAttributes",{});d(this,"constantAttributes",{});d(this,"bindings",{});d(this,"uniforms",{});d(this,"vertexArray");d(this,"transformFeedback",null);d(this,"pipeline");d(this,"shaderInputs");d(this,"_uniformStore");d(this,"_attributeInfos",{});d(this,"_gpuGeometry",null);d(this,"_getModuleUniforms");d(this,"props");d(this,"_pipelineNeedsUpdate","newly created");d(this,"_needsRedraw","initializing");d(this,"_destroyed",!1);d(this,"_lastDrawTimestamp",-1);d(this,"_lastLogTime",0);d(this,"_logOpen",!1);d(this,"_drawCount",0);var a,c,l,h;this.props={...Vi.defaultProps,...s},s=this.props,this.id=s.id||Yn("model"),this.device=e,Object.assign(this.userData,s.userData);const i=Object.fromEntries(((a=this.props.modules)==null?void 0:a.map(u=>[u.name,u]))||[]);this.setShaderInputs(s.shaderInputs||new Hb(i));const r=Kb(e),n=(((c=this.props.modules)==null?void 0:c.length)>0?this.props.modules:(l=this.shaderInputs)==null?void 0:l.getModules())||[];if(this.device.type==="webgpu"&&this.props.source){(h=this.props).shaderLayout||(h.shaderLayout=l_(this.props.source));const{source:u,getUniforms:f}=this.props.shaderAssembler.assembleWGSLShader({platformInfo:r,...this.props,modules:n});this.source=u,this._getModuleUniforms=f}else{const{vs:u,fs:f,getUniforms:p}=this.props.shaderAssembler.assembleGLSLShaderPair({platformInfo:r,...this.props,modules:n});this.vs=u,this.fs=f,this._getModuleUniforms=p}this.vertexCount=this.props.vertexCount,this.instanceCount=this.props.instanceCount,this.topology=this.props.topology,this.bufferLayout=this.props.bufferLayout,this.parameters=this.props.parameters,s.geometry&&this.setGeometry(s.geometry),this.pipelineFactory=s.pipelineFactory||dn.getDefaultPipelineFactory(this.device),this.shaderFactory=s.shaderFactory||gn.getDefaultShaderFactory(this.device),this.pipeline=this._updatePipeline(),this.vertexArray=e.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry),"isInstanced"in s&&(this.isInstanced=s.isInstanced),s.instanceCount&&this.setInstanceCount(s.instanceCount),s.vertexCount&&this.setVertexCount(s.vertexCount),s.indexBuffer&&this.setIndexBuffer(s.indexBuffer),s.attributes&&this.setAttributes(s.attributes),s.constantAttributes&&this.setConstantAttributes(s.constantAttributes),s.bindings&&this.setBindings(s.bindings),s.uniforms&&this.setUniforms(s.uniforms),s.moduleSettings&&this.updateModuleSettings(s.moduleSettings),s.transformFeedback&&(this.transformFeedback=s.transformFeedback),Object.seal(this)}destroy(){var e;this._destroyed||(this.pipelineFactory.release(this.pipeline),this.shaderFactory.release(this.pipeline.vs),this.pipeline.fs&&this.shaderFactory.release(this.pipeline.fs),this._uniformStore.destroy(),(e=this._gpuGeometry)==null||e.destroy(),this._destroyed=!0)}needsRedraw(){this._getBindingsUpdateTimestamp()>this._lastDrawTimestamp&&this.setNeedsRedraw("contents of bound textures or buffers updated");const e=this._needsRedraw;return this._needsRedraw=!1,e}setNeedsRedraw(e){this._needsRedraw||(this._needsRedraw=e)}predraw(){this.updateShaderInputs(),this.pipeline=this._updatePipeline()}draw(e){this.predraw();let s;try{this._logDrawCallStart(),this.pipeline=this._updatePipeline();const i=this._getBindings();this.pipeline.setBindings(i,{disableWarnings:this.props.disableWarnings}),_n(this.uniforms)||this.pipeline.setUniformsWebGL(this.uniforms);const{indexBuffer:r}=this.vertexArray,n=r?r.byteLength/(r.indexType==="uint32"?4:2):void 0;s=this.pipeline.draw({renderPass:e,vertexArray:this.vertexArray,isInstanced:this.isInstanced,vertexCount:this.vertexCount,instanceCount:this.instanceCount,indexCount:n,transformFeedback:this.transformFeedback||void 0,parameters:this.parameters,topology:this.topology})}finally{this._logDrawCallEnd()}return this._logFramebuffer(e),s?(this._lastDrawTimestamp=this.device.timestamp,this._needsRedraw=!1):this._needsRedraw="waiting for resource initialization",s}setGeometry(e){var i;(i=this._gpuGeometry)==null||i.destroy();const s=e&&Fb(this.device,e);if(s){this.setTopology(s.topology||"triangle-list");const r=new or(this.bufferLayout);this.bufferLayout=r.mergeBufferLayouts(s.bufferLayout,this.bufferLayout),this.vertexArray&&this._setGeometryAttributes(s)}this._gpuGeometry=s}setTopology(e){e!==this.topology&&(this.topology=e,this._setPipelineNeedsUpdate("topology"))}setBufferLayout(e){const s=new or(this.bufferLayout);this.bufferLayout=this._gpuGeometry?s.mergeBufferLayouts(e,this._gpuGeometry.bufferLayout):e,this._setPipelineNeedsUpdate("bufferLayout"),this.pipeline=this._updatePipeline(),this.vertexArray=this.device.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry)}setParameters(e){pn(e,this.parameters,2)||(this.parameters=e,this._setPipelineNeedsUpdate("parameters"))}setInstanceCount(e){this.instanceCount=e,this.isInstanced===void 0&&e>0&&(this.isInstanced=!0),this.setNeedsRedraw("instanceCount")}setVertexCount(e){this.vertexCount=e,this.setNeedsRedraw("vertexCount")}setShaderInputs(e){this.shaderInputs=e,this._uniformStore=new vp(this.shaderInputs.modules);for(const[s,i]of Object.entries(this.shaderInputs.modules))if(Yb(i)){const r=this._uniformStore.getManagedUniformBuffer(this.device,s);this.bindings[`${s}Uniforms`]=r}this.setNeedsRedraw("shaderInputs")}updateShaderInputs(){this._uniformStore.setUniforms(this.shaderInputs.getUniformValues()),this.setBindings(this.shaderInputs.getBindingValues()),this.setNeedsRedraw("shaderInputs")}setBindings(e){Object.assign(this.bindings,e),this.setNeedsRedraw("bindings")}setTransformFeedback(e){this.transformFeedback=e,this.setNeedsRedraw("transformFeedback")}setIndexBuffer(e){this.vertexArray.setIndexBuffer(e),this.setNeedsRedraw("indexBuffer")}setAttributes(e,s){const i=(s==null?void 0:s.disableWarnings)??this.props.disableWarnings;e.indices&&x.warn(`Model:${this.id} setAttributes() - indexBuffer should be set using setIndexBuffer()`)();const r=new or(this.bufferLayout);for(const[n,o]of Object.entries(e)){const a=r.getBufferLayout(n);if(!a){i||x.warn(`Model(${this.id}): Missing layout for buffer "${n}".`)();continue}const c=r.getAttributeNamesForBuffer(a);let l=!1;for(const h of c){const u=this._attributeInfos[h];u&&(this.vertexArray.setBuffer(u.location,o),l=!0)}!l&&!i&&x.warn(`Model(${this.id}): Ignoring buffer "${o.id}" for unknown attribute "${n}"`)()}this.setNeedsRedraw("attributes")}setConstantAttributes(e,s){for(const[i,r]of Object.entries(e)){const n=this._attributeInfos[i];n?this.vertexArray.setConstantWebGL(n.location,r):((s==null?void 0:s.disableWarnings)??this.props.disableWarnings)||x.warn(`Model "${this.id}: Ignoring constant supplied for unknown attribute "${i}"`)()}this.setNeedsRedraw("constants")}setUniforms(e){_n(e)||(this.pipeline.setUniformsWebGL(e),Object.assign(this.uniforms,e)),this.setNeedsRedraw("uniforms")}updateModuleSettings(e){const{bindings:s,uniforms:i}=Sh(this._getModuleUniforms(e));Object.assign(this.bindings,s),Object.assign(this.uniforms,i),this.setNeedsRedraw("moduleSettings")}_getBindings(){return Object.entries(this.bindings).reduce((e,[s,i])=>(i instanceof ka?i.isReady&&(e[s]=i.texture):e[s]=i,e),{})}_getBindingsUpdateTimestamp(){let e=0;for(const s of Object.values(this.bindings))s instanceof oi?e=Math.max(e,s.texture.updateTimestamp):s instanceof j||s instanceof K?e=Math.max(e,s.updateTimestamp):s instanceof ka?e=s.texture?Math.max(e,s.texture.updateTimestamp):1/0:s instanceof ci||(e=Math.max(e,s.buffer.updateTimestamp));return e}_setGeometryAttributes(e){const s={...e.attributes};for(const[i]of Object.entries(s))!this.pipeline.shaderLayout.attributes.find(r=>r.name===i)&&i!=="positions"&&delete s[i];this.vertexCount=e.vertexCount,this.setIndexBuffer(e.indices||null),this.setAttributes(e.attributes,{disableWarnings:!0}),this.setAttributes(s,{disableWarnings:this.props.disableWarnings}),this.setNeedsRedraw("geometry attributes")}_setPipelineNeedsUpdate(e){this._pipelineNeedsUpdate||(this._pipelineNeedsUpdate=e),this.setNeedsRedraw(e)}_updatePipeline(){if(this._pipelineNeedsUpdate){let e=null,s=null;this.pipeline&&(x.log(1,`Model ${this.id}: Recreating pipeline because "${this._pipelineNeedsUpdate}".`)(),e=this.pipeline.vs,s=this.pipeline.fs),this._pipelineNeedsUpdate=!1;const i=this.shaderFactory.createShader({id:`${this.id}-vertex`,stage:"vertex",source:this.source||this.vs,debugShaders:this.props.debugShaders});let r=null;this.source?r=i:this.fs&&(r=this.shaderFactory.createShader({id:`${this.id}-fragment`,stage:"fragment",source:this.source||this.fs,debugShaders:this.props.debugShaders})),this.pipeline=this.pipelineFactory.createRenderPipeline({...this.props,bufferLayout:this.bufferLayout,topology:this.topology,parameters:this.parameters,bindings:this._getBindings(),vs:i,fs:r}),this._attributeInfos=Il(this.pipeline.shaderLayout,this.bufferLayout),e&&this.shaderFactory.release(e),s&&this.shaderFactory.release(s)}return this.pipeline}_logDrawCallStart(){const e=x.level>3?0:Xb;x.level<2||Date.now()-this._lastLogTime<e||(this._lastLogTime=Date.now(),this._logOpen=!0,x.group(ut,`>>> DRAWING MODEL ${this.id}`,{collapsed:x.level<=2})())}_logDrawCallEnd(){if(this._logOpen){const e=Ub(this.pipeline.shaderLayout,this.id);x.table(ut,e)();const s=this.shaderInputs.getDebugTable();for(const[r,n]of Object.entries(this.uniforms))s[r]={value:n};x.table(ut,s)();const i=this._getAttributeDebugTable();x.table(ut,this._attributeInfos)(),x.table(ut,i)(),x.groupEnd(ut)(),this._logOpen=!1}}_logFramebuffer(e){const s=this.device.props.debugFramebuffers;if(this._drawCount++,!s)return;const i=e.props.framebuffer;i&&Lb(i,{id:i.id,minimap:!0})}_getAttributeDebugTable(){const e={};for(const[s,i]of Object.entries(this._attributeInfos)){const r=this.vertexArray.attributes[i.location];e[i.location]={name:s,type:i.shaderType,values:r?this._getBufferOrConstantValues(r,i.bufferDataType):"null"}}if(this.vertexArray.indexBuffer){const{indexBuffer:s}=this.vertexArray,i=s.indexType==="uint32"?new Uint32Array(s.debugData):new Uint16Array(s.debugData);e.indices={name:"indices",type:s.indexType,values:i.toString()}}return e}_getBufferOrConstantValues(e,s){const i=Nl(s);return(e instanceof j?new i(e.debugData):e).toString()}};d(Vi,"defaultProps",{...St.defaultProps,source:void 0,vs:null,fs:null,id:"unnamed",handle:void 0,userData:{},defines:{},modules:[],moduleSettings:void 0,geometry:null,indexBuffer:null,attributes:{},constantAttributes:{},varyings:[],isInstanced:void 0,instanceCount:0,vertexCount:0,shaderInputs:void 0,pipelineFactory:void 0,shaderFactory:void 0,transformFeedback:void 0,shaderAssembler:ni.getDefaultShaderAssembler(),debugShaders:void 0,disableWarnings:void 0});let ue=Vi;function Yb(t){return!!(t.uniformTypes&&!_n(t.uniformTypes))}function Kb(t){return{type:t.type,shaderLanguage:t.info.shadingLanguage,shaderLanguageVersion:t.info.shadingLanguageVersion,gpu:t.info.gpu,features:t.features}}function _n(t){for(const e in t)return!1;return!0}const ss=class ss{constructor(e,s=ss.defaultProps){d(this,"device");d(this,"model");d(this,"transformFeedback");if(!ss.isSupported(e))throw new Error("BufferTransform not yet implemented on WebGPU");this.device=e,this.model=new ue(this.device,{id:s.id||"buffer-transform-model",fs:s.fs||Pg(),topology:s.topology||"point-list",varyings:s.outputs||s.varyings,...s}),this.transformFeedback=this.device.createTransformFeedback({layout:this.model.pipeline.shaderLayout,buffers:s.feedbackBuffers}),this.model.setTransformFeedback(this.transformFeedback),Object.seal(this)}static isSupported(e){var s;return((s=e==null?void 0:e.info)==null?void 0:s.type)==="webgl"}destroy(){this.model&&this.model.destroy()}delete(){this.destroy()}run(e){e!=null&&e.inputBuffers&&this.model.setAttributes(e.inputBuffers),e!=null&&e.outputBuffers&&this.transformFeedback.setBuffers(e.outputBuffers);const s=this.device.beginRenderPass(e);this.model.draw(s),s.end()}getBuffer(e){return this.transformFeedback.getBuffer(e)}readAsync(e){const s=this.getBuffer(e);if(!s)throw new Error("BufferTransform#getBuffer");if(s instanceof j)return s.readAsync();const{buffer:i,byteOffset:r=0,byteLength:n=i.byteLength}=s;return i.readAsync(r,n)}};d(ss,"defaultProps",{...ue.defaultProps,outputs:void 0,feedbackBuffers:void 0});let os=ss;class It{constructor(e){d(this,"id");d(this,"topology");d(this,"vertexCount");d(this,"indices");d(this,"attributes");d(this,"userData",{});const{attributes:s={},indices:i=null,vertexCount:r=null}=e;this.id=e.id||Yn("geometry"),this.topology=e.topology,i&&(this.indices=ArrayBuffer.isView(i)?{value:i,size:1}:i),this.attributes={};for(const[n,o]of Object.entries(s)){const a=ArrayBuffer.isView(o)?{value:o}:o;if(!ArrayBuffer.isView(a.value))throw new Error(`${this._print(n)}: must be typed array or object with value as typed array`);if((n==="POSITION"||n==="positions")&&!a.size&&(a.size=3),n==="indices"){if(this.indices)throw new Error("Multiple indices detected");this.indices=a}else this.attributes[n]=a}this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this.vertexCount=r||this._calculateVertexCount(this.attributes,this.indices)}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return`Geometry ${this.id} attribute ${e}`}_setAttributes(e,s){return this}_calculateVertexCount(e,s){if(s)return s.value.length;let i=1/0;for(const r of Object.values(e)){const{value:n,size:o,constant:a}=r;!a&&n&&o!==void 0&&o>=1&&(i=Math.min(i,n.length/o))}return i}}const qb={blendColorOperation:"add",blendColorSrcFactor:"one",blendColorDstFactor:"zero",blendAlphaOperation:"add",blendAlphaSrcFactor:"constant-alpha",blendAlphaDstFactor:"zero"};class vh extends Xn{constructor(){super(...arguments),this._colorEncoderState=null}render(e){return"pickingFBO"in e?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:s,views:i,viewports:r,onViewportActive:n,pickingFBO:o,deviceRect:{x:a,y:c,width:l,height:h},cullRect:u,effects:f,pass:p="picking",pickZ:_,moduleParameters:m}){this.pickZ=_;const T=this._resetColorEncoder(_),S=[a,c,l,h],v=super.render({target:o,layers:e,layerFilter:s,views:i,viewports:r,onViewportActive:n,cullRect:u,effects:f==null?void 0:f.filter(E=>E.useInPicking),pass:p,isPicking:!0,moduleParameters:m,clearColor:[0,0,0,0],colorMask:15,scissorRect:S});return this._colorEncoderState=null,{decodePickingColor:T&&Jb.bind(null,T),stats:v}}shouldDrawLayer(e){const{pickable:s,operation:i}=e.props;return s&&i.includes("draw")||i.includes("terrain")||i.includes("mask")}getModuleParameters(){return{picking:{isActive:1,isAttribute:this.pickZ},lightSources:{enabled:!1}}}getLayerParameters(e,s,i){const r={depthMask:!0,depthTest:!0,depthRange:[0,1],...e.props.parameters},{pickable:n,operation:o}=e.props;return!this._colorEncoderState||o.includes("terrain")?r.blend=!1:n&&o.includes("draw")&&(Object.assign(r,qb),r.blend=!0,r.blendColor=Zb(this._colorEncoderState,e,i)),r}_resetColorEncoder(e){return this._colorEncoderState=e?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}}function Zb(t,e,s){const{byLayer:i,byAlpha:r}=t;let n,o=i.get(e);return o?(o.viewports.push(s),n=o.a):(n=i.size+1,n<=255?(o={a:n,layer:e,viewports:[s]},i.set(e,o),r[n]=o):(U.warn("Too many pickable layers, only picking the first 255")(),n=0)),[0,0,0,n/255]}function Jb(t,e){const s=t.byAlpha[e[3]];return s&&{pickedLayer:s.layer,pickedViewports:s.viewports,pickedObjectIndex:s.layer.decodePickingColor(e)}}const dt={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},Ti=Symbol.for("component"),Ve=Symbol.for("propTypes"),br=Symbol.for("deprecatedProps"),At=Symbol.for("asyncPropDefaults"),et=Symbol.for("asyncPropOriginal"),Ue=Symbol.for("asyncPropResolved");function Kn(t,e=()=>!0){return Array.isArray(t)?Rh(t,e,[]):e(t)?[t]:[]}function Rh(t,e,s){let i=-1;for(;++i<t.length;){const r=t[i];Array.isArray(r)?Rh(r,e,s):e(r)&&s.push(r)}return s}function Qb({target:t,source:e,start:s=0,count:i=1}){const r=e.length,n=i*r;let o=0;for(let a=s;o<r;o++)t[a++]=e[o];for(;o<n;)o<n-o?(t.copyWithin(s+o,s,s+o),o*=2):(t.copyWithin(s+o,s,s+n-o),o=n);return t}class Gb{constructor(e,s,i){this._loadCount=0,this._subscribers=new Set,this.id=e,this.context=i,this.setData(s)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(e,s){if(e===this._data&&!s)return;this._data=e;const i=++this._loadCount;let r=e;typeof e=="string"&&(r=si(e)),r instanceof Promise?(this.isLoaded=!1,this._loader=r.then(n=>{this._loadCount===i&&(this.isLoaded=!0,this._error=void 0,this._content=n)}).catch(n=>{this._loadCount===i&&(this.isLoaded=!0,this._error=n||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=e);for(const n of this._subscribers)n.onChange(this.getData())}}class eT{constructor(e){var s;this.protocol=e.protocol||"resource://",this._context={device:e.device,gl:(s=e.device)==null?void 0:s.gl,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return e.startsWith(this.protocol)?!0:e in this._resources}add({resourceId:e,data:s,forceUpdate:i=!1,persistent:r=!0}){let n=this._resources[e];n?n.setData(s,i):(n=new Gb(e,s,this._context),this._resources[e]=n),n.persistent=r}remove(e){const s=this._resources[e];s&&(s.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){const s=this._consumers[e];if(s){for(const i in s){const r=s[i],n=this._resources[r.resourceId];n&&n.unsubscribe(r)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:s,consumerId:i,requestId:r="default"}){const{_resources:n,protocol:o}=this;e.startsWith(o)&&(e=e.replace(o,""),n[e]||this.add({resourceId:e,data:null,persistent:!1}));const a=n[e];if(this._track(i,r,a,s),a)return a.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(const e in this._resources)this._resources[e].delete()}_track(e,s,i,r){const n=this._consumers,o=n[e]=n[e]||{};let a=o[s];const c=a&&a.resourceId&&this._resources[a.resourceId];c&&(c.unsubscribe(a),this.prune()),i&&(a?(a.onChange=r,a.resourceId=i.id):a={onChange:r,resourceId:i.id},o[s]=a,i.subscribe(a))}_prune(){this._pruneRequest=null;for(const e of Object.keys(this._resources)){const s=this._resources[e];!s.persistent&&!s.inUse()&&(s.delete(),delete this._resources[e])}}}const tT="layerManager.setLayers",sT="layerManager.activateViewport";class iT{constructor(e,s){this._lastRenderedLayers=[],this._needsRedraw=!1,this._needsUpdate=!1,this._nextLayers=null,this._debug=!1,this._defaultShaderModulesChanged=!1,this.activateViewport=a=>{re(sT,this,a),a&&(this.context.viewport=a)};const{deck:i,stats:r,viewport:n,timeline:o}=s||{};this.layers=[],this.resourceManager=new eT({device:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,device:e,gl:e==null?void 0:e.gl,deck:i,shaderAssembler:ib(),defaultShaderModules:[Am],renderPass:void 0,stats:r||new zi({id:"deck.gl"}),viewport:n||new mh({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:o||new Ah,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(const e of this.layers)this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let s=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);for(const i of this.layers){const r=i.getNeedsRedraw(e);s=s||r}return s}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._defaultShaderModulesChanged?"shader modules changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter(s=>e.find(i=>s.id.indexOf(i)===0)):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,s){re(tT,this,s,e),this._lastRenderedLayers=e;const i=Kn(e,Boolean);for(const r of i)r.context=this.context;this._updateLayers(this.layers,i)}updateLayers(){const e=this.needsUpdate();e&&(this.setNeedsRedraw(`updating layers: ${e}`),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}addDefaultShaderModule(e){const{defaultShaderModules:s}=this.context;s.find(i=>i.name===e.name)||(s.push(e),this._defaultShaderModulesChanged=!0)}removeDefaultShaderModule(e){const{defaultShaderModules:s}=this.context,i=s.findIndex(r=>r.name===e.name);i>=0&&(s.splice(i,1),this._defaultShaderModulesChanged=!0)}_handleError(e,s,i){i.raiseError(s,`${e} of ${i}`)}_updateLayers(e,s){const i={};for(const o of e)i[o.id]?U.warn(`Multiple old layers with same id ${o.id}`)():i[o.id]=o;if(this._defaultShaderModulesChanged){for(const o of e)o.setNeedsUpdate(),o.setChangeFlags({extensionsChanged:!0});this._defaultShaderModulesChanged=!1}const r=[];this._updateSublayersRecursively(s,i,r),this._finalizeOldLayers(i);let n=!1;for(const o of r)if(o.hasUniformTransition()){n=`Uniform transition in ${o}`;break}this._needsUpdate=n,this.layers=r}_updateSublayersRecursively(e,s,i){for(const r of e){r.context=this.context;const n=s[r.id];n===null&&U.warn(`Multiple new layers with same id ${r.id}`)(),s[r.id]=null;let o=null;try{this._debug&&n!==r&&r.validateProps(),n?(this._transferLayerState(n,r),this._updateLayer(r)):this._initializeLayer(r),i.push(r),o=r.isComposite?r.getSubLayers():null}catch(a){this._handleError("matching",a,r)}o&&this._updateSublayersRecursively(o,s,i)}}_finalizeOldLayers(e){for(const s in e){const i=e[s];i&&this._finalizeLayer(i)}}_initializeLayer(e){try{e._initialize(),e.lifecycle=dt.INITIALIZED}catch(s){this._handleError("initialization",s,e)}}_transferLayerState(e,s){s._transferState(e),s.lifecycle=dt.MATCHED,s!==e&&(e.lifecycle=dt.AWAITING_GC)}_updateLayer(e){try{e._update()}catch(s){this._handleError("update",s,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||`finalized ${e}`,e.lifecycle=dt.AWAITING_FINALIZATION;try{e._finalize(),e.lifecycle=dt.FINALIZED}catch(s){this._handleError("finalization",s,e)}}}function pe(t,e,s){if(t===e)return!0;if(!s||!t||!e)return!1;if(Array.isArray(t)){if(!Array.isArray(e)||t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(!pe(t[i],e[i],s-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof t=="object"&&typeof e=="object"){const i=Object.keys(t),r=Object.keys(e);if(i.length!==r.length)return!1;for(const n of i)if(!e.hasOwnProperty(n)||!pe(t[n],e[n],s-1))return!1;return!0}return!1}class rT{constructor(e){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(const e in this.controllers){const s=this.controllers[e];s&&s.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){const s=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),s}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(const e in this.controllers){const s=this.controllers[e];s&&s.updateTransition()}}getViewports(e){return e?this._viewports.filter(s=>s.containsPixel(e)):this._viewports}getViews(){const e={};return this.views.forEach(s=>{e[s.id]=s}),e}getView(e){return this.views.find(s=>s.id===e)}getViewState(e){const s=typeof e=="string"?this.getView(e):e,i=s&&this.viewState[s.getViewStateId()]||this.viewState;return s?s.filterViewState(i):i}getViewport(e){return this._viewportMap[e]}unproject(e,s){const i=this.getViewports(),r={x:e[0],y:e[1]};for(let n=i.length-1;n>=0;--n){const o=i[n];if(o.containsPixel(r)){const a=e.slice();return a[0]-=o.x,a[1]-=o.y,o.unproject(a,s)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,s){(e!==this.width||s!==this.height)&&(this.width=e,this.height=s,this.setNeedsUpdate("Size changed"))}_setViews(e){e=Kn(e,Boolean),this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){e?(!pe(e,this.viewState,3)&&this.setNeedsUpdate("viewState changed"),this.viewState=e):U.warn("missing `viewState` or `initialViewState`")()}_createController(e,s){const i=s.type;return new i({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._eventCallbacks.onViewStateChange,onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:n=>{var o;return(o=this.getView(e.id))==null?void 0:o.makeViewport({viewState:n,width:this.width,height:this.height})}})}_updateController(e,s,i,r){const n=e.controller;if(n&&i){const o={...s,...n,id:e.id,x:i.x,y:i.y,width:i.width,height:i.height};return(!r||r.constructor!==n.type)&&(r=this._createController(e,o)),r&&r.setProps(o),r}return null}_rebuildViewports(){const{views:e}=this,s=this.controllers;this._viewports=[],this.controllers={};let i=!1;for(let r=e.length;r--;){const n=e[r],o=this.getViewState(n),a=n.makeViewport({viewState:o,width:this.width,height:this.height});let c=s[n.id];const l=!!n.controller;l&&!c&&(i=!0),(i||!l)&&c&&(c.finalize(),c=null),this.controllers[n.id]=this._updateController(n,o,a,c),a&&this._viewports.unshift(a)}for(const r in s){const n=s[r];n&&!this.controllers[r]&&n.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)})}_diffViews(e,s){return e.length!==s.length?!0:e.some((i,r)=>!e[r].equals(s[r]))}}const nT=/([0-9]+\.?[0-9]*)(%|px)/;function Ie(t){switch(typeof t){case"number":return{position:t,relative:!1};case"string":const e=nT.exec(t);if(e&&e.length>=3){const s=e[2]==="%",i=parseFloat(e[1]);return{position:s?i/100:i,relative:s}}default:throw new Error(`Could not parse position string ${t}`)}}function Me(t,e){return t.relative?Math.round(t.position*e):t.position}class oT{constructor(e){const{id:s,x:i=0,y:r=0,width:n="100%",height:o="100%",padding:a=null}=e;this.id=s||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=Ie(i),this._y=Ie(r),this._width=Ie(n),this._height=Ie(o),this._padding=a&&{left:Ie(a.left||0),right:Ie(a.right||0),top:Ie(a.top||0),bottom:Ie(a.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e?!0:this.ViewportType===e.ViewportType&&pe(this.props,e.props,2)}makeViewport({width:e,height:s,viewState:i}){i=this.filterViewState(i);const r=this.getDimensions({width:e,height:s});return!r.height||!r.width?null:new this.ViewportType({...i,...this.props,...r})}getViewStateId(){const{viewState:e}=this.props;return typeof e=="string"?e:(e==null?void 0:e.id)||this.id}filterViewState(e){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;const s={...e};for(const i in this.props.viewState)i!=="id"&&(s[i]=this.props.viewState[i]);return s}return e}getDimensions({width:e,height:s}){const i={x:Me(this._x,e),y:Me(this._y,s),width:Me(this._width,e),height:Me(this._height,s)};return this._padding&&(i.padding={left:Me(this._padding.left,e),top:Me(this._padding.top,s),right:Me(this._padding.right,e),bottom:Me(this._padding.bottom,s)}),i}get controller(){const e=this.props.controller;return e?e===!0?{type:this.ControllerType}:typeof e=="function"?{type:e}:{type:this.ControllerType,...e}:null}}class ji{constructor(e){this._inProgress=!1,this._handle=null,this.time=0,this.settings={duration:0},this._timeline=e}get inProgress(){return this._inProgress}start(e){var s,i;this.cancel(),this.settings=e,this._inProgress=!0,(i=(s=this.settings).onStart)==null||i.call(s,this)}end(){var e,s;this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,(s=(e=this.settings).onEnd)==null||s.call(e,this))}cancel(){var e,s;this._inProgress&&((s=(e=this.settings).onInterrupt)==null||s.call(e,this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){var e,s;if(!this._inProgress)return!1;if(this._handle===null){const{_timeline:i,settings:r}=this;this._handle=i.addChannel({delay:i.getTime(),duration:r.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),(s=(e=this.settings).onUpdate)==null||s.call(e,this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}const Fa=()=>{},mn={BREAK:1,SNAP_TO_END:2,IGNORE:3},aT=t=>t,cT=mn.BREAK;class lT{constructor(e){this._onTransitionUpdate=s=>{const{time:i,settings:{interpolator:r,startProps:n,endProps:o,duration:a,easing:c}}=s,l=c(i/a),h=r.interpolateProps(n,o,l);this.propsInTransition=this.getControllerState({...this.props,...h}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})},this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new ji(e.timeline),this.onViewStateChange=e.onViewStateChange||Fa,this.onStateChange=e.onStateChange||Fa}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let s=!1;const i=this.props;if(this.props=e,!i||this._shouldIgnoreViewportChange(i,e))return!1;if(this._isTransitionEnabled(e)){let r=i;if(this.transition.inProgress){const{interruption:n,endProps:o}=this.transition.settings;r={...i,...n===mn.SNAP_TO_END?o:this.propsInTransition||i}}this._triggerTransition(r,e),s=!0}else this.transition.cancel();return s}updateTransition(){this.transition.update()}_isTransitionEnabled(e){const{transitionDuration:s,transitionInterpolator:i}=e;return(s>0||s==="auto")&&!!i}_isUpdateDueToCurrentTransition(e){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition):!1}_shouldIgnoreViewportChange(e,s){return this.transition.inProgress?this.transition.settings.interruption===mn.IGNORE||this._isUpdateDueToCurrentTransition(s):this._isTransitionEnabled(s)?s.transitionInterpolator.arePropsEqual(e,s):!0}_triggerTransition(e,s){const i=this.getControllerState(e),r=this.getControllerState(s).shortestPathFrom(i),n=s.transitionInterpolator,o=n.getDuration?n.getDuration(e,s):s.transitionDuration;if(o===0)return;const a=n.initializeProps(e,r);this.propsInTransition={};const c={duration:o,easing:s.transitionEasing||aT,interpolator:n,interruption:s.transitionInterruption||cT,startProps:a.start,endProps:a.end,onStart:s.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(s.onTransitionInterrupt),onEnd:this._onTransitionEnd(s.onTransitionEnd)};this.transition.start(c),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return s=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),e==null||e(s)}}}function te(t,e){if(!t)throw new Error(e||"deck.gl: assertion failed.")}class hT{constructor(e){const{compare:s,extract:i,required:r}=e;this._propsToCompare=s,this._propsToExtract=i||s,this._requiredProps=r}arePropsEqual(e,s){for(const i of this._propsToCompare)if(!(i in e)||!(i in s)||!rs(e[i],s[i]))return!1;return!0}initializeProps(e,s){const i={},r={};for(const n of this._propsToExtract)(n in e||n in s)&&(i[n]=e[n],r[n]=s[n]);return this._checkRequiredProps(i),this._checkRequiredProps(r),{start:i,end:r}}getDuration(e,s){return s.transitionDuration}_checkRequiredProps(e){this._requiredProps&&this._requiredProps.forEach(s=>{const i=e[s];te(Number.isFinite(i)||Array.isArray(i),`${s} is required for transition`)})}}const uT=["longitude","latitude","zoom","bearing","pitch"],fT=["longitude","latitude","zoom"];class xh extends hT{constructor(e={}){const s=Array.isArray(e)?e:e.transitionProps,i=Array.isArray(e)?{}:e;i.transitionProps=Array.isArray(s)?{compare:s,required:s}:s||{compare:uT,required:fT},super(i.transitionProps),this.opts=i}initializeProps(e,s){const i=super.initializeProps(e,s),{makeViewport:r,around:n}=this.opts;if(r&&n){const o=r(e),a=r(s),c=o.unproject(n);i.start.around=n,Object.assign(i.end,{around:a.project(c),aroundPosition:c,width:s.width,height:s.height})}return i}interpolateProps(e,s,i){const r={};for(const n of this._propsToExtract)r[n]=gi(e[n]||0,s[n]||0,i);if(s.aroundPosition&&this.opts.makeViewport){const n=this.opts.makeViewport({...s,...r});Object.assign(r,n.panByPosition(s.aroundPosition,gi(e.around,s.around,i)))}return r}}const Oe={transitionDuration:0},dT=300,Is=t=>1-(1-t)*(1-t),ft={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],DOUBLE_PAN:["dblpanstart","dblpanmove","dblpanend"],DOUBLE_TAP:["dblclick"],KEYBOARD:["keydown"]},je={};class gT{constructor(e){this.state={},this._events={},this._interactionState={isDragging:!1},this._customEvents=[],this._eventStartBlocked=null,this._panMove=!1,this.invertPan=!1,this.dragMode="rotate",this.inertia=0,this.scrollZoom=!0,this.dragPan=!0,this.dragRotate=!0,this.doubleClickZoom=!0,this.touchZoom=!0,this.touchRotate=!1,this.keyboard=!0,this.transitionManager=new lT({...e,getControllerState:s=>new this.ControllerState(s),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){var e;for(const s in this._events)this._events[s]&&((e=this.eventManager)==null||e.off(s,this.handleEvent));this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;const s=this._eventStartBlocked;switch(e.type){case"panstart":return s?!1:this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return s?!1:this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"tripanstart":return s?!1:this._onTriplePanStart(e);case"tripanmove":return this._onTriplePan(e);case"tripanend":return this._onTriplePanEnd(e);case"dblclick":return this._onDoubleTap(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){const{x:s,y:i}=this.props,{offsetCenter:r}=e;return[r.x-s,r.y-i]}isPointInBounds(e,s){const{width:i,height:r}=this.props;if(s&&s.handled)return!1;const n=e[0]>=0&&e[0]<=i&&e[1]>=0&&e[1]<=r;return n&&s&&s.stopPropagation(),n}isFunctionKeyPressed(e){const{srcEvent:s}=e;return!!(s.metaKey||s.altKey||s.ctrlKey||s.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){const s=setTimeout(()=>{this._eventStartBlocked===s&&(this._eventStartBlocked=null)},e);this._eventStartBlocked=s}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);const{inertia:s}=e;this.inertia=Number.isFinite(s)?s:s===!0?dT:0;const{scrollZoom:i=!0,dragPan:r=!0,dragRotate:n=!0,doubleClickZoom:o=!0,touchZoom:a=!0,touchRotate:c=!1,keyboard:l=!0}=e,h=!!this.onViewStateChange;this.toggleEvents(ft.WHEEL,h&&i),this.toggleEvents(ft.PAN,h),this.toggleEvents(ft.PINCH,h&&(a||c)),this.toggleEvents(ft.DOUBLE_PAN,h&&c),this.toggleEvents(ft.DOUBLE_TAP,h&&o),this.toggleEvents(ft.KEYBOARD,h&&l),this.scrollZoom=i,this.dragPan=r,this.dragRotate=n,this.doubleClickZoom=o,this.touchZoom=a,this.touchRotate=c,this.keyboard=l}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,s){this.eventManager&&e.forEach(i=>{this._events[i]!==s&&(this._events[i]=s,s?this.eventManager.on(i,this.handleEvent):this.eventManager.off(i,this.handleEvent))})}updateViewport(e,s=null,i={}){const r={...e.getViewportProps(),...s},n=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(i),n){const o=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:r,interactionState:this._interactionState,oldViewState:o,viewId:this.props.id})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState,viewId:this.props.id})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){const s=this.getCenter(e);if(!this.isPointInBounds(s,e))return!1;let i=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(i=!i);const r=this.controllerState[i?"panStart":"rotateStart"]({pos:s});return this._panMove=i,this.updateViewport(r,Oe,{isDragging:!0}),!0}_onPan(e){return this.isDragging()?this._panMove?this._onPanMove(e):this._onPanRotate(e):!1}_onPanEnd(e){return this.isDragging()?this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e):!1}_onPanMove(e){if(!this.dragPan)return!1;const s=this.getCenter(e),i=this.controllerState.pan({pos:s});return this.updateViewport(i,Oe,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){const{inertia:s}=this;if(this.dragPan&&s&&e.velocity){const i=this.getCenter(e),r=[i[0]+e.velocityX*s/2,i[1]+e.velocityY*s/2],n=this.controllerState.pan({pos:r}).panEnd();this.updateViewport(n,{...this._getTransitionProps(),transitionDuration:s,transitionEasing:Is},{isDragging:!1,isPanning:!0})}else{const i=this.controllerState.panEnd();this.updateViewport(i,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;const s=this.getCenter(e),i=this.controllerState.rotate({pos:s});return this.updateViewport(i,Oe,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){const{inertia:s}=this;if(this.dragRotate&&s&&e.velocity){const i=this.getCenter(e),r=[i[0]+e.velocityX*s/2,i[1]+e.velocityY*s/2],n=this.controllerState.rotate({pos:r}).rotateEnd();this.updateViewport(n,{...this._getTransitionProps(),transitionDuration:s,transitionEasing:Is},{isDragging:!1,isRotating:!0})}else{const i=this.controllerState.rotateEnd();this.updateViewport(i,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;const s=this.getCenter(e);if(!this.isPointInBounds(s,e))return!1;e.srcEvent.preventDefault();const{speed:i=.01,smooth:r=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:n}=e;let o=2/(1+Math.exp(-Math.abs(n*i)));n<0&&o!==0&&(o=1/o);const a=this.controllerState.zoom({pos:s,scale:o});return this.updateViewport(a,{...this._getTransitionProps({around:s}),transitionDuration:r?250:1},{isZooming:!0,isPanning:!0}),!0}_onTriplePanStart(e){const s=this.getCenter(e);if(!this.isPointInBounds(s,e))return!1;const i=this.controllerState.rotateStart({pos:s});return this.updateViewport(i,Oe,{isDragging:!0}),!0}_onTriplePan(e){if(!this.touchRotate||!this.isDragging())return!1;const s=this.getCenter(e);s[0]-=e.deltaX;const i=this.controllerState.rotate({pos:s});return this.updateViewport(i,Oe,{isDragging:!0,isRotating:!0}),!0}_onTriplePanEnd(e){if(!this.isDragging())return!1;const{inertia:s}=this;if(this.touchRotate&&s&&e.velocityY){const i=this.getCenter(e),r=[i[0],i[1]+=e.velocityY*s/2],n=this.controllerState.rotate({pos:r});this.updateViewport(n,{...this._getTransitionProps(),transitionDuration:s,transitionEasing:Is},{isDragging:!1,isRotating:!0}),this.blockEvents(s)}else{const i=this.controllerState.rotateEnd();this.updateViewport(i,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){const s=this.getCenter(e);if(!this.isPointInBounds(s,e))return!1;const i=this.controllerState.zoomStart({pos:s}).rotateStart({pos:s});return je._startPinchRotation=e.rotation,je._lastPinchEvent=e,this.updateViewport(i,Oe,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let s=this.controllerState;if(this.touchZoom){const{scale:i}=e,r=this.getCenter(e);s=s.zoom({pos:r,scale:i})}if(this.touchRotate){const{rotation:i}=e;s=s.rotate({deltaAngleX:je._startPinchRotation-i})}return this.updateViewport(s,Oe,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),je._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;const{inertia:s}=this,{_lastPinchEvent:i}=je;if(this.touchZoom&&s&&i&&e.scale!==i.scale){const r=this.getCenter(e);let n=this.controllerState.rotateEnd();const o=Math.log2(e.scale),a=(o-Math.log2(i.scale))/(e.deltaTime-i.deltaTime),c=Math.pow(2,o+a*s/2);n=n.zoom({pos:r,scale:c}).zoomEnd(),this.updateViewport(n,{...this._getTransitionProps({around:r}),transitionDuration:s,transitionEasing:Is},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(s)}else{const r=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(r,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return je._startPinchRotation=null,je._lastPinchEvent=null,!0}_onDoubleTap(e){if(!this.doubleClickZoom)return!1;const s=this.getCenter(e);if(!this.isPointInBounds(s,e))return!1;const i=this.isFunctionKeyPressed(e),r=this.controllerState.zoom({pos:s,scale:i?.5:2});return this.updateViewport(r,this._getTransitionProps({around:s}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){if(!this.keyboard)return!1;const s=this.isFunctionKeyPressed(e),{zoomSpeed:i,moveSpeed:r,rotateSpeedX:n,rotateSpeedY:o}=this.keyboard===!0?{}:this.keyboard,{controllerState:a}=this;let c;const l={};switch(e.srcEvent.code){case"Minus":c=s?a.zoomOut(i).zoomOut(i):a.zoomOut(i),l.isZooming=!0;break;case"Equal":c=s?a.zoomIn(i).zoomIn(i):a.zoomIn(i),l.isZooming=!0;break;case"ArrowLeft":s?(c=a.rotateLeft(n),l.isRotating=!0):(c=a.moveLeft(r),l.isPanning=!0);break;case"ArrowRight":s?(c=a.rotateRight(n),l.isRotating=!0):(c=a.moveRight(r),l.isPanning=!0);break;case"ArrowUp":s?(c=a.rotateUp(o),l.isRotating=!0):(c=a.moveUp(r),l.isPanning=!0);break;case"ArrowDown":s?(c=a.rotateDown(o),l.isRotating=!0):(c=a.moveDown(r),l.isPanning=!0);break;default:return!1}return this.updateViewport(c,this._getTransitionProps(),l),!0}_getTransitionProps(e){const{transition:s}=this;return!s||!s.transitionInterpolator?Oe:e?{...s,transitionInterpolator:new xh({...e,...s.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:s}}class pT{constructor(e,s){this._viewportProps=this.applyConstraints(e),this._state=s}getViewportProps(){return this._viewportProps}getState(){return this._state}}const Da=5,_T=1.2;class mT extends pT{constructor(e){const{width:s,height:i,latitude:r,longitude:n,zoom:o,bearing:a=0,pitch:c=0,altitude:l=1.5,position:h=[0,0,0],maxZoom:u=20,minZoom:f=0,maxPitch:p=60,minPitch:_=0,startPanLngLat:m,startZoomLngLat:T,startRotatePos:S,startBearing:v,startPitch:w,startZoom:E,normalize:R=!0}=e;te(Number.isFinite(n)),te(Number.isFinite(r)),te(Number.isFinite(o)),super({width:s,height:i,latitude:r,longitude:n,zoom:o,bearing:a,pitch:c,altitude:l,maxZoom:u,minZoom:f,maxPitch:p,minPitch:_,normalize:R,position:h},{startPanLngLat:m,startZoomLngLat:T,startRotatePos:S,startBearing:v,startPitch:w,startZoom:E}),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:s}){const i=this.getState().startPanLngLat||this._unproject(s);if(!i)return this;const n=this.makeViewport(this.getViewportProps()).panByPosition(i,e);return this._getUpdatedState(n)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:s=0,deltaAngleY:i=0}){const{startRotatePos:r,startBearing:n,startPitch:o}=this.getState();if(!r||n===void 0||o===void 0)return this;let a;return e?a=this._getNewRotation(e,r,o,n):a={bearing:n+s,pitch:o+i},this._getUpdatedState(a)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:s,scale:i}){let{startZoom:r,startZoomLngLat:n}=this.getState();if(n||(r=this.getViewportProps().zoom,n=this._unproject(s)||this._unproject(e)),!n)return this;const{maxZoom:o,minZoom:a}=this.getViewportProps();let c=r+Math.log2(i);c=Be(c,a,o);const l=this.makeViewport({...this.getViewportProps(),zoom:c});return this._getUpdatedState({zoom:c,...l.panByPosition(n,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){const s=e.getViewportProps(),i={...this.getViewportProps()},{bearing:r,longitude:n}=i;return Math.abs(r-s.bearing)>180&&(i.bearing=r<0?r+360:r-360),Math.abs(n-s.longitude)>180&&(i.longitude=n<0?n+360:n-360),i}applyConstraints(e){const{maxZoom:s,minZoom:i,zoom:r}=e;e.zoom=Be(r,i,s);const{maxPitch:n,minPitch:o,pitch:a}=e;e.pitch=Be(a,o,n);const{normalize:c=!0}=e;return c&&Object.assign(e,Wy(e)),e}_zoomFromCenter(e){const{width:s,height:i}=this.getViewportProps();return this.zoom({pos:[s/2,i/2],scale:e})}_panFromCenter(e){const{width:s,height:i}=this.getViewportProps();return this.pan({startPos:[s/2,i/2],pos:[s/2+e[0],i/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){const s=this.makeViewport(this.getViewportProps());return e&&s.unproject(e)}_getNewRotation(e,s,i,r){const n=e[0]-s[0],o=e[1]-s[1],a=e[1],c=s[1],{width:l,height:h}=this.getViewportProps(),u=n/l;let f=0;o>0?Math.abs(h-c)>Da&&(f=o/(c-h)*_T):o<0&&c>Da&&(f=1-a/c),f=Be(f,-1,1);const{minPitch:p,maxPitch:_}=this.getViewportProps(),m=r+180*u;let T=i;return f>0?T=i+f*(_-i):f<0&&(T=i-f*(p-i)),{pitch:T,bearing:m}}}class yT extends gT{constructor(){super(...arguments),this.ControllerState=mT,this.transition={transitionDuration:300,transitionInterpolator:new xh({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})},this.dragMode="pan"}setProps(e){e.position=e.position||[0,0,0];const s=this.props;super.setProps(e),(!s||s.height!==e.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}}class Ph extends oT{constructor(e={}){super(e)}get ViewportType(){return bh}get ControllerType(){return yT}}Ph.displayName="MapView";const bT=new gh;function TT(t,e){const s=t.order??1/0,i=e.order??1/0;return s-i}class AT{constructor(e){this._resolvedEffects=[],this._defaultEffects=[],this.effects=[],this._context=e,this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(e){const s=this._defaultEffects;if(!s.find(i=>i.id===e.id)){const i=s.findIndex(r=>TT(r,e)>0);i<0?s.push(e):s.splice(i,0,e),e.setup(this._context),this._setEffects(this.effects)}}setProps(e){"effects"in e&&(pe(e.effects,this.effects,1)||this._setEffects(e.effects))}needsRedraw(e={clearRedrawFlags:!1}){const s=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),s}getEffects(){return this._resolvedEffects}_setEffects(e){const s={};for(const r of this.effects)s[r.id]=r;const i=[];for(const r of e){const n=s[r.id];let o=r;n&&n!==r?n.setProps?(n.setProps(r.props),o=n):n.cleanup(this._context):n||r.setup(this._context),i.push(o),delete s[r.id]}for(const r in s)s[r].cleanup(this._context);this.effects=i,this._resolvedEffects=i.concat(this._defaultEffects),e.some(r=>r instanceof gh)||this._resolvedEffects.push(bT),this._needsRedraw="effects changed"}finalize(){for(const e of this._resolvedEffects)e.cleanup(this._context);this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}}class wT extends Xn{shouldDrawLayer(e){const{operation:s}=e.props;return s.includes("draw")||s.includes("terrain")}}const ST="deckRenderer.renderLayers";class ET{constructor(e){this.device=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new wT(e),this.pickLayersPass=new vh(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){if(!e.viewports.length)return;const s=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,i={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...e};i.effects&&this._preRender(i.effects,i);const r=this.lastPostProcessEffect?this.renderBuffers[0]:i.target;this.lastPostProcessEffect&&(i.clearColor=[0,0,0,0],i.clearCanvas=!0);const n=s.render({...i,target:r});i.effects&&this._postRender(i.effects,i),this.renderCount++,re(ST,this,n,e)}needsRedraw(e={clearRedrawFlags:!1}){const s=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),s}finalize(){const{renderBuffers:e}=this;for(const s of e)s.delete();e.length=0}_preRender(e,s){this.lastPostProcessEffect=null,s.preRenderStats=s.preRenderStats||{};for(const i of e)s.preRenderStats[i.id]=i.preRender(s),i.postRender&&(this.lastPostProcessEffect=i.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){const{renderBuffers:e}=this,s=this.device.canvasContext.getDrawingBufferSize();e.length===0&&[0,1].map(i=>{const r=this.device.createTexture({sampler:{minFilter:"linear",magFilter:"linear"}});e.push(this.device.createFramebuffer({id:`deck-renderbuffer-${i}`,colorAttachments:[r]}))});for(const i of e)i.resize(s)}_postRender(e,s){const{renderBuffers:i}=this,r={...s,inputBuffer:i[0],swapBuffer:i[1]};for(const n of e)if(n.postRender){r.target=n.id===this.lastPostProcessEffect?s.target:void 0;const o=n.postRender(r);r.inputBuffer=o,r.swapBuffer=o===i[0]?i[1]:i[0]}}}const vT={pickedColor:null,pickedObjectIndex:-1};function RT({pickedColors:t,decodePickingColor:e,deviceX:s,deviceY:i,deviceRadius:r,deviceRect:n}){const{x:o,y:a,width:c,height:l}=n;let h=r*r,u=-1,f=0;for(let p=0;p<l;p++){const _=p+a-i,m=_*_;if(m>h)f+=4*c;else for(let T=0;T<c;T++){if(t[f+3]-1>=0){const v=T+o-s,w=v*v+m;w<=h&&(h=w,u=f)}f+=4}}if(u>=0){const p=t.slice(u,u+4),_=e(p);if(_){const m=Math.floor(u/4/c),T=u/4-m*c;return{..._,pickedColor:p,pickedX:o+T,pickedY:a+m}}U.error("Picked non-existent layer. Is picking buffer corrupt?")()}return vT}function xT({pickedColors:t,decodePickingColor:e}){const s=new Map;if(t){for(let i=0;i<t.length;i+=4)if(t[i+3]-1>=0){const n=t.slice(i,i+4),o=n.join(",");if(!s.has(o)){const a=e(n);a?s.set(o,{...a,color:n}):U.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(s.values())}function Ch({pickInfo:t,viewports:e,pixelRatio:s,x:i,y:r,z:n}){let o=e[0];e.length>1&&(o=CT((t==null?void 0:t.pickedViewports)||e,{x:i,y:r}));let a;if(o){const c=[i-o.x,r-o.y];n!==void 0&&(c[2]=n),a=o.unproject(c)}return{color:null,layer:null,viewport:o,index:-1,picked:!1,x:i,y:r,pixel:[i,r],coordinate:a,devicePixel:t&&"pickedX"in t?[t.pickedX,t.pickedY]:void 0,pixelRatio:s}}function PT(t){const{pickInfo:e,lastPickedInfo:s,mode:i,layers:r}=t,{pickedColor:n,pickedLayer:o,pickedObjectIndex:a}=e,c=o?[o]:[];if(i==="hover"){const u=s.index,f=s.layerId,p=o?o.props.id:null;if(p!==f||a!==u){if(p!==f){const _=r.find(m=>m.props.id===f);_&&c.unshift(_)}s.layerId=p,s.index=a,s.info=null}}const l=Ch(t),h=new Map;return h.set(null,l),c.forEach(u=>{let f={...l};u===o&&(f.color=n,f.index=a,f.picked=!0),f=Ih({layer:u,info:f,mode:i});const p=f.layer;u===o&&i==="hover"&&(s.info=f),h.set(p.id,f),i==="hover"&&p.updateAutoHighlight(f)}),h}function Ih({layer:t,info:e,mode:s}){for(;t&&e;){const i=e.layer||null;e.sourceLayer=i,e.layer=t,e=t.getPickingInfo({info:e,mode:s,sourceLayer:i}),t=t.parent}return e}function CT(t,e){for(let s=t.length-1;s>=0;s--){const i=t[s];if(i.containsPixel(e))return i}return t[0]}class IT{constructor(e){this._pickable=!0,this.device=e,this.pickLayersPass=new vh(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.destroy(),this.depthFBO&&this.depthFBO.destroy()}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:s,layers:i,viewports:r},n=this.lastPickedInfo.info){const o=n&&n.layer&&n.layer.id,a=n&&n.viewport&&n.viewport.id,c=o?i.find(f=>f.id===o):null,l=a&&r.find(f=>f.id===a)||r[0],h=l&&l.unproject([e-l.x,s-l.y]);return{...n,...{x:e,y:s,viewport:l,coordinate:h,layer:c}}}_resizeBuffer(){var s,i;if(!this.pickingFBO&&(this.pickingFBO=this.device.createFramebuffer({colorAttachments:["rgba8unorm"],depthStencilAttachment:"depth16unorm"}),this.device.isTextureFormatRenderable("rgba32float"))){const r=this.device.createFramebuffer({colorAttachments:["rgba32float"],depthStencilAttachment:"depth16unorm"});this.depthFBO=r}const{canvas:e}=this.device.getCanvasContext();(s=this.pickingFBO)==null||s.resize({width:e.width,height:e.height}),(i=this.depthFBO)==null||i.resize({width:e.width,height:e.height})}_getPickable(e){if(this._pickable===!1)return null;const s=e.filter(i=>this.pickLayersPass.shouldDrawLayer(i)&&!i.isComposite);return s.length?s:null}_pickClosestObject({layers:e,views:s,viewports:i,x:r,y:n,radius:o=0,depth:a=1,mode:c="query",unproject3D:l,onViewportActive:h,effects:u}){const f=this.device.canvasContext.cssToDeviceRatio(),p=this._getPickable(e);if(!p||i.length===0)return{result:[],emptyInfo:Ch({viewports:i,x:r,y:n,pixelRatio:f})};this._resizeBuffer();const _=this.device.canvasContext.cssToDevicePixels([r,n],!0),m=[_.x+Math.floor(_.width/2),_.y+Math.floor(_.height/2)],T=Math.round(o*f),{width:S,height:v}=this.pickingFBO,w=this._getPickingRect({deviceX:m[0],deviceY:m[1],deviceRadius:T,deviceWidth:S,deviceHeight:v}),E={x:r-o,y:n-o,width:o*2+1,height:o*2+1};let R;const P=[],M=new Set;for(let C=0;C<a;C++){let I;if(w){const O=this._drawAndSample({layers:p,views:s,viewports:i,onViewportActive:h,deviceRect:w,cullRect:E,effects:u,pass:`picking:${c}`});I=RT({...O,deviceX:m[0],deviceY:m[1],deviceRadius:T,deviceRect:w})}else I={pickedColor:null,pickedObjectIndex:-1};let k;if(I.pickedLayer&&l&&this.depthFBO){const{pickedColors:O}=this._drawAndSample({layers:[I.pickedLayer],views:s,viewports:i,onViewportActive:h,deviceRect:{x:I.pickedX,y:I.pickedY,width:1,height:1},cullRect:E,effects:u,pass:`picking:${c}:z`},!0);O[3]&&(k=O[0])}I.pickedLayer&&C+1<a&&(M.add(I.pickedLayer),I.pickedLayer.disablePickingIndex(I.pickedObjectIndex)),R=PT({pickInfo:I,lastPickedInfo:this.lastPickedInfo,mode:c,layers:p,viewports:i,x:r,y:n,z:k,pixelRatio:f});for(const O of R.values())O.layer&&P.push(O);if(!I.pickedColor)break}for(const C of M)C.restorePickingColors();return{result:P,emptyInfo:R.get(null)}}_pickVisibleObjects({layers:e,views:s,viewports:i,x:r,y:n,width:o=1,height:a=1,mode:c="query",maxObjects:l=null,onViewportActive:h,effects:u}){const f=this._getPickable(e);if(!f||i.length===0)return[];this._resizeBuffer();const p=this.device.canvasContext.cssToDeviceRatio(),_=this.device.canvasContext.cssToDevicePixels([r,n],!0),m=_.x,T=_.y+_.height,S=this.device.canvasContext.cssToDevicePixels([r+o,n+a],!0),v=S.x+S.width,w=S.y,E={x:m,y:w,width:v-m,height:T-w},R=this._drawAndSample({layers:f,views:s,viewports:i,onViewportActive:h,deviceRect:E,cullRect:{x:r,y:n,width:o,height:a},effects:u,pass:`picking:${c}`}),P=xT(R),M=new Map,C=[],I=Number.isFinite(l);for(let k=0;k<P.length&&!(I&&C.length>=l);k++){const O=P[k];let F={color:O.pickedColor,layer:null,index:O.pickedObjectIndex,picked:!0,x:r,y:n,pixelRatio:p};F=Ih({layer:O.pickedLayer,info:F,mode:c});const D=F.layer.id;M.has(D)||M.set(D,new Set);const B=M.get(D),le=F.object??F.index;B.has(le)||(B.add(le),C.push(F))}return C}_drawAndSample({layers:e,views:s,viewports:i,onViewportActive:r,deviceRect:n,cullRect:o,effects:a,pass:c},l=!1){const h=l?this.depthFBO:this.pickingFBO,u={layers:e,layerFilter:this.layerFilter,views:s,viewports:i,onViewportActive:r,pickingFBO:h,deviceRect:n,cullRect:o,effects:a,pass:c,pickZ:l,preRenderStats:{}};for(const v of a)v.useInPicking&&(u.preRenderStats[v.id]=v.preRender(u));const{decodePickingColor:f}=this.pickLayersPass.render(u),{x:p,y:_,width:m,height:T}=n,S=new(l?Float32Array:Uint8Array)(m*T*4);return this.device.readPixelsToArrayWebGL(h,{sourceX:p,sourceY:_,sourceWidth:m,sourceHeight:T,target:S}),{pickedColors:S,decodePickingColor:f}}_getPickingRect({deviceX:e,deviceY:s,deviceRadius:i,deviceWidth:r,deviceHeight:n}){const o=Math.max(0,e-i),a=Math.max(0,s-i),c=Math.min(r,e+i+1)-o,l=Math.min(n,s+i+1)-a;return c<=0||l<=0?null:{x:o,y:a,width:c,height:l}}}const MT={"top-left":{top:0,left:0},"top-right":{top:0,right:0},"bottom-left":{bottom:0,left:0},"bottom-right":{bottom:0,right:0},fill:{top:0,left:0,bottom:0,right:0}},OT="top-left",Ba="__root";class NT{constructor({deck:e,parentElement:s}){this.defaultWidgets=[],this.widgets=[],this.resolvedWidgets=[],this.containers={},this.lastViewports={},this.deck=e,this.parentElement=s}getWidgets(){return this.resolvedWidgets}setProps(e){e.widgets&&!pe(e.widgets,this.widgets,1)&&this._setWidgets(e.widgets)}finalize(){for(const e of this.getWidgets())this._remove(e);this.defaultWidgets.length=0,this.resolvedWidgets.length=0;for(const e in this.containers)this.containers[e].remove()}addDefault(e){this.defaultWidgets.find(s=>s.id===e.id)||(this._add(e),this.defaultWidgets.push(e),this._setWidgets(this.widgets))}_setWidgets(e){const s={};for(const i of this.resolvedWidgets)s[i.id]=i;this.resolvedWidgets.length=0;for(const i of this.defaultWidgets)s[i.id]=null,this.resolvedWidgets.push(i);for(let i of e){const r=s[i.id];r?r.viewId!==i.viewId||r.placement!==i.placement?(this._remove(r),this._add(i)):i!==r&&(r.setProps(i.props),i=r):this._add(i),s[i.id]=null,this.resolvedWidgets.push(i)}for(const i in s){const r=s[i];r&&this._remove(r)}this.widgets=e}_add(e){const{viewId:s=null,placement:i=OT}=e,r=e.onAdd({deck:this.deck,viewId:s});r&&this._getContainer(s,i).append(r),e._element=r}_remove(e){e.onRemove(),e._element&&e._element.remove(),e._element=void 0}_getContainer(e,s){var o;const i=e||Ba;let r=this.containers[i];r||(r=document.createElement("div"),r.style.pointerEvents="none",r.style.position="absolute",r.style.overflow="hidden",(o=this.parentElement)==null||o.append(r),this.containers[i]=r);let n=r.querySelector(`.${s}`);return n||(n=document.createElement("div"),n.className=s,n.style.position="absolute",n.style.zIndex="2",Object.assign(n.style,MT[s]),r.append(n)),n}_updateContainers(){const e=this.deck.width,s=this.deck.height;for(const i in this.containers){const r=this.lastViewports[i]||null,n=i===Ba||r,o=this.containers[i];n?(o.style.display="block",o.style.left=`${r?r.x:0}px`,o.style.top=`${r?r.y:0}px`,o.style.width=`${r?r.width:e}px`,o.style.height=`${r?r.height:s}px`):o.style.display="none"}}onRedraw({viewports:e,layers:s}){var n,o;const i=e.reduce((a,c)=>(a[c.id]=c,a),{}),{lastViewports:r}=this;for(const a of this.getWidgets()){const{viewId:c}=a;if(c){const l=i[c];l&&(a.onViewportChange&&!l.equals(r[c])&&a.onViewportChange(l),(n=a.onRedraw)==null||n.call(a,{viewports:[l],layers:s}))}else{if(a.onViewportChange)for(const l of e)l.equals(r[l.id])||a.onViewportChange(l);(o=a.onRedraw)==null||o.call(a,{viewports:e,layers:s})}}this.lastViewports=i,this._updateContainers()}onHover(e,s){var i,r;for(const n of this.getWidgets()){const{viewId:o}=n;(!o||o===((i=e.viewport)==null?void 0:i.id))&&((r=n.onHover)==null||r.call(n,e,s))}}onEvent(e,s){var r,n;const i=cn[s.type];if(i)for(const o of this.getWidgets()){const{viewId:a}=o;(!a||a===((r=e.viewport)==null?void 0:r.id))&&((n=o[i.handler])==null||n.call(o,e,s))}}}const kT={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class FT{constructor(){this.id="default-tooltip",this.placement="fill",this.props={},this.isVisible=!1}onAdd({deck:e}){const s=document.createElement("div");return s.className="deck-tooltip",Object.assign(s.style,kT),this.deck=e,this.element=s,s}onRemove(){this.deck=void 0,this.element=void 0}setProps(){}onViewportChange(e){var s;this.isVisible&&e.id===((s=this.lastViewport)==null?void 0:s.id)&&e!==this.lastViewport&&this.setTooltip(null)}onHover(e){const{deck:s}=this,i=s&&s.props.getTooltip;if(!i)return;const r=i(e);this.lastViewport=e.viewport,this.setTooltip(r,e.x,e.y)}setTooltip(e,s,i){const r=this.element;if(r){if(typeof e=="string")r.innerText=e;else if(e)e.text&&(r.innerText=e.text),e.html&&(r.innerHTML=e.html),e.className&&(r.className=e.className);else{this.isVisible=!1,r.style.display="none";return}this.isVisible=!0,r.style.display="block",r.style.transform=`translate(${s}px, ${i}px)`,e&&typeof e=="object"&&"style"in e&&Object.assign(r.style,e.style)}}}var ae;(function(t){t[t.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",t[t.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",t[t.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT",t[t.POINTS=0]="POINTS",t[t.LINES=1]="LINES",t[t.LINE_LOOP=2]="LINE_LOOP",t[t.LINE_STRIP=3]="LINE_STRIP",t[t.TRIANGLES=4]="TRIANGLES",t[t.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=6]="TRIANGLE_FAN",t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_COLOR=768]="SRC_COLOR",t[t.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",t[t.SRC_ALPHA=770]="SRC_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",t[t.DST_ALPHA=772]="DST_ALPHA",t[t.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",t[t.DST_COLOR=774]="DST_COLOR",t[t.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",t[t.CONSTANT_COLOR=32769]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",t[t.FUNC_ADD=32774]="FUNC_ADD",t[t.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",t[t.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",t[t.BLEND_EQUATION=32777]="BLEND_EQUATION",t[t.BLEND_EQUATION_RGB=32777]="BLEND_EQUATION_RGB",t[t.BLEND_EQUATION_ALPHA=34877]="BLEND_EQUATION_ALPHA",t[t.BLEND_DST_RGB=32968]="BLEND_DST_RGB",t[t.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",t[t.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",t[t.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",t[t.BLEND_COLOR=32773]="BLEND_COLOR",t[t.ARRAY_BUFFER_BINDING=34964]="ARRAY_BUFFER_BINDING",t[t.ELEMENT_ARRAY_BUFFER_BINDING=34965]="ELEMENT_ARRAY_BUFFER_BINDING",t[t.LINE_WIDTH=2849]="LINE_WIDTH",t[t.ALIASED_POINT_SIZE_RANGE=33901]="ALIASED_POINT_SIZE_RANGE",t[t.ALIASED_LINE_WIDTH_RANGE=33902]="ALIASED_LINE_WIDTH_RANGE",t[t.CULL_FACE_MODE=2885]="CULL_FACE_MODE",t[t.FRONT_FACE=2886]="FRONT_FACE",t[t.DEPTH_RANGE=2928]="DEPTH_RANGE",t[t.DEPTH_WRITEMASK=2930]="DEPTH_WRITEMASK",t[t.DEPTH_CLEAR_VALUE=2931]="DEPTH_CLEAR_VALUE",t[t.DEPTH_FUNC=2932]="DEPTH_FUNC",t[t.STENCIL_CLEAR_VALUE=2961]="STENCIL_CLEAR_VALUE",t[t.STENCIL_FUNC=2962]="STENCIL_FUNC",t[t.STENCIL_FAIL=2964]="STENCIL_FAIL",t[t.STENCIL_PASS_DEPTH_FAIL=2965]="STENCIL_PASS_DEPTH_FAIL",t[t.STENCIL_PASS_DEPTH_PASS=2966]="STENCIL_PASS_DEPTH_PASS",t[t.STENCIL_REF=2967]="STENCIL_REF",t[t.STENCIL_VALUE_MASK=2963]="STENCIL_VALUE_MASK",t[t.STENCIL_WRITEMASK=2968]="STENCIL_WRITEMASK",t[t.STENCIL_BACK_FUNC=34816]="STENCIL_BACK_FUNC",t[t.STENCIL_BACK_FAIL=34817]="STENCIL_BACK_FAIL",t[t.STENCIL_BACK_PASS_DEPTH_FAIL=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",t[t.STENCIL_BACK_PASS_DEPTH_PASS=34819]="STENCIL_BACK_PASS_DEPTH_PASS",t[t.STENCIL_BACK_REF=36003]="STENCIL_BACK_REF",t[t.STENCIL_BACK_VALUE_MASK=36004]="STENCIL_BACK_VALUE_MASK",t[t.STENCIL_BACK_WRITEMASK=36005]="STENCIL_BACK_WRITEMASK",t[t.VIEWPORT=2978]="VIEWPORT",t[t.SCISSOR_BOX=3088]="SCISSOR_BOX",t[t.COLOR_CLEAR_VALUE=3106]="COLOR_CLEAR_VALUE",t[t.COLOR_WRITEMASK=3107]="COLOR_WRITEMASK",t[t.UNPACK_ALIGNMENT=3317]="UNPACK_ALIGNMENT",t[t.PACK_ALIGNMENT=3333]="PACK_ALIGNMENT",t[t.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",t[t.MAX_VIEWPORT_DIMS=3386]="MAX_VIEWPORT_DIMS",t[t.SUBPIXEL_BITS=3408]="SUBPIXEL_BITS",t[t.RED_BITS=3410]="RED_BITS",t[t.GREEN_BITS=3411]="GREEN_BITS",t[t.BLUE_BITS=3412]="BLUE_BITS",t[t.ALPHA_BITS=3413]="ALPHA_BITS",t[t.DEPTH_BITS=3414]="DEPTH_BITS",t[t.STENCIL_BITS=3415]="STENCIL_BITS",t[t.POLYGON_OFFSET_UNITS=10752]="POLYGON_OFFSET_UNITS",t[t.POLYGON_OFFSET_FACTOR=32824]="POLYGON_OFFSET_FACTOR",t[t.TEXTURE_BINDING_2D=32873]="TEXTURE_BINDING_2D",t[t.SAMPLE_BUFFERS=32936]="SAMPLE_BUFFERS",t[t.SAMPLES=32937]="SAMPLES",t[t.SAMPLE_COVERAGE_VALUE=32938]="SAMPLE_COVERAGE_VALUE",t[t.SAMPLE_COVERAGE_INVERT=32939]="SAMPLE_COVERAGE_INVERT",t[t.COMPRESSED_TEXTURE_FORMATS=34467]="COMPRESSED_TEXTURE_FORMATS",t[t.VENDOR=7936]="VENDOR",t[t.RENDERER=7937]="RENDERER",t[t.VERSION=7938]="VERSION",t[t.IMPLEMENTATION_COLOR_READ_TYPE=35738]="IMPLEMENTATION_COLOR_READ_TYPE",t[t.IMPLEMENTATION_COLOR_READ_FORMAT=35739]="IMPLEMENTATION_COLOR_READ_FORMAT",t[t.BROWSER_DEFAULT_WEBGL=37444]="BROWSER_DEFAULT_WEBGL",t[t.STATIC_DRAW=35044]="STATIC_DRAW",t[t.STREAM_DRAW=35040]="STREAM_DRAW",t[t.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",t[t.BUFFER_SIZE=34660]="BUFFER_SIZE",t[t.BUFFER_USAGE=34661]="BUFFER_USAGE",t[t.CURRENT_VERTEX_ATTRIB=34342]="CURRENT_VERTEX_ATTRIB",t[t.VERTEX_ATTRIB_ARRAY_ENABLED=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",t[t.VERTEX_ATTRIB_ARRAY_SIZE=34339]="VERTEX_ATTRIB_ARRAY_SIZE",t[t.VERTEX_ATTRIB_ARRAY_STRIDE=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",t[t.VERTEX_ATTRIB_ARRAY_TYPE=34341]="VERTEX_ATTRIB_ARRAY_TYPE",t[t.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",t[t.VERTEX_ATTRIB_ARRAY_POINTER=34373]="VERTEX_ATTRIB_ARRAY_POINTER",t[t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",t[t.CULL_FACE=2884]="CULL_FACE",t[t.FRONT=1028]="FRONT",t[t.BACK=1029]="BACK",t[t.FRONT_AND_BACK=1032]="FRONT_AND_BACK",t[t.BLEND=3042]="BLEND",t[t.DEPTH_TEST=2929]="DEPTH_TEST",t[t.DITHER=3024]="DITHER",t[t.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",t[t.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",t[t.SAMPLE_COVERAGE=32928]="SAMPLE_COVERAGE",t[t.SCISSOR_TEST=3089]="SCISSOR_TEST",t[t.STENCIL_TEST=2960]="STENCIL_TEST",t[t.NO_ERROR=0]="NO_ERROR",t[t.INVALID_ENUM=1280]="INVALID_ENUM",t[t.INVALID_VALUE=1281]="INVALID_VALUE",t[t.INVALID_OPERATION=1282]="INVALID_OPERATION",t[t.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",t[t.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",t[t.CW=2304]="CW",t[t.CCW=2305]="CCW",t[t.DONT_CARE=4352]="DONT_CARE",t[t.FASTEST=4353]="FASTEST",t[t.NICEST=4354]="NICEST",t[t.GENERATE_MIPMAP_HINT=33170]="GENERATE_MIPMAP_HINT",t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.INT=5124]="INT",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.FLOAT=5126]="FLOAT",t[t.DOUBLE=5130]="DOUBLE",t[t.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",t[t.ALPHA=6406]="ALPHA",t[t.RGB=6407]="RGB",t[t.RGBA=6408]="RGBA",t[t.LUMINANCE=6409]="LUMINANCE",t[t.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",t[t.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",t[t.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",t[t.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",t[t.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",t[t.VERTEX_SHADER=35633]="VERTEX_SHADER",t[t.COMPILE_STATUS=35713]="COMPILE_STATUS",t[t.DELETE_STATUS=35712]="DELETE_STATUS",t[t.LINK_STATUS=35714]="LINK_STATUS",t[t.VALIDATE_STATUS=35715]="VALIDATE_STATUS",t[t.ATTACHED_SHADERS=35717]="ATTACHED_SHADERS",t[t.ACTIVE_ATTRIBUTES=35721]="ACTIVE_ATTRIBUTES",t[t.ACTIVE_UNIFORMS=35718]="ACTIVE_UNIFORMS",t[t.MAX_VERTEX_ATTRIBS=34921]="MAX_VERTEX_ATTRIBS",t[t.MAX_VERTEX_UNIFORM_VECTORS=36347]="MAX_VERTEX_UNIFORM_VECTORS",t[t.MAX_VARYING_VECTORS=36348]="MAX_VARYING_VECTORS",t[t.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",t[t.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",t[t.MAX_TEXTURE_IMAGE_UNITS=34930]="MAX_TEXTURE_IMAGE_UNITS",t[t.MAX_FRAGMENT_UNIFORM_VECTORS=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",t[t.SHADER_TYPE=35663]="SHADER_TYPE",t[t.SHADING_LANGUAGE_VERSION=35724]="SHADING_LANGUAGE_VERSION",t[t.CURRENT_PROGRAM=35725]="CURRENT_PROGRAM",t[t.NEVER=512]="NEVER",t[t.LESS=513]="LESS",t[t.EQUAL=514]="EQUAL",t[t.LEQUAL=515]="LEQUAL",t[t.GREATER=516]="GREATER",t[t.NOTEQUAL=517]="NOTEQUAL",t[t.GEQUAL=518]="GEQUAL",t[t.ALWAYS=519]="ALWAYS",t[t.KEEP=7680]="KEEP",t[t.REPLACE=7681]="REPLACE",t[t.INCR=7682]="INCR",t[t.DECR=7683]="DECR",t[t.INVERT=5386]="INVERT",t[t.INCR_WRAP=34055]="INCR_WRAP",t[t.DECR_WRAP=34056]="DECR_WRAP",t[t.NEAREST=9728]="NEAREST",t[t.LINEAR=9729]="LINEAR",t[t.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",t[t.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",t[t.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",t[t.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",t[t.TEXTURE_MAG_FILTER=10240]="TEXTURE_MAG_FILTER",t[t.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",t[t.TEXTURE_WRAP_S=10242]="TEXTURE_WRAP_S",t[t.TEXTURE_WRAP_T=10243]="TEXTURE_WRAP_T",t[t.TEXTURE_2D=3553]="TEXTURE_2D",t[t.TEXTURE=5890]="TEXTURE",t[t.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",t[t.TEXTURE_BINDING_CUBE_MAP=34068]="TEXTURE_BINDING_CUBE_MAP",t[t.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",t[t.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",t[t.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",t[t.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",t[t.MAX_CUBE_MAP_TEXTURE_SIZE=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",t[t.TEXTURE0=33984]="TEXTURE0",t[t.ACTIVE_TEXTURE=34016]="ACTIVE_TEXTURE",t[t.REPEAT=10497]="REPEAT",t[t.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",t[t.TEXTURE_WIDTH=4096]="TEXTURE_WIDTH",t[t.TEXTURE_HEIGHT=4097]="TEXTURE_HEIGHT",t[t.FLOAT_VEC2=35664]="FLOAT_VEC2",t[t.FLOAT_VEC3=35665]="FLOAT_VEC3",t[t.FLOAT_VEC4=35666]="FLOAT_VEC4",t[t.INT_VEC2=35667]="INT_VEC2",t[t.INT_VEC3=35668]="INT_VEC3",t[t.INT_VEC4=35669]="INT_VEC4",t[t.BOOL=35670]="BOOL",t[t.BOOL_VEC2=35671]="BOOL_VEC2",t[t.BOOL_VEC3=35672]="BOOL_VEC3",t[t.BOOL_VEC4=35673]="BOOL_VEC4",t[t.FLOAT_MAT2=35674]="FLOAT_MAT2",t[t.FLOAT_MAT3=35675]="FLOAT_MAT3",t[t.FLOAT_MAT4=35676]="FLOAT_MAT4",t[t.SAMPLER_2D=35678]="SAMPLER_2D",t[t.SAMPLER_CUBE=35680]="SAMPLER_CUBE",t[t.LOW_FLOAT=36336]="LOW_FLOAT",t[t.MEDIUM_FLOAT=36337]="MEDIUM_FLOAT",t[t.HIGH_FLOAT=36338]="HIGH_FLOAT",t[t.LOW_INT=36339]="LOW_INT",t[t.MEDIUM_INT=36340]="MEDIUM_INT",t[t.HIGH_INT=36341]="HIGH_INT",t[t.FRAMEBUFFER=36160]="FRAMEBUFFER",t[t.RENDERBUFFER=36161]="RENDERBUFFER",t[t.RGBA4=32854]="RGBA4",t[t.RGB5_A1=32855]="RGB5_A1",t[t.RGB565=36194]="RGB565",t[t.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",t[t.STENCIL_INDEX=6401]="STENCIL_INDEX",t[t.STENCIL_INDEX8=36168]="STENCIL_INDEX8",t[t.DEPTH_STENCIL=34041]="DEPTH_STENCIL",t[t.RENDERBUFFER_WIDTH=36162]="RENDERBUFFER_WIDTH",t[t.RENDERBUFFER_HEIGHT=36163]="RENDERBUFFER_HEIGHT",t[t.RENDERBUFFER_INTERNAL_FORMAT=36164]="RENDERBUFFER_INTERNAL_FORMAT",t[t.RENDERBUFFER_RED_SIZE=36176]="RENDERBUFFER_RED_SIZE",t[t.RENDERBUFFER_GREEN_SIZE=36177]="RENDERBUFFER_GREEN_SIZE",t[t.RENDERBUFFER_BLUE_SIZE=36178]="RENDERBUFFER_BLUE_SIZE",t[t.RENDERBUFFER_ALPHA_SIZE=36179]="RENDERBUFFER_ALPHA_SIZE",t[t.RENDERBUFFER_DEPTH_SIZE=36180]="RENDERBUFFER_DEPTH_SIZE",t[t.RENDERBUFFER_STENCIL_SIZE=36181]="RENDERBUFFER_STENCIL_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",t[t.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",t[t.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",t[t.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",t[t.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",t[t.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",t[t.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",t[t.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",t[t.NONE=0]="NONE",t[t.FRAMEBUFFER_COMPLETE=36053]="FRAMEBUFFER_COMPLETE",t[t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",t[t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",t[t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",t[t.FRAMEBUFFER_UNSUPPORTED=36061]="FRAMEBUFFER_UNSUPPORTED",t[t.FRAMEBUFFER_BINDING=36006]="FRAMEBUFFER_BINDING",t[t.RENDERBUFFER_BINDING=36007]="RENDERBUFFER_BINDING",t[t.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",t[t.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",t[t.MAX_RENDERBUFFER_SIZE=34024]="MAX_RENDERBUFFER_SIZE",t[t.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",t[t.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL",t[t.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",t[t.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",t[t.READ_BUFFER=3074]="READ_BUFFER",t[t.UNPACK_ROW_LENGTH=3314]="UNPACK_ROW_LENGTH",t[t.UNPACK_SKIP_ROWS=3315]="UNPACK_SKIP_ROWS",t[t.UNPACK_SKIP_PIXELS=3316]="UNPACK_SKIP_PIXELS",t[t.PACK_ROW_LENGTH=3330]="PACK_ROW_LENGTH",t[t.PACK_SKIP_ROWS=3331]="PACK_SKIP_ROWS",t[t.PACK_SKIP_PIXELS=3332]="PACK_SKIP_PIXELS",t[t.TEXTURE_BINDING_3D=32874]="TEXTURE_BINDING_3D",t[t.UNPACK_SKIP_IMAGES=32877]="UNPACK_SKIP_IMAGES",t[t.UNPACK_IMAGE_HEIGHT=32878]="UNPACK_IMAGE_HEIGHT",t[t.MAX_3D_TEXTURE_SIZE=32883]="MAX_3D_TEXTURE_SIZE",t[t.MAX_ELEMENTS_VERTICES=33e3]="MAX_ELEMENTS_VERTICES",t[t.MAX_ELEMENTS_INDICES=33001]="MAX_ELEMENTS_INDICES",t[t.MAX_TEXTURE_LOD_BIAS=34045]="MAX_TEXTURE_LOD_BIAS",t[t.MAX_FRAGMENT_UNIFORM_COMPONENTS=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",t[t.MAX_VERTEX_UNIFORM_COMPONENTS=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",t[t.MAX_ARRAY_TEXTURE_LAYERS=35071]="MAX_ARRAY_TEXTURE_LAYERS",t[t.MIN_PROGRAM_TEXEL_OFFSET=35076]="MIN_PROGRAM_TEXEL_OFFSET",t[t.MAX_PROGRAM_TEXEL_OFFSET=35077]="MAX_PROGRAM_TEXEL_OFFSET",t[t.MAX_VARYING_COMPONENTS=35659]="MAX_VARYING_COMPONENTS",t[t.FRAGMENT_SHADER_DERIVATIVE_HINT=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",t[t.RASTERIZER_DISCARD=35977]="RASTERIZER_DISCARD",t[t.VERTEX_ARRAY_BINDING=34229]="VERTEX_ARRAY_BINDING",t[t.MAX_VERTEX_OUTPUT_COMPONENTS=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",t[t.MAX_FRAGMENT_INPUT_COMPONENTS=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",t[t.MAX_SERVER_WAIT_TIMEOUT=37137]="MAX_SERVER_WAIT_TIMEOUT",t[t.MAX_ELEMENT_INDEX=36203]="MAX_ELEMENT_INDEX",t[t.RED=6403]="RED",t[t.RGB8=32849]="RGB8",t[t.RGBA8=32856]="RGBA8",t[t.RGB10_A2=32857]="RGB10_A2",t[t.TEXTURE_3D=32879]="TEXTURE_3D",t[t.TEXTURE_WRAP_R=32882]="TEXTURE_WRAP_R",t[t.TEXTURE_MIN_LOD=33082]="TEXTURE_MIN_LOD",t[t.TEXTURE_MAX_LOD=33083]="TEXTURE_MAX_LOD",t[t.TEXTURE_BASE_LEVEL=33084]="TEXTURE_BASE_LEVEL",t[t.TEXTURE_MAX_LEVEL=33085]="TEXTURE_MAX_LEVEL",t[t.TEXTURE_COMPARE_MODE=34892]="TEXTURE_COMPARE_MODE",t[t.TEXTURE_COMPARE_FUNC=34893]="TEXTURE_COMPARE_FUNC",t[t.SRGB=35904]="SRGB",t[t.SRGB8=35905]="SRGB8",t[t.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",t[t.COMPARE_REF_TO_TEXTURE=34894]="COMPARE_REF_TO_TEXTURE",t[t.RGBA32F=34836]="RGBA32F",t[t.RGB32F=34837]="RGB32F",t[t.RGBA16F=34842]="RGBA16F",t[t.RGB16F=34843]="RGB16F",t[t.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",t[t.TEXTURE_BINDING_2D_ARRAY=35869]="TEXTURE_BINDING_2D_ARRAY",t[t.R11F_G11F_B10F=35898]="R11F_G11F_B10F",t[t.RGB9_E5=35901]="RGB9_E5",t[t.RGBA32UI=36208]="RGBA32UI",t[t.RGB32UI=36209]="RGB32UI",t[t.RGBA16UI=36214]="RGBA16UI",t[t.RGB16UI=36215]="RGB16UI",t[t.RGBA8UI=36220]="RGBA8UI",t[t.RGB8UI=36221]="RGB8UI",t[t.RGBA32I=36226]="RGBA32I",t[t.RGB32I=36227]="RGB32I",t[t.RGBA16I=36232]="RGBA16I",t[t.RGB16I=36233]="RGB16I",t[t.RGBA8I=36238]="RGBA8I",t[t.RGB8I=36239]="RGB8I",t[t.RED_INTEGER=36244]="RED_INTEGER",t[t.RGB_INTEGER=36248]="RGB_INTEGER",t[t.RGBA_INTEGER=36249]="RGBA_INTEGER",t[t.R8=33321]="R8",t[t.RG8=33323]="RG8",t[t.R16F=33325]="R16F",t[t.R32F=33326]="R32F",t[t.RG16F=33327]="RG16F",t[t.RG32F=33328]="RG32F",t[t.R8I=33329]="R8I",t[t.R8UI=33330]="R8UI",t[t.R16I=33331]="R16I",t[t.R16UI=33332]="R16UI",t[t.R32I=33333]="R32I",t[t.R32UI=33334]="R32UI",t[t.RG8I=33335]="RG8I",t[t.RG8UI=33336]="RG8UI",t[t.RG16I=33337]="RG16I",t[t.RG16UI=33338]="RG16UI",t[t.RG32I=33339]="RG32I",t[t.RG32UI=33340]="RG32UI",t[t.R8_SNORM=36756]="R8_SNORM",t[t.RG8_SNORM=36757]="RG8_SNORM",t[t.RGB8_SNORM=36758]="RGB8_SNORM",t[t.RGBA8_SNORM=36759]="RGBA8_SNORM",t[t.RGB10_A2UI=36975]="RGB10_A2UI",t[t.TEXTURE_IMMUTABLE_FORMAT=37167]="TEXTURE_IMMUTABLE_FORMAT",t[t.TEXTURE_IMMUTABLE_LEVELS=33503]="TEXTURE_IMMUTABLE_LEVELS",t[t.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",t[t.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",t[t.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",t[t.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",t[t.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",t[t.HALF_FLOAT=5131]="HALF_FLOAT",t[t.RG=33319]="RG",t[t.RG_INTEGER=33320]="RG_INTEGER",t[t.INT_2_10_10_10_REV=36255]="INT_2_10_10_10_REV",t[t.CURRENT_QUERY=34917]="CURRENT_QUERY",t[t.QUERY_RESULT=34918]="QUERY_RESULT",t[t.QUERY_RESULT_AVAILABLE=34919]="QUERY_RESULT_AVAILABLE",t[t.ANY_SAMPLES_PASSED=35887]="ANY_SAMPLES_PASSED",t[t.ANY_SAMPLES_PASSED_CONSERVATIVE=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",t[t.MAX_DRAW_BUFFERS=34852]="MAX_DRAW_BUFFERS",t[t.DRAW_BUFFER0=34853]="DRAW_BUFFER0",t[t.DRAW_BUFFER1=34854]="DRAW_BUFFER1",t[t.DRAW_BUFFER2=34855]="DRAW_BUFFER2",t[t.DRAW_BUFFER3=34856]="DRAW_BUFFER3",t[t.DRAW_BUFFER4=34857]="DRAW_BUFFER4",t[t.DRAW_BUFFER5=34858]="DRAW_BUFFER5",t[t.DRAW_BUFFER6=34859]="DRAW_BUFFER6",t[t.DRAW_BUFFER7=34860]="DRAW_BUFFER7",t[t.DRAW_BUFFER8=34861]="DRAW_BUFFER8",t[t.DRAW_BUFFER9=34862]="DRAW_BUFFER9",t[t.DRAW_BUFFER10=34863]="DRAW_BUFFER10",t[t.DRAW_BUFFER11=34864]="DRAW_BUFFER11",t[t.DRAW_BUFFER12=34865]="DRAW_BUFFER12",t[t.DRAW_BUFFER13=34866]="DRAW_BUFFER13",t[t.DRAW_BUFFER14=34867]="DRAW_BUFFER14",t[t.DRAW_BUFFER15=34868]="DRAW_BUFFER15",t[t.MAX_COLOR_ATTACHMENTS=36063]="MAX_COLOR_ATTACHMENTS",t[t.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",t[t.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",t[t.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",t[t.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",t[t.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",t[t.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",t[t.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",t[t.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",t[t.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",t[t.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",t[t.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",t[t.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",t[t.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",t[t.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",t[t.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15",t[t.SAMPLER_3D=35679]="SAMPLER_3D",t[t.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",t[t.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",t[t.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",t[t.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",t[t.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",t[t.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",t[t.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",t[t.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",t[t.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",t[t.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",t[t.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",t[t.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",t[t.MAX_SAMPLES=36183]="MAX_SAMPLES",t[t.SAMPLER_BINDING=35097]="SAMPLER_BINDING",t[t.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",t[t.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",t[t.PIXEL_PACK_BUFFER_BINDING=35053]="PIXEL_PACK_BUFFER_BINDING",t[t.PIXEL_UNPACK_BUFFER_BINDING=35055]="PIXEL_UNPACK_BUFFER_BINDING",t[t.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",t[t.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",t[t.COPY_READ_BUFFER_BINDING=36662]="COPY_READ_BUFFER_BINDING",t[t.COPY_WRITE_BUFFER_BINDING=36663]="COPY_WRITE_BUFFER_BINDING",t[t.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",t[t.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",t[t.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",t[t.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",t[t.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",t[t.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",t[t.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",t[t.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",t[t.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",t[t.UNSIGNED_NORMALIZED=35863]="UNSIGNED_NORMALIZED",t[t.SIGNED_NORMALIZED=36764]="SIGNED_NORMALIZED",t[t.VERTEX_ATTRIB_ARRAY_INTEGER=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",t[t.VERTEX_ATTRIB_ARRAY_DIVISOR=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",t[t.TRANSFORM_FEEDBACK_BUFFER_MODE=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",t[t.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",t[t.TRANSFORM_FEEDBACK_VARYINGS=35971]="TRANSFORM_FEEDBACK_VARYINGS",t[t.TRANSFORM_FEEDBACK_BUFFER_START=35972]="TRANSFORM_FEEDBACK_BUFFER_START",t[t.TRANSFORM_FEEDBACK_BUFFER_SIZE=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",t[t.TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",t[t.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",t[t.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",t[t.INTERLEAVED_ATTRIBS=35980]="INTERLEAVED_ATTRIBS",t[t.SEPARATE_ATTRIBS=35981]="SEPARATE_ATTRIBS",t[t.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",t[t.TRANSFORM_FEEDBACK_BUFFER_BINDING=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",t[t.TRANSFORM_FEEDBACK=36386]="TRANSFORM_FEEDBACK",t[t.TRANSFORM_FEEDBACK_PAUSED=36387]="TRANSFORM_FEEDBACK_PAUSED",t[t.TRANSFORM_FEEDBACK_ACTIVE=36388]="TRANSFORM_FEEDBACK_ACTIVE",t[t.TRANSFORM_FEEDBACK_BINDING=36389]="TRANSFORM_FEEDBACK_BINDING",t[t.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",t[t.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",t[t.FRAMEBUFFER_ATTACHMENT_RED_SIZE=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_GREEN_SIZE=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_BLUE_SIZE=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",t[t.FRAMEBUFFER_DEFAULT=33304]="FRAMEBUFFER_DEFAULT",t[t.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",t[t.DRAW_FRAMEBUFFER_BINDING=36006]="DRAW_FRAMEBUFFER_BINDING",t[t.READ_FRAMEBUFFER_BINDING=36010]="READ_FRAMEBUFFER_BINDING",t[t.RENDERBUFFER_SAMPLES=36011]="RENDERBUFFER_SAMPLES",t[t.FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",t[t.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",t[t.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",t[t.UNIFORM_BUFFER_BINDING=35368]="UNIFORM_BUFFER_BINDING",t[t.UNIFORM_BUFFER_START=35369]="UNIFORM_BUFFER_START",t[t.UNIFORM_BUFFER_SIZE=35370]="UNIFORM_BUFFER_SIZE",t[t.MAX_VERTEX_UNIFORM_BLOCKS=35371]="MAX_VERTEX_UNIFORM_BLOCKS",t[t.MAX_FRAGMENT_UNIFORM_BLOCKS=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",t[t.MAX_COMBINED_UNIFORM_BLOCKS=35374]="MAX_COMBINED_UNIFORM_BLOCKS",t[t.MAX_UNIFORM_BUFFER_BINDINGS=35375]="MAX_UNIFORM_BUFFER_BINDINGS",t[t.MAX_UNIFORM_BLOCK_SIZE=35376]="MAX_UNIFORM_BLOCK_SIZE",t[t.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",t[t.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",t[t.UNIFORM_BUFFER_OFFSET_ALIGNMENT=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",t[t.ACTIVE_UNIFORM_BLOCKS=35382]="ACTIVE_UNIFORM_BLOCKS",t[t.UNIFORM_TYPE=35383]="UNIFORM_TYPE",t[t.UNIFORM_SIZE=35384]="UNIFORM_SIZE",t[t.UNIFORM_BLOCK_INDEX=35386]="UNIFORM_BLOCK_INDEX",t[t.UNIFORM_OFFSET=35387]="UNIFORM_OFFSET",t[t.UNIFORM_ARRAY_STRIDE=35388]="UNIFORM_ARRAY_STRIDE",t[t.UNIFORM_MATRIX_STRIDE=35389]="UNIFORM_MATRIX_STRIDE",t[t.UNIFORM_IS_ROW_MAJOR=35390]="UNIFORM_IS_ROW_MAJOR",t[t.UNIFORM_BLOCK_BINDING=35391]="UNIFORM_BLOCK_BINDING",t[t.UNIFORM_BLOCK_DATA_SIZE=35392]="UNIFORM_BLOCK_DATA_SIZE",t[t.UNIFORM_BLOCK_ACTIVE_UNIFORMS=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",t[t.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",t[t.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",t[t.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",t[t.OBJECT_TYPE=37138]="OBJECT_TYPE",t[t.SYNC_CONDITION=37139]="SYNC_CONDITION",t[t.SYNC_STATUS=37140]="SYNC_STATUS",t[t.SYNC_FLAGS=37141]="SYNC_FLAGS",t[t.SYNC_FENCE=37142]="SYNC_FENCE",t[t.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",t[t.UNSIGNALED=37144]="UNSIGNALED",t[t.SIGNALED=37145]="SIGNALED",t[t.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",t[t.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",t[t.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",t[t.WAIT_FAILED=37149]="WAIT_FAILED",t[t.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",t[t.COLOR=6144]="COLOR",t[t.DEPTH=6145]="DEPTH",t[t.STENCIL=6146]="STENCIL",t[t.MIN=32775]="MIN",t[t.MAX=32776]="MAX",t[t.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",t[t.STREAM_READ=35041]="STREAM_READ",t[t.STREAM_COPY=35042]="STREAM_COPY",t[t.STATIC_READ=35045]="STATIC_READ",t[t.STATIC_COPY=35046]="STATIC_COPY",t[t.DYNAMIC_READ=35049]="DYNAMIC_READ",t[t.DYNAMIC_COPY=35050]="DYNAMIC_COPY",t[t.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",t[t.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",t[t.INVALID_INDEX=4294967295]="INVALID_INDEX",t[t.TIMEOUT_IGNORED=-1]="TIMEOUT_IGNORED",t[t.MAX_CLIENT_WAIT_TIMEOUT_WEBGL=37447]="MAX_CLIENT_WAIT_TIMEOUT_WEBGL",t[t.UNMASKED_VENDOR_WEBGL=37445]="UNMASKED_VENDOR_WEBGL",t[t.UNMASKED_RENDERER_WEBGL=37446]="UNMASKED_RENDERER_WEBGL",t[t.MAX_TEXTURE_MAX_ANISOTROPY_EXT=34047]="MAX_TEXTURE_MAX_ANISOTROPY_EXT",t[t.TEXTURE_MAX_ANISOTROPY_EXT=34046]="TEXTURE_MAX_ANISOTROPY_EXT",t[t.R16_EXT=33322]="R16_EXT",t[t.RG16_EXT=33324]="RG16_EXT",t[t.RGB16_EXT=32852]="RGB16_EXT",t[t.RGBA16_EXT=32859]="RGBA16_EXT",t[t.R16_SNORM_EXT=36760]="R16_SNORM_EXT",t[t.RG16_SNORM_EXT=36761]="RG16_SNORM_EXT",t[t.RGB16_SNORM_EXT=36762]="RGB16_SNORM_EXT",t[t.RGBA16_SNORM_EXT=36763]="RGBA16_SNORM_EXT",t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RED_RGTC1_EXT=36283]="COMPRESSED_RED_RGTC1_EXT",t[t.COMPRESSED_SIGNED_RED_RGTC1_EXT=36284]="COMPRESSED_SIGNED_RED_RGTC1_EXT",t[t.COMPRESSED_RED_GREEN_RGTC2_EXT=36285]="COMPRESSED_RED_GREEN_RGTC2_EXT",t[t.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT=36286]="COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT",t[t.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",t[t.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=36493]="COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT",t[t.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT=36494]="COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT",t[t.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT=36495]="COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37493]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ETC2=37494]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37495]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37496]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37497]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_RGB_ATC_WEBGL=35986]="COMPRESSED_RGB_ATC_WEBGL",t[t.COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL=35986]="COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL",t[t.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL=34798]="COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR",t[t.QUERY_COUNTER_BITS_EXT=34916]="QUERY_COUNTER_BITS_EXT",t[t.CURRENT_QUERY_EXT=34917]="CURRENT_QUERY_EXT",t[t.QUERY_RESULT_EXT=34918]="QUERY_RESULT_EXT",t[t.QUERY_RESULT_AVAILABLE_EXT=34919]="QUERY_RESULT_AVAILABLE_EXT",t[t.TIME_ELAPSED_EXT=35007]="TIME_ELAPSED_EXT",t[t.TIMESTAMP_EXT=36392]="TIMESTAMP_EXT",t[t.GPU_DISJOINT_EXT=36795]="GPU_DISJOINT_EXT",t[t.COMPLETION_STATUS_KHR=37297]="COMPLETION_STATUS_KHR",t[t.DEPTH_CLAMP_EXT=34383]="DEPTH_CLAMP_EXT",t[t.FIRST_VERTEX_CONVENTION_WEBGL=36429]="FIRST_VERTEX_CONVENTION_WEBGL",t[t.LAST_VERTEX_CONVENTION_WEBGL=36430]="LAST_VERTEX_CONVENTION_WEBGL",t[t.PROVOKING_VERTEX_WEBL=36431]="PROVOKING_VERTEX_WEBL",t[t.POLYGON_MODE_WEBGL=2880]="POLYGON_MODE_WEBGL",t[t.POLYGON_OFFSET_LINE_WEBGL=10754]="POLYGON_OFFSET_LINE_WEBGL",t[t.LINE_WEBGL=6913]="LINE_WEBGL",t[t.FILL_WEBGL=6914]="FILL_WEBGL",t[t.MAX_CLIP_DISTANCES_WEBGL=3378]="MAX_CLIP_DISTANCES_WEBGL",t[t.MAX_CULL_DISTANCES_WEBGL=33529]="MAX_CULL_DISTANCES_WEBGL",t[t.MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL=33530]="MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL",t[t.CLIP_DISTANCE0_WEBGL=12288]="CLIP_DISTANCE0_WEBGL",t[t.CLIP_DISTANCE1_WEBGL=12289]="CLIP_DISTANCE1_WEBGL",t[t.CLIP_DISTANCE2_WEBGL=12290]="CLIP_DISTANCE2_WEBGL",t[t.CLIP_DISTANCE3_WEBGL=12291]="CLIP_DISTANCE3_WEBGL",t[t.CLIP_DISTANCE4_WEBGL=12292]="CLIP_DISTANCE4_WEBGL",t[t.CLIP_DISTANCE5_WEBGL=12293]="CLIP_DISTANCE5_WEBGL",t[t.CLIP_DISTANCE6_WEBGL=12294]="CLIP_DISTANCE6_WEBGL",t[t.CLIP_DISTANCE7_WEBGL=12295]="CLIP_DISTANCE7_WEBGL",t[t.POLYGON_OFFSET_CLAMP_EXT=36379]="POLYGON_OFFSET_CLAMP_EXT",t[t.LOWER_LEFT_EXT=36001]="LOWER_LEFT_EXT",t[t.UPPER_LEFT_EXT=36002]="UPPER_LEFT_EXT",t[t.NEGATIVE_ONE_TO_ONE_EXT=37726]="NEGATIVE_ONE_TO_ONE_EXT",t[t.ZERO_TO_ONE_EXT=37727]="ZERO_TO_ONE_EXT",t[t.CLIP_ORIGIN_EXT=37724]="CLIP_ORIGIN_EXT",t[t.CLIP_DEPTH_MODE_EXT=37725]="CLIP_DEPTH_MODE_EXT",t[t.SRC1_COLOR_WEBGL=35065]="SRC1_COLOR_WEBGL",t[t.SRC1_ALPHA_WEBGL=34185]="SRC1_ALPHA_WEBGL",t[t.ONE_MINUS_SRC1_COLOR_WEBGL=35066]="ONE_MINUS_SRC1_COLOR_WEBGL",t[t.ONE_MINUS_SRC1_ALPHA_WEBGL=35067]="ONE_MINUS_SRC1_ALPHA_WEBGL",t[t.MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL=35068]="MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL",t[t.MIRROR_CLAMP_TO_EDGE_EXT=34627]="MIRROR_CLAMP_TO_EDGE_EXT"})(ae||(ae={}));const qn={3042:!1,32773:new Float32Array([0,0,0,0]),32777:32774,34877:32774,32969:1,32968:0,32971:1,32970:0,3106:new Float32Array([0,0,0,0]),3107:[!0,!0,!0,!0],2884:!1,2885:1029,2929:!1,2931:1,2932:513,2928:new Float32Array([0,1]),2930:!0,3024:!0,35725:null,36006:null,36007:null,34229:null,34964:null,2886:2305,33170:4352,2849:1,32823:!1,32824:0,10752:0,32926:!1,32928:!1,32938:1,32939:!1,3089:!1,3088:new Int32Array([0,0,1024,1024]),2960:!1,2961:0,2968:4294967295,36005:4294967295,2962:519,2967:0,2963:4294967295,34816:519,36003:0,36004:4294967295,2964:7680,2965:7680,2966:7680,34817:7680,34818:7680,34819:7680,2978:[0,0,1024,1024],36389:null,36662:null,36663:null,35053:null,35055:null,35723:4352,36010:null,35977:!1,3333:4,3317:4,37440:!1,37441:!1,37443:37444,3330:0,3332:0,3331:0,3314:0,32878:0,3316:0,3315:0,32877:0},q=(t,e,s)=>e?t.enable(s):t.disable(s),Ua=(t,e,s)=>t.hint(s,e),ne=(t,e,s)=>t.pixelStorei(s,e),La=(t,e,s)=>{const i=s===36006?36009:36008;return t.bindFramebuffer(i,e)},Ut=(t,e,s)=>{const r={34964:34962,36662:36662,36663:36663,35053:35051,35055:35052}[s];t.bindBuffer(r,e)};function Tr(t){return Array.isArray(t)||ArrayBuffer.isView(t)&&!(t instanceof DataView)}const DT={3042:q,32773:(t,e)=>t.blendColor(...e),32777:"blendEquation",34877:"blendEquation",32969:"blendFunc",32968:"blendFunc",32971:"blendFunc",32970:"blendFunc",3106:(t,e)=>t.clearColor(...e),3107:(t,e)=>t.colorMask(...e),2884:q,2885:(t,e)=>t.cullFace(e),2929:q,2931:(t,e)=>t.clearDepth(e),2932:(t,e)=>t.depthFunc(e),2928:(t,e)=>t.depthRange(...e),2930:(t,e)=>t.depthMask(e),3024:q,35723:Ua,35725:(t,e)=>t.useProgram(e),36007:(t,e)=>t.bindRenderbuffer(36161,e),36389:(t,e)=>{var s;return(s=t.bindTransformFeedback)==null?void 0:s.call(t,36386,e)},34229:(t,e)=>t.bindVertexArray(e),36006:La,36010:La,34964:Ut,36662:Ut,36663:Ut,35053:Ut,35055:Ut,2886:(t,e)=>t.frontFace(e),33170:Ua,2849:(t,e)=>t.lineWidth(e),32823:q,32824:"polygonOffset",10752:"polygonOffset",35977:q,32926:q,32928:q,32938:"sampleCoverage",32939:"sampleCoverage",3089:q,3088:(t,e)=>t.scissor(...e),2960:q,2961:(t,e)=>t.clearStencil(e),2968:(t,e)=>t.stencilMaskSeparate(1028,e),36005:(t,e)=>t.stencilMaskSeparate(1029,e),2962:"stencilFuncFront",2967:"stencilFuncFront",2963:"stencilFuncFront",34816:"stencilFuncBack",36003:"stencilFuncBack",36004:"stencilFuncBack",2964:"stencilOpFront",2965:"stencilOpFront",2966:"stencilOpFront",34817:"stencilOpBack",34818:"stencilOpBack",34819:"stencilOpBack",2978:(t,e)=>t.viewport(...e),34383:q,10754:q,12288:q,12289:q,12290:q,12291:q,12292:q,12293:q,12294:q,12295:q,3333:ne,3317:ne,37440:ne,37441:ne,37443:ne,3330:ne,3332:ne,3331:ne,3314:ne,32878:ne,3316:ne,3315:ne,32877:ne,framebuffer:(t,e)=>{const s=e&&"handle"in e?e.handle:e;return t.bindFramebuffer(36160,s)},blend:(t,e)=>e?t.enable(3042):t.disable(3042),blendColor:(t,e)=>t.blendColor(...e),blendEquation:(t,e)=>{const s=typeof e=="number"?[e,e]:e;t.blendEquationSeparate(...s)},blendFunc:(t,e)=>{const s=(e==null?void 0:e.length)===2?[...e,...e]:e;t.blendFuncSeparate(...s)},clearColor:(t,e)=>t.clearColor(...e),clearDepth:(t,e)=>t.clearDepth(e),clearStencil:(t,e)=>t.clearStencil(e),colorMask:(t,e)=>t.colorMask(...e),cull:(t,e)=>e?t.enable(2884):t.disable(2884),cullFace:(t,e)=>t.cullFace(e),depthTest:(t,e)=>e?t.enable(2929):t.disable(2929),depthFunc:(t,e)=>t.depthFunc(e),depthMask:(t,e)=>t.depthMask(e),depthRange:(t,e)=>t.depthRange(...e),dither:(t,e)=>e?t.enable(3024):t.disable(3024),derivativeHint:(t,e)=>{t.hint(35723,e)},frontFace:(t,e)=>t.frontFace(e),mipmapHint:(t,e)=>t.hint(33170,e),lineWidth:(t,e)=>t.lineWidth(e),polygonOffsetFill:(t,e)=>e?t.enable(32823):t.disable(32823),polygonOffset:(t,e)=>t.polygonOffset(...e),sampleCoverage:(t,e)=>t.sampleCoverage(e[0],e[1]||!1),scissorTest:(t,e)=>e?t.enable(3089):t.disable(3089),scissor:(t,e)=>t.scissor(...e),stencilTest:(t,e)=>e?t.enable(2960):t.disable(2960),stencilMask:(t,e)=>{e=Tr(e)?e:[e,e];const[s,i]=e;t.stencilMaskSeparate(1028,s),t.stencilMaskSeparate(1029,i)},stencilFunc:(t,e)=>{e=Tr(e)&&e.length===3?[...e,...e]:e;const[s,i,r,n,o,a]=e;t.stencilFuncSeparate(1028,s,i,r),t.stencilFuncSeparate(1029,n,o,a)},stencilOp:(t,e)=>{e=Tr(e)&&e.length===3?[...e,...e]:e;const[s,i,r,n,o,a]=e;t.stencilOpSeparate(1028,s,i,r),t.stencilOpSeparate(1029,n,o,a)},viewport:(t,e)=>t.viewport(...e)};function Y(t,e,s){return e[t]!==void 0?e[t]:s[t]}const BT={blendEquation:(t,e,s)=>t.blendEquationSeparate(Y(32777,e,s),Y(34877,e,s)),blendFunc:(t,e,s)=>t.blendFuncSeparate(Y(32969,e,s),Y(32968,e,s),Y(32971,e,s),Y(32970,e,s)),polygonOffset:(t,e,s)=>t.polygonOffset(Y(32824,e,s),Y(10752,e,s)),sampleCoverage:(t,e,s)=>t.sampleCoverage(Y(32938,e,s),Y(32939,e,s)),stencilFuncFront:(t,e,s)=>t.stencilFuncSeparate(1028,Y(2962,e,s),Y(2967,e,s),Y(2963,e,s)),stencilFuncBack:(t,e,s)=>t.stencilFuncSeparate(1029,Y(34816,e,s),Y(36003,e,s),Y(36004,e,s)),stencilOpFront:(t,e,s)=>t.stencilOpSeparate(1028,Y(2964,e,s),Y(2965,e,s),Y(2966,e,s)),stencilOpBack:(t,e,s)=>t.stencilOpSeparate(1029,Y(34817,e,s),Y(34818,e,s),Y(34819,e,s))},Va={enable:(t,e)=>t({[e]:!0}),disable:(t,e)=>t({[e]:!1}),pixelStorei:(t,e,s)=>t({[e]:s}),hint:(t,e,s)=>t({[e]:s}),useProgram:(t,e)=>t({35725:e}),bindRenderbuffer:(t,e,s)=>t({36007:s}),bindTransformFeedback:(t,e,s)=>t({36389:s}),bindVertexArray:(t,e)=>t({34229:e}),bindFramebuffer:(t,e,s)=>{switch(e){case 36160:return t({36006:s,36010:s});case 36009:return t({36006:s});case 36008:return t({36010:s});default:return null}},bindBuffer:(t,e,s)=>{const i={34962:[34964],36662:[36662],36663:[36663],35051:[35053],35052:[35055]}[e];return i?t({[i]:s}):{valueChanged:!0}},blendColor:(t,e,s,i,r)=>t({32773:new Float32Array([e,s,i,r])}),blendEquation:(t,e)=>t({32777:e,34877:e}),blendEquationSeparate:(t,e,s)=>t({32777:e,34877:s}),blendFunc:(t,e,s)=>t({32969:e,32968:s,32971:e,32970:s}),blendFuncSeparate:(t,e,s,i,r)=>t({32969:e,32968:s,32971:i,32970:r}),clearColor:(t,e,s,i,r)=>t({3106:new Float32Array([e,s,i,r])}),clearDepth:(t,e)=>t({2931:e}),clearStencil:(t,e)=>t({2961:e}),colorMask:(t,e,s,i,r)=>t({3107:[e,s,i,r]}),cullFace:(t,e)=>t({2885:e}),depthFunc:(t,e)=>t({2932:e}),depthRange:(t,e,s)=>t({2928:new Float32Array([e,s])}),depthMask:(t,e)=>t({2930:e}),frontFace:(t,e)=>t({2886:e}),lineWidth:(t,e)=>t({2849:e}),polygonOffset:(t,e,s)=>t({32824:e,10752:s}),sampleCoverage:(t,e,s)=>t({32938:e,32939:s}),scissor:(t,e,s,i,r)=>t({3088:new Int32Array([e,s,i,r])}),stencilMask:(t,e)=>t({2968:e,36005:e}),stencilMaskSeparate:(t,e,s)=>t({[e===1028?2968:36005]:s}),stencilFunc:(t,e,s,i)=>t({2962:e,2967:s,2963:i,34816:e,36003:s,36004:i}),stencilFuncSeparate:(t,e,s,i,r)=>t({[e===1028?2962:34816]:s,[e===1028?2967:36003]:i,[e===1028?2963:36004]:r}),stencilOp:(t,e,s,i)=>t({2964:e,2965:s,2966:i,34817:e,34818:s,34819:i}),stencilOpSeparate:(t,e,s,i,r)=>t({[e===1028?2964:34817]:s,[e===1028?2965:34818]:i,[e===1028?2966:34819]:r}),viewport:(t,e,s,i,r)=>t({2978:[e,s,i,r]})},Te=(t,e)=>t.isEnabled(e),za={3042:Te,2884:Te,2929:Te,3024:Te,32823:Te,32926:Te,32928:Te,3089:Te,2960:Te,35977:Te},UT=new Set([34016,36388,36387,35983,35368,34965,35739,35738,3074,34853,34854,34855,34856,34857,34858,34859,34860,34861,34862,34863,34864,34865,34866,34867,34868,35097,32873,35869,32874,34068]);function Ft(t,e){if(VT(e))return;const s={};for(const r in e){const n=Number(r),o=DT[r];o&&(typeof o=="string"?s[o]=!0:o(t,e[r],n))}const i=t.state&&t.state.cache;if(i)for(const r in s){const n=BT[r];n(t,e,i)}}function Mh(t,e=qn){if(typeof e=="number"){const r=e,n=za[r];return n?n(t,r):t.getParameter(r)}const s=Array.isArray(e)?e:Object.keys(e),i={};for(const r of s){const n=za[r];i[r]=n?n(t,Number(r)):t.getParameter(Number(r))}return i}function LT(t){Ft(t,qn)}function VT(t){for(const e in t)return!1;return!0}function zT(t,e){if(t===e)return!0;const s=Array.isArray(t)||ArrayBuffer.isView(t),i=Array.isArray(e)||ArrayBuffer.isView(e);if(s&&i&&t.length===e.length){for(let r=0;r<t.length;++r)if(t[r]!==e[r])return!1;return!0}return!1}class Qe{constructor(e,s){d(this,"gl");d(this,"program",null);d(this,"stateStack",[]);d(this,"enable",!0);d(this,"cache",null);d(this,"log");d(this,"initialized",!1);this.gl=e,this.log=(s==null?void 0:s.log)||(()=>{}),this._updateCache=this._updateCache.bind(this),Object.seal(this)}static get(e){return e.state}push(e={}){this.stateStack.push({})}pop(){const e=this.stateStack[this.stateStack.length-1];Ft(this.gl,e),this.stateStack.pop()}trackState(e,s){if(this.cache=s.copyState?Mh(e):Object.assign({},qn),this.initialized)throw new Error("WebGLStateTracker");this.initialized=!0,this.gl.state=this,HT(e);for(const i in Va){const r=Va[i];WT(e,i,r)}Wa(e,"getParameter"),Wa(e,"isEnabled")}_updateCache(e){let s=!1,i;const r=this.stateStack.length>0?this.stateStack[this.stateStack.length-1]:null;for(const n in e){const o=e[n],a=this.cache[n];zT(o,a)||(s=!0,i=a,r&&!(n in r)&&(r[n]=a),this.cache[n]=o)}return{valueChanged:s,oldValue:i}}}function Wa(t,e){const s=t[e].bind(t);t[e]=function(r){if(r===void 0||UT.has(r))return s(r);const n=Qe.get(t);return r in n.cache||(n.cache[r]=s(r)),n.enable?n.cache[r]:s(r)},Object.defineProperty(t[e],"name",{value:`${e}-from-cache`,configurable:!1})}function WT(t,e,s){if(!t[e])return;const i=t[e].bind(t);t[e]=function(...n){const o=Qe.get(t),{valueChanged:a,oldValue:c}=s(o._updateCache,...n);return a&&i(...n),c},Object.defineProperty(t[e],"name",{value:`${e}-to-cache`,configurable:!1})}function HT(t){const e=t.useProgram.bind(t);t.useProgram=function(i){const r=Qe.get(t);r.program!==i&&(e(i),r.program=i)}}function jT(t,e,s){let i="";const r={preserveDrawingBuffer:!0,...s};let n=null;if(n||(n=t.getContext("webgl2",r)),r.failIfMajorPerformanceCaveat&&(i||(i="Only software GPU is available. Set `failIfMajorPerformanceCaveat: false` to allow.")),!n&&!s.failIfMajorPerformanceCaveat&&(r.failIfMajorPerformanceCaveat=!1,n=t.getContext("webgl2",r),n.luma||(n.luma={}),n.luma.softwareRenderer=!0),n||(n=t.getContext("webgl",{}),n&&(n=null,i||(i="Your browser only supports WebGL1"))),!n)throw i||(i="Your browser does not support WebGL"),new Error(`Failed to create WebGL context: ${i}`);const{onContextLost:o,onContextRestored:a}=e;return t.addEventListener("webglcontextlost",c=>o(c),!1),t.addEventListener("webglcontextrestored",c=>a(c),!1),n.luma||(n.luma={}),n}function Mt(t,e,s){return s[e]===void 0&&(s[e]=t.getExtension(e)||null),s[e]}function $T(t,e){const s=t.getParameter(7936),i=t.getParameter(7937);Mt(t,"WEBGL_debug_renderer_info",e);const r=e.WEBGL_debug_renderer_info,n=t.getParameter(r?r.UNMASKED_VENDOR_WEBGL:7936),o=t.getParameter(r?r.UNMASKED_RENDERER_WEBGL:7937),a=n||s,c=o||i,l=t.getParameter(7938),h=Oh(a,c),u=XT(a,c),f=YT(a,c);return{type:"webgl",gpu:h,gpuType:f,gpuBackend:u,vendor:a,renderer:c,version:l,shadingLanguage:"glsl",shadingLanguageVersion:300}}function Oh(t,e){return/NVIDIA/i.exec(t)||/NVIDIA/i.exec(e)?"nvidia":/INTEL/i.exec(t)||/INTEL/i.exec(e)?"intel":/Apple/i.exec(t)||/Apple/i.exec(e)?"apple":/AMD/i.exec(t)||/AMD/i.exec(e)||/ATI/i.exec(t)||/ATI/i.exec(e)?"amd":/SwiftShader/i.exec(t)||/SwiftShader/i.exec(e)?"software":"unknown"}function XT(t,e){return/Metal/i.exec(t)||/Metal/i.exec(e)?"metal":/ANGLE/i.exec(t)||/ANGLE/i.exec(e)?"opengl":"unknown"}function YT(t,e){if(/SwiftShader/i.exec(t)||/SwiftShader/i.exec(e))return"cpu";switch(Oh(t,e)){case"intel":return"integrated";case"software":return"cpu";case"unknown":return"unknown";default:return"discrete"}}function Nh(t){switch(t){case"uint8":return 5121;case"sint8":return 5120;case"unorm8":return 5121;case"snorm8":return 5120;case"uint16":return 5123;case"sint16":return 5122;case"unorm16":return 5123;case"snorm16":return 5122;case"uint32":return 5125;case"sint32":return 5124;case"float16":return 5131;case"float32":return 5126}throw new Error(String(t))}const ie="texture-compression-bc",z="texture-compression-astc",Ae="texture-compression-etc2",KT="texture-compression-etc1-webgl",Ms="texture-compression-pvrtc-webgl",Ar="texture-compression-atc-webgl",Os="float32-renderable-webgl",wr="float16-renderable-webgl",qT="rgb9e5ufloat_renderable-webgl",Sr="snorm8-renderable-webgl",Lt="norm16-renderable-webgl",Er="snorm16-renderable-webgl",Ns="float32-filterable",Ha="float16-filterable-webgl",jt="WEBGL_compressed_texture_s3tc",$t="WEBGL_compressed_texture_s3tc_srgb",pt="EXT_texture_compression_rgtc",_t="EXT_texture_compression_bptc",ZT="WEBGL_compressed_texture_etc",JT="WEBGL_compressed_texture_astc",QT="WEBGL_compressed_texture_etc1",GT="WEBGL_compressed_texture_pvrtc",e0="WEBGL_compressed_texture_atc",ja="EXT_texture_norm16",$a="EXT_render_snorm",t0="EXT_color_buffer_float",Zn={"float32-renderable-webgl":["EXT_color_buffer_float"],"float16-renderable-webgl":["EXT_color_buffer_half_float"],"rgb9e5ufloat_renderable-webgl":["WEBGL_render_shared_exponent"],"snorm8-renderable-webgl":[$a],"norm16-renderable-webgl":[ja],"snorm16-renderable-webgl":[ja,$a],"float32-filterable":["OES_texture_float_linear"],"float16-filterable-webgl":["OES_texture_half_float_linear"],"texture-filterable-anisotropic-webgl":["EXT_texture_filter_anisotropic"],"texture-blend-float-webgl":["EXT_float_blend"],"texture-compression-bc":[jt,$t,pt,_t],"texture-compression-bc5-webgl":[pt],"texture-compression-bc7-webgl":[_t],"texture-compression-etc2":[ZT],"texture-compression-astc":[JT],"texture-compression-etc1-webgl":[QT],"texture-compression-pvrtc-webgl":[GT],"texture-compression-atc-webgl":[e0]};function s0(t){return t in Zn}function Zt(t,e,s){return(Zn[e]||[]).every(r=>Mt(t,r,s))}const ms={r8unorm:{gl:33321,b:1,c:1,rb:!0},r8snorm:{gl:36756,b:1,c:1,render:Sr},r8uint:{gl:33330,b:1,c:1,rb:!0},r8sint:{gl:33329,b:1,c:1,rb:!0},rg8unorm:{gl:33323,b:2,c:2,rb:!0},rg8snorm:{gl:36757,b:2,c:2,render:Sr},rg8uint:{gl:33336,b:2,c:2,rb:!0},rg8sint:{gl:33335,b:2,c:2,rb:!0},r16uint:{gl:33332,b:2,c:1,rb:!0},r16sint:{gl:33331,b:2,c:1,rb:!0},r16float:{gl:33325,b:2,c:1,render:wr,filter:"float16-filterable-webgl",rb:!0},"r16unorm-webgl":{gl:33322,b:2,c:1,f:Lt,rb:!0},"r16snorm-webgl":{gl:36760,b:2,c:1,f:Er},"rgba4unorm-webgl":{gl:32854,b:2,c:4,wgpu:!1,rb:!0},"rgb565unorm-webgl":{gl:36194,b:2,c:4,wgpu:!1,rb:!0},"rgb5a1unorm-webgl":{gl:32855,b:2,c:4,wgpu:!1,rb:!0},"rgb8unorm-webgl":{gl:32849,b:3,c:3,wgpu:!1},"rgb8snorm-webgl":{gl:36758,b:3,c:3,wgpu:!1},rgba8unorm:{gl:32856,b:4,c:2,bpp:4},"rgba8unorm-srgb":{gl:35907,b:4,c:4,bpp:4},rgba8snorm:{gl:36759,b:4,c:4,render:Sr},rgba8uint:{gl:36220,b:4,c:4,bpp:4},rgba8sint:{gl:36238,b:4,c:4,bpp:4},bgra8unorm:{b:4,c:4},"bgra8unorm-srgb":{b:4,c:4},rg16uint:{gl:33338,b:4,c:1,bpp:4},rg16sint:{gl:33337,b:4,c:2,bpp:4},rg16float:{gl:33327,bpp:4,b:4,c:2,render:wr,filter:Ha,rb:!0},"rg16unorm-webgl":{gl:33324,b:2,c:2,render:Lt},"rg16snorm-webgl":{gl:36761,b:2,c:2,render:Er},r32uint:{gl:33334,b:4,c:1,bpp:4,rb:!0},r32sint:{gl:33333,b:4,c:1,bpp:4,rb:!0},r32float:{gl:33326,bpp:4,b:4,c:1,render:Os,filter:Ns},rgb9e5ufloat:{gl:35901,b:4,c:3,p:1,render:qT},rg11b10ufloat:{gl:35898,b:4,c:3,p:1,render:Os,rb:!0},rgb10a2unorm:{gl:32857,b:4,c:4,p:1,rb:!0},"rgb10a2uint-webgl":{b:4,c:4,gl:36975,p:1,wgpu:!1,bpp:4,rb:!0},"rgb16unorm-webgl":{gl:32852,b:2,c:3,f:Lt},"rgb16snorm-webgl":{gl:36762,b:2,c:3,f:Lt},rg32uint:{gl:33340,b:8,c:2,rb:!0},rg32sint:{gl:33339,b:8,c:2,rb:!0},rg32float:{gl:33328,b:8,c:2,render:!1,filter:Ns,rb:!0},rgba16uint:{gl:36214,b:8,c:4,rb:!0},rgba16sint:{gl:36232,b:8,c:4,rb:!0},rgba16float:{gl:34842,b:8,c:4,render:wr,filter:Ha},"rgba16unorm-webgl":{gl:32859,b:2,c:4,render:Lt,rb:!0},"rgba16snorm-webgl":{gl:36763,b:2,c:4,render:Er},"rgb32float-webgl":{gl:34837,render:Os,filter:Ns,gl2ext:t0,dataFormat:6407,types:[5126]},rgba32uint:{gl:36208,b:16,c:4,rb:!0},rgba32sint:{gl:36226,b:16,c:4,rb:!0},rgba32float:{gl:34836,b:16,c:4,render:Os,filter:Ns,rb:!0},stencil8:{gl:36168,b:1,c:1,attachment:36128,rb:!0},depth16unorm:{gl:33189,b:2,c:1,attachment:36096,dataFormat:6402,types:[5123],rb:!0},depth24plus:{gl:33190,b:3,c:1,attachment:36096,dataFormat:6402,types:[5125]},depth32float:{gl:36012,b:4,c:1,attachment:36096,dataFormat:6402,types:[5126],rb:!0},"depth24plus-stencil8":{gl:35056,b:4,c:2,p:1,attachment:33306,rb:!0,depthTexture:!0,dataFormat:34041,types:[34042]},"depth32float-stencil8":{gl:36013,b:5,c:2,p:1,attachment:33306,dataFormat:34041,types:[36269],rb:!0},"bc1-rgb-unorm-webgl":{gl:33776,x:jt,f:ie},"bc1-rgb-unorm-srgb-webgl":{gl:35916,x:$t,f:ie},"bc1-rgba-unorm":{gl:33777,x:jt,f:ie},"bc1-rgba-unorm-srgb":{gl:35916,x:$t,f:ie},"bc2-rgba-unorm":{gl:33778,x:jt,f:ie},"bc2-rgba-unorm-srgb":{gl:35918,x:$t,f:ie},"bc3-rgba-unorm":{gl:33779,x:jt,f:ie},"bc3-rgba-unorm-srgb":{gl:35919,x:$t,f:ie},"bc4-r-unorm":{gl:36283,x:pt,f:ie},"bc4-r-snorm":{gl:36284,x:pt,f:ie},"bc5-rg-unorm":{gl:36285,x:pt,f:ie},"bc5-rg-snorm":{gl:36286,x:pt,f:ie},"bc6h-rgb-ufloat":{gl:36495,x:_t,f:ie},"bc6h-rgb-float":{gl:36494,x:_t,f:ie},"bc7-rgba-unorm":{gl:36492,x:_t,f:ie},"bc7-rgba-unorm-srgb":{gl:36493,x:_t,f:ie},"etc2-rgb8unorm":{gl:37492,f:Ae},"etc2-rgb8unorm-srgb":{gl:37494,f:Ae},"etc2-rgb8a1unorm":{gl:37496,f:Ae},"etc2-rgb8a1unorm-srgb":{gl:37497,f:Ae},"etc2-rgba8unorm":{gl:37493,f:Ae},"etc2-rgba8unorm-srgb":{gl:37495,f:Ae},"eac-r11unorm":{gl:37488,f:Ae},"eac-r11snorm":{gl:37489,f:Ae},"eac-rg11unorm":{gl:37490,f:Ae},"eac-rg11snorm":{gl:37491,f:Ae},"astc-4x4-unorm":{gl:37808,f:z},"astc-4x4-unorm-srgb":{gl:37840,f:z},"astc-5x4-unorm":{gl:37809,f:z},"astc-5x4-unorm-srgb":{gl:37841,f:z},"astc-5x5-unorm":{gl:37810,f:z},"astc-5x5-unorm-srgb":{gl:37842,f:z},"astc-6x5-unorm":{gl:37811,f:z},"astc-6x5-unorm-srgb":{gl:37843,f:z},"astc-6x6-unorm":{gl:37812,f:z},"astc-6x6-unorm-srgb":{gl:37844,f:z},"astc-8x5-unorm":{gl:37813,f:z},"astc-8x5-unorm-srgb":{gl:37845,f:z},"astc-8x6-unorm":{gl:37814,f:z},"astc-8x6-unorm-srgb":{gl:37846,f:z},"astc-8x8-unorm":{gl:37815,f:z},"astc-8x8-unorm-srgb":{gl:37847,f:z},"astc-10x5-unorm":{gl:37819,f:z},"astc-10x5-unorm-srgb":{gl:37851,f:z},"astc-10x6-unorm":{gl:37817,f:z},"astc-10x6-unorm-srgb":{gl:37849,f:z},"astc-10x8-unorm":{gl:37818,f:z},"astc-10x8-unorm-srgb":{gl:37850,f:z},"astc-10x10-unorm":{gl:37819,f:z},"astc-10x10-unorm-srgb":{gl:37851,f:z},"astc-12x10-unorm":{gl:37820,f:z},"astc-12x10-unorm-srgb":{gl:37852,f:z},"astc-12x12-unorm":{gl:37821,f:z},"astc-12x12-unorm-srgb":{gl:37853,f:z},"pvrtc-rgb4unorm-webgl":{gl:35840,f:Ms},"pvrtc-rgba4unorm-webgl":{gl:35842,f:Ms},"pvrtc-rbg2unorm-webgl":{gl:35841,f:Ms},"pvrtc-rgba2unorm-webgl":{gl:35843,f:Ms},"etc1-rbg-unorm-webgl":{gl:36196,f:KT},"atc-rgb-unorm-webgl":{gl:35986,f:Ar},"atc-rgba-unorm-webgl":{gl:35986,f:Ar},"atc-rgbai-unorm-webgl":{gl:34798,f:Ar}};function i0(t,e,s){const i=ms[e];if(!i||i.gl===void 0)return!1;const r=i.f;if(r)return Zt(t,r,s);const n=i.x||i.gl2ext;return n?!!Mt(t,n,s):!0}function r0(t,e,s){return kh(t,e,s).filterable||!1}function n0(t,e,s){return kh(t,e,s).renderable||!1}function kh(t,e,s){const i=Rl(e);if(!i)return{supported:!1};const r=ms[e];if(!r)return{supported:!1};let n=r.gl!==void 0;n=n&&Zt(t,r.f,s);const o=e.startsWith("depth")||e.startsWith("stencil"),a=i==null?void 0:i.signed,c=n&&!a&&r.render&&Zt(t,r.render,s),l=n&&!o&&!a&&r.filter&&Zt(t,r.filter,s);return{supported:n,renderable:c,filterable:l,blendable:!1,storable:!1}}function Fh(t){var r;const e=ms[t],s=c0(t),i=Rl(t);return{internalFormat:s,format:(e==null?void 0:e.dataFormat)||a0(i.channels,i.integer,i.normalized,s),type:i.dataType?Nh(i.dataType):((r=e==null?void 0:e.types)==null?void 0:r[0])||5121,compressed:i.compressed||!1}}function o0(t){const e=ms[t];if(!(e!=null&&e.attachment))throw new Error(`${t} is not a depth stencil format`);return e.attachment}function a0(t,e,s,i){if(i===6408||i===6407)return i;switch(t){case"r":return e&&!s?36244:6403;case"rg":return e&&!s?33320:33319;case"rgb":return e&&!s?36248:6407;case"rgba":return e&&!s?36249:6408;case"bgra":throw new Error("bgra pixels not supported by WebGL");default:return 6408}}function c0(t){const e=ms[t],s=e==null?void 0:e.gl;if(s===void 0)throw new Error(`Unsupported texture format ${t}`);return s}const Xa={"depth-clip-control":"EXT_depth_clamp","timer-query-webgl":"EXT_disjoint_timer_query_webgl2","compilation-status-async-webgl":"KHR_parallel_shader_compile","polygon-mode-webgl":"WEBGL_polygon_mode","provoking-vertex-webgl":"WEBGL_provoking_vertex","shader-clip-cull-distance-webgl":"WEBGL_clip_cull_distance","shader-noperspective-interpolation-webgl":"NV_shader_noperspective_interpolation","shader-conservative-depth-webgl":"EXT_conservative_depth"};class l0 extends jg{constructor(s,i,r){super([],r);d(this,"gl");d(this,"extensions");d(this,"testedFeatures",new Set);this.gl=s,this.extensions=i,Mt(s,"EXT_color_buffer_float",i)}*[Symbol.iterator](){const s=this.getFeatures();for(const i of s)this.has(i)&&(yield i);return[]}has(s){var i;return(i=this.disabledFeatures)!=null&&i[s]?!1:(this.testedFeatures.has(s)||(this.testedFeatures.add(s),s0(s)&&Zt(this.gl,s,this.extensions)&&this.features.add(s),this.getWebGLFeature(s)&&this.features.add(s)),this.features.has(s))}initializeFeatures(){const s=this.getFeatures().filter(i=>i!=="polygon-mode-webgl");for(const i of s)this.has(i)}getFeatures(){return[...Object.keys(Xa),...Object.keys(Zn)]}getWebGLFeature(s){const i=Xa[s];return typeof i=="string"?!!Mt(this.gl,i,this.extensions):!!i}}class h0 extends Hg{constructor(s){super();d(this,"gl");d(this,"limits",{});this.gl=s}get maxTextureDimension1D(){return 0}get maxTextureDimension2D(){return this.getParameter(3379)}get maxTextureDimension3D(){return this.getParameter(32883)}get maxTextureArrayLayers(){return this.getParameter(35071)}get maxBindGroups(){return 0}get maxDynamicUniformBuffersPerPipelineLayout(){return 0}get maxDynamicStorageBuffersPerPipelineLayout(){return 0}get maxSampledTexturesPerShaderStage(){return this.getParameter(35660)}get maxSamplersPerShaderStage(){return this.getParameter(35661)}get maxStorageBuffersPerShaderStage(){return 0}get maxStorageTexturesPerShaderStage(){return 0}get maxUniformBuffersPerShaderStage(){return this.getParameter(35375)}get maxUniformBufferBindingSize(){return this.getParameter(35376)}get maxStorageBufferBindingSize(){return 0}get minUniformBufferOffsetAlignment(){return this.getParameter(35380)}get minStorageBufferOffsetAlignment(){return 0}get maxVertexBuffers(){return 16}get maxVertexAttributes(){return this.getParameter(34921)}get maxVertexBufferArrayStride(){return 2048}get maxInterStageShaderComponents(){return this.getParameter(35659)}get maxComputeWorkgroupStorageSize(){return 0}get maxComputeInvocationsPerWorkgroup(){return 0}get maxComputeWorkgroupSizeX(){return 0}get maxComputeWorkgroupSizeY(){return 0}get maxComputeWorkgroupSizeZ(){return 0}get maxComputeWorkgroupsPerDimension(){return 0}getParameter(s){return this.limits[s]===void 0&&(this.limits[s]=this.gl.getParameter(s)),this.limits[s]||0}}class Jt extends li{constructor(s,i){super(s,i);d(this,"device");d(this,"gl");d(this,"handle");d(this,"colorAttachments",[]);d(this,"depthStencilAttachment",null);const r=i.handle===null;this.device=s,this.gl=s.gl,this.handle=this.props.handle||r?this.props.handle:this.gl.createFramebuffer(),r||(s.setSpectorMetadata(this.handle,{id:this.props.id,props:this.props}),this.autoCreateAttachmentTextures(),this.updateAttachments())}destroy(){super.destroy(),!this.destroyed&&this.handle!==null&&this.gl.deleteFramebuffer(this.handle)}updateAttachments(){const s=this.gl.bindFramebuffer(36160,this.handle);for(let i=0;i<this.colorAttachments.length;++i){const r=this.colorAttachments[i];if(r){const n=36064+i;this._attachTextureView(n,r)}}if(this.depthStencilAttachment){const i=o0(this.depthStencilAttachment.props.format);this._attachTextureView(i,this.depthStencilAttachment)}if(this.device.props.debug){const i=this.gl.checkFramebufferStatus(36160);if(i!==36053)throw new Error(`Framebuffer ${f0(i)}`)}this.gl.bindFramebuffer(36160,s)}_attachTextureView(s,i){const{gl:r}=this.device,{texture:n}=i,o=i.props.baseMipLevel,a=i.props.baseArrayLayer;switch(r.bindTexture(n.glTarget,n.handle),n.glTarget){case 35866:case 32879:r.framebufferTextureLayer(36160,s,n.handle,o,a);break;case 34067:const c=u0(a);r.framebufferTexture2D(36160,s,c,n.handle,o);break;case 3553:r.framebufferTexture2D(36160,s,3553,n.handle,o);break;default:throw new Error("Illegal texture type")}r.bindTexture(n.glTarget,null)}}function u0(t){return t<34069?t+34069:t}function f0(t){switch(t){case 36053:return"success";case 36054:return"Mismatched attachments";case 36055:return"No attachments";case 36057:return"Height/width mismatch";case 36061:return"Unsupported or split attachments";case 36182:return"Samples mismatch";default:return`${t}`}}class d0 extends $r{constructor(s,i){super(i);d(this,"device");d(this,"format","rgba8unorm");d(this,"depthStencilFormat","depth24plus");d(this,"presentationSize");d(this,"_framebuffer",null);this.device=s,this.presentationSize=[-1,-1],this._setAutoCreatedCanvasId(`${this.device.id}-canvas`),this.update()}getCurrentFramebuffer(){return this.update(),this._framebuffer=this._framebuffer||new Jt(this.device,{handle:null}),this._framebuffer}update(){const s=this.getPixelSize();(s[0]!==this.presentationSize[0]||s[1]!==this.presentationSize[1])&&(this.presentationSize=s,this.resize())}resize(s){if(this.device.gl&&this.canvas){const i=this.getDevicePixelRatio(s==null?void 0:s.useDevicePixels);this.setDevicePixelRatio(i,s);return}}commit(){}}async function Dh(t,e){const s=document.getElementsByTagName("head")[0];if(!s)throw new Error("loadScript");const i=document.createElement("script");return i.setAttribute("type","text/javascript"),i.setAttribute("src",t),e&&(i.id=e),new Promise((r,n)=>{i.onload=r,i.onerror=o=>n(new Error(`Unable to load script '${t}': ${o}`)),s.appendChild(i)})}const g0=1;let H=null,Ya=!1;const Jn={debugSpectorJS:x.get("debug-spectorjs"),debugSpectorJSUrl:"https://cdn.jsdelivr.net/npm/spectorjs@0.9.30/dist/spector.bundle.js",gl:void 0};async function p0(t){if(!globalThis.SPECTOR)try{await Dh(t.debugSpectorJSUrl||Jn.debugSpectorJSUrl)}catch(e){x.warn(String(e))}}function _0(t){var e;if(t={...Jn,...t},!t.debugSpectorJS)return null;if(!H&&globalThis.SPECTOR&&!((e=globalThis.luma)!=null&&e.spector)){x.probe(g0,"SPECTOR found and initialized. Start with `luma.spector.displayUI()`")();const{Spector:s}=globalThis.SPECTOR;H=new s,globalThis.luma&&(globalThis.luma.spector=H)}if(!H)return null;if(Ya||(Ya=!0,H.spyCanvases(),H==null||H.onCaptureStarted.add(s=>x.info("Spector capture started:",s)()),H==null||H.onCapture.add(s=>{x.info("Spector capture complete:",s)(),H==null||H.getResultUI(),H==null||H.resultView.display(),H==null||H.resultView.addCapture(s)})),t.gl){const s=t.gl,i=s.device;H==null||H.startCapture(t.gl,500),s.device=i,new Promise(r=>setTimeout(r,2e3)).then(r=>{x.info("Spector capture stopped after 2 seconds")(),H==null||H.stopCapture()})}return H}const m0="https://unpkg.com/webgl-debug@2.0.1/index.js";function Bh(t){return t.luma=t.luma||{},t.luma}async function y0(){st()&&!globalThis.WebGLDebugUtils&&(globalThis.global=globalThis.global||globalThis,globalThis.global.module={},await Dh(m0))}function b0(t,e={}){return e.debugWebGL||e.traceWebGL?A0(t,e):T0(t)}function T0(t){const e=Bh(t);return e.realContext?e.realContext:t}function A0(t,e){if(!globalThis.WebGLDebugUtils)return x.warn("webgl-debug not loaded")(),t;const s=Bh(t);if(s.debugContext)return s.debugContext;globalThis.WebGLDebugUtils.init({...ae,...t});const i=globalThis.WebGLDebugUtils.makeDebugContext(t,w0.bind(null,e),S0.bind(null,e));for(const o in ae)!(o in i)&&typeof ae[o]=="number"&&(i[o]=ae[o]);class r{}Object.setPrototypeOf(i,Object.getPrototypeOf(t)),Object.setPrototypeOf(r,i);const n=Object.create(r);return s.realContext=t,s.debugContext=n,n.debug=!0,n}function Ka(t,e){e=Array.from(e).map(i=>i===void 0?"undefined":i);let s=globalThis.WebGLDebugUtils.glFunctionArgsToString(t,e);return s=`${s.slice(0,100)}${s.length>100?"...":""}`,`gl.${t}(${s})`}function w0(t,e,s,i){i=Array.from(i).map(a=>a===void 0?"undefined":a);const r=globalThis.WebGLDebugUtils.glEnumToString(e),n=globalThis.WebGLDebugUtils.glFunctionArgsToString(s,i),o=`${r} in gl.${s}(${n})`;x.error(o)();debugger}function S0(t,e,s){let i="";x.level>=1&&(i=Ka(e,s),t.traceWebGL&&x.log(1,i)());for(const r of s)if(r===void 0){i=i||Ka(e,s);debugger}}const vr={};function E0(t="id"){vr[t]=vr[t]||1;const e=vr[t]++;return`${t}-${e}`}class Qt extends j{constructor(s,i={}){super(s,i);d(this,"device");d(this,"gl");d(this,"handle");d(this,"glTarget");d(this,"glUsage");d(this,"glIndexType",5123);d(this,"byteLength");d(this,"bytesUsed");this.device=s,this.gl=this.device.gl;const r=typeof i=="object"?i.handle:void 0;this.handle=r||this.gl.createBuffer(),s.setSpectorMetadata(this.handle,{...this.props,data:typeof this.props.data}),this.glTarget=v0(this.props.usage),this.glUsage=R0(this.props.usage),this.glIndexType=this.props.indexType==="uint32"?5125:5123,i.data?this._initWithData(i.data,i.byteOffset,i.byteLength):this._initWithByteLength(i.byteLength||0)}_initWithData(s,i=0,r=s.byteLength+i){const n=this.glTarget;this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,r,this.glUsage),this.gl.bufferSubData(n,i,s),this.gl.bindBuffer(n,null),this.bytesUsed=r,this.byteLength=r,this._setDebugData(s,i,r),this.trackAllocatedMemory(r)}_initWithByteLength(s){let i=s;s===0&&(i=new Float32Array(0));const r=this.glTarget;return this.gl.bindBuffer(r,this.handle),this.gl.bufferData(r,i,this.glUsage),this.gl.bindBuffer(r,null),this.bytesUsed=s,this.byteLength=s,this._setDebugData(null,0,s),this.trackAllocatedMemory(s),this}destroy(){!this.destroyed&&this.handle&&(this.removeStats(),this.trackDeallocatedMemory(),this.gl.deleteBuffer(this.handle),this.destroyed=!0,this.handle=null)}write(s,i=0){this.gl.bindBuffer(36663,this.handle),this.gl.bufferSubData(36663,i,s),this.gl.bindBuffer(36663,null),this._setDebugData(s,i,s.byteLength)}async readAsync(s=0,i){return this.readSyncWebGL(s,i)}readSyncWebGL(s=0,i){i=i??this.byteLength-s;const r=new Uint8Array(i),n=0;return this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,s,r,n,i),this.gl.bindBuffer(36662,null),this._setDebugData(r,s,i),r}}function v0(t){return t&j.INDEX?34963:t&j.VERTEX?34962:t&j.UNIFORM?35345:34962}function R0(t){return t&j.INDEX||t&j.VERTEX?35044:t&j.UNIFORM?35048:35044}function x0(t){const e=t.split(/\r?\n/),s=[];for(const i of e){if(i.length<=1)continue;const r=i.split(":");if(r.length===2){const[u,f]=r;s.push({message:f.trim(),type:qa(u),lineNum:0,linePos:0});continue}const[n,o,a,...c]=r;let l=parseInt(a,10);isNaN(l)&&(l=0);let h=parseInt(o,10);isNaN(h)&&(h=0),s.push({message:c.join(":").trim(),type:qa(n),lineNum:l,linePos:h})}return s}function qa(t){const e=["warning","error","info"],s=t.toLowerCase();return e.includes(s)?s:"info"}class P0 extends ai{constructor(s,i){super(s,i);d(this,"device");d(this,"handle");switch(this.device=s,this.props.stage){case"vertex":this.handle=this.props.handle||this.device.gl.createShader(35633);break;case"fragment":this.handle=this.props.handle||this.device.gl.createShader(35632);break;default:throw new Error(this.props.stage)}this._compile(this.source)}destroy(){this.handle&&(this.removeStats(),this.device.gl.deleteShader(this.handle),this.destroyed=!0)}get asyncCompilationStatus(){return this._waitForCompilationComplete().then(()=>this.compilationStatus)}async getCompilationInfo(){return await this._waitForCompilationComplete(),this.getCompilationInfoSync()}getCompilationInfoSync(){const s=this.device.gl.getShaderInfoLog(this.handle);return s?x0(s):[]}getTranslatedSource(){const i=this.device.getExtension("WEBGL_debug_shaders").WEBGL_debug_shaders;return(i==null?void 0:i.getTranslatedShaderSource(this.handle))||null}async _compile(s){s=s.startsWith("#version ")?s:`#version 300 es
${s}`;const{gl:i}=this.device;if(i.shaderSource(this.handle,s),i.compileShader(this.handle),!this.device.props.debug){this.compilationStatus="pending";return}if(!this.device.features.has("compilation-status-async-webgl")){if(this._getCompilationStatus(),this.debugShader(),this.compilationStatus==="error")throw new Error(`GLSL compilation errors in ${this.props.stage} shader ${this.props.id}`);return}x.once(1,"Shader compilation is asynchronous")(),await this._waitForCompilationComplete(),x.info(2,`Shader ${this.id} - async compilation complete: ${this.compilationStatus}`)(),this._getCompilationStatus(),this.debugShader()}async _waitForCompilationComplete(){const s=async n=>await new Promise(o=>setTimeout(o,n));if(!this.device.features.has("compilation-status-async-webgl")){await s(10);return}const{gl:r}=this.device;for(;;){if(r.getShaderParameter(this.handle,37297))return;await s(10)}}_getCompilationStatus(){this.compilationStatus=this.device.gl.getShaderParameter(this.handle,35713)?"success":"error"}}function C0(t,e,s,i){if(N0(e))return i(t);const r=t;r.pushState();try{return I0(t,e),Ft(r.gl,s),i(t)}finally{r.popState()}}function I0(t,e){const s=t,{gl:i}=s;if(e.cullMode)switch(e.cullMode){case"none":i.disable(2884);break;case"front":i.enable(2884),i.cullFace(1028);break;case"back":i.enable(2884),i.cullFace(1029);break}if(e.frontFace&&i.frontFace(Ge("frontFace",e.frontFace,{ccw:2305,cw:2304})),e.unclippedDepth&&t.features.has("depth-clip-control")&&i.enable(34383),e.depthBias!==void 0&&(i.enable(32823),i.polygonOffset(e.depthBias,e.depthBiasSlopeScale||0)),e.provokingVertex&&t.features.has("provoking-vertex-webgl")){const n=s.getExtension("WEBGL_provoking_vertex").WEBGL_provoking_vertex,o=Ge("provokingVertex",e.provokingVertex,{first:36429,last:36430});n==null||n.provokingVertexWEBGL(o)}if((e.polygonMode||e.polygonOffsetLine)&&t.features.has("polygon-mode-webgl")){if(e.polygonMode){const n=s.getExtension("WEBGL_polygon_mode").WEBGL_polygon_mode,o=Ge("polygonMode",e.polygonMode,{fill:6914,line:6913});n==null||n.polygonModeWEBGL(1028,o),n==null||n.polygonModeWEBGL(1029,o)}e.polygonOffsetLine&&i.enable(10754)}if(t.features.has("shader-clip-cull-distance-webgl")&&(e.clipDistance0&&i.enable(12288),e.clipDistance1&&i.enable(12289),e.clipDistance2&&i.enable(12290),e.clipDistance3&&i.enable(12291),e.clipDistance4&&i.enable(12292),e.clipDistance5&&i.enable(12293),e.clipDistance6&&i.enable(12294),e.clipDistance7&&i.enable(12295)),e.depthWriteEnabled!==void 0&&i.depthMask(O0("depthWriteEnabled",e.depthWriteEnabled)),e.depthCompare&&(e.depthCompare!=="always"?i.enable(2929):i.disable(2929),i.depthFunc(yn("depthCompare",e.depthCompare))),e.stencilWriteMask){const r=e.stencilWriteMask;i.stencilMaskSeparate(1028,r),i.stencilMaskSeparate(1029,r)}if(e.stencilReadMask&&x.warn("stencilReadMask not supported under WebGL"),e.stencilCompare){const r=e.stencilReadMask||4294967295,n=yn("depthCompare",e.stencilCompare);e.stencilCompare!=="always"?i.enable(2960):i.disable(2960),i.stencilFuncSeparate(1028,n,0,r),i.stencilFuncSeparate(1029,n,0,r)}if(e.stencilPassOperation&&e.stencilFailOperation&&e.stencilDepthFailOperation){const r=Rr("stencilPassOperation",e.stencilPassOperation),n=Rr("stencilFailOperation",e.stencilFailOperation),o=Rr("stencilDepthFailOperation",e.stencilDepthFailOperation);i.stencilOpSeparate(1028,n,o,r),i.stencilOpSeparate(1029,n,o,r)}switch(e.blend){case!0:i.enable(3042);break;case!1:i.disable(3042);break}if(e.blendColorOperation||e.blendAlphaOperation){const r=Za("blendColorOperation",e.blendColorOperation||"add"),n=Za("blendAlphaOperation",e.blendAlphaOperation||"add");i.blendEquationSeparate(r,n);const o=ks("blendColorSrcFactor",e.blendColorSrcFactor||"one"),a=ks("blendColorDstFactor",e.blendColorDstFactor||"zero"),c=ks("blendAlphaSrcFactor",e.blendAlphaSrcFactor||"one"),l=ks("blendAlphaDstFactor",e.blendAlphaDstFactor||"zero");i.blendFuncSeparate(o,a,c,l)}}function yn(t,e){return Ge(t,e,{never:512,less:513,equal:514,"less-equal":515,greater:516,"not-equal":517,"greater-equal":518,always:519})}function Rr(t,e){return Ge(t,e,{keep:7680,zero:0,replace:7681,invert:5386,"increment-clamp":7682,"decrement-clamp":7683,"increment-wrap":34055,"decrement-wrap":34056})}function Za(t,e){return Ge(t,e,{add:32774,subtract:32778,"reverse-subtract":32779,min:32775,max:32776})}function ks(t,e){return Ge(t,e,{one:1,zero:0,"src-color":768,"one-minus-src-color":769,"dst-color":774,"one-minus-dst-color":775,"src-alpha":770,"one-minus-src-alpha":771,"dst-alpha":772,"one-minus-dst-alpha":773,"src-alpha-saturated":776,"constant-color":32769,"one-minus-constant-color":32770,"constant-alpha":32771,"one-minus-constant-alpha":32772})}function M0(t,e){return`Illegal parameter ${e} for ${t}`}function Ge(t,e,s){if(!(e in s))throw new Error(M0(t,e));return s[e]}function O0(t,e){return e}function N0(t){let e=!0;for(const s in t){e=!1;break}return e}function Uh(t){const e={};return t.addressModeU&&(e[10242]=xr(t.addressModeU)),t.addressModeV&&(e[10243]=xr(t.addressModeV)),t.addressModeW&&(e[32882]=xr(t.addressModeW)),t.magFilter&&(e[10240]=bn(t.magFilter)),(t.minFilter||t.mipmapFilter)&&(e[10241]=k0(t.minFilter||"linear",t.mipmapFilter)),t.lodMinClamp!==void 0&&(e[33082]=t.lodMinClamp),t.lodMaxClamp!==void 0&&(e[33083]=t.lodMaxClamp),t.type==="comparison-sampler"&&(e[34892]=34894),t.compare&&(e[34893]=yn("compare",t.compare)),t.maxAnisotropy&&(e[34046]=t.maxAnisotropy),e}function xr(t){switch(t){case"clamp-to-edge":return 33071;case"repeat":return 10497;case"mirror-repeat":return 33648}}function bn(t){switch(t){case"nearest":return 9728;case"linear":return 9729}}function k0(t,e="none"){if(!e)return bn(t);switch(e){case"none":return bn(t);case"nearest":return t==="nearest"?9984:9986;case"linear":return t==="nearest"?9985:9987}}class Tn extends ci{constructor(s,i){super(s,i);d(this,"device");d(this,"handle");d(this,"parameters");this.device=s,this.parameters=Uh(i),this.handle=this.handle||this.device.gl.createSampler(),this._setSamplerParameters(this.parameters)}destroy(){this.handle&&(this.device.gl.deleteSampler(this.handle),this.handle=void 0)}toString(){return`Sampler(${this.id},${JSON.stringify(this.props)})`}_setSamplerParameters(s){for(const[i,r]of Object.entries(s)){const n=Number(i);switch(n){case 33082:case 33083:this.device.gl.samplerParameterf(this.handle,n,r);break;default:this.device.gl.samplerParameteri(this.handle,n,r);break}}}}function Ot(t,e,s){if(F0(e))return s(t);const{nocatch:i=!0}=e,r=Qe.get(t);r.push(),Ft(t,e);let n;if(i)n=s(t),r.pop();else try{n=s(t)}finally{r.pop()}return n}function F0(t){for(const e in t)return!1;return!0}class mt extends oi{constructor(s,i){super(s,{...K.defaultProps,...i});d(this,"device");d(this,"gl");d(this,"handle");d(this,"texture");this.device=s,this.gl=this.device.gl,this.handle=null,this.texture=i.texture}}const D0="Failed to deduce GL constant from typed array";function B0(t){switch(ArrayBuffer.isView(t)?t.constructor:t){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(D0)}}function U0(t,e){const{clamped:s=!0}=e||{};switch(t){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return s?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function Lh(t){switch(t){case 6406:case 33326:case 6403:case 36244:return 1;case 33339:case 33340:case 33328:case 33320:case 33319:return 2;case 6407:case 36248:case 34837:return 3;case 6408:case 36249:case 34836:return 4;default:return 0}}function L0(t){switch(t){case 5121:return 1;case 33635:case 32819:case 32820:return 2;case 5126:return 4;default:return 0}}function V0(t,e,s){const{dimension:i,width:r,height:n,depth:o=0}=s,{glInternalFormat:a}=s,c=s.glTarget;switch(i){case"2d-array":case"3d":t.texStorage3D(c,e,a,r,n,o);break;default:t.texStorage2D(c,e,a,r,n)}}function Ja(t,e,s,i){const{width:r,height:n}=i,{dimension:o,depth:a=0,mipLevel:c=0}=i,{x:l=0,y:h=0,z:u=0}=i,{glFormat:f,glType:p}=i,_=Vh(i.glTarget,o,a),m=i.flipY?{37440:!0}:{};Ot(t,m,()=>{switch(o){case"2d-array":case"3d":t.bindTexture(_,e),t.texSubImage3D(_,c,l,h,u,r,n,a,f,p,s),t.bindTexture(_,null);break;case"2d":case"cube":t.bindTexture(_,e),t.texSubImage2D(_,c,l,h,r,n,f,p,s),t.bindTexture(_,null);break;default:throw new Error(o)}})}function Qa(t,e,s){const{dimension:i,width:r,height:n,depth:o=0,mipLevel:a=0,byteOffset:c=0}=s,{x:l=0,y:h=0,z:u=0}=s,{glFormat:f,glType:p,compressed:_}=s,m=Vh(s.glTarget,i,o);switch(i){case"2d-array":case"3d":_?t.compressedTexSubImage3D(m,a,l,h,u,r,n,o,f,e,c):t.texSubImage3D(m,a,l,h,u,r,n,o,f,p,e,c);break;case"2d":case"cube":_?t.compressedTexSubImage2D(m,a,l,h,r,n,f,e,c):t.texSubImage2D(m,a,l,h,r,n,f,p,e,c);break;default:throw new Error(i)}}function z0(t){switch(t){case"1d":break;case"2d":return 3553;case"3d":return 32879;case"cube":return 34067;case"2d-array":return 35866}throw new Error(t)}function Vh(t,e,s){return e==="cube"?34069+s:t}function W0(t,e){var S;const{sourceX:s=0,sourceY:i=0,sourceAttachment:r=0}=e||{};let{target:n=null,sourceWidth:o,sourceHeight:a,sourceDepth:c,sourceFormat:l,sourceType:h}=e||{};const{framebuffer:u,deleteFramebuffer:f}=zh(t),{gl:p,handle:_}=u;o||(o=u.width),a||(a=u.height);const m=(S=u.colorAttachments[r])==null?void 0:S.texture;if(!m)throw new Error(`Invalid framebuffer attachment ${r}`);c=(m==null?void 0:m.depth)||1,l||(l=(m==null?void 0:m.glFormat)||6408),h||(h=(m==null?void 0:m.glType)||5121),n=$0(n,h,l,o,a),h=h||B0(n);const T=p.bindFramebuffer(36160,_);return p.readBuffer(36064+r),p.readPixels(s,i,o,a,l,h,n),p.readBuffer(36064),p.bindFramebuffer(36160,T||null),f&&u.destroy(),n}function H0(t,e){const{target:s,sourceX:i=0,sourceY:r=0,sourceFormat:n=6408,targetByteOffset:o=0}=e||{};let{sourceWidth:a,sourceHeight:c,sourceType:l}=e||{};const{framebuffer:h,deleteFramebuffer:u}=zh(t);a=a||h.width,c=c||h.height;const f=h;l=l||5121;let p=s;if(!p){const m=Lh(n),T=L0(l),S=o+a*c*m*T;p=f.device.createBuffer({byteLength:S})}const _=t.device.createCommandEncoder();return _.copyTextureToBuffer({sourceTexture:t,width:a,height:c,origin:[i,r],destinationBuffer:p,byteOffset:o}),_.destroy(),u&&h.destroy(),p}function zh(t){return t instanceof li?{framebuffer:t,deleteFramebuffer:!1}:{framebuffer:j0(t),deleteFramebuffer:!0}}function j0(t,e){const{device:s,width:i,height:r,id:n}=t;return s.createFramebuffer({...e,id:`framebuffer-for-${n}`,width:i,height:r,colorAttachments:[t]})}function $0(t,e,s,i,r,n){if(t)return t;e||(e=5121);const o=U0(e,{clamped:!1}),a=Lh(s);return new o(i*r*a)}class Gt extends K{constructor(s,i){super(s,i);d(this,"device");d(this,"gl");d(this,"handle");d(this,"sampler");d(this,"view");d(this,"mipmaps");d(this,"compressed");d(this,"glTarget");d(this,"glFormat");d(this,"glType");d(this,"glInternalFormat");d(this,"textureUnit",0);const r={...this.props};r.data=i.data,this.device=s,this.gl=this.device.gl,this.glTarget=z0(this.props.dimension);const n=Fh(this.props.format);this.glInternalFormat=n.internalFormat,this.glFormat=n.format,this.glType=n.type,this.compressed=n.compressed,this.mipmaps=!!this.props.mipmaps,this._initialize(r),Object.seal(this)}_initialize(s){this.handle=this.props.handle||this.gl.createTexture(),this.device.setSpectorMetadata(this.handle,{...this.props,data:s.data});let{width:i,height:r}=s;if(!i||!r){const n=K.getTextureDataSize(s.data);i=(n==null?void 0:n.width)||1,r=(n==null?void 0:n.height)||1}if(this.width=i,this.height=r,this.depth=s.depth,this.setSampler(s.sampler),this.view=new mt(this.device,{...this.props,texture:this}),this.bind(),V0(this.gl,this.mipLevels,this),s.data)switch(s.dimension){case"1d":this.setTexture1DData(s.data);break;case"2d":this.setTexture2DData(s.data);break;case"3d":this.setTexture3DData(s.data);break;case"cube":this.setTextureCubeData(s.data);break;case"2d-array":this.setTextureArrayData(s.data);break;case"cube-array":this.setTextureCubeArrayData(s.data);break;default:throw new Error(s.dimension)}this.mipmaps&&this.generateMipmap()}destroy(){this.handle&&(this.gl.deleteTexture(this.handle),this.removeStats(),this.trackDeallocatedMemory("Texture"),this.destroyed=!0)}createView(s){return new mt(this.device,{...s,texture:this})}setSampler(s={}){let i;s instanceof Tn?(this.sampler=s,i=s.props):(this.sampler=new Tn(this.device,s),i=s);const r=Uh(i);this._setSamplerParameters(r)}generateMipmap(s={}){(!this.device.isTextureFormatRenderable(this.props.format)||!this.device.isTextureFormatFilterable(this.props.format))&&x.warn(`${this} is not renderable or filterable, may not be able to generate mipmaps`)();try{this.gl.bindTexture(this.glTarget,this.handle),Ot(this.gl,s,()=>{this.gl.generateMipmap(this.glTarget)})}catch(i){x.warn(`Error generating mipmap for ${this}: ${i.message}`)()}finally{this.gl.bindTexture(this.glTarget,null)}}copyExternalImage(s){const i=K.getExternalImageSize(s.image),r={...K.defaultCopyExternalImageOptions,...i,...s},{image:n,depth:o,mipLevel:a,x:c,y:l,z:h,flipY:u}=r;let{width:f,height:p}=r;const{dimension:_,glTarget:m,glFormat:T,glInternalFormat:S,glType:v}=this;if(f=Math.min(f,this.width-c),p=Math.min(p,this.height-l),s.sourceX||s.sourceY)throw new Error("WebGL does not support sourceX/sourceY)");return Ja(this.device.gl,this.handle,n,{dimension:_,mipLevel:a,x:c,y:l,z:h,width:f,height:p,depth:o,glFormat:T,glInternalFormat:S,glType:v,glTarget:m,flipY:u}),{width:r.width,height:r.height}}setTexture1DData(s){throw new Error("setTexture1DData not supported in WebGL.")}setTexture2DData(s,i=0){this.bind();const r=K.normalizeTextureData(s,this);r.length>1&&this.props.mipmaps!==!1&&x.warn(`Texture ${this.id} mipmap and multiple LODs.`)();for(let n=0;n<r.length;n++){const o=r[n];this._setMipLevel(i,n,o)}this.unbind()}setTexture3DData(s){if(this.props.dimension!=="3d")throw new Error(this.id);ArrayBuffer.isView(s)&&(this.bind(),Qa(this.device.gl,s,this),this.unbind())}setTextureCubeData(s,i=0){if(this.props.dimension!=="cube")throw new Error(this.id);for(const r of K.CubeFaces)this.setTextureCubeFaceData(s[r],r)}setTextureArrayData(s){throw this.props.dimension!=="2d-array"?new Error(this.id):new Error("setTextureArrayData not implemented.")}setTextureCubeArrayData(s){throw new Error("setTextureCubeArrayData not supported in WebGL2.")}setTextureCubeFaceData(s,i,r=0){Array.isArray(s)&&s.length>1&&this.props.mipmaps!==!1&&x.warn(`${this.id} has mipmap and multiple LODs.`)();const n=K.CubeFaces.indexOf(i);this.setTexture2DData(s,n)}update(){throw new Error("Texture.update() not implemented. Use ExternalTexture")}setImageDataForFace(s){const{face:i,width:r,height:n,pixels:o,data:a,format:c=6408,type:l=5121}=s,{gl:h}=this,u=o||a;this.bind(),u instanceof Promise?u.then(f=>this.setImageDataForFace(Object.assign({},s,{face:i,data:f,pixels:f}))):this.width||this.height?h.texImage2D(i,0,c,r,n,0,c,l,u):h.texImage2D(i,0,c,c,l,u)}_getImageDataMap(s){for(let i=0;i<K.CubeFaces.length;++i){const r=K.CubeFaces[i];s[r]&&(s[34069+i]=s[r],delete s[r])}return s}_setSamplerParameters(s){x.log(1,`${this.id} sampler parameters`,this.device.getGLKeys(s))(),this.gl.bindTexture(this.glTarget,this.handle);for(const[i,r]of Object.entries(s)){const n=Number(i),o=r;switch(n){case 33082:case 33083:this.gl.texParameterf(this.glTarget,n,o);break;case 10241:this.gl.texParameteri(this.glTarget,n,o);break;case 10242:case 10243:this.gl.texParameteri(this.glTarget,n,o);break;case 34046:this.device.features.has("texture-filterable-anisotropic-webgl")&&this.gl.texParameteri(this.glTarget,n,o);break;default:this.gl.texParameteri(this.glTarget,n,o);break}}this.gl.bindTexture(this.glTarget,null)}_setMipLevel(s,i,r,n=this.glTarget){if(K.isExternalImage(r)){Ja(this.device.gl,this.handle,r,{...this,depth:s,mipLevel:i,glTarget:n,flipY:this.props.flipY});return}if(K.isTextureLevelData(r)){Qa(this.device.gl,r.data,{...this,depth:s,mipLevel:i,glTarget:n});return}throw new Error("Texture: invalid image data")}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(s){const{gl:i}=this;return s!==void 0&&(this.textureUnit=s,i.activeTexture(33984+s)),i.bindTexture(this.glTarget,this.handle),s}unbind(s){const{gl:i}=this;return s!==void 0&&(this.textureUnit=s,i.activeTexture(33984+s)),i.bindTexture(this.glTarget,null),s}}const X0=[1,2,4,8];class Y0 extends Xr{constructor(s,i){var n;super(s,i);d(this,"device");d(this,"glParameters");this.device=s;let r;if(!((n=i==null?void 0:i.parameters)!=null&&n.viewport))if(i!=null&&i.framebuffer){const{width:o,height:a}=i.framebuffer;r=[0,0,o,a]}else{const[o,a]=s.getCanvasContext().getDrawingBufferSize();r=[0,0,o,a]}if(this.device.pushState(),this.setParameters({viewport:r,...this.props.parameters}),this.props.framebuffer){const o=this.props.framebuffer.colorAttachments.map((a,c)=>36064+c);this.device.gl.drawBuffers(o)}else this.device.gl.drawBuffers([1029]);this.clear()}end(){this.device.popState()}pushDebugGroup(s){}popDebugGroup(){}insertDebugMarker(s){}setParameters(s={}){const i={...this.glParameters};i.framebuffer=this.props.framebuffer||null,this.props.depthReadOnly&&(i.depthMask=!this.props.depthReadOnly),i.stencilMask=this.props.stencilReadOnly?0:1,i[35977]=this.props.discard,s.viewport&&(s.viewport.length>=6?(i.viewport=s.viewport.slice(0,4),i.depthRange=[s.viewport[4],s.viewport[5]]):i.viewport=s.viewport),s.scissorRect&&(i.scissorTest=!0,i.scissor=s.scissorRect),s.blendConstant&&(i.blendColor=s.blendConstant),s.stencilReference&&(console.warn("RenderPassParameters.stencilReference not yet implemented in WebGL"),s[2967]=s.stencilReference),s.colorMask&&(i.colorMask=X0.map(r=>!!(r&s.colorMask))),this.glParameters=i,Ft(this.device.gl,i)}beginOcclusionQuery(s){const i=this.props.occlusionQuerySet;i==null||i.beginOcclusionQuery()}endOcclusionQuery(){const s=this.props.occlusionQuerySet;s==null||s.endOcclusionQuery()}clear(){const s={...this.glParameters};let i=0;this.props.clearColors&&this.props.clearColors.forEach((r,n)=>{r&&this.clearColorBuffer(n,r)}),this.props.clearColor!==!1&&this.props.clearColors===void 0&&(i|=16384,s.clearColor=this.props.clearColor),this.props.clearDepth!==!1&&(i|=256,s.clearDepth=this.props.clearDepth),this.props.clearStencil!==!1&&(i|=1024,s.clearStencil=this.props.clearStencil),i!==0&&Ot(this.device.gl,s,()=>{this.device.gl.clear(i)})}clearColorBuffer(s=0,i=[0,0,0,0]){Ot(this.device.gl,{framebuffer:this.props.framebuffer},()=>{switch(i.constructor){case Int8Array:case Int16Array:case Int32Array:this.device.gl.clearBufferiv(6144,s,i);break;case Uint8Array:case Uint8ClampedArray:case Uint16Array:case Uint32Array:this.device.gl.clearBufferuiv(6144,s,i);break;case Float32Array:this.device.gl.clearBufferfv(6144,s,i);break;default:throw new Error("clearColorBuffer: color must be typed array")}})}}function K0(t){return q0.includes(t)}const q0=[35678,35680,35679,35682,36289,36292,36293,36298,36299,36300,36303,36306,36307,36308,36311],Wh={5126:[5126,1,"float","f32","float32"],35664:[5126,2,"vec2","vec2<f32>","float32x2"],35665:[5126,3,"vec3","vec3<f32>","float32x3"],35666:[5126,4,"vec4","vec4<f32>","float32x4"],5124:[5124,1,"int","i32","sint32"],35667:[5124,2,"ivec2","vec2<i32>","sint32x2"],35668:[5124,3,"ivec3","vec3<i32>","sint32x3"],35669:[5124,4,"ivec4","vec4<i32>","sint32x4"],5125:[5125,1,"uint","u32","uint32"],36294:[5125,2,"uvec2","vec2<u32>","uint32x2"],36295:[5125,3,"uvec3","vec3<u32>","uint32x3"],36296:[5125,4,"uvec4","vec4<u32>","uint32x4"],35670:[5126,1,"bool","f32","float32"],35671:[5126,2,"bvec2","vec2<f32>","float32x2"],35672:[5126,3,"bvec3","vec3<f32>","float32x3"],35673:[5126,4,"bvec4","vec4<f32>","float32x4"],35674:[5126,8,"mat2","mat2x2<f32>"],35685:[5126,8,"mat2x3","mat2x3<f32>"],35686:[5126,8,"mat2x4","mat2x4<f32>"],35687:[5126,12,"mat3x2","mat3x2<f32>"],35675:[5126,12,"mat3","mat3x3<f32>"],35688:[5126,12,"mat3x4","mat3x4<f32>"],35689:[5126,16,"mat4x2","mat4x2<f32>"],35690:[5126,16,"mat4x3","mat4x3<f32>"],35676:[5126,16,"mat4","mat4x4<f32>"]};function Hh(t){const e=Wh[t];if(!e)throw new Error("uniform");const[s,i,,r]=e;return{format:r,components:i,glType:s}}function Z0(t){const e=Wh[t];if(!e)throw new Error("attribute");const[,s,,i,r]=e;return{attributeType:i,vertexFormat:r,components:s}}function J0(t,e){const s={attributes:[],bindings:[]};s.attributes=Q0(t,e);const i=tA(t,e);for(const a of i){const c=a.uniforms.map(l=>({name:l.name,format:l.format,byteOffset:l.byteOffset,byteStride:l.byteStride,arrayLength:l.arrayLength}));s.bindings.push({type:"uniform",name:a.name,location:a.location,visibility:(a.vertex?1:0)&(a.fragment?2:0),minBindingSize:a.byteLength,uniforms:c})}const r=eA(t,e);let n=0;for(const a of r)if(K0(a.type)){const{viewDimension:c,sampleType:l}=iA(a.type);s.bindings.push({type:"texture",name:a.name,location:n,viewDimension:c,sampleType:l}),a.textureUnit=n,n+=1}r.length&&(s.uniforms=r);const o=G0(t,e);return o!=null&&o.length&&(s.varyings=o),s}function Q0(t,e){const s=[],i=t.getProgramParameter(e,35721);for(let r=0;r<i;r++){const n=t.getActiveAttrib(e,r);if(!n)throw new Error("activeInfo");const{name:o,type:a}=n,c=t.getAttribLocation(e,o);if(c>=0){const{attributeType:l}=Z0(a),h=/instance/i.test(o)?"instance":"vertex";s.push({name:o,location:c,stepMode:h,type:l})}}return s.sort((r,n)=>r.location-n.location),s}function G0(t,e){const s=[],i=t.getProgramParameter(e,35971);for(let r=0;r<i;r++){const n=t.getTransformFeedbackVarying(e,r);if(!n)throw new Error("activeInfo");const{name:o,type:a,size:c}=n,{glType:l,components:h}=Hh(a),u={location:r,name:o,type:l,size:c*h};s.push(u)}return s.sort((r,n)=>r.location-n.location),s}function eA(t,e){const s=[],i=t.getProgramParameter(e,35718);for(let r=0;r<i;r++){const n=t.getActiveUniform(e,r);if(!n)throw new Error("activeInfo");const{name:o,size:a,type:c}=n,{name:l,isArray:h}=rA(o);let u=t.getUniformLocation(e,l);const f={location:u,name:l,size:a,type:c,isArray:h};if(s.push(f),f.size>1)for(let p=0;p<f.size;p++){const _=`${l}[${p}]`;u=t.getUniformLocation(e,_);const m={...f,name:_,location:u};s.push(m)}}return s}function tA(t,e){const s=(n,o)=>t.getActiveUniformBlockParameter(e,n,o),i=[],r=t.getProgramParameter(e,35382);for(let n=0;n<r;n++){const o={name:t.getActiveUniformBlockName(e,n)||"",location:s(n,35391),byteLength:s(n,35392),vertex:s(n,35396),fragment:s(n,35398),uniformCount:s(n,35394),uniforms:[]},a=s(n,35395)||[],c=t.getActiveUniforms(e,a,35383),l=t.getActiveUniforms(e,a,35384),h=t.getActiveUniforms(e,a,35387),u=t.getActiveUniforms(e,a,35388);for(let f=0;f<o.uniformCount;++f){const p=t.getActiveUniform(e,a[f]);if(!p)throw new Error("activeInfo");o.uniforms.push({name:p.name,format:Hh(c[f]).format,type:c[f],arrayLength:l[f],byteOffset:h[f],byteStride:u[f]})}i.push(o)}return i.sort((n,o)=>n.location-o.location),i}const sA={35678:["2d","float"],35680:["cube","float"],35679:["3d","float"],35682:["3d","depth"],36289:["2d-array","float"],36292:["2d-array","depth"],36293:["cube","float"],36298:["2d","sint"],36299:["3d","sint"],36300:["cube","sint"],36303:["2d-array","uint"],36306:["2d","uint"],36307:["3d","uint"],36308:["cube","uint"],36311:["2d-array","uint"]};function iA(t){const e=sA[t];if(!e)throw new Error("sampler");const[s,i]=e;return{viewDimension:s,sampleType:i}}function rA(t){if(t[t.length-1]!=="]")return{name:t,length:1,isArray:!1};const s=/([^[]*)(\[[0-9]+\])?/.exec(t);if(!s||s.length<2)throw new Error(`Failed to parse GLSL uniform name ${t}`);return{name:s[1],length:s[2]?1:0,isArray:!!s[2]}}function nA(t,e,s,i){const r=t;let n=i;n===!0&&(n=1),n===!1&&(n=0);const o=typeof n=="number"?[n]:n;switch(s){case 35678:case 35680:case 35679:case 35682:case 36289:case 36292:case 36293:case 36298:case 36299:case 36300:case 36303:case 36306:case 36307:case 36308:case 36311:if(typeof i!="number")throw new Error("samplers must be set to integers");return t.uniform1i(e,i);case 5126:return t.uniform1fv(e,o);case 35664:return t.uniform2fv(e,o);case 35665:return t.uniform3fv(e,o);case 35666:return t.uniform4fv(e,o);case 5124:return t.uniform1iv(e,o);case 35667:return t.uniform2iv(e,o);case 35668:return t.uniform3iv(e,o);case 35669:return t.uniform4iv(e,o);case 35670:return t.uniform1iv(e,o);case 35671:return t.uniform2iv(e,o);case 35672:return t.uniform3iv(e,o);case 35673:return t.uniform4iv(e,o);case 5125:return r.uniform1uiv(e,o,1);case 36294:return r.uniform2uiv(e,o,2);case 36295:return r.uniform3uiv(e,o,3);case 36296:return r.uniform4uiv(e,o,4);case 35674:return t.uniformMatrix2fv(e,!1,o);case 35675:return t.uniformMatrix3fv(e,!1,o);case 35676:return t.uniformMatrix4fv(e,!1,o);case 35685:return r.uniformMatrix2x3fv(e,!1,o);case 35686:return r.uniformMatrix2x4fv(e,!1,o);case 35687:return r.uniformMatrix3x2fv(e,!1,o);case 35688:return r.uniformMatrix3x4fv(e,!1,o);case 35689:return r.uniformMatrix4x2fv(e,!1,o);case 35690:return r.uniformMatrix4x3fv(e,!1,o)}throw new Error("Illegal uniform")}function oA(t){return wh(t)!==null||typeof t=="number"||typeof t=="boolean"}function aA(t){const e={bindings:{},uniforms:{}};return Object.keys(t).forEach(s=>{const i=t[s];oA(i)?e.uniforms[s]=i:e.bindings[s]=i}),e}function cA(t){switch(t){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 3;case"triangle-list":return 4;case"triangle-strip":return 5;default:throw new Error(t)}}function lA(t){switch(t){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 1;case"triangle-list":return 4;case"triangle-strip":return 4;default:throw new Error(t)}}const Ga=4;class hA extends St{constructor(s,i){super(s,i);d(this,"device");d(this,"handle");d(this,"vs");d(this,"fs");d(this,"introspectedLayout");d(this,"uniforms",{});d(this,"bindings",{});d(this,"varyings",null);d(this,"_uniformCount",0);d(this,"_uniformSetters",{});this.device=s,this.handle=this.props.handle||this.device.gl.createProgram(),this.device.setSpectorMetadata(this.handle,{id:this.props.id}),this.vs=i.vs,this.fs=i.fs;const{varyings:r,bufferMode:n=35981}=i;r&&r.length>0&&(this.varyings=r,this.device.gl.transformFeedbackVaryings(this.handle,r,n)),this._linkShaders(),x.time(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.introspectedLayout=J0(this.device.gl,this.handle),x.timeEnd(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.shaderLayout=uA(this.introspectedLayout,i.shaderLayout)}destroy(){this.handle&&(this.device.gl.deleteProgram(this.handle),this.destroyed=!0)}setBindings(s,i){for(const[r,n]of Object.entries(s)){const o=this.shaderLayout.bindings.find(a=>a.name===r)||this.shaderLayout.bindings.find(a=>a.name===`${r}Uniforms`);if(!o){const a=this.shaderLayout.bindings.map(c=>`"${c.name}"`).join(", ");i!=null&&i.disableWarnings||x.warn(`No binding "${r}" in render pipeline "${this.id}", expected one of ${a}`,n)();continue}switch(n||x.warn(`Unsetting binding "${r}" in render pipeline "${this.id}"`)(),o.type){case"uniform":if(!(n instanceof Qt)&&!(n.buffer instanceof Qt))throw new Error("buffer value");break;case"texture":if(!(n instanceof mt||n instanceof Gt||n instanceof Jt))throw new Error("texture value");break;case"sampler":x.warn(`Ignoring sampler ${r}`)();break;default:throw new Error(o.type)}this.bindings[r]=n}}draw(s){var T;const{renderPass:i,parameters:r=this.props.parameters,topology:n=this.props.topology,vertexArray:o,vertexCount:a,instanceCount:c,isInstanced:l=!1,firstVertex:h=0,transformFeedback:u}=s,f=cA(n),p=!!o.indexBuffer,_=(T=o.indexBuffer)==null?void 0:T.glIndexType;if(this.linkStatus!=="success")return x.info(2,`RenderPipeline:${this.id}.draw() aborted - waiting for shader linking`)(),!1;if(!this._areTexturesRenderable())return x.info(2,`RenderPipeline:${this.id}.draw() aborted - textures not yet loaded`)(),!1;this.device.gl.useProgram(this.handle),o.bindBeforeRender(i),u&&u.begin(this.props.topology),this._applyBindings(),this._applyUniforms();const m=i;return C0(this.device,r,m.glParameters,()=>{p&&l?this.device.gl.drawElementsInstanced(f,a||0,_,h,c||0):p?this.device.gl.drawElements(f,a||0,_,h):l?this.device.gl.drawArraysInstanced(f,h,a||0,c||0):this.device.gl.drawArrays(f,h,a||0),u&&u.end()}),o.unbindAfterRender(i),!0}setUniformsWebGL(s){const{bindings:i}=aA(s);Object.keys(i).forEach(r=>{x.warn(`Unsupported value "${JSON.stringify(i[r])}" used in setUniforms() for key ${r}. Use setBindings() instead?`)()}),Object.assign(this.uniforms,s)}async _linkShaders(){const{gl:s}=this.device;if(s.attachShader(this.handle,this.vs.handle),s.attachShader(this.handle,this.fs.handle),x.time(Ga,`linkProgram for ${this.id}`)(),s.linkProgram(this.handle),x.timeEnd(Ga,`linkProgram for ${this.id}`)(),x.level,!this.device.features.has("compilation-status-async-webgl")){const r=this._getLinkStatus();this._reportLinkStatus(r);return}x.once(1,"RenderPipeline linking is asynchronous")(),await this._waitForLinkComplete(),x.info(2,`RenderPipeline ${this.id} - async linking complete: ${this.linkStatus}`)();const i=this._getLinkStatus();this._reportLinkStatus(i)}async _reportLinkStatus(s){var i;switch(s){case"success":return;default:switch(this.vs.compilationStatus){case"error":throw this.vs.debugShader(),new Error(`Error during compilation of shader ${this.vs.id}`);case"pending":this.vs.asyncCompilationStatus.then(()=>this.vs.debugShader());break}switch((i=this.fs)==null?void 0:i.compilationStatus){case"error":throw this.fs.debugShader(),new Error(`Error during compilation of shader ${this.fs.id}`);case"pending":this.fs.asyncCompilationStatus.then(()=>this.fs.debugShader());break}const r=this.device.gl.getProgramInfoLog(this.handle);throw new Error(`Error during ${s}: ${r}`)}}_getLinkStatus(){const{gl:s}=this.device;return s.getProgramParameter(this.handle,35714)?(s.validateProgram(this.handle),s.getProgramParameter(this.handle,35715)?(this.linkStatus="success","success"):(this.linkStatus="error","validation")):(this.linkStatus="error","linking")}async _waitForLinkComplete(){const s=async n=>await new Promise(o=>setTimeout(o,n));if(!this.device.features.has("compilation-status-async-webgl")){await s(10);return}const{gl:r}=this.device;for(;;){if(r.getProgramParameter(this.handle,37297))return;await s(10)}}_areTexturesRenderable(){let s=!0;for(const i of this.shaderLayout.bindings)!this.bindings[i.name]&&!this.bindings[i.name.replace(/Uniforms$/,"")]&&(x.warn(`Binding ${i.name} not found in ${this.id}`)(),s=!1);return s}_applyBindings(){if(this.linkStatus!=="success")return;const{gl:s}=this.device;s.useProgram(this.handle);let i=0,r=0;for(const n of this.shaderLayout.bindings){const o=this.bindings[n.name]||this.bindings[n.name.replace(/Uniforms$/,"")];if(!o)throw new Error(`No value for binding ${n.name} in ${this.id}`);switch(n.type){case"uniform":const{name:a}=n,c=s.getUniformBlockIndex(this.handle,a);if(c===4294967295)throw new Error(`Invalid uniform block name ${a}`);s.uniformBlockBinding(this.handle,r,c),o instanceof Qt?s.bindBufferBase(35345,r,o.handle):s.bindBufferRange(35345,r,o.buffer.handle,o.offset||0,o.size||o.buffer.byteLength-o.offset),r+=1;break;case"texture":if(!(o instanceof mt||o instanceof Gt||o instanceof Jt))throw new Error("texture");let l;if(o instanceof mt)l=o.texture;else if(o instanceof Gt)l=o;else if(o instanceof Jt&&o.colorAttachments[0]instanceof mt)x.warn("Passing framebuffer in texture binding may be deprecated. Use fbo.colorAttachments[0] instead")(),l=o.colorAttachments[0].texture;else throw new Error("No texture");s.activeTexture(33984+i),s.bindTexture(l.glTarget,l.handle),i+=1;break;case"sampler":break;case"storage":case"read-only-storage":throw new Error(`binding type '${n.type}' not supported in WebGL`)}}}_applyUniforms(){for(const s of this.shaderLayout.uniforms||[]){const{name:i,location:r,type:n,textureUnit:o}=s,a=this.uniforms[i]??o;a!==void 0&&nA(this.device.gl,r,n,a)}}}function uA(t,e){const s={...t,attributes:t.attributes.map(i=>({...i}))};for(const i of(e==null?void 0:e.attributes)||[]){const r=s.attributes.find(n=>n.name===i.name);r?(r.type=i.type||r.type,r.stepMode=i.stepMode||r.stepMode):x.warn(`shader layout attribute ${i.name} not present in shader`)}return s}class fA extends Kr{constructor(s){super(s,{});d(this,"device");d(this,"commands",[]);this.device=s}submitCommands(s=this.commands){for(const i of s)switch(i.name){case"copy-buffer-to-buffer":dA(this.device,i.options);break;case"copy-buffer-to-texture":gA(this.device,i.options);break;case"copy-texture-to-buffer":pA(this.device,i.options);break;case"copy-texture-to-texture":_A(this.device,i.options);break;default:throw new Error(i.name)}}}function dA(t,e){const s=e.sourceBuffer,i=e.destinationBuffer;t.gl.bindBuffer(36662,s.handle),t.gl.bindBuffer(36663,i.handle),t.gl.copyBufferSubData(36662,36663,e.sourceOffset??0,e.destinationOffset??0,e.size),t.gl.bindBuffer(36662,null),t.gl.bindBuffer(36663,null)}function gA(t,e){throw new Error("Not implemented")}function pA(t,e){const{sourceTexture:s,mipLevel:i=0,aspect:r="all",width:n=e.sourceTexture.width,height:o=e.sourceTexture.height,depthOrArrayLayers:a=0,origin:c=[0,0],destinationBuffer:l,byteOffset:h=0,bytesPerRow:u,rowsPerImage:f}=e;if(r!=="all")throw new Error("aspect not supported in WebGL");if(i!==0||a!==0||u||f)throw new Error("not implemented");const{framebuffer:p,destroyFramebuffer:_}=jh(s);let m;try{const T=l,S=n||p.width,v=o||p.height,w=Fh(p.colorAttachments[0].texture.props.format),E=w.format,R=w.type;t.gl.bindBuffer(35051,T.handle),m=t.gl.bindFramebuffer(36160,p.handle),t.gl.readPixels(c[0],c[1],S,v,E,R,h)}finally{t.gl.bindBuffer(35051,null),m!==void 0&&t.gl.bindFramebuffer(36160,m),_&&p.destroy()}}function _A(t,e){const{sourceTexture:s,destinationMipLevel:i=0,origin:r=[0,0],destinationOrigin:n=[0,0],destinationTexture:o}=e;let{width:a=e.destinationTexture.width,height:c=e.destinationTexture.height}=e;const{framebuffer:l,destroyFramebuffer:h}=jh(s),[u,f]=r,[p,_,m]=n,T=t.gl.bindFramebuffer(36160,l.handle);let S=null,v;if(o instanceof Gt)S=o,a=Number.isFinite(a)?a:S.width,c=Number.isFinite(c)?c:S.height,S.bind(0),v=S.glTarget;else throw new Error("invalid destination");switch(v){case 3553:case 34067:t.gl.copyTexSubImage2D(v,i,p,_,u,f,a,c);break;case 35866:case 32879:t.gl.copyTexSubImage3D(v,i,p,_,m,u,f,a,c);break}S&&S.unbind(),t.gl.bindFramebuffer(36160,T),h&&l.destroy()}function jh(t){if(t instanceof K){const{width:e,height:s,id:i}=t;return{framebuffer:t.device.createFramebuffer({id:`framebuffer-for-${i}`,width:e,height:s,colorAttachments:[t]}),destroyFramebuffer:!0}}return{framebuffer:t,destroyFramebuffer:!1}}class mA extends Yr{constructor(s,i){super(s,i);d(this,"device");d(this,"commandBuffer");this.device=s,this.commandBuffer=new fA(s)}destroy(){}finish(){this.commandBuffer.submitCommands()}copyBufferToBuffer(s){this.commandBuffer.commands.push({name:"copy-buffer-to-buffer",options:s})}copyBufferToTexture(s){this.commandBuffer.commands.push({name:"copy-buffer-to-texture",options:s})}copyTextureToBuffer(s){this.commandBuffer.commands.push({name:"copy-texture-to-buffer",options:s})}copyTextureToTexture(s){this.commandBuffer.commands.push({name:"copy-texture-to-texture",options:s})}pushDebugGroup(s){}popDebugGroup(){}insertDebugMarker(s){}resolveQuerySet(s,i,r){}}function yA(t){const{target:e,source:s,start:i=0,count:r=1}=t,n=s.length,o=r*n;let a=0;for(let c=i;a<n;a++)e[c++]=s[a];for(;a<o;)a<o-a?(e.copyWithin(i+a,i,i+a),a*=2):(e.copyWithin(i+a,i,i+o-a),a=o);return t.target}class Qn extends qr{constructor(s,i){super(s,i);d(this,"device");d(this,"handle");d(this,"buffer",null);d(this,"bufferValue",null);this.device=s,this.handle=this.device.gl.createVertexArray()}get[Symbol.toStringTag](){return"VertexArray"}static isConstantAttributeZeroSupported(s){return Nu()==="Chrome"}destroy(){var s;super.destroy(),this.buffer&&((s=this.buffer)==null||s.destroy()),this.handle&&(this.device.gl.deleteVertexArray(this.handle),this.handle=void 0)}setIndexBuffer(s){const i=s;if(i&&i.glTarget!==34963)throw new Error("Use .setBuffer()");this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34963,i?i.handle:null),this.indexBuffer=i,this.device.gl.bindVertexArray(null)}setBuffer(s,i){const r=i;if(r.glTarget===34963)throw new Error("Use .setIndexBuffer()");const{size:n,type:o,stride:a,offset:c,normalized:l,integer:h,divisor:u}=this._getAccessor(s);this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34962,r.handle),h?this.device.gl.vertexAttribIPointer(s,n,o,a,c):this.device.gl.vertexAttribPointer(s,n,o,l,a,c),this.device.gl.bindBuffer(34962,null),this.device.gl.enableVertexAttribArray(s),this.device.gl.vertexAttribDivisor(s,u||0),this.attributes[s]=r,this.device.gl.bindVertexArray(null)}setConstantWebGL(s,i){this._enable(s,!1),this.attributes[s]=i}bindBeforeRender(){this.device.gl.bindVertexArray(this.handle),this._applyConstantAttributes()}unbindAfterRender(){this.device.gl.bindVertexArray(null)}_applyConstantAttributes(){for(let s=0;s<this.maxVertexAttributes;++s){const i=this.attributes[s];ArrayBuffer.isView(i)&&this.device.setConstantAttributeWebGL(s,i)}}_getAccessor(s){const i=this.attributeInfos[s];if(!i)throw new Error(`Unknown attribute location ${s}`);const r=Nh(i.bufferDataType);return{size:i.bufferComponents,type:r,stride:i.byteStride,offset:i.byteOffset,normalized:i.normalized,integer:i.integer,divisor:i.stepMode==="instance"?1:0}}_enable(s,i=!0){const n=Qn.isConstantAttributeZeroSupported(this.device)||s!==0;(i||n)&&(s=Number(s),this.device.gl.bindVertexArray(this.handle),i?this.device.gl.enableVertexAttribArray(s):this.device.gl.disableVertexAttribArray(s),this.device.gl.bindVertexArray(null))}getConstantBuffer(s,i){const r=bA(i),n=r.byteLength*s,o=r.length*s;if(this.buffer&&n!==this.buffer.byteLength)throw new Error(`Buffer size is immutable, byte length ${n} !== ${this.buffer.byteLength}.`);let a=!this.buffer;if(this.buffer=this.buffer||this.device.createBuffer({byteLength:n}),a=a||!TA(r,this.bufferValue),a){const c=bp(i.constructor,o);yA({target:c,source:r,start:0,count:o}),this.buffer.write(c),this.bufferValue=i}return this.buffer}}function bA(t){return Array.isArray(t)?new Float32Array(t):t}function TA(t,e){if(!t||!e||t.length!==e.length||t.constructor!==e.constructor)return!1;for(let s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0}class AA extends Zr{constructor(s,i){super(s,i);d(this,"device");d(this,"gl");d(this,"handle");d(this,"layout");d(this,"buffers",{});d(this,"unusedBuffers",{});d(this,"bindOnUse",!0);d(this,"_bound",!1);this.device=s,this.gl=s.gl,this.handle=this.props.handle||this.gl.createTransformFeedback(),this.layout=this.props.layout,i.buffers&&this.setBuffers(i.buffers),Object.seal(this)}destroy(){this.gl.deleteTransformFeedback(this.handle),super.destroy()}begin(s="point-list"){this.gl.bindTransformFeedback(36386,this.handle),this.bindOnUse&&this._bindBuffers(),this.gl.beginTransformFeedback(lA(s))}end(){this.gl.endTransformFeedback(),this.bindOnUse&&this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null)}setBuffers(s){this.buffers={},this.unusedBuffers={},this.bind(()=>{for(const i in s)this.setBuffer(i,s[i])})}setBuffer(s,i){const r=this._getVaryingIndex(s),{buffer:n,byteLength:o,byteOffset:a}=this._getBufferRange(i);if(r<0){this.unusedBuffers[s]=n,x.warn(`${this.id} unusedBuffers varying buffer ${s}`)();return}this.buffers[r]={buffer:n,byteLength:o,byteOffset:a},this.bindOnUse||this._bindBuffer(r,n,a,o)}getBuffer(s){if(ec(s))return this.buffers[s]||null;const i=this._getVaryingIndex(s);return i>=0?this.buffers[i]:null}bind(s=this.handle){if(typeof s!="function")return this.gl.bindTransformFeedback(36386,s),this;let i;return this._bound?i=s():(this.gl.bindTransformFeedback(36386,this.handle),this._bound=!0,i=s(),this._bound=!1,this.gl.bindTransformFeedback(36386,null)),i}unbind(){this.bind(null)}_getBufferRange(s){if(s instanceof Qt)return{buffer:s,byteOffset:0,byteLength:s.byteLength};const{buffer:i,byteOffset:r=0,byteLength:n=s.buffer.byteLength}=s;return{buffer:i,byteOffset:r,byteLength:n}}_getVaryingIndex(s){if(ec(s))return Number(s);for(const i of this.layout.varyings)if(s===i.name)return i.location;return-1}_bindBuffers(){for(const s in this.buffers){const{buffer:i,byteLength:r,byteOffset:n}=this._getBufferRange(this.buffers[s]);this._bindBuffer(Number(s),i,n,r)}}_unbindBuffers(){for(const s in this.buffers)this.gl.bindBufferBase(35982,Number(s),null)}_bindBuffer(s,i,r=0,n){const o=i&&i.handle;!o||n===void 0?this.gl.bindBufferBase(35982,s,o):this.gl.bindBufferRange(35982,s,o,r,n)}}function ec(t){return typeof t=="number"?Number.isInteger(t):/^\d+$/.test(t)}class wA extends Jr{constructor(s,i){super(s,i);d(this,"device");d(this,"handle");d(this,"target",null);d(this,"_queryPending",!1);d(this,"_pollingPromise",null);if(this.device=s,i.count>1)throw new Error("WebGL QuerySet can only have one value");this.handle=this.device.gl.createQuery(),Object.seal(this)}get[Symbol.toStringTag](){return"Query"}destroy(){this.device.gl.deleteQuery(this.handle)}beginTimestampQuery(){return this._begin(35007)}endTimestampQuery(){this._end()}beginOcclusionQuery(s){return this._begin(s!=null&&s.conservative?36202:35887)}endOcclusionQuery(){this._end()}beginTransformFeedbackQuery(){return this._begin(35976)}endTransformFeedbackQuery(){this._end()}async resolveQuery(){return[await this.pollQuery()]}_begin(s){this._queryPending||(this.target=s,this.device.gl.beginQuery(this.target,this.handle))}_end(){this._queryPending||this.target&&(this.device.gl.endQuery(this.target),this.target=null,this._queryPending=!0)}isResultAvailable(){if(!this._queryPending)return!1;const s=this.device.gl.getQueryParameter(this.handle,34919);return s&&(this._queryPending=!1),s}isTimerDisjoint(){return this.device.gl.getParameter(36795)}getResult(){return this.device.gl.getQueryParameter(this.handle,34918)}getTimerMilliseconds(){return this.getResult()/1e6}pollQuery(s=Number.POSITIVE_INFINITY){if(this._pollingPromise)return this._pollingPromise;let i=0;return this._pollingPromise=new Promise((r,n)=>{const o=()=>{this.isResultAvailable()?(r(this.getResult()),this._pollingPromise=null):i++>s?(n("Timed out"),this._pollingPromise=null):requestAnimationFrame(o)};requestAnimationFrame(o)}),this._pollingPromise}}const SA=256,EA=1024,vA=16384;function RA(t,e){x.warn("clear will be removed in next minor release");const{framebuffer:s=null,color:i=null,depth:r=null,stencil:n=null}=e||{},o={};s&&(o.framebuffer=s);let a=0;i&&(a|=vA,i!==!0&&(o.clearColor=i)),r&&(a|=SA,r!==!0&&(o.clearDepth=r)),n&&(a|=EA,r!==!0&&(o.clearStencil=r));const c=t.gl;Ot(c,o,()=>{c.clear(a)})}class Xt extends Ze{constructor(s){var h,u;super({...s,id:s.id||E0("webgl-device")});d(this,"type","webgl");d(this,"handle");d(this,"features");d(this,"limits");d(this,"info");d(this,"canvasContext");d(this,"lost");d(this,"_resolveContextLost");d(this,"gl");d(this,"debug",!1);d(this,"_canvasSizeInfo",{clientWidth:0,clientHeight:0,devicePixelRatio:1});d(this,"_extensions",{});d(this,"_polyfilled",!1);d(this,"spectorJS");d(this,"renderPass",null);d(this,"_constants");if(!s.createCanvasContext)throw new Error("WebGLDevice requires props.createCanvasContext to be set");const i=s.createCanvasContext===!0?{}:s.createCanvasContext;let r=(u=(h=i.canvas)==null?void 0:h.gl)==null?void 0:u.device;if(r)throw new Error(`WebGL context already attached to device ${r.id}`);this.canvasContext=new d0(this,i),this.lost=new Promise(f=>{this._resolveContextLost=f});const n={...s.webgl};i.alphaMode==="premultiplied"&&(n.premultipliedAlpha=!0),s.powerPreference!==void 0&&(n.powerPreference=s.powerPreference);const o=jT(this.canvasContext.canvas,{onContextLost:f=>{var p;return(p=this._resolveContextLost)==null?void 0:p.call(this,{reason:"destroyed",message:"Entered sleep mode, or too many apps or browser tabs are using the GPU."})},onContextRestored:f=>console.log("WebGL context restored")},n);if(!o)throw new Error("WebGL context creation failed");if(r=o.device,r)throw new Error(`WebGL context already attached to device ${r.id}`);this.handle=o,this.gl=o,this.spectorJS=_0({...this.props,gl:this.handle}),this.gl.device=this,this.gl._version=2,this.info=$T(this.gl,this._extensions),this.limits=new h0(this.gl),this.features=new l0(this.gl,this._extensions,this.props._disabledFeatures),this.props._initializeFeatures&&this.features.initializeFeatures(),this.canvasContext.resize(),new Qe(this.gl,{log:(...f)=>x.log(1,...f)()}).trackState(this.gl,{copyState:!1});const c=s.debugWebGL||s.debug,l=s.debugWebGL;c&&(this.gl=b0(this.gl,{debugWebGL:c,traceWebGL:l}),x.warn("WebGL debug mode activated. Performance reduced.")(),s.debugWebGL&&(x.level=Math.max(x.level,1)))}destroy(){}get isLost(){return this.gl.isContextLost()}isTextureFormatSupported(s){return i0(this.gl,s,this._extensions)}isTextureFormatFilterable(s){return r0(this.gl,s,this._extensions)}isTextureFormatRenderable(s){return n0(this.gl,s,this._extensions)}createCanvasContext(s){throw new Error("WebGL only supports a single canvas")}createBuffer(s){const i=this._normalizeBufferProps(s);return new Qt(this,i)}createTexture(s){return new Gt(this,s)}createExternalTexture(s){throw new Error("createExternalTexture() not implemented")}createSampler(s){return new Tn(this,s)}createShader(s){return new P0(this,s)}createFramebuffer(s){return new Jt(this,s)}createVertexArray(s){return new Qn(this,s)}createTransformFeedback(s){return new AA(this,s)}createQuerySet(s){return new wA(this,s)}createRenderPipeline(s){return new hA(this,s)}beginRenderPass(s){return new Y0(this,s)}createComputePipeline(s){throw new Error("ComputePipeline not supported in WebGL")}beginComputePass(s){throw new Error("ComputePass not supported in WebGL")}createCommandEncoder(s={}){return new mA(this,s)}submit(){var s;(s=this.renderPass)==null||s.end(),this.renderPass=null}readPixelsToArrayWebGL(s,i){return W0(s,i)}readPixelsToBufferWebGL(s,i){return H0(s,i)}setParametersWebGL(s){Ft(this.gl,s)}getParametersWebGL(s){return Mh(this.gl,s)}withParametersWebGL(s,i){return Ot(this.gl,s,i)}clearWebGL(s){RA(this,s)}resetWebGL(){x.warn("WebGLDevice.resetWebGL is deprecated, use only for debugging")(),LT(this.gl)}loseDevice(){var n;let s=!1;const r=this.getExtension("WEBGL_lose_context").WEBGL_lose_context;return r&&(s=!0,r.loseContext()),(n=this._resolveContextLost)==null||n.call(this,{reason:"destroyed",message:"Application triggered context loss"}),s}pushState(){Qe.get(this.gl).push()}popState(){Qe.get(this.gl).pop()}setSpectorMetadata(s,i){s.__SPECTOR_Metadata=i}getGLKey(s,i){const r=Number(s);for(const n in this.gl)if(this.gl[n]===r)return`GL.${n}`;return i!=null&&i.emptyIfUnknown?"":String(s)}getGLKeys(s){const i={emptyIfUnknown:!0};return Object.entries(s).reduce((r,[n,o])=>(r[`${n}:${this.getGLKey(n,i)}`]=`${o}:${this.getGLKey(o,i)}`,r),{})}setConstantAttributeWebGL(s,i){const r=this.limits.maxVertexAttributes;this._constants=this._constants||new Array(r).fill(null);const n=this._constants[s];switch(n&&IA(n,i)&&x.info(1,`setConstantAttributeWebGL(${s}) could have been skipped, value unchanged`)(),this._constants[s]=i,i.constructor){case Float32Array:xA(this,s,i);break;case Int32Array:PA(this,s,i);break;case Uint32Array:CA(this,s,i);break;default:throw new Error("constant")}}getExtension(s){return Mt(this.gl,s,this._extensions),this._extensions}}function xA(t,e,s){switch(s.length){case 1:t.gl.vertexAttrib1fv(e,s);break;case 2:t.gl.vertexAttrib2fv(e,s);break;case 3:t.gl.vertexAttrib3fv(e,s);break;case 4:t.gl.vertexAttrib4fv(e,s);break}}function PA(t,e,s){t.gl.vertexAttribI4iv(e,s)}function CA(t,e,s){t.gl.vertexAttribI4uiv(e,s)}function IA(t,e){if(!t||!e||t.length!==e.length||t.constructor!==e.constructor)return!1;for(let s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0}const MA={WEBGL_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},OES_element_index_uint:{},OES_texture_float:{},OES_texture_half_float:{HALF_FLOAT_OES:5131},EXT_color_buffer_float:{},OES_standard_derivatives:{FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723},EXT_frag_depth:{},EXT_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},EXT_shader_texture_lod:{}},OA=t=>({drawBuffersWEBGL(e){return t.drawBuffers(e)},COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067}),NA=t=>({VERTEX_ARRAY_BINDING_OES:34229,createVertexArrayOES(){return t.createVertexArray()},deleteVertexArrayOES(e){return t.deleteVertexArray(e)},isVertexArrayOES(e){return t.isVertexArray(e)},bindVertexArrayOES(e){return t.bindVertexArray(e)}}),kA=t=>({VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,drawArraysInstancedANGLE(...e){return t.drawArraysInstanced(...e)},drawElementsInstancedANGLE(...e){return t.drawElementsInstanced(...e)},vertexAttribDivisorANGLE(...e){return t.vertexAttribDivisor(...e)}});function FA(t=!0){const e=HTMLCanvasElement.prototype;if(!t&&e.originalGetContext){e.getContext=e.originalGetContext,e.originalGetContext=void 0;return}e.originalGetContext=e.getContext,e.getContext=function(s,i){if(s==="webgl"||s==="experimental-webgl"){const r=this.originalGetContext("webgl2",i);return r instanceof HTMLElement&&DA(r),r}return this.originalGetContext(s,i)}}function DA(t){t.getExtension("EXT_color_buffer_float");const e={...MA,WEBGL_disjoint_timer_query:t.getExtension("EXT_disjoint_timer_query_webgl2"),WEBGL_draw_buffers:OA(t),OES_vertex_array_object:NA(t),ANGLE_instanced_arrays:kA(t)},s=t.getExtension;t.getExtension=function(r){const n=s.call(t,r);return n||(r in e?e[r]:null)};const i=t.getSupportedExtensions;t.getSupportedExtensions=function(){const r=i.apply(t)||[];return r==null?void 0:r.concat(Object.keys(e))}}const Fs=1;class BA extends qg{constructor(){super();d(this,"type","webgl");Ze.defaultProps={...Ze.defaultProps,...Jn},Xt.adapter=this}isSupported(){return typeof WebGL2RenderingContext<"u"}enforceWebGL2(s){FA(s)}async attach(s){if(s instanceof Xt)return s;if((s==null?void 0:s.device)instanceof Ze)return s.device;if(!UA(s))throw new Error("Invalid WebGL2RenderingContext");return new Xt({_handle:s})}async create(s={}){x.groupCollapsed(Fs,"WebGLDevice created")();const i=[];(s.debugWebGL||s.debug)&&i.push(y0()),s.debugSpectorJS&&i.push(p0(s));const r=await Promise.allSettled(i);for(const a of r)a.status==="rejected"&&x.error(`Failed to initialize debug libraries ${a.reason}`)();const n=new Xt(s),o=`Created ${n.type}${n.debug?" debug":""} context: ${n.info.vendor}, ${n.info.renderer} for canvas: ${n.canvasContext.id}`;return x.probe(Fs,o)(),x.table(Fs,n.info)(),x.groupEnd(Fs)(),n}}function UA(t){return typeof WebGL2RenderingContext<"u"&&t instanceof WebGL2RenderingContext?!0:!!(t&&Number.isFinite(t._version))}const tc=new BA;function Ne(){}const LA=({isDragging:t})=>t?"grabbing":"grab",$h={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,parameters:{},parent:null,device:null,deviceProps:{type:"webgl"},gl:null,glOptions:{},canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,widgets:[],onDeviceInitialized:Ne,onWebGLInitialized:Ne,onResize:Ne,onViewStateChange:Ne,onInteractionStateChange:Ne,onBeforeRender:Ne,onAfterRender:Ne,onLoad:Ne,onError:t=>U.error(t.message,t.cause)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:LA,getTooltip:null,debug:!1,drawPickingColors:!1};class Gn{constructor(e){this.width=0,this.height=0,this.userData={},this.device=null,this.canvas=null,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this.eventManager=null,this.widgetManager=null,this.tooltip=null,this.animationLoop=null,this.cursorState={isHovering:!1,isDragging:!1},this.stats=new zi({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this._lastPointerDownInfo=null,this._onPointerMove=i=>{const{_pickRequest:r}=this;if(i.type==="pointerleave")r.x=-1,r.y=-1,r.radius=0;else{if(i.leftButton||i.rightButton)return;{const n=i.offsetCenter;if(!n)return;r.x=n.x,r.y=n.y,r.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:r.x,y:r.y}),r.event=i},this._onEvent=i=>{const r=cn[i.type],n=i.offsetCenter;if(!r||!n||!this.layerManager)return;const o=this.layerManager.getLayers(),a=this.deckPicker.getLastPickedObject({x:n.x,y:n.y,layers:o,viewports:this.getViewports(n)},this._lastPointerDownInfo),{layer:c}=a,l=c&&(c[r.handler]||c.props[r.handler]),h=this.props[r.handler];let u=!1;l&&(u=l.call(c,a,i)),u||(h==null||h(a,i),this.widgetManager.onEvent(a,i))},this._onPointerDown=i=>{const r=i.offsetCenter,n=this._pick("pickObject","pickObject Time",{x:r.x,y:r.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=n.result[0]||n.emptyInfo},this.props={...$h,...e},e=this.props,e.viewState&&e.initialViewState&&U.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),this.viewState=this.props.initialViewState,e.device&&(this.device=e.device);let s=this.device;!s&&e.gl&&(e.gl instanceof WebGLRenderingContext&&U.error("WebGL1 context not supported.")(),s=tc.attach(e.gl)),s||(s=jr.createDevice({type:"best-available",adapters:[tc],...e.deviceProps,createCanvasContext:{canvas:this._createCanvas(e)}})),this.animationLoop=this._createAnimationLoop(s,e),this.setProps(e),e._typedArrayManagerProps&&Ct.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){var e,s,i,r,n,o,a,c,l,h;(e=this.animationLoop)==null||e.stop(),(s=this.animationLoop)==null||s.destroy(),this.animationLoop=null,this._lastPointerDownInfo=null,(i=this.layerManager)==null||i.finalize(),this.layerManager=null,(r=this.viewManager)==null||r.finalize(),this.viewManager=null,(n=this.effectManager)==null||n.finalize(),this.effectManager=null,(o=this.deckRenderer)==null||o.finalize(),this.deckRenderer=null,(a=this.deckPicker)==null||a.finalize(),this.deckPicker=null,(c=this.eventManager)==null||c.destroy(),this.eventManager=null,(l=this.widgetManager)==null||l.finalize(),this.widgetManager=null,!this.props.canvas&&!this.props.device&&!this.props.gl&&this.canvas&&((h=this.canvas.parentElement)==null||h.removeChild(this.canvas),this.canvas=null)}setProps(e){var i;this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&U.removed("onLayerHover","onHover")(),"onLayerClick"in e&&U.removed("onLayerClick","onClick")(),e.initialViewState&&!pe(this.props.initialViewState,e.initialViewState,3)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);const s=Object.create(this.props);Object.assign(s,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),(i=this.animationLoop)==null||i.setProps(s),this.layerManager&&(this.viewManager.setProps(s),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(s),this.effectManager.setProps(s),this.deckRenderer.setProps(s),this.deckPicker.setProps(s),this.widgetManager.setProps(s)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let s=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);const i=this.viewManager.needsRedraw(e),r=this.layerManager.needsRedraw(e),n=this.effectManager.needsRedraw(e),o=this.deckRenderer.needsRedraw(e);return s=s||i||r||n||o,s}redraw(e){if(!this.layerManager)return;let s=this.needsRedraw({clearRedrawFlags:!0});s=e||s,s&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(s):this._drawLayers(s))}get isInitialized(){return this.viewManager!==null}getViews(){return te(this.viewManager),this.viewManager.views}getViewports(e){return te(this.viewManager),this.viewManager.getViewports(e)}getCanvas(){return this.canvas}pickObject(e){const s=this._pick("pickObject","pickObject Time",e).result;return s.length?s[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,s=!1){for(const i in e)this.layerManager.resourceManager.add({resourceId:i,data:e[i],forceUpdate:s})}_removeResources(e){for(const s of e)this.layerManager.resourceManager.remove(s)}_addDefaultEffect(e){this.effectManager.addDefaultEffect(e)}_addDefaultShaderModule(e){this.layerManager.addDefaultShaderModule(e)}_removeDefaultShaderModule(e){var s;(s=this.layerManager)==null||s.removeDefaultShaderModule(e)}_pick(e,s,i){te(this.deckPicker);const{stats:r}=this;r.get("Pick Count").incrementCount(),r.get(s).timeStart();const n=this.deckPicker[e]({layers:this.layerManager.getLayers(i),views:this.viewManager.getViews(),viewports:this.getViewports(i),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...i});return r.get(s).timeEnd(),n}_createCanvas(e){let s=e.canvas;return typeof s=="string"&&(s=document.getElementById(s),te(s)),s||(s=document.createElement("canvas"),s.id=e.id||"deckgl-overlay",(e.parent||document.body).appendChild(s)),Object.assign(s.style,e.style),s}_setCanvasSize(e){var r;if(!this.canvas)return;const{width:s,height:i}=e;if(s||s===0){const n=Number.isFinite(s)?`${s}px`:s;this.canvas.style.width=n}if(i||i===0){const n=Number.isFinite(i)?`${i}px`:i;this.canvas.style.position=((r=e.style)==null?void 0:r.position)||"absolute",this.canvas.style.height=n}}_updateCanvasSize(){var r,n;const{canvas:e}=this;if(!e)return;const s=e.clientWidth??e.width,i=e.clientHeight??e.height;(s!==this.width||i!==this.height)&&(this.width=s,this.height=i,(r=this.viewManager)==null||r.setProps({width:s,height:i}),(n=this.layerManager)==null||n.activateViewport(this.getViewports()[0]),this.props.onResize({width:s,height:i}))}_createAnimationLoop(e,s){const{gl:i,onError:r,useDevicePixels:n}=s;return new kb({device:e,useDevicePixels:n,autoResizeDrawingBuffer:!i,autoResizeViewport:!1,onInitialize:o=>this._setDevice(o.device),onRender:this._onRenderFrame.bind(this),onError:r})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){const{views:e}=this.props,s=Array.isArray(e)?e:e?[e]:[new Ph({id:"default-view"})];return s.length&&this.props.controller&&(s[0].props.controller=this.props.controller),s}_onContextLost(){const{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){var s,i,r;const{_pickRequest:e}=this;if(e.event){const{result:n,emptyInfo:o}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=n.length>0;let a=o,c=!1;for(const l of n)a=l,c=((s=l.layer)==null?void 0:s.onHover(l,e.event))||c;c||((r=(i=this.props).onHover)==null||r.call(i,a,e.event),this.widgetManager.onHover(a,e.event)),e.event=null}}_updateCursor(){const e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setDevice(e){var r,n;if(this.device=e,!this.animationLoop)return;this.canvas||(this.canvas=(r=this.device.canvasContext)==null?void 0:r.canvas),this.device.setParametersWebGL({blend:!0,blendFunc:[ae.SRC_ALPHA,ae.ONE_MINUS_SRC_ALPHA,ae.ONE,ae.ONE_MINUS_SRC_ALPHA],polygonOffsetFill:!0,depthTest:!0,depthFunc:ae.LEQUAL}),this.props.onDeviceInitialized(this.device),this.device instanceof Xt&&this.props.onWebGLInitialized(this.device.gl);const s=new Ah;s.play(),this.animationLoop.attachTimeline(s),this.eventManager=new my(this.props.parent||this.canvas,{touchAction:this.props.touchAction,recognizers:Object.keys(Aa).map(o=>{var p;const[a,c,l,h]=Aa[o],u=(p=this.props.recognizerOptions)==null?void 0:p[o],f={...c,...u,event:o};return{recognizer:new a(f),recognizeWith:l,requestFailure:h}}),events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const o in cn)this.eventManager.on(o,this._onEvent);this.viewManager=new rT({timeline:s,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const i=this.viewManager.getViewports()[0];this.layerManager=new iT(this.device,{deck:this,stats:this.stats,viewport:i,timeline:s}),this.effectManager=new AT({deck:this,device:this.device}),this.deckRenderer=new ET(this.device),this.deckPicker=new IT(this.device),this.widgetManager=new NT({deck:this,parentElement:(n=this.canvas)==null?void 0:n.parentElement}),this.widgetManager.addDefault(new FT),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,s){var o;const{device:i,gl:r}=this.layerManager.context;this.props.onBeforeRender({device:i,gl:r});const n={target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...s};(o=this.deckRenderer)==null||o.renderLayers(n),n.pass==="screen"&&this.widgetManager.onRedraw({viewports:n.viewports,layers:n.layers}),this.props.onAfterRender({device:i,gl:r})}_onRenderFrame(){this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),U.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.layerManager.updateLayers(),this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){const s=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:s},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){const{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();const s=this.animationLoop.stats;e.get("GPU Time").addTime(s.get("GPU Time").lastTiming),e.get("CPU Time").addTime(s.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:e,stats:s}=this;e.fps=s.get("frameRate").getHz(),e.setPropsTime=s.get("setProps Time").time,e.updateAttributesTime=s.get("Update Attributes").time,e.framesRedrawn=s.get("Redraw Count").count,e.pickTime=s.get("pickObject Time").time+s.get("pickMultipleObjects Time").time+s.get("pickObjects Time").time,e.pickCount=s.get("Pick Count").count,e.gpuTime=s.get("GPU Time").time,e.cpuTime=s.get("CPU Time").time,e.gpuTimePerFrame=s.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=s.get("CPU Time").getAverageTime();const i=jr.stats.get("Memory Usage");e.bufferMemory=i.get("Buffer Memory").count,e.textureMemory=i.get("Texture Memory").count,e.renderbufferMemory=i.get("Renderbuffer Memory").count,e.gpuMemory=i.get("GPU Memory").count}}Gn.defaultProps=$h;Gn.VERSION=eg;function VA(t){switch(t){case"float64":return Float64Array;case"uint8":case"unorm8":return Uint8ClampedArray;default:return Nl(t)}}const zA=Ol;function Ds(t,e){return{attribute:t,format:e.size>1?`${e.type}x${e.size}`:e.type,byteOffset:e.offset||0}}function Ke(t){return t.stride||t.size*t.bytesPerElement}function WA(t,e){return t.type===e.type&&t.size===e.size&&Ke(t)===Ke(e)&&(t.offset||0)===(e.offset||0)}function An(t,e){e.offset&&U.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const s=Ke(t),i=e.vertexOffset!==void 0?e.vertexOffset:t.vertexOffset||0,r=e.elementOffset||0,n=i*s+r*t.bytesPerElement+(t.offset||0);return{...e,offset:n,stride:s}}function HA(t,e){const s=An(t,e);return{high:s,low:{...s,offset:s.offset+t.size*4}}}class jA{constructor(e,s,i){this._buffer=null,this.device=e,this.id=s.id||"",this.size=s.size||1;const r=s.logicalType||s.type,n=r==="float64";let{defaultValue:o}=s;o=Number.isFinite(o)?[o]:o||new Array(this.size).fill(0);let a;n?a="float32":!r&&s.isIndexed?a="uint32":a=r||"float32";let c=VA(r||a);this.doublePrecision=n,n&&s.fp64===!1&&(c=Float32Array),this.value=null,this.settings={...s,defaultType:c,defaultValue:o,logicalType:r,type:a,normalized:a.includes("norm"),size:this.size,bytesPerElement:c.BYTES_PER_ELEMENT},this.state={...i,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1}}get isConstant(){return this.state.constant}get buffer(){return this._buffer}get byteOffset(){const e=this.getAccessor();return e.vertexOffset?e.vertexOffset*Ke(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),Ct.release(this.state.allocatedValue)}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(e=this.id,s=null){const i={};if(this.state.constant){const r=this.value;if(s){const n=An(this.getAccessor(),s),o=n.offset/r.BYTES_PER_ELEMENT,a=n.size||this.size;i[e]=r.subarray(o,o+a)}else i[e]=r}else i[e]=this.getBuffer();return this.doublePrecision&&(this.value instanceof Float64Array?i[`${e}64Low`]=i[e]:i[`${e}64Low`]=new Float32Array(this.size)),i}_getBufferLayout(e=this.id,s=null){const i=this.getAccessor(),r=[],n={name:this.id,byteStride:Ke(i),attributes:r};if(this.doublePrecision){const o=HA(i,s||{});r.push(Ds(e,{...i,...o.high}),Ds(`${e}64Low`,{...i,...o.low}))}else if(s){const o=An(i,s);r.push(Ds(e,{...i,...o}))}else r.push(Ds(e,i));return n}setAccessor(e){this.state.bufferAccessor=e}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){const s=Array.from(this.value);e=[s,s]}else{const{value:s,numInstances:i,size:r}=this,n=i*r;if(s&&n&&s.length>=n){const o=new Array(r).fill(1/0),a=new Array(r).fill(-1/0);for(let c=0;c<n;)for(let l=0;l<r;l++){const h=s[c++];h<o[l]&&(o[l]=h),h>a[l]&&(a[l]=h)}e=[o,a]}}return this.state.bounds=e,e}setData(e){const{state:s}=this;let i;ArrayBuffer.isView(e)?i={value:e}:e instanceof j?i={buffer:e}:i=e;const r={...this.settings,...i};if(ArrayBuffer.isView(i.value)){if(!i.type)if(this.doublePrecision&&i.value instanceof Float64Array)r.type="float32";else{const o=zA(i.value);r.type=r.normalized?o.replace("int","norm"):o}r.bytesPerElement=i.value.BYTES_PER_ELEMENT,r.stride=Ke(r)}if(s.bounds=null,i.constant){let n=i.value;if(n=this._normalizeValue(n,[],0),this.settings.normalized&&(n=this.normalizeConstant(n)),!(!s.constant||!this._areValuesEqual(n,this.value)))return!1;s.externalBuffer=null,s.constant=!0,this.value=ArrayBuffer.isView(n)?n:new Float32Array(n)}else if(i.buffer){const n=i.buffer;s.externalBuffer=n,s.constant=!1,this.value=i.value||null}else if(i.value){this._checkExternalBuffer(i);let n=i.value;s.externalBuffer=null,s.constant=!1,this.value=n;let{buffer:o}=this;const a=Ke(r),c=(r.vertexOffset||0)*a;if(this.doublePrecision&&n instanceof Float64Array&&(n=_r(n,r)),this.settings.isIndexed){const h=this.settings.defaultType;n.constructor!==h&&(n=new h(n))}const l=n.byteLength+c+a*2;(!o||o.byteLength<l)&&(o=this._createBuffer(l)),o.write(n,c)}return this.setAccessor(r),!0}updateSubBuffer(e={}){this.state.bounds=null;const s=this.value,{startOffset:i=0,endOffset:r}=e;this.buffer.write(this.doublePrecision&&s instanceof Float64Array?_r(s,{size:this.size,startIndex:i,endIndex:r}):s.subarray(i,r),i*s.BYTES_PER_ELEMENT+this.byteOffset)}allocate(e,s=!1){const{state:i}=this,r=i.allocatedValue,n=Ct.allocate(r,e+1,{size:this.size,type:this.settings.defaultType,copy:s});this.value=n;const{byteOffset:o}=this;let{buffer:a}=this;return(!a||a.byteLength<n.byteLength+o)&&(a=this._createBuffer(n.byteLength+o),s&&r&&a.write(r instanceof Float64Array?_r(r,this):r,o)),i.allocatedValue=n,i.constant=!1,i.externalBuffer=null,this.setAccessor(this.settings),!0}_checkExternalBuffer(e){const{value:s}=e;if(!ArrayBuffer.isView(s))throw new Error(`Attribute ${this.id} value is not TypedArray`);const i=this.settings.defaultType;let r=!1;if(this.doublePrecision&&(r=s.BYTES_PER_ELEMENT<4),r)throw new Error(`Attribute ${this.id} does not support ${s.constructor.name}`);!(s instanceof i)&&this.settings.normalized&&!("normalized"in e)&&U.warn(`Attribute ${this.id} is normalized`)()}normalizeConstant(e){switch(this.settings.type){case"snorm8":return new Float32Array(e).map(s=>(s+128)/255*2-1);case"snorm16":return new Float32Array(e).map(s=>(s+32768)/65535*2-1);case"unorm8":return new Float32Array(e).map(s=>s/255);case"unorm16":return new Float32Array(e).map(s=>s/65535);default:return e}}_normalizeValue(e,s,i){const{defaultValue:r,size:n}=this.settings;if(Number.isFinite(e))return s[i]=e,s;if(!e){let o=n;for(;--o>=0;)s[i+o]=r[o];return s}switch(n){case 4:s[i+3]=Number.isFinite(e[3])?e[3]:r[3];case 3:s[i+2]=Number.isFinite(e[2])?e[2]:r[2];case 2:s[i+1]=Number.isFinite(e[1])?e[1]:r[1];case 1:s[i+0]=Number.isFinite(e[0])?e[0]:r[0];break;default:let o=n;for(;--o>=0;)s[i+o]=Number.isFinite(e[o])?e[o]:r[o]}return s}_areValuesEqual(e,s){if(!e||!s)return!1;const{size:i}=this;for(let r=0;r<i;r++)if(e[r]!==s[r])return!1;return!0}_createBuffer(e){var r;this._buffer&&this._buffer.destroy();const{isIndexed:s,type:i}=this.settings;return this._buffer=this.device.createBuffer({...(r=this._buffer)==null?void 0:r.props,id:this.id,usage:s?j.INDEX:j.VERTEX,indexType:s?i:void 0,byteLength:e}),this._buffer}}const sc=[],ic=[];function $i(t,e=0,s=1/0){let i=sc;const r={index:-1,data:t,target:[]};return t?typeof t[Symbol.iterator]=="function"?i=t:t.length>0&&(ic.length=t.length,i=ic):i=sc,(e>0||Number.isFinite(s))&&(i=(Array.isArray(i)?i:Array.from(i)).slice(e,s),r.index=e-1),{iterable:i,objectInfo:r}}function Xh(t){return t&&t[Symbol.asyncIterator]}function Yh(t,e){const{size:s,stride:i,offset:r,startIndices:n,nested:o}=e,a=t.BYTES_PER_ELEMENT,c=i?i/a:s,l=r?r/a:0,h=Math.floor((t.length-l)/c);return(u,{index:f,target:p})=>{if(!n){const S=f*c+l;for(let v=0;v<s;v++)p[v]=t[S+v];return p}const _=n[f],m=n[f+1]||h;let T;if(o){T=new Array(m-_);for(let S=_;S<m;S++){const v=S*c+l;p=new Array(s);for(let w=0;w<s;w++)p[w]=t[v+w];T[S-_]=p}}else if(c===s)T=t.subarray(_*s+l,m*s+l);else{T=new t.constructor((m-_)*s);let S=0;for(let v=_;v<m;v++){const w=v*c+l;for(let E=0;E<s;E++)T[S++]=t[w+E]}}return T}}const $A=[],Ys=[[0,1/0]];function XA(t,e){if(t===Ys||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return t;const s=[],i=t.length;let r=0;for(let n=0;n<i;n++){const o=t[n];o[1]<e[0]?(s.push(o),r=n+1):o[0]>e[1]?s.push(o):e=[Math.min(o[0],e[0]),Math.max(o[1],e[1])]}return s.splice(r,0,e),s}const YA={interpolation:{duration:0,easing:t=>t},spring:{stiffness:.05,damping:.5}};function Kh(t,e){if(!t)return null;Number.isFinite(t)&&(t={type:"interpolation",duration:t});const s=t.type||"interpolation";return{...YA[s],...e,...t,type:s}}class qh extends jA{constructor(e,s){super(e,s,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,layoutChanged:!1,updateRanges:Ys}),this.constant=!1,this.settings.update=s.update||(s.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){const s=this.state.needsRedraw;return this.state.needsRedraw=s&&!e,s}layoutChanged(){return this.state.layoutChanged}setAccessor(e){var s;(s=this.state).layoutChanged||(s.layoutChanged=!WA(e,this.getAccessor())),super.setAccessor(e)}getUpdateTriggers(){const{accessor:e}=this.settings;return[this.id].concat(typeof e!="function"&&e||[])}supportsTransition(){return!!this.settings.transition}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;const{accessor:s}=this.settings,i=this.settings.transition,r=Array.isArray(s)?e[s.find(n=>e[n])]:e[s];return Kh(r,i)}setNeedsUpdate(e=this.id,s){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),s){const{startRow:i=0,endRow:r=1/0}=s;this.state.updateRanges=XA(this.state.updateRanges,[i,r])}else this.state.updateRanges=Ys}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=$A}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){const{state:s,settings:i}=this;return i.noAlloc?!1:i.update?(super.allocate(e,s.updateRanges!==Ys),!0):!1}updateBuffer({numInstances:e,data:s,props:i,context:r}){if(!this.needsUpdate())return!1;const{state:{updateRanges:n},settings:{update:o,noAlloc:a}}=this;let c=!0;if(o){for(const[l,h]of n)o.call(r,this,{data:s,startRow:l,endRow:h,props:i,numInstances:e});if(this.value)if(this.constant||!this.buffer||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[l,h]of n){const u=Number.isFinite(l)?this.getVertexOffset(l):0,f=Number.isFinite(h)?this.getVertexOffset(h):a||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:u,endOffset:f})}this._checkAttributeArray()}else c=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),c}setConstantValue(e){return e===void 0||typeof e=="function"?!1:(this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(e){const{state:s}=this;return e?(this.clearNeedsUpdate(),s.lastExternalBuffer===e||(s.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(s.lastExternalBuffer=null,!1)}setBinaryValue(e,s=null){const{state:i,settings:r}=this;if(!e)return i.binaryValue=null,i.binaryAccessor=null,!1;if(r.noAlloc)return!1;if(i.binaryValue===e)return this.clearNeedsUpdate(),!0;if(i.binaryValue=e,this.setNeedsRedraw(),r.transform||s!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});const o=e;te(ArrayBuffer.isView(o.value),`invalid ${r.accessor}`);const a=!!o.size&&o.size!==this.size;return i.binaryAccessor=Yh(o.value,{size:o.size||this.size,stride:o.stride,offset:o.offset,startIndices:s,nested:a}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){const{startIndices:s}=this;return(s?e<s.length?s[e]:this.numInstances:e)*this.size}getValue(){const e=this.settings.shaderAttributes,s=super.getValue();if(!e)return s;for(const i in e)Object.assign(s,super.getValue(i,e[i]));return s}getBufferLayout(e){this.state.layoutChanged=!1;const s=this.settings.shaderAttributes,i=super._getBufferLayout(),{stepMode:r}=this.settings;if(r==="dynamic"?i.stepMode=e?e.isInstanced?"instance":"vertex":"instance":i.stepMode=r??"vertex",!s)return i;for(const n in s){const o=super._getBufferLayout(n,s[n]);i.attributes.push(...o.attributes)}return i}_autoUpdater(e,{data:s,startRow:i,endRow:r,props:n,numInstances:o}){if(e.constant)return;const{settings:a,state:c,value:l,size:h,startIndices:u}=e,{accessor:f,transform:p}=a,_=c.binaryAccessor||(typeof f=="function"?f:n[f]);te(typeof _=="function",`accessor "${f}" is not a function`);let m=e.getVertexOffset(i);const{iterable:T,objectInfo:S}=$i(s,i,r);for(const v of T){S.index++;let w=_(v,S);if(p&&(w=p.call(this,w)),u){const E=(S.index<u.length-1?u[S.index+1]:o)-u[S.index];if(w&&Array.isArray(w[0])){let R=m;for(const P of w)e._normalizeValue(P,l,R),R+=h}else w&&w.length>h?l.set(w,m):(e._normalizeValue(w,S.target,0),Qb({target:l,source:S.target,start:m,count:E}));m+=E*h}else e._normalizeValue(w,l,m),m+=h}}_validateAttributeUpdaters(){const{settings:e}=this;if(!(e.noAlloc||typeof e.update=="function"))throw new Error(`Attribute ${this.id} missing update or accessor`)}_checkAttributeArray(){const{value:e}=this,s=Math.min(4,this.size);if(e&&e.length>=s){let i=!0;switch(s){case 4:i=i&&Number.isFinite(e[3]);case 3:i=i&&Number.isFinite(e[2]);case 2:i=i&&Number.isFinite(e[1]);case 1:i=i&&Number.isFinite(e[0]);break;default:i=!1}if(!i)throw new Error(`Illegal attribute generated for ${this.id}`)}}}function Pr(t){const{source:e,target:s,start:i=0,size:r,getData:n}=t,o=t.end||s.length,a=e.length,c=o-i;if(a>c){s.set(e.subarray(0,c),i);return}if(s.set(e,i),!n)return;let l=a;for(;l<c;){const h=n(l,e);for(let u=0;u<r;u++)s[i+l]=h[u]||0,l++}}function KA({source:t,target:e,size:s,getData:i,sourceStartIndices:r,targetStartIndices:n}){if(!r||!n)return Pr({source:t,target:e,size:s,getData:i}),e;let o=0,a=0;const c=i&&((h,u)=>i(h+a,u)),l=Math.min(r.length,n.length);for(let h=1;h<l;h++){const u=r[h]*s,f=n[h]*s;Pr({source:t.subarray(o,u),target:e,start:a,end:f,size:s,getData:c}),o=u,a=f}return a<e.length&&Pr({source:[],target:e,start:a,size:s,getData:c}),e}function qA(t){const{device:e,settings:s,value:i}=t,r=new qh(e,s);return r.setData({value:i instanceof Float64Array?new Float64Array(0):new Float32Array(0),normalized:s.normalized}),r}function Zh(t){switch(t){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`No defined attribute type for size "${t}"`)}}function Jh(t){switch(t){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4";default:throw new Error("invalid type size")}}function Qh(t){t.push(t.shift())}function ZA(t,e){const{doublePrecision:s,settings:i,value:r,size:n}=t,o=s&&r instanceof Float64Array?2:1;let a=0;const{shaderAttributes:c}=t.settings;if(c)for(const l of Object.values(c))a=Math.max(a,l.vertexOffset??0);return(i.noAlloc?r.length:(e+a)*n)*o}function Gh({device:t,source:e,target:s}){return(!s||s.byteLength<e.byteLength)&&(s==null||s.destroy(),s=t.createBuffer({byteLength:e.byteLength,usage:e.usage})),s}function eu({device:t,buffer:e,attribute:s,fromLength:i,toLength:r,fromStartIndices:n,getData:o=a=>a}){const a=s.doublePrecision&&s.value instanceof Float64Array?2:1,c=s.size*a,l=s.byteOffset,h=s.settings.bytesPerElement<4?l/s.settings.bytesPerElement*4:l,u=s.startIndices,f=n&&u,p=s.isConstant;if(!f&&e&&i>=r)return e;const _=s.value instanceof Float64Array?Float32Array:s.value.constructor,m=p?s.value:new _(s.getBuffer().readSyncWebGL(l,r*_.BYTES_PER_ELEMENT).buffer);if(s.settings.normalized&&!p){const w=o;o=(E,R)=>s.normalizeConstant(w(E,R))}const T=p?(w,E)=>o(m,E):(w,E)=>o(m.subarray(w+l,w+l+c),E),S=e?new Float32Array(e.readSyncWebGL(h,i*4).buffer):new Float32Array(0),v=new Float32Array(r);return KA({source:S,target:v,sourceStartIndices:n,targetStartIndices:u,size:c,getData:T}),(!e||e.byteLength<v.byteLength+h)&&(e==null||e.destroy(),e=t.createBuffer({byteLength:v.byteLength+h,usage:ae.DYNAMIC_COPY})),e.write(v,h),e}class tu{constructor({device:e,attribute:s,timeline:i}){this.buffers=[],this.currentLength=0,this.device=e,this.transition=new ji(i),this.attribute=s,this.attributeInTransition=qA(s),this.currentStartIndices=s.startIndices}get inProgress(){return this.transition.inProgress}start(e,s,i=1/0){this.settings=e,this.currentStartIndices=this.attribute.startIndices,this.currentLength=ZA(this.attribute,s),this.transition.start({...e,duration:i})}update(){const e=this.transition.update();return e&&this.onUpdate(),e}setBuffer(e){this.attributeInTransition.setData({buffer:e,normalized:this.attribute.settings.normalized,value:this.attributeInTransition.value})}cancel(){this.transition.cancel()}delete(){this.cancel();for(const e of this.buffers)e.destroy();this.buffers.length=0}}class JA extends tu{constructor({device:e,attribute:s,timeline:i}){super({device:e,attribute:s,timeline:i}),this.type="interpolation",this.transform=tw(e,s)}start(e,s){const i=this.currentLength,r=this.currentStartIndices;if(super.start(e,s,e.duration),e.duration<=0){this.transition.cancel();return}const{buffers:n,attribute:o}=this;Qh(n),n[0]=eu({device:this.device,buffer:n[0],attribute:o,fromLength:i,toLength:this.currentLength,fromStartIndices:r,getData:e.enter}),n[1]=Gh({device:this.device,source:n[0],target:n[1]}),this.setBuffer(n[1]);const{transform:a}=this,c=a.model;let l=Math.floor(this.currentLength/o.size);su(o)&&(l/=2),c.setVertexCount(l),o.isConstant?(c.setAttributes({aFrom:n[0]}),c.setConstantAttributes({aTo:o.value})):c.setAttributes({aFrom:n[0],aTo:o.getBuffer()}),a.transformFeedback.setBuffers({vCurrent:n[1]})}onUpdate(){const{duration:e,easing:s}=this.settings,{time:i}=this.transition;let r=i/e;s&&(r=s(r));const{model:n}=this.transform,o={time:r};n.shaderInputs.setProps({interpolation:o}),this.transform.run({discard:!0})}delete(){super.delete(),this.transform.destroy()}}const QA=`uniform interpolationUniforms {
  float time;
} interpolation;
`,rc={name:"interpolation",vs:QA,uniformTypes:{time:"f32"}},GA=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, interpolation.time);
  gl_Position = vec4(0.0);
}
`,ew=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aFrom64Low;
in ATTRIBUTE_TYPE aTo;
in ATTRIBUTE_TYPE aTo64Low;
out ATTRIBUTE_TYPE vCurrent;
out ATTRIBUTE_TYPE vCurrent64Low;

vec2 mix_fp64(vec2 a, vec2 b, float x) {
  vec2 range = sub_fp64(b, a);
  return sum_fp64(a, mul_fp64(range, vec2(x, 0.0)));
}

void main(void) {
  for (int i=0; i<ATTRIBUTE_SIZE; i++) {
    vec2 value = mix_fp64(vec2(aFrom[i], aFrom64Low[i]), vec2(aTo[i], aTo64Low[i]), interpolation.time);
    vCurrent[i] = value.x;
    vCurrent64Low[i] = value.y;
  }
  gl_Position = vec4(0.0);
}
`;function su(t){return t.doublePrecision&&t.value instanceof Float64Array}function tw(t,e){const s=e.size,i=Zh(s),r=Jh(s),n=e.getBufferLayout();return su(e)?new os(t,{vs:ew,bufferLayout:[{name:"aFrom",byteStride:8*s,attributes:[{attribute:"aFrom",format:r,byteOffset:0},{attribute:"aFrom64Low",format:r,byteOffset:4*s}]},{name:"aTo",byteStride:8*s,attributes:[{attribute:"aTo",format:r,byteOffset:0},{attribute:"aTo64Low",format:r,byteOffset:4*s}]}],modules:[Tm,rc],defines:{ATTRIBUTE_TYPE:i,ATTRIBUTE_SIZE:s},moduleSettings:{},varyings:["vCurrent","vCurrent64Low"],bufferMode:ae.INTERLEAVED_ATTRIBS,disableWarnings:!0}):new os(t,{vs:GA,bufferLayout:[{name:"aFrom",format:r},{name:"aTo",format:n.attributes[0].format}],modules:[rc],defines:{ATTRIBUTE_TYPE:i},varyings:["vCurrent"],disableWarnings:!0})}class sw extends tu{constructor({device:e,attribute:s,timeline:i}){super({device:e,attribute:s,timeline:i}),this.type="spring",this.texture=cw(e),this.framebuffer=lw(e,this.texture),this.transform=aw(e,s)}start(e,s){const i=this.currentLength,r=this.currentStartIndices;super.start(e,s);const{buffers:n,attribute:o}=this;for(let c=0;c<2;c++)n[c]=eu({device:this.device,buffer:n[c],attribute:o,fromLength:i,toLength:this.currentLength,fromStartIndices:r,getData:e.enter});n[2]=Gh({device:this.device,source:n[0],target:n[2]}),this.setBuffer(n[1]);const{model:a}=this.transform;a.setVertexCount(Math.floor(this.currentLength/o.size)),o.isConstant?a.setConstantAttributes({aTo:o.value}):a.setAttributes({aTo:o.getBuffer()})}onUpdate(){const{buffers:e,transform:s,framebuffer:i,transition:r}=this,n=this.settings;s.model.setAttributes({aPrev:e[0],aCur:e[1]}),s.transformFeedback.setBuffers({vNext:e[2]});const o={stiffness:n.stiffness,damping:n.damping};s.model.shaderInputs.setProps({spring:o}),s.run({framebuffer:i,discard:!1,parameters:{viewport:[0,0,1,1]},clearColor:[0,0,0,0]}),Qh(e),this.setBuffer(e[1]),this.device.readPixelsToArrayWebGL(i)[0]>0||r.end()}delete(){super.delete(),this.transform.destroy(),this.texture.destroy(),this.framebuffer.destroy()}}const iw=`uniform springUniforms {
  float damping;
  float stiffness;
} spring;
`,rw={name:"spring",vs:iw,uniformTypes:{damping:"f32",stiffness:"f32"}},nw=`#version 300 es
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

in ATTRIBUTE_TYPE aPrev;
in ATTRIBUTE_TYPE aCur;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vNext;
out float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE force = delta * spring.stiffness;
  ATTRIBUTE_TYPE resistance = velocity * spring.damping;
  return force - resistance + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,ow=`#version 300 es
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

in float vIsTransitioningFlag;

out vec4 fragColor;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  fragColor = vec4(1.0);
}`;function aw(t,e){const s=Zh(e.size),i=Jh(e.size);return new os(t,{vs:nw,fs:ow,bufferLayout:[{name:"aPrev",format:i},{name:"aCur",format:i},{name:"aTo",format:e.getBufferLayout().attributes[0].format}],varyings:["vNext"],modules:[rw],defines:{ATTRIBUTE_TYPE:s},parameters:{depthCompare:"always",blendColorOperation:"max",blendColorSrcFactor:"one",blendColorDstFactor:"one",blendAlphaOperation:"max",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one"}})}function cw(t){return t.createTexture({data:new Uint8Array(4),format:"rgba8unorm",mipmaps:!1,width:1,height:1})}function lw(t,e){return t.createFramebuffer({id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,colorAttachments:[e]})}const hw={interpolation:JA,spring:sw};class uw{constructor(e,{id:s,timeline:i}){if(!e)throw new Error("AttributeTransitionManager is constructed without device");this.id=s,this.device=e,this.timeline=i,this.transitions={},this.needsRedraw=!1,this.numInstances=1}finalize(){for(const e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:s,numInstances:i}){this.numInstances=i||1;for(const r in e){const n=e[r],o=n.getTransitionSetting(s);o&&this._updateAttribute(r,n,o)}for(const r in this.transitions){const n=e[r];(!n||!n.getTransitionSetting(s))&&this._removeTransition(r)}}hasAttribute(e){const s=this.transitions[e];return s&&s.inProgress}getAttributes(){const e={};for(const s in this.transitions){const i=this.transitions[s];i.inProgress&&(e[s]=i.attributeInTransition)}return e}run(){if(this.numInstances===0)return!1;for(const s in this.transitions)this.transitions[s].update()&&(this.needsRedraw=!0);const e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].delete(),delete this.transitions[e]}_updateAttribute(e,s,i){const r=this.transitions[e];let n=!r||r.type!==i.type;if(n){r&&this._removeTransition(e);const o=hw[i.type];o?this.transitions[e]=new o({attribute:s,timeline:this.timeline,device:this.device}):(U.error(`unsupported transition type '${i.type}'`)(),n=!1)}(n||s.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(i,this.numInstances))}}const nc="attributeManager.invalidate",fw="attributeManager.updateStart",dw="attributeManager.updateEnd",gw="attribute.updateStart",pw="attribute.allocate",_w="attribute.updateEnd";class mw{constructor(e,{id:s="attribute-manager",stats:i,timeline:r}={}){this.mergeBoundsMemoized=_s(Ab),this.id=s,this.device=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=i,this.attributeTransitionManager=new uw(e,{id:`${s}-transitions`,timeline:r}),Object.seal(this)}finalize(){for(const e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){const s=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,s&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{stepMode:"instance"})}remove(e){for(const s of e)this.attributes[s]!==void 0&&(this.attributes[s].delete(),delete this.attributes[s])}invalidate(e,s){const i=this._invalidateTrigger(e,s);re(nc,this,e,i)}invalidateAll(e){for(const s in this.attributes)this.attributes[s].setNeedsUpdate(s,e);re(nc,this,"all")}update({data:e,numInstances:s,startIndices:i=null,transitions:r,props:n={},buffers:o={},context:a={}}){let c=!1;re(fw,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const l in this.attributes){const h=this.attributes[l],u=h.settings.accessor;h.startIndices=i,h.numInstances=s,n[l]&&U.removed(`props.${l}`,`data.attributes.${l}`)(),h.setExternalBuffer(o[l])||h.setBinaryValue(typeof u=="string"?o[u]:void 0,e.startIndices)||typeof u=="string"&&!o[u]&&h.setConstantValue(n[u])||h.needsUpdate()&&(c=!0,this._updateAttribute({attribute:h,numInstances:s,data:e,props:n,context:a})),this.needsRedraw=this.needsRedraw||h.needsRedraw()}c&&re(dw,this,s),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:s,transitions:r})}updateTransition(){const{attributeTransitionManager:e}=this,s=e.run();return this.needsRedraw=this.needsRedraw||s,s}getAttributes(){return{...this.attributes,...this.attributeTransitionManager.getAttributes()}}getBounds(e){const s=e.map(i=>{var r;return(r=this.attributes[i])==null?void 0:r.getBounds()});return this.mergeBoundsMemoized(s)}getChangedAttributes(e={clearChangedFlags:!1}){const{attributes:s,attributeTransitionManager:i}=this,r={...i.getAttributes()};for(const n in s){const o=s[n];o.needsRedraw(e)&&!i.hasAttribute(n)&&(r[n]=o)}return r}getBufferLayouts(e){return Object.values(this.getAttributes()).map(s=>s.getBufferLayout(e))}_add(e,s){for(const i in e){const r=e[i],n={...r,id:i,size:r.isIndexed&&1||r.size||1,...s};this.attributes[i]=new qh(this.device,n)}this._mapUpdateTriggersToAttributes()}_mapUpdateTriggersToAttributes(){const e={};for(const s in this.attributes)this.attributes[s].getUpdateTriggers().forEach(r=>{e[r]||(e[r]=[]),e[r].push(s)});this.updateTriggers=e}_invalidateTrigger(e,s){const{attributes:i,updateTriggers:r}=this,n=r[e];return n&&n.forEach(o=>{const a=i[o];a&&a.setNeedsUpdate(a.id,s)}),n}_updateAttribute(e){const{attribute:s,numInstances:i}=e;if(re(gw,s),s.constant){s.setConstantValue(s.value);return}s.allocate(i)&&re(pw,s,i),s.updateBuffer(e)&&(this.needsRedraw=!0,re(_w,s,i))}}class yw extends ji{get value(){return this._value}_onUpdate(){const{time:e,settings:{fromValue:s,toValue:i,duration:r,easing:n}}=this,o=n(e/r);this._value=gi(s,i,o)}}const oc=1e-5;function ac(t,e,s,i,r){const n=e-t,a=(s-e)*r,c=-n*i;return a+c+n+e}function bw(t,e,s,i,r){if(Array.isArray(s)){const n=[];for(let o=0;o<s.length;o++)n[o]=ac(t[o],e[o],s[o],i,r);return n}return ac(t,e,s,i,r)}function cc(t,e){if(Array.isArray(t)){let s=0;for(let i=0;i<t.length;i++){const r=t[i]-e[i];s+=r*r}return Math.sqrt(s)}return Math.abs(t-e)}class Tw extends ji{get value(){return this._currValue}_onUpdate(){const{fromValue:e,toValue:s,damping:i,stiffness:r}=this.settings,{_prevValue:n=e,_currValue:o=e}=this;let a=bw(n,o,s,i,r);const c=cc(a,s),l=cc(a,o);c<oc&&l<oc&&(a=s,this.end()),this._prevValue=o,this._currValue=a}}const Aw={interpolation:yw,spring:Tw};class ww{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,s,i,r){const{transitions:n}=this;if(n.has(e)){const c=n.get(e),{value:l=c.settings.fromValue}=c;s=l,this.remove(e)}if(r=Kh(r),!r)return;const o=Aw[r.type];if(!o){U.error(`unsupported transition type '${r.type}'`)();return}const a=new o(this.timeline);a.start({...r,fromValue:s,toValue:i}),n.set(e,a)}remove(e){const{transitions:s}=this;s.has(e)&&(s.get(e).cancel(),s.delete(e))}update(){const e={};for(const[s,i]of this.transitions)i.update(),e[s]=i.value,i.inProgress||this.remove(s);return e}clear(){for(const e of this.transitions.keys())this.remove(e)}}function Sw(t){const e=t[Ve];for(const s in e){const i=e[s],{validate:r}=i;if(r&&!r(t[s],i))throw new Error(`Invalid prop ${s}: ${t[s]}`)}}function Ew(t,e){const s=iu({newProps:t,oldProps:e,propTypes:t[Ve],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),i=Rw(t,e);let r=!1;return i||(r=xw(t,e)),{dataChanged:i,propsChanged:s,updateTriggersChanged:r,extensionsChanged:Pw(t,e),transitionsChanged:vw(t,e)}}function vw(t,e){if(!t.transitions)return!1;const s={},i=t[Ve];let r=!1;for(const n in t.transitions){const o=i[n],a=o&&o.type;(a==="number"||a==="color"||a==="array")&&wn(t[n],e[n],o)&&(s[n]=!0,r=!0)}return r?s:!1}function iu({newProps:t,oldProps:e,ignoreProps:s={},propTypes:i={},triggerName:r="props"}){if(e===t)return!1;if(typeof t!="object"||t===null)return`${r} changed shallowly`;if(typeof e!="object"||e===null)return`${r} changed shallowly`;for(const n of Object.keys(t))if(!(n in s)){if(!(n in e))return`${r}.${n} added`;const o=wn(t[n],e[n],i[n]);if(o)return`${r}.${n} ${o}`}for(const n of Object.keys(e))if(!(n in s)){if(!(n in t))return`${r}.${n} dropped`;if(!Object.hasOwnProperty.call(t,n)){const o=wn(t[n],e[n],i[n]);if(o)return`${r}.${n} ${o}`}}return!1}function wn(t,e,s){let i=s&&s.equal;return i&&!i(t,e,s)||!i&&(i=t&&e&&t.equals,i&&!i.call(t,e))?"changed deeply":!i&&e!==t?"changed shallowly":null}function Rw(t,e){if(e===null)return"oldProps is null, initial diff";let s=!1;const{dataComparator:i,_dataDiff:r}=t;return i?i(t.data,e.data)||(s="Data comparator detected a change"):t.data!==e.data&&(s="A new data container was supplied"),s&&r&&(s=r(t.data,e.data)||s),s}function xw(t,e){if(e===null)return{all:!0};if("all"in t.updateTriggers&&lc(t,e,"all"))return{all:!0};const s={};let i=!1;for(const r in t.updateTriggers)r!=="all"&&lc(t,e,r)&&(s[r]=!0,i=!0);return i?s:!1}function Pw(t,e){if(e===null)return!0;const s=e.extensions,{extensions:i}=t;if(i===s)return!1;if(!s||!i||i.length!==s.length)return!0;for(let r=0;r<i.length;r++)if(!i[r].equals(s[r]))return!0;return!1}function lc(t,e,s){let i=t.updateTriggers[s];i=i??{};let r=e.updateTriggers[s];return r=r??{},iu({oldProps:r,newProps:i,triggerName:s})}const Cw="count(): argument not an object",Iw="count(): argument not a container";function Mw(t){if(!Nw(t))throw new Error(Cw);if(typeof t.count=="function")return t.count();if(Number.isFinite(t.size))return t.size;if(Number.isFinite(t.length))return t.length;if(Ow(t))return Object.keys(t).length;throw new Error(Iw)}function Ow(t){return t!==null&&typeof t=="object"&&t.constructor===Object}function Nw(t){return t!==null&&typeof t=="object"}function hc(t,e){if(!e)return t;const s={...t,...e};if("defines"in e&&(s.defines={...t.defines,...e.defines}),"modules"in e&&(s.modules=(t.modules||[]).concat(e.modules),e.modules.some(i=>i.name==="project64"))){const i=s.modules.findIndex(r=>r.name==="project32");i>=0&&s.modules.splice(i,1)}if("inject"in e)if(!t.inject)s.inject=e.inject;else{const i={...t.inject};for(const r in e.inject)i[r]=(i[r]||"")+e.inject[r];s.inject=i}return s}const kw={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},Sn={};function Fw(t,e,s,i){if(s instanceof K)return s;s.constructor&&s.constructor.name!=="Object"&&(s={data:s});let r=null;s.compressed&&(r={minFilter:"linear",mipmapFilter:s.data.length>1?"nearest":"linear"});const n=e.createTexture({...s,sampler:{...kw,...r,...i},mipmaps:!0});return Sn[n.id]=t,n}function Dw(t,e){!e||!(e instanceof K)||Sn[e.id]===t&&(e.delete(),delete Sn[e.id])}const Bw={boolean:{validate(t,e){return!0},equal(t,e,s){return!!t==!!e}},number:{validate(t,e){return Number.isFinite(t)&&(!("max"in e)||t<=e.max)&&(!("min"in e)||t>=e.min)}},color:{validate(t,e){return e.optional&&!t||En(t)&&(t.length===3||t.length===4)},equal(t,e,s){return pe(t,e,1)}},accessor:{validate(t,e){const s=Ai(t);return s==="function"||s===Ai(e.value)},equal(t,e,s){return typeof e=="function"?!0:pe(t,e,1)}},array:{validate(t,e){return e.optional&&!t||En(t)},equal(t,e,s){const{compare:i}=s,r=Number.isInteger(i)?i:i?1:0;return i?pe(t,e,r):t===e}},object:{equal(t,e,s){if(s.ignore)return!0;const{compare:i}=s,r=Number.isInteger(i)?i:i?1:0;return i?pe(t,e,r):t===e}},function:{validate(t,e){return e.optional&&!t||typeof t=="function"},equal(t,e,s){return!s.compare&&s.ignore!==!1||t===e}},data:{transform:(t,e,s)=>{if(!t)return t;const{dataTransform:i}=s.props;return i?i(t):typeof t.shape=="string"&&t.shape.endsWith("-table")&&Array.isArray(t.data)?t.data:t}},image:{transform:(t,e,s)=>{const i=s.context;return!i||!i.device?null:Fw(s.id,i.device,t,{...e.parameters,...s.props.textureParameters})},release:(t,e,s)=>{Dw(s.id,t)}}};function Uw(t){const e={},s={},i={};for(const[r,n]of Object.entries(t)){const o=n==null?void 0:n.deprecatedFor;if(o)i[r]=Array.isArray(o)?o:[o];else{const a=Lw(r,n);e[r]=a,s[r]=a.value}}return{propTypes:e,defaultProps:s,deprecatedProps:i}}function Lw(t,e){switch(Ai(e)){case"object":return Vt(t,e);case"array":return Vt(t,{type:"array",value:e,compare:!1});case"boolean":return Vt(t,{type:"boolean",value:e});case"number":return Vt(t,{type:"number",value:e});case"function":return Vt(t,{type:"function",value:e,compare:!0});default:return{name:t,type:"unknown",value:e}}}function Vt(t,e){return"type"in e?{name:t,...Bw[e.type],...e}:"value"in e?{name:t,type:Ai(e.value),...e}:{name:t,type:"object",value:e}}function En(t){return Array.isArray(t)||ArrayBuffer.isView(t)}function Ai(t){return En(t)?"array":t===null?"null":typeof t}function Vw(t,e){let s;for(let n=e.length-1;n>=0;n--){const o=e[n];"extensions"in o&&(s=o.extensions)}const i=vn(t.constructor,s),r=Object.create(i);r[Ti]=t,r[et]={},r[Ue]={};for(let n=0;n<e.length;++n){const o=e[n];for(const a in o)r[a]=o[a]}return Object.freeze(r),r}const zw="_mergedDefaultProps";function vn(t,e){let s=zw;if(e)for(const r of e){const n=r.constructor;n&&(s+=`:${n.extensionName||n.name}`)}const i=ru(t,s);return i||(t[s]=Ww(t,e||[]))}function Ww(t,e){if(!t.prototype)return null;const i=Object.getPrototypeOf(t),r=vn(i),n=ru(t,"defaultProps")||{},o=Uw(n),a=Object.assign(Object.create(null),r,o.defaultProps),c=Object.assign(Object.create(null),r==null?void 0:r[Ve],o.propTypes),l=Object.assign(Object.create(null),r==null?void 0:r[br],o.deprecatedProps);for(const h of e){const u=vn(h.constructor);u&&(Object.assign(a,u),Object.assign(c,u[Ve]),Object.assign(l,u[br]))}return Hw(a,t),$w(a,c),jw(a,l),a[Ve]=c,a[br]=l,e.length===0&&!eo(t,"_propTypes")&&(t._propTypes=c),a}function Hw(t,e){const s=Yw(e);Object.defineProperties(t,{id:{writable:!0,value:s}})}function jw(t,e){for(const s in e)Object.defineProperty(t,s,{enumerable:!1,set(i){const r=`${this.id}: ${s}`;for(const n of e[s])eo(this,n)||(this[n]=i);U.deprecated(r,e[s].join("/"))()}})}function $w(t,e){const s={},i={};for(const r in e){const n=e[r],{name:o,value:a}=n;n.async&&(s[o]=a,i[o]=Xw(o))}t[At]=s,t[et]={},Object.defineProperties(t,i)}function Xw(t){return{enumerable:!0,set(e){typeof e=="string"||e instanceof Promise||Xh(e)?this[et][t]=e:this[Ue][t]=e},get(){if(this[Ue]){if(t in this[Ue])return this[Ue][t]||this[At][t];if(t in this[et]){const e=this[Ti]&&this[Ti].internalState;if(e&&e.hasAsyncProp(t))return e.getAsyncProp(t)||this[At][t]}}return this[At][t]}}}function eo(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function ru(t,e){return eo(t,e)&&t[e]}function Yw(t){const e=t.componentName;return e||U.warn(`${t.name}.componentName not specified`)(),e||t.name}let Kw=0;class to{constructor(...e){this.props=Vw(this,e),this.id=this.props.id,this.count=Kw++}clone(e){const{props:s}=this,i={};for(const r in s[At])r in s[Ue]?i[r]=s[Ue][r]:r in s[et]&&(i[r]=s[et][r]);return new this.constructor({...s,...i,...e})}}to.componentName="Component";to.defaultProps={};const qw=Object.freeze({});class Zw{constructor(e){this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(const e in this.asyncProps){const s=this.asyncProps[e];s&&s.type&&s.type.release&&s.type.release(s.resolvedValue,s.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||qw}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){const s=this.asyncProps[e];return s&&s.resolvedValue}isAsyncPropLoading(e){if(e){const s=this.asyncProps[e];return!!(s&&s.pendingLoadCount>0&&s.pendingLoadCount!==s.resolvedLoadCount)}for(const s in this.asyncProps)if(this.isAsyncPropLoading(s))return!0;return!1}reloadAsyncProp(e,s){this._watchPromise(e,Promise.resolve(s))}setAsyncProps(e){this.component=e[Ti]||this.component;const s=e[Ue]||{},i=e[et]||e,r=e[At]||{};for(const n in s){const o=s[n];this._createAsyncPropData(n,r[n]),this._updateAsyncProp(n,o),s[n]=this.getAsyncProp(n)}for(const n in i){const o=i[n];this._createAsyncPropData(n,r[n]),this._updateAsyncProp(n,o)}}_fetch(e,s){return null}_onResolve(e,s){}_onError(e,s){}_updateAsyncProp(e,s){if(this._didAsyncInputValueChange(e,s)){if(typeof s=="string"&&(s=this._fetch(e,s)),s instanceof Promise){this._watchPromise(e,s);return}if(Xh(s)){this._resolveAsyncIterable(e,s);return}this._setPropValue(e,s)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(const e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,s){const i=this.asyncProps[e];return s===i.resolvedValue||s===i.lastValue?!1:(i.lastValue=s,!0)}_setPropValue(e,s){this._freezeAsyncOldProps();const i=this.asyncProps[e];i&&(s=this._postProcessValue(i,s),i.resolvedValue=s,i.pendingLoadCount++,i.resolvedLoadCount=i.pendingLoadCount)}_setAsyncPropValue(e,s,i){const r=this.asyncProps[e];r&&i>=r.resolvedLoadCount&&s!==void 0&&(this._freezeAsyncOldProps(),r.resolvedValue=s,r.resolvedLoadCount=i,this.onAsyncPropUpdated(e,s))}_watchPromise(e,s){const i=this.asyncProps[e];if(i){i.pendingLoadCount++;const r=i.pendingLoadCount;s.then(n=>{this.component&&(n=this._postProcessValue(i,n),this._setAsyncPropValue(e,n,r),this._onResolve(e,n))}).catch(n=>{this._onError(e,n)})}}async _resolveAsyncIterable(e,s){if(e!=="data"){this._setPropValue(e,s);return}const i=this.asyncProps[e];if(!i)return;i.pendingLoadCount++;const r=i.pendingLoadCount;let n=[],o=0;for await(const a of s){if(!this.component)return;const{dataTransform:c}=this.component.props;c?n=c(a,n):n=n.concat(a),Object.defineProperty(n,"__diff",{enumerable:!1,value:[{startRow:o,endRow:n.length}]}),o=n.length,this._setAsyncPropValue(e,n,r)}this._onResolve(e,n)}_postProcessValue(e,s){const i=e.type;return i&&this.component&&(i.release&&i.release(e.resolvedValue,i,this.component),i.transform)?i.transform(s,i,this.component):s}_createAsyncPropData(e,s){if(!this.asyncProps[e]){const r=this.component&&this.component.props[Ve];this.asyncProps[e]={type:r&&r[e],lastValue:null,resolvedValue:s,pendingLoadCount:0,resolvedLoadCount:0}}}}class Jw extends Zw{constructor({attributeManager:e,layer:s}){super(s),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(e,s){const i=this.layer,r=i==null?void 0:i.props.fetch;return r?r(s,{propName:e,layer:i}):super._fetch(e,s)}_onResolve(e,s){const i=this.layer;if(i){const r=i.props.onDataLoad;e==="data"&&r&&r(s,{propName:e,layer:i})}}_onError(e,s){const i=this.layer;i&&i.raiseError(s,`loading ${e} of ${this.layer}`)}}const Qw="layer.changeFlag",Gw="layer.initialize",eS="layer.update",tS="layer.finalize",sS="layer.matched",uc=2**24-1,iS=Object.freeze([]),rS=_s(({oldViewport:t,viewport:e})=>t.equals(e));let fe=new Uint8ClampedArray(0);const nS={data:{type:"data",value:iS,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:t=>t&&t.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(t,{propName:e,layer:s,loaders:i,loadOptions:r,signal:n})=>{const{resourceManager:o}=s.context;r=r||s.getLoadOptions(),i=i||s.props.loaders,n&&(r={...r,fetch:{...r==null?void 0:r.fetch,signal:n}});let a=o.contains(t);return!a&&!r&&(o.add({resourceId:t,data:si(t,i),persistent:!1}),a=!0),a?o.subscribe({resourceId:t,onChange:c=>{var l;return(l=s.internalState)==null?void 0:l.reloadAsyncProp(e,c)},consumerId:s.id,requestId:e}):si(t,i,r)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:L.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:t})=>[0,-t*100]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class Ce extends to{constructor(){super(...arguments),this.internalState=null,this.lifecycle=dt.NO_STATE,this.parent=null}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){return`${this.constructor.layerName||this.constructor.name}({id: '${this.props.id}'})`}project(e){te(this.internalState);const s=this.internalState.viewport||this.context.viewport,i=Th(e,{viewport:s,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[r,n,o]=uh(i,s.pixelProjectionMatrix);return e.length===2?[r,n]:[r,n,o]}unproject(e){return te(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,s){te(this.internalState);const i=this.internalState.viewport||this.context.viewport;return xb(e,{viewport:i,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...s})}get isComposite(){return!1}get isDrawable(){return!0}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){const e=this.state;return e&&(e.models||e.model&&[e.model])||[]}setModuleParameters(e){for(const s of this.getModels())s.updateModuleSettings(e)}setShaderModuleProps(...e){for(const s of this.getModels())s.shaderInputs.setProps(...e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){const{coordinateSystem:e}=this.props;return e===L.DEFAULT||e===L.LNGLAT||e===L.CARTESIAN}onHover(e,s){return this.props.onHover&&this.props.onHover(e,s)||!1}onClick(e,s){return this.props.onClick&&this.props.onClick(e,s)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,s=[]){return s[0]=e+1&255,s[1]=e+1>>8&255,s[2]=e+1>>8>>8&255,s}decodePickingColor(e){te(e instanceof Uint8Array);const[s,i,r]=e;return s+i*256+r*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:Mw(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var e;return(e=this.getAttributeManager())==null?void 0:e.getBounds(["positions","instancePositions"])}getShaders(e){e=hc(e,{disableWarnings:!0,modules:this.context.defaultShaderModules});for(const s of this.props.extensions)e=hc(e,s.getShaders.call(this,s));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){const s=this.getAttributeManager(),{dataChanged:i}=e.changeFlags;if(i&&s)if(Array.isArray(i))for(const r of i)s.invalidateAll(r);else s.invalidateAll();if(s){const{props:r}=e,n=this.internalState.hasPickingBuffer,o=Number.isInteger(r.highlightedObjectIndex)||r.pickable||r.extensions.some(a=>a.getNeedsPickingBuffer.call(this,a));if(n!==o){this.internalState.hasPickingBuffer=o;const{pickingColors:a,instancePickingColors:c}=s.attributes,l=a||c;l&&(o&&l.constant&&(l.constant=!1,s.invalidate(l.id)),!l.value&&!o&&(l.constant=!0,l.value=[0,0,0]))}}}finalizeState(e){for(const i of this.getModels())i.destroy();const s=this.getAttributeManager();s&&s.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(const s of this.getModels())s.draw(e)}getPickingInfo({info:e,mode:s,sourceLayer:i}){const{index:r}=e;return r>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[r]),e}raiseError(e,s){var i,r,n,o;s&&(e=new Error(`${s}: ${e.message}`,{cause:e})),(r=(i=this.props).onError)!=null&&r.call(i,e)||(o=(n=this.context)==null?void 0:n.onError)==null||o.call(n,e,this)}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){var e;return((e=this.internalState)==null?void 0:e.uniformTransitions.active)||!1}activateViewport(e){if(!this.internalState)return;const s=this.internalState.viewport;this.internalState.viewport=e,(!s||!rS({oldViewport:s,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){const s=this.getAttributeManager();s&&(e==="all"?s.invalidateAll():s.invalidate(e))}updateAttributes(e){let s=!1;for(const i in e)e[i].layoutChanged()&&(s=!0);for(const i of this.getModels())this._setModelAttributes(i,e,s)}_updateAttributes(){const e=this.getAttributeManager();if(!e)return;const s=this.props,i=this.getNumInstances(),r=this.getStartIndices();e.update({data:s.data,numInstances:i,startIndices:r,props:s,transitions:s.transitions,buffers:s.data.attributes,context:this});const n=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(n)}_updateAttributeTransition(){const e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){const{uniformTransitions:e}=this.internalState;if(e.active){const s=e.update(),i=Object.create(this.props);for(const r in s)Object.defineProperty(i,r,{value:s[r]});return i}return this.props}calculateInstancePickingColors(e,{numInstances:s}){if(e.constant)return;const i=Math.floor(fe.length/4);if(this.internalState.usesPickingColorCache=!0,i<s){s>uc&&U.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),fe=Ct.allocate(fe,s,{size:4,copy:!0,maxCount:Math.max(s,uc)});const r=Math.floor(fe.length/4),n=[0,0,0];for(let o=i;o<r;o++)this.encodePickingColor(o,n),fe[o*4+0]=n[0],fe[o*4+1]=n[1],fe[o*4+2]=n[2],fe[o*4+3]=0}e.value=fe.subarray(0,s*4)}_setModelAttributes(e,s,i=!1){var a;if(!Object.keys(s).length)return;if(i){const c=this.getAttributeManager();e.setBufferLayout(c.getBufferLayouts(e)),s=c.getAttributes()}const r=((a=e.userData)==null?void 0:a.excludeAttributes)||{},n={},o={};for(const c in s){if(r[c])continue;const l=s[c].getValue();for(const h in l){const u=l[h];u instanceof j?s[c].settings.isIndexed?e.setIndexBuffer(u):n[h]=u:u&&(o[h]=u)}}e.setAttributes(n),e.setConstantAttributes(o)}disablePickingIndex(e){const s=this.props.data;if(!("attributes"in s)){this._disablePickingIndex(e);return}const{pickingColors:i,instancePickingColors:r}=this.getAttributeManager().attributes,n=i||r,o=n&&s.attributes&&s.attributes[n.id];if(o&&o.value){const a=o.value,c=this.encodePickingColor(e);for(let l=0;l<s.length;l++){const h=n.getVertexOffset(l);a[h]===c[0]&&a[h+1]===c[1]&&a[h+2]===c[2]&&this._disablePickingIndex(l)}}else this._disablePickingIndex(e)}_disablePickingIndex(e){const{pickingColors:s,instancePickingColors:i}=this.getAttributeManager().attributes,r=s||i;if(!r)return;const n=r.getVertexOffset(e),o=r.getVertexOffset(e+1);r.buffer.write(new Uint8Array(o-n),n)}restorePickingColors(){const{pickingColors:e,instancePickingColors:s}=this.getAttributeManager().attributes,i=e||s;i&&(this.internalState.usesPickingColorCache&&i.value.buffer!==fe.buffer&&(i.value=fe.subarray(0,i.value.length)),i.updateSubBuffer({startOffset:0}))}_initialize(){te(!this.internalState),te(Number.isFinite(this.props.coordinateSystem)),re(Gw,this);const e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:"uint8",size:4,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new Jw({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(U.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.uniformTransitions=new ww(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(const s of this.props.extensions)s.initializeState.call(this,this.context,s);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){re(sS,this,this===e);const{state:s,internalState:i}=e;this!==e&&(this.internalState=i,this.state=s,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){const e=this.needsUpdate();if(re(eS,this,e),!e)return;const s=this.props,i=this.context,r=this.internalState,n=i.viewport,o=this._updateUniformTransition();r.propsInTransition=o,i.viewport=r.viewport||n,this.props=o;try{const a=this._getUpdateParams(),c=this.getModels();if(i.device)this.updateState(a);else try{this.updateState(a)}catch{}for(const h of this.props.extensions)h.updateState.call(this,a,h);this.setNeedsRedraw(),this._updateAttributes();const l=this.getModels()[0]!==c[0];this._postUpdate(a,l)}finally{i.viewport=n,this.props=s,this._clearChangeFlags(),r.needsUpdate=!1,r.resetOldProps()}}_finalize(){re(tS,this),this.finalizeState(this.context);for(const e of this.props.extensions)e.finalizeState.call(this,this.context,e)}_drawLayer({renderPass:e,moduleParameters:s=null,uniforms:i={},parameters:r={}}){this._updateAttributeTransition();const n=this.props,o=this.context;this.props=this.internalState.propsInTransition||n;const a=Math.pow(this.props.opacity,1/2.2);i.opacity=a;try{if(s){const{isActive:h,isAttribute:u}=s.picking,{viewport:f,devicePixelRatio:p,coordinateSystem:_,coordinateOrigin:m}=s,{material:T,modelMatrix:S}=this.props,{picking:v,...w}=s;this.setModuleParameters(w);const{shadowEnabled:E,drawToShadowMap:R,shadowMaps:P,dummyShadowMap:M,shadowColor:C,shadowMatrices:I,shadowLightId:k,picking:O,heightMap:F,heightMapBounds:D,dummyHeightMap:B,terrainCover:le,drawToTerrainHeightMap:Eu,useTerrainHeightMap:vu,terrainSkipRender:Ru,lightSources:xu}=s,Pu={viewport:f,shadowEnabled:E,drawToShadowMap:R,shadowMaps:P,dummyShadowMap:M,shadowColor:C,shadowMatrices:I,shadowLightId:k},Cu={viewport:f,picking:O,heightMap:F,heightMapBounds:D,dummyHeightMap:B,terrainCover:le,drawToTerrainHeightMap:Eu,useTerrainHeightMap:vu,terrainSkipRender:Ru};this.setShaderModuleProps({shadow:Pu,terrain:Cu,layer:{opacity:a},lighting:xu,phongMaterial:T,gouraudMaterial:T,picking:{isActive:h,isAttribute:u},project:{viewport:f,devicePixelRatio:p,modelMatrix:S,coordinateSystem:_,coordinateOrigin:m}})}const{getPolygonOffset:c}=this.props,l=c&&c(i)||[0,0];o.device.setParametersWebGL({polygonOffset:l});for(const h of this.getModels())h.setParameters(r);o.device.withParametersWebGL(r,()=>{const h={renderPass:e,moduleParameters:s,uniforms:i,parameters:r,context:o};for(const u of this.props.extensions)u.draw.call(this,h,u);this.draw(h)})}finally{this.props=n}}getChangeFlags(){var e;return(e=this.internalState)==null?void 0:e.changeFlags}setChangeFlags(e){if(!this.internalState)return;const{changeFlags:s}=this.internalState;for(const r in e)if(e[r]){let n=!1;switch(r){case"dataChanged":const o=e[r],a=s[r];o&&Array.isArray(a)&&(s.dataChanged=Array.isArray(o)?a.concat(o):o,n=!0);default:s[r]||(s[r]=e[r],n=!0)}n&&re(Qw,this,r,e)}const i=!!(s.dataChanged||s.updateTriggersChanged||s.propsChanged||s.extensionsChanged);s.propsOrDataChanged=i,s.somethingChanged=i||s.viewportChanged||s.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,s){var r;const i=Ew(e,s);if(i.updateTriggersChanged)for(const n in i.updateTriggersChanged)i.updateTriggersChanged[n]&&this.invalidateAttribute(n);if(i.transitionsChanged)for(const n in i.transitionsChanged)this.internalState.uniformTransitions.add(n,s[n],e[n],(r=e.transitions)==null?void 0:r[n]);return this.setChangeFlags(i)}validateProps(){Sw(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){const s={highlightedObjectColor:e.picked?e.color:null},{highlightColor:i}=this.props;e.picked&&typeof i=="function"&&(s.highlightColor=i(e)),this.setShaderModuleProps({picking:s}),this.setNeedsRedraw()}_getAttributeManager(){const e=this.context;return new mw(e.device,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,s){const{props:i,oldProps:r}=e,n=this.state.model;n!=null&&n.isInstanced&&n.setInstanceCount(this.getNumInstances());const{autoHighlight:o,highlightedObjectIndex:a,highlightColor:c}=i;if(s||r.autoHighlight!==o||r.highlightedObjectIndex!==a||r.highlightColor!==c){const l={};Array.isArray(c)&&(l.highlightColor=c),(s||r.autoHighlight!==o||a!==r.highlightedObjectIndex)&&(l.highlightedObjectColor=Number.isFinite(a)&&a>=0?this.encodePickingColor(a):null),this.setShaderModuleProps({picking:l})}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let s=!1;s=s||this.internalState.needsRedraw&&this.id;const i=this.getAttributeManager(),r=i?i.getNeedsRedraw(e):!1;if(s=s||r,s)for(const n of this.props.extensions)n.onNeedsRedraw.call(this,n);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags,s}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}Ce.defaultProps=nS;Ce.layerName="Layer";const oS="compositeLayer.renderLayers";class so extends Ce{get isComposite(){return!0}get isDrawable(){return!1}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(e=>e.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(e){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){const{object:s}=e;return s&&s.__source&&s.__source.parent&&s.__source.parent.id===this.id&&(e.object=s.__source.object,e.index=s.__source.index),e}filterSubLayer(e){return!0}shouldRenderSubLayer(e,s){return s&&s.length}getSubLayerClass(e,s){const{_subLayerProps:i}=this.props;return i&&i[e]&&i[e].type||s}getSubLayerRow(e,s,i){return e.__source={parent:this,object:s,index:i},e}getSubLayerAccessor(e){if(typeof e=="function"){const s={index:-1,data:this.props.data,target:[]};return(i,r)=>i&&i.__source?(s.index=i.__source.index,e(i.__source.object,s)):e(i,r)}return e}getSubLayerProps(e={}){var M;const{opacity:s,pickable:i,visible:r,parameters:n,getPolygonOffset:o,highlightedObjectIndex:a,autoHighlight:c,highlightColor:l,coordinateSystem:h,coordinateOrigin:u,wrapLongitude:f,positionFormat:p,modelMatrix:_,extensions:m,fetch:T,operation:S,_subLayerProps:v}=this.props,w={id:"",updateTriggers:{},opacity:s,pickable:i,visible:r,parameters:n,getPolygonOffset:o,highlightedObjectIndex:a,autoHighlight:c,highlightColor:l,coordinateSystem:h,coordinateOrigin:u,wrapLongitude:f,positionFormat:p,modelMatrix:_,extensions:m,fetch:T,operation:S},E=v&&e.id&&v[e.id],R=E&&E.updateTriggers,P=e.id||"sublayer";if(E){const C=this.props[Ve],I=e.type?e.type._propTypes:{};for(const k in E){const O=I[k]||C[k];O&&O.type==="accessor"&&(E[k]=this.getSubLayerAccessor(E[k]))}}Object.assign(w,e,E),w.id=`${this.props.id}-${P}`,w.updateTriggers={all:(M=this.props.updateTriggers)==null?void 0:M.all,...e.updateTriggers,...R};for(const C of m){const I=C.getSubLayerProps.call(this,C);I&&Object.assign(w,I,{updateTriggers:Object.assign(w.updateTriggers,I.updateTriggers)})}return w}_updateAutoHighlight(e){for(const s of this.getSubLayers())s.updateAutoHighlight(e)}_getAttributeManager(){return null}_postUpdate(e,s){let i=this.internalState.subLayers;const r=!i||this.needsUpdate();if(r){const n=this.renderLayers();i=Kn(n,Boolean),this.internalState.subLayers=i}re(oS,this,r,i);for(const n of i)n.parent=this}}so.layerName="CompositeLayer";class nu{constructor(e){this.indexStarts=[0],this.vertexStarts=[0],this.vertexCount=0,this.instanceCount=0;const{attributes:s={}}=e;this.typedArrayManager=Ct,this.attributes={},this._attributeDefs=s,this.opts=e,this.updateGeometry(e)}updateGeometry(e){Object.assign(this.opts,e);const{data:s,buffers:i={},getGeometry:r,geometryBuffer:n,positionFormat:o,dataChanged:a,normalize:c=!0}=this.opts;if(this.data=s,this.getGeometry=r,this.positionSize=n&&n.size||(o==="XY"?2:3),this.buffers=i,this.normalize=c,n&&(te(s.startIndices),this.getGeometry=this.getGeometryFromBuffer(n),c||(i.vertexPositions=n)),this.geometryBuffer=i.vertexPositions,Array.isArray(a))for(const l of a)this._rebuildGeometry(l);else this._rebuildGeometry()}updatePartialGeometry({startRow:e,endRow:s}){this._rebuildGeometry({startRow:e,endRow:s})}getGeometryFromBuffer(e){const s=e.value||e;return ArrayBuffer.isView(s)?Yh(s,{size:this.positionSize,offset:e.offset,stride:e.stride,startIndices:this.data.startIndices}):null}_allocate(e,s){const{attributes:i,buffers:r,_attributeDefs:n,typedArrayManager:o}=this;for(const a in n)if(a in r)o.release(i[a]),i[a]=null;else{const c=n[a];c.copy=s,i[a]=o.allocate(i[a],e,c)}}_forEachGeometry(e,s,i){const{data:r,getGeometry:n}=this,{iterable:o,objectInfo:a}=$i(r,s,i);for(const c of o){a.index++;const l=n?n(c,a):null;e(l,a.index)}}_rebuildGeometry(e){if(!this.data)return;let{indexStarts:s,vertexStarts:i,instanceCount:r}=this;const{data:n,geometryBuffer:o}=this,{startRow:a=0,endRow:c=1/0}=e||{},l={};if(e||(s=[0],i=[0]),this.normalize||!o)this._forEachGeometry((u,f)=>{const p=u&&this.normalizeGeometry(u);l[f]=p,i[f+1]=i[f]+(p?this.getGeometrySize(p):0)},a,c),r=i[i.length-1];else if(i=n.startIndices,r=i[n.length]||0,ArrayBuffer.isView(o))r=r||o.length/this.positionSize;else if(o instanceof j){const u=this.positionSize*4;r=r||o.byteLength/u}else if(o.buffer){const u=o.stride||this.positionSize*4;r=r||o.buffer.byteLength/u}else if(o.value){const u=o.value,f=o.stride/u.BYTES_PER_ELEMENT||this.positionSize;r=r||u.length/f}this._allocate(r,!!e),this.indexStarts=s,this.vertexStarts=i,this.instanceCount=r;const h={};this._forEachGeometry((u,f)=>{const p=l[f]||u;h.vertexStart=i[f],h.indexStart=s[f];const _=f<i.length-1?i[f+1]:r;h.geometrySize=_-i[f],h.geometryIndex=f,this.updateGeometryAttributes(p,h)},a,c),this.vertexCount=s[s.length-1]}}const fc=`uniform arcUniforms {
  bool greatCircle;
  bool useShortestPath;
  float numSegments;
  float widthScale;
  float widthMinPixels;
  float widthMaxPixels;
  highp int widthUnits;
} arc;
`,aS={name:"arc",vs:fc,fs:fc,uniformTypes:{greatCircle:"f32",useShortestPath:"f32",numSegments:"f32",widthScale:"f32",widthMinPixels:"f32",widthMaxPixels:"f32",widthUnits:"i32"}},cS=`#version 300 es
#define SHADER_NAME arc-layer-vertex-shader

in vec4 instanceSourceColors;
in vec4 instanceTargetColors;
in vec3 instanceSourcePositions;
in vec3 instanceSourcePositions64Low;
in vec3 instanceTargetPositions;
in vec3 instanceTargetPositions64Low;
in vec3 instancePickingColors;
in float instanceWidths;
in float instanceHeights;
in float instanceTilts;

out vec4 vColor;
out vec2 uv;
out float isValid;

float paraboloid(float distance, float sourceZ, float targetZ, float ratio) {
  // d: distance on the xy plane
  // r: ratio of the current point
  // p: ratio of the peak of the arc
  // h: height multiplier
  // z = f(r) = sqrt(r * (p * 2 - r)) * d * h
  // f(0) = 0
  // f(1) = dz

  float deltaZ = targetZ - sourceZ;
  float dh = distance * instanceHeights;
  if (dh == 0.0) {
    return sourceZ + deltaZ * ratio;
  }
  float unitZ = deltaZ / dh;
  float p2 = unitZ * unitZ + 1.0;

  // sqrt does not deal with negative values, manually flip source and target if delta.z < 0
  float dir = step(deltaZ, 0.0);
  float z0 = mix(sourceZ, targetZ, dir);
  float r = mix(ratio, 1.0 - ratio, dir);
  return sqrt(r * (p2 - r)) * dh + z0;
}

// offset vector by strokeWidth pixels
// offset_direction is -1 (left) or 1 (right)
vec2 getExtrusionOffset(vec2 line_clipspace, float offset_direction, float width) {
  // normalized direction of the line
  vec2 dir_screenspace = normalize(line_clipspace * project.viewportSize);
  // rotate by 90 degrees
  dir_screenspace = vec2(-dir_screenspace.y, dir_screenspace.x);

  return dir_screenspace * offset_direction * width / 2.0;
}

float getSegmentRatio(float index) {
  return smoothstep(0.0, 1.0, index / (arc.numSegments - 1.0));
}

vec3 interpolateFlat(vec3 source, vec3 target, float segmentRatio) {
  float distance = length(source.xy - target.xy);
  float z = paraboloid(distance, source.z, target.z, segmentRatio);

  float tiltAngle = radians(instanceTilts);
  vec2 tiltDirection = normalize(target.xy - source.xy);
  vec2 tilt = vec2(-tiltDirection.y, tiltDirection.x) * z * sin(tiltAngle);

  return vec3(
    mix(source.xy, target.xy, segmentRatio) + tilt,
    z * cos(tiltAngle)
  );
}

/* Great circle interpolation
 * http://www.movable-type.co.uk/scripts/latlong.html
 */
float getAngularDist (vec2 source, vec2 target) {
  vec2 sourceRadians = radians(source);
  vec2 targetRadians = radians(target);
  vec2 sin_half_delta = sin((sourceRadians - targetRadians) / 2.0);
  vec2 shd_sq = sin_half_delta * sin_half_delta;

  float a = shd_sq.y + cos(sourceRadians.y) * cos(targetRadians.y) * shd_sq.x;
  return 2.0 * asin(sqrt(a));
}

vec3 interpolateGreatCircle(vec3 source, vec3 target, vec3 source3D, vec3 target3D, float angularDist, float t) {
  vec2 lngLat;

  // if the angularDist is PI, linear interpolation is applied. otherwise, use spherical interpolation
  if(abs(angularDist - PI) < 0.001) {
    lngLat = (1.0 - t) * source.xy + t * target.xy;
  } else {
    float a = sin((1.0 - t) * angularDist);
    float b = sin(t * angularDist);
    vec3 p = source3D.yxz * a + target3D.yxz * b;
    lngLat = degrees(vec2(atan(p.y, -p.x), atan(p.z, length(p.xy))));
  }

  float z = paraboloid(angularDist * EARTH_RADIUS, source.z, target.z, t);

  return vec3(lngLat, z);
}

/* END GREAT CIRCLE */

void main(void) {
  geometry.worldPosition = instanceSourcePositions;
  geometry.worldPositionAlt = instanceTargetPositions;

  /*
  *  --(i, -1)-----------_(i+1, -1)--
  *       |          _,-"  |
  *       o      _,-"      o
  *       |  _,-"          |
  *  --(i, 1)"-------------(i+1, 1)--
  */
  float segmentIndex = float(gl_VertexID / 2);
  float segmentSide = mod(float(gl_VertexID), 2.) == 0. ? -1. : 1.;
  float segmentRatio = getSegmentRatio(segmentIndex);
  float prevSegmentRatio = getSegmentRatio(max(0.0, segmentIndex - 1.0));
  float nextSegmentRatio = getSegmentRatio(min(arc.numSegments - 1.0, segmentIndex + 1.0));

  // if it's the first point, use next - current as direction
  // otherwise use current - prev
  float indexDir = mix(-1.0, 1.0, step(segmentIndex, 0.0));
  isValid = 1.0;

  uv = vec2(segmentRatio, segmentSide);
  geometry.uv = uv;
  geometry.pickingColor = instancePickingColors;

  vec4 curr;
  vec4 next;
  vec3 source;
  vec3 target;

  if ((arc.greatCircle || project.projectionMode == PROJECTION_MODE_GLOBE) && project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
    source = project_globe_(vec3(instanceSourcePositions.xy, 0.0));
    target = project_globe_(vec3(instanceTargetPositions.xy, 0.0));
    float angularDist = getAngularDist(instanceSourcePositions.xy, instanceTargetPositions.xy);

    vec3 prevPos = interpolateGreatCircle(instanceSourcePositions, instanceTargetPositions, source, target, angularDist, prevSegmentRatio);
    vec3 currPos = interpolateGreatCircle(instanceSourcePositions, instanceTargetPositions, source, target, angularDist, segmentRatio);
    vec3 nextPos = interpolateGreatCircle(instanceSourcePositions, instanceTargetPositions, source, target, angularDist, nextSegmentRatio);

    if (abs(currPos.x - prevPos.x) > 180.0) {
      indexDir = -1.0;
      isValid = 0.0;
    } else if (abs(currPos.x - nextPos.x) > 180.0) {
      indexDir = 1.0;
      isValid = 0.0;
    }
    nextPos = indexDir < 0.0 ? prevPos : nextPos;
    nextSegmentRatio = indexDir < 0.0 ? prevSegmentRatio : nextSegmentRatio;

    if (isValid == 0.0) {
      // split at the 180th meridian
      nextPos.x += nextPos.x > 0.0 ? -360.0 : 360.0;
      float t = ((currPos.x > 0.0 ? 180.0 : -180.0) - currPos.x) / (nextPos.x - currPos.x);
      currPos = mix(currPos, nextPos, t);
      segmentRatio = mix(segmentRatio, nextSegmentRatio, t);
    }

    vec3 currPos64Low = mix(instanceSourcePositions64Low, instanceTargetPositions64Low, segmentRatio);
    vec3 nextPos64Low = mix(instanceSourcePositions64Low, instanceTargetPositions64Low, nextSegmentRatio);
  
    curr = project_position_to_clipspace(currPos, currPos64Low, vec3(0.0), geometry.position);
    next = project_position_to_clipspace(nextPos, nextPos64Low, vec3(0.0));
  
  } else {
    vec3 source_world = instanceSourcePositions;
    vec3 target_world = instanceTargetPositions;
    if (arc.useShortestPath) {
      source_world.x = mod(source_world.x + 180., 360.0) - 180.;
      target_world.x = mod(target_world.x + 180., 360.0) - 180.;

      float deltaLng = target_world.x - source_world.x;
      if (deltaLng > 180.) target_world.x -= 360.;
      if (deltaLng < -180.) source_world.x -= 360.;
    }
    source = project_position(source_world, instanceSourcePositions64Low);
    target = project_position(target_world, instanceTargetPositions64Low);

    // common x at longitude=-180
    float antiMeridianX = 0.0;

    if (arc.useShortestPath) {
      if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
        antiMeridianX = -(project.coordinateOrigin.x + 180.) / 360. * TILE_SIZE;
      }
      float thresholdRatio = (antiMeridianX - source.x) / (target.x - source.x);

      if (prevSegmentRatio <= thresholdRatio && nextSegmentRatio > thresholdRatio) {
        isValid = 0.0;
        indexDir = sign(segmentRatio - thresholdRatio);
        segmentRatio = thresholdRatio;
      }
    }

    nextSegmentRatio = indexDir < 0.0 ? prevSegmentRatio : nextSegmentRatio;
    vec3 currPos = interpolateFlat(source, target, segmentRatio);
    vec3 nextPos = interpolateFlat(source, target, nextSegmentRatio);

    if (arc.useShortestPath) {
      if (nextPos.x < antiMeridianX) {
        currPos.x += TILE_SIZE;
        nextPos.x += TILE_SIZE;
      }
    }

    curr = project_common_position_to_clipspace(vec4(currPos, 1.0));
    next = project_common_position_to_clipspace(vec4(nextPos, 1.0));
    geometry.position = vec4(currPos, 1.0);
  }

  // Multiply out width and clamp to limits
  // mercator pixels are interpreted as screen pixels
  float widthPixels = clamp(
    project_size_to_pixel(instanceWidths * arc.widthScale, arc.widthUnits),
    arc.widthMinPixels, arc.widthMaxPixels
  );

  // extrude
  vec3 offset = vec3(
    getExtrusionOffset((next.xy - curr.xy) * indexDir, segmentSide, widthPixels),
    0.0);
  DECKGL_FILTER_SIZE(offset, geometry);
  DECKGL_FILTER_GL_POSITION(curr, geometry);
  gl_Position = curr + vec4(project_pixel_size_to_clipspace(offset.xy), 0.0, 0.0);

  vec4 color = mix(instanceSourceColors, instanceTargetColors, segmentRatio);
  vColor = vec4(color.rgb, color.a * layer.opacity);
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`,lS=`#version 300 es
#define SHADER_NAME arc-layer-fragment-shader

precision highp float;

in vec4 vColor;
in vec2 uv;
in float isValid;

out vec4 fragColor;

void main(void) {
  if (isValid == 0.0) {
    discard;
  }

  fragColor = vColor;
  geometry.uv = uv;

  DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,wi=[0,0,0,255],hS={getSourcePosition:{type:"accessor",value:t=>t.sourcePosition},getTargetPosition:{type:"accessor",value:t=>t.targetPosition},getSourceColor:{type:"accessor",value:wi},getTargetColor:{type:"accessor",value:wi},getWidth:{type:"accessor",value:1},getHeight:{type:"accessor",value:1},getTilt:{type:"accessor",value:0},greatCircle:!1,numSegments:{type:"number",value:50,min:1},widthUnits:"pixels",widthScale:{type:"number",value:1,min:0},widthMinPixels:{type:"number",value:0,min:0},widthMaxPixels:{type:"number",value:Number.MAX_SAFE_INTEGER,min:0}};class io extends Ce{getBounds(){var e;return(e=this.getAttributeManager())==null?void 0:e.getBounds(["instanceSourcePositions","instanceTargetPositions"])}getShaders(){return super.getShaders({vs:cS,fs:lS,modules:[Nt,kt,aS]})}get wrapLongitude(){return!1}initializeState(){this.getAttributeManager().addInstanced({instanceSourcePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getSourcePosition"},instanceTargetPositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getTargetPosition"},instanceSourceColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getSourceColor",defaultValue:wi},instanceTargetColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getTargetColor",defaultValue:wi},instanceWidths:{size:1,transition:!0,accessor:"getWidth",defaultValue:1},instanceHeights:{size:1,transition:!0,accessor:"getHeight",defaultValue:1},instanceTilts:{size:1,transition:!0,accessor:"getTilt",defaultValue:0}})}updateState(e){var s;super.updateState(e),e.changeFlags.extensionsChanged&&((s=this.state.model)==null||s.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){const{widthUnits:s,widthScale:i,widthMinPixels:r,widthMaxPixels:n,greatCircle:o,wrapLongitude:a,numSegments:c}=this.props,l={numSegments:c,widthUnits:We[s],widthScale:i,widthMinPixels:r,widthMaxPixels:n,greatCircle:o,useShortestPath:a},h=this.state.model;h.shaderInputs.setProps({arc:l}),h.setVertexCount(c*2),h.draw(this.context.renderPass)}_getModel(){return new ue(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),topology:"triangle-strip",isInstanced:!0})}}io.layerName="ArcLayer";io.defaultProps=hS;const dc=`uniform iconUniforms {
  float sizeScale;
  vec2 iconsTextureDim;
  float sizeMinPixels;
  float sizeMaxPixels;
  bool billboard;
  highp int sizeUnits;
  float alphaCutoff;
} icon;
`,uS={name:"icon",vs:dc,fs:dc,uniformTypes:{sizeScale:"f32",iconsTextureDim:"vec2<f32>",sizeMinPixels:"f32",sizeMaxPixels:"f32",billboard:"f32",sizeUnits:"i32",alphaCutoff:"f32"}},fS=`#version 300 es
#define SHADER_NAME icon-layer-vertex-shader

in vec2 positions;

in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceSizes;
in float instanceAngles;
in vec4 instanceColors;
in vec3 instancePickingColors;
in vec4 instanceIconFrames;
in float instanceColorModes;
in vec2 instanceOffsets;
in vec2 instancePixelOffset;

out float vColorMode;
out vec4 vColor;
out vec2 vTextureCoords;
out vec2 uv;

vec2 rotate_by_angle(vec2 vertex, float angle) {
  float angle_radian = angle * PI / 180.0;
  float cos_angle = cos(angle_radian);
  float sin_angle = sin(angle_radian);
  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
  return rotationMatrix * vertex;
}

void main(void) {
  geometry.worldPosition = instancePositions;
  geometry.uv = positions;
  geometry.pickingColor = instancePickingColors;
  uv = positions;

  vec2 iconSize = instanceIconFrames.zw;
  // convert size in meters to pixels, then scaled and clamp
 
  // project meters to pixels and clamp to limits 
  float sizePixels = clamp(
    project_size_to_pixel(instanceSizes * icon.sizeScale, icon.sizeUnits),
    icon.sizeMinPixels, icon.sizeMaxPixels
  );

  // scale icon height to match instanceSize
  float instanceScale = iconSize.y == 0.0 ? 0.0 : sizePixels / iconSize.y;

  // scale and rotate vertex in "pixel" value and convert back to fraction in clipspace
  vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;
  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;
  pixelOffset += instancePixelOffset;
  pixelOffset.y *= -1.0;

  if (icon.billboard)  {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
    vec3 offset = vec3(pixelOffset, 0.0);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);

  } else {
    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
    DECKGL_FILTER_SIZE(offset_common, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position); 
    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  }

  vTextureCoords = mix(
    instanceIconFrames.xy,
    instanceIconFrames.xy + iconSize,
    (positions.xy + 1.0) / 2.0
  ) / icon.iconsTextureDim;

  vColor = instanceColors;
  DECKGL_FILTER_COLOR(vColor, geometry);

  vColorMode = instanceColorModes;
}
`,dS=`#version 300 es
#define SHADER_NAME icon-layer-fragment-shader

precision highp float;

uniform sampler2D iconsTexture;

in float vColorMode;
in vec4 vColor;
in vec2 vTextureCoords;
in vec2 uv;

out vec4 fragColor;

void main(void) {
  geometry.uv = uv;

  vec4 texColor = texture(iconsTexture, vTextureCoords);

  // if colorMode == 0, use pixel color from the texture
  // if colorMode == 1 or rendering picking buffer, use texture as transparency mask
  vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);
  // Take the global opacity and the alpha from vColor into account for the alpha component
  float a = texColor.a * layer.opacity * vColor.a;

  if (a < icon.alphaCutoff) {
    discard;
  }

  fragColor = vec4(color, a);
  DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,gS=1024,pS=4,gc=()=>{},pc={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},_S={x:0,y:0,width:0,height:0};function mS(t){return Math.pow(2,Math.ceil(Math.log2(t)))}function yS(t,e,s,i){const r=Math.min(s/e.width,i/e.height),n=Math.floor(e.width*r),o=Math.floor(e.height*r);return r===1?{image:e,width:n,height:o}:(t.canvas.height=o,t.canvas.width=n,t.clearRect(0,0,n,o),t.drawImage(e,0,0,e.width,e.height,0,0,n,o),{image:t.canvas,width:n,height:o})}function as(t){return t&&(t.id||t.url)}function bS(t,e,s,i){const{width:r,height:n,device:o}=t,a=o.createTexture({format:"rgba8unorm",width:e,height:s,sampler:i,mipmaps:!0}),c=o.createCommandEncoder();return c.copyTextureToTexture({sourceTexture:t,destinationTexture:a,width:r,height:n}),c.finish(),t.destroy(),a}function _c(t,e,s){for(let i=0;i<e.length;i++){const{icon:r,xOffset:n}=e[i],o=as(r);t[o]={...r,x:n,y:s}}}function TS({icons:t,buffer:e,mapping:s={},xOffset:i=0,yOffset:r=0,rowHeight:n=0,canvasWidth:o}){let a=[];for(let c=0;c<t.length;c++){const l=t[c],h=as(l);if(!s[h]){const{height:u,width:f}=l;i+f+e>o&&(_c(s,a,r),i=0,r=n+r+e,n=0,a=[]),a.push({icon:l,xOffset:i}),i=i+f+e,n=Math.max(n,u)}}return a.length>0&&_c(s,a,r),{mapping:s,rowHeight:n,xOffset:i,yOffset:r,canvasWidth:o,canvasHeight:mS(n+r+e)}}function AS(t,e,s){if(!t||!e)return null;s=s||{};const i={},{iterable:r,objectInfo:n}=$i(t);for(const o of r){n.index++;const a=e(o,n),c=as(a);if(!a)throw new Error("Icon is missing.");if(!a.url)throw new Error("Icon url is missing.");!i[c]&&(!s[c]||a.url!==s[c].url)&&(i[c]={...a,source:o,sourceIndex:n.index})}return i}class wS{constructor(e,{onUpdate:s=gc,onError:i=gc}){this._loadOptions=null,this._texture=null,this._externalTexture=null,this._mapping={},this._samplerParameters=null,this._pendingCount=0,this._autoPacking=!1,this._xOffset=0,this._yOffset=0,this._rowHeight=0,this._buffer=pS,this._canvasWidth=gS,this._canvasHeight=0,this._canvas=null,this.device=e,this.onUpdate=s,this.onError=i}finalize(){var e;(e=this._texture)==null||e.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(e){const s=this._autoPacking?as(e):e;return this._mapping[s]||_S}setProps({loadOptions:e,autoPacking:s,iconAtlas:i,iconMapping:r,textureParameters:n}){var o;e&&(this._loadOptions=e),s!==void 0&&(this._autoPacking=s),r&&(this._mapping=r),i&&((o=this._texture)==null||o.delete(),this._texture=null,this._externalTexture=i),n&&(this._samplerParameters=n)}get isLoaded(){return this._pendingCount===0}packIcons(e,s){if(!this._autoPacking||typeof document>"u")return;const i=Object.values(AS(e,s,this._mapping)||{});if(i.length>0){const{mapping:r,xOffset:n,yOffset:o,rowHeight:a,canvasHeight:c}=TS({icons:i,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=a,this._mapping=r,this._xOffset=n,this._yOffset=o,this._canvasHeight=c,this._texture||(this._texture=this.device.createTexture({format:"rgba8unorm",width:this._canvasWidth,height:this._canvasHeight,sampler:this._samplerParameters||pc,mipmaps:!0})),this._texture.height!==this._canvasHeight&&(this._texture=bS(this._texture,this._canvasWidth,this._canvasHeight,this._samplerParameters||pc)),this.onUpdate(),this._canvas=this._canvas||document.createElement("canvas"),this._loadIcons(i)}}_loadIcons(e){const s=this._canvas.getContext("2d",{willReadFrequently:!0});for(const i of e)this._pendingCount++,si(i.url,this._loadOptions).then(r=>{var _;const n=as(i),o=this._mapping[n],{x:a,y:c,width:l,height:h}=o,{image:u,width:f,height:p}=yS(s,r,l,h);(_=this._texture)==null||_.copyExternalImage({image:u,x:a+(l-f)/2,y:c+(h-p)/2,width:f,height:p}),o.width=f,o.height=p,this._texture.generateMipmap(),this.onUpdate()}).catch(r=>{this.onError({url:i.url,source:i.source,sourceIndex:i.sourceIndex,loadOptions:this._loadOptions,error:r})}).finally(()=>{this._pendingCount--})}}const ou=[0,0,0,255],SS={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:t=>t.position},getIcon:{type:"accessor",value:t=>t.icon},getColor:{type:"accessor",value:ou},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,optional:!0},textureParameters:{type:"object",ignore:!0,value:null}};class Xi extends Ce{getShaders(){return super.getShaders({vs:fS,fs:dS,modules:[Nt,kt,uS]})}initializeState(){this.state={iconManager:new wS(this.context.device,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})},this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:"uint8",accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getColor",defaultValue:ou},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState(e){var p;super.updateState(e);const{props:s,oldProps:i,changeFlags:r}=e,n=this.getAttributeManager(),{iconAtlas:o,iconMapping:a,data:c,getIcon:l,textureParameters:h}=s,{iconManager:u}=this.state;if(typeof o=="string")return;const f=o||this.internalState.isAsyncPropLoading("iconAtlas");u.setProps({loadOptions:s.loadOptions,autoPacking:!f,iconAtlas:o,iconMapping:f?a:null,textureParameters:h}),f?i.iconMapping!==s.iconMapping&&n.invalidate("getIcon"):(r.dataChanged||r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged.getIcon))&&u.packIcons(c,l),r.extensionsChanged&&((p=this.state.model)==null||p.destroy(),this.state.model=this._getModel(),n.invalidateAll())}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(e){super.finalizeState(e),this.state.iconManager.finalize()}draw({uniforms:e}){const{sizeScale:s,sizeMinPixels:i,sizeMaxPixels:r,sizeUnits:n,billboard:o,alphaCutoff:a}=this.props,{iconManager:c}=this.state,l=c.getTexture();if(l){const h=this.state.model,u={iconsTexture:l,iconsTextureDim:[l.width,l.height],sizeUnits:We[n],sizeScale:s,sizeMinPixels:i,sizeMaxPixels:r,billboard:o,alphaCutoff:a};h.shaderInputs.setProps({icon:u}),h.draw(this.context.renderPass)}}_getModel(){const e=[-1,-1,1,-1,-1,1,1,1];return new ue(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new It({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array(e)}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){var i;const s=(i=this.getCurrentLayer())==null?void 0:i.props.onIconError;s?s(e):U.error(e.error.message)()}getInstanceOffset(e){const{width:s,height:i,anchorX:r=s/2,anchorY:n=i/2}=this.state.iconManager.getIconMapping(e);return[s/2-r,i/2-n]}getInstanceColorMode(e){return this.state.iconManager.getIconMapping(e).mask?1:0}getInstanceIconFrame(e){const{x:s,y:i,width:r,height:n}=this.state.iconManager.getIconMapping(e);return[s,i,r,n]}}Xi.defaultProps=SS;Xi.layerName="IconLayer";const mc=`uniform scatterplotUniforms {
  float radiusScale;
  float radiusMinPixels;
  float radiusMaxPixels;
  float lineWidthScale;
  float lineWidthMinPixels;
  float lineWidthMaxPixels;
  float stroked;
  bool filled;
  bool antialiasing;
  bool billboard;
  highp int radiusUnits;
  highp int lineWidthUnits;
} scatterplot;
`,ES={name:"scatterplot",vs:mc,fs:mc,uniformTypes:{radiusScale:"f32",radiusMinPixels:"f32",radiusMaxPixels:"f32",lineWidthScale:"f32",lineWidthMinPixels:"f32",lineWidthMaxPixels:"f32",stroked:"f32",filled:"f32",antialiasing:"f32",billboard:"f32",radiusUnits:"i32",lineWidthUnits:"i32"}},vS=`#version 300 es
#define SHADER_NAME scatterplot-layer-vertex-shader

in vec3 positions;

in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceRadius;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;

out vec4 vFillColor;
out vec4 vLineColor;
out vec2 unitPosition;
out float innerUnitRadius;
out float outerRadiusPixels;


void main(void) {
  geometry.worldPosition = instancePositions;

  // Multiply out radius and clamp to limits
  outerRadiusPixels = clamp(
    project_size_to_pixel(scatterplot.radiusScale * instanceRadius, scatterplot.radiusUnits),
    scatterplot.radiusMinPixels, scatterplot.radiusMaxPixels
  );
  
  // Multiply out line width and clamp to limits
  float lineWidthPixels = clamp(
    project_size_to_pixel(scatterplot.lineWidthScale * instanceLineWidths, scatterplot.lineWidthUnits),
    scatterplot.lineWidthMinPixels, scatterplot.lineWidthMaxPixels
  );

  // outer radius needs to offset by half stroke width
  outerRadiusPixels += scatterplot.stroked * lineWidthPixels / 2.0;
  // Expand geometry to accomodate edge smoothing
  float edgePadding = scatterplot.antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;

  // position on the containing square in [-1, 1] space
  unitPosition = edgePadding * positions.xy;
  geometry.uv = unitPosition;
  geometry.pickingColor = instancePickingColors;

  innerUnitRadius = 1.0 - scatterplot.stroked * lineWidthPixels / outerRadiusPixels;
  
  if (scatterplot.billboard) {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
    vec3 offset = edgePadding * positions * outerRadiusPixels;
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
  } else {
    vec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);
    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  }

  // Apply opacity to instance color, or return instance picking color
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * layer.opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * layer.opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,RS=`#version 300 es
#define SHADER_NAME scatterplot-layer-fragment-shader

precision highp float;

in vec4 vFillColor;
in vec4 vLineColor;
in vec2 unitPosition;
in float innerUnitRadius;
in float outerRadiusPixels;

out vec4 fragColor;

void main(void) {
  geometry.uv = unitPosition;

  float distToCenter = length(unitPosition) * outerRadiusPixels;
  float inCircle = scatterplot.antialiasing ?
    smoothedge(distToCenter, outerRadiusPixels) : 
    step(distToCenter, outerRadiusPixels);

  if (inCircle == 0.0) {
    discard;
  }

  if (scatterplot.stroked > 0.5) {
    float isLine = scatterplot.antialiasing ? 
      smoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :
      step(innerUnitRadius * outerRadiusPixels, distToCenter);

    if (scatterplot.filled) {
      fragColor = mix(vFillColor, vLineColor, isLine);
    } else {
      if (isLine == 0.0) {
        discard;
      }
      fragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);
    }
  } else if (scatterplot.filled == false) {
    discard;
  } else {
    fragColor = vFillColor;
  }

  fragColor.a *= inCircle;
  DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,yc=[0,0,0,255],xS={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:t=>t.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:yc},getLineColor:{type:"accessor",value:yc},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}};class ro extends Ce{getShaders(){return super.getShaders({vs:vS,fs:RS,modules:[Nt,kt,ES]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){var s;super.updateState(e),e.changeFlags.extensionsChanged&&((s=this.state.model)==null||s.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){const{radiusUnits:s,radiusScale:i,radiusMinPixels:r,radiusMaxPixels:n,stroked:o,filled:a,billboard:c,antialiasing:l,lineWidthUnits:h,lineWidthScale:u,lineWidthMinPixels:f,lineWidthMaxPixels:p}=this.props,_={stroked:o,filled:a,billboard:c,antialiasing:l,radiusUnits:We[s],radiusScale:i,radiusMinPixels:r,radiusMaxPixels:n,lineWidthUnits:We[h],lineWidthScale:u,lineWidthMinPixels:f,lineWidthMaxPixels:p},m=this.state.model;m.shaderInputs.setProps({scatterplot:_}),m.draw(this.context.renderPass)}_getModel(){const e=[-1,-1,0,1,-1,0,-1,1,0,1,1,0];return new ue(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new It({topology:"triangle-strip",attributes:{positions:{size:3,value:new Float32Array(e)}}}),isInstanced:!0})}}ro.defaultProps=xS;ro.layerName="ScatterplotLayer";const au={CLOCKWISE:1,COUNTER_CLOCKWISE:-1};function cu(t,e,s={}){return PS(t,s)!==e?(IS(t,s),!0):!1}function PS(t,e={}){return Math.sign(CS(t,e))}const bc={x:0,y:1,z:2};function CS(t,e={}){const{start:s=0,end:i=t.length,plane:r="xy"}=e,n=e.size||2;let o=0;const a=bc[r[0]],c=bc[r[1]];for(let l=s,h=i-n;l<i;l+=n)o+=(t[l+a]-t[h+a])*(t[l+c]+t[h+c]),h=l;return o/2}function IS(t,e){const{start:s=0,end:i=t.length,size:r=2}=e,n=(i-s)/r,o=Math.floor(n/2);for(let a=0;a<o;++a){const c=s+a*r,l=s+(n-1-a)*r;for(let h=0;h<r;++h){const u=t[c+h];t[c+h]=t[l+h],t[l+h]=u}}}function _e(t,e){const s=e.length,i=t.length;if(i>0){let r=!0;for(let n=0;n<s;n++)if(t[i-s+n]!==e[n]){r=!1;break}if(r)return!1}for(let r=0;r<s;r++)t[i+r]=e[r];return!0}function Rn(t,e){const s=e.length;for(let i=0;i<s;i++)t[i]=e[i]}function cs(t,e,s,i,r=[]){const n=i+e*s;for(let o=0;o<s;o++)r[o]=t[n+o];return r}function xn(t,e,s,i,r=[]){let n,o;if(s&8)n=(i[3]-t[1])/(e[1]-t[1]),o=3;else if(s&4)n=(i[1]-t[1])/(e[1]-t[1]),o=1;else if(s&2)n=(i[2]-t[0])/(e[0]-t[0]),o=2;else if(s&1)n=(i[0]-t[0])/(e[0]-t[0]),o=0;else return null;for(let a=0;a<t.length;a++)r[a]=(o&1)===a?i[o]:n*(e[a]-t[a])+t[a];return r}function Ks(t,e){let s=0;return t[0]<e[0]?s|=1:t[0]>e[2]&&(s|=2),t[1]<e[1]?s|=4:t[1]>e[3]&&(s|=8),s}function lu(t,e){const{size:s=2,broken:i=!1,gridResolution:r=10,gridOffset:n=[0,0],startIndex:o=0,endIndex:a=t.length}=e||{},c=(a-o)/s;let l=[];const h=[l],u=cs(t,0,s,o);let f,p;const _=uu(u,r,n,[]),m=[];_e(l,u);for(let T=1;T<c;T++){for(f=cs(t,T,s,o,f),p=Ks(f,_);p;){xn(u,f,p,_,m);const S=Ks(m,_);S&&(xn(u,m,S,_,m),p=S),_e(l,m),Rn(u,m),OS(_,r,p),i&&l.length>s&&(l=[],h.push(l),_e(l,u)),p=Ks(f,_)}_e(l,f),Rn(u,f)}return i?h:h[0]}const Tc=0,MS=1;function hu(t,e=null,s){if(!t.length)return[];const{size:i=2,gridResolution:r=10,gridOffset:n=[0,0],edgeTypes:o=!1}=s||{},a=[],c=[{pos:t,types:o?new Array(t.length/i).fill(MS):null,holes:e||[]}],l=[[],[]];let h=[];for(;c.length;){const{pos:u,types:f,holes:p}=c.shift();NS(u,i,p[0]||u.length,l),h=uu(l[0],r,n,h);const _=Ks(l[1],h);if(_){let m=Ac(u,f,i,0,p[0]||u.length,h,_);const T={pos:m[0].pos,types:m[0].types,holes:[]},S={pos:m[1].pos,types:m[1].types,holes:[]};c.push(T,S);for(let v=0;v<p.length;v++)m=Ac(u,f,i,p[v],p[v+1]||u.length,h,_),m[0]&&(T.holes.push(T.pos.length),T.pos=Bs(T.pos,m[0].pos),o&&(T.types=Bs(T.types,m[0].types))),m[1]&&(S.holes.push(S.pos.length),S.pos=Bs(S.pos,m[1].pos),o&&(S.types=Bs(S.types,m[1].types)))}else{const m={positions:u};o&&(m.edgeTypes=f),p.length&&(m.holeIndices=p),a.push(m)}}return a}function Ac(t,e,s,i,r,n,o){const a=(r-i)/s,c=[],l=[],h=[],u=[],f=[];let p,_,m;const T=cs(t,a-1,s,i);let S=Math.sign(o&8?T[1]-n[3]:T[0]-n[2]),v=e&&e[a-1],w=0,E=0;for(let R=0;R<a;R++)p=cs(t,R,s,i,p),_=Math.sign(o&8?p[1]-n[3]:p[0]-n[2]),m=e&&e[i/s+R],_&&S&&S!==_&&(xn(T,p,o,n,f),_e(c,f)&&h.push(v),_e(l,f)&&u.push(v)),_<=0?(_e(c,p)&&h.push(m),w-=_):h.length&&(h[h.length-1]=Tc),_>=0?(_e(l,p)&&u.push(m),E+=_):u.length&&(u[u.length-1]=Tc),Rn(T,p),S=_,v=m;return[w?{pos:c,types:e&&h}:null,E?{pos:l,types:e&&u}:null]}function uu(t,e,s,i){const r=Math.floor((t[0]-s[0])/e)*e+s[0],n=Math.floor((t[1]-s[1])/e)*e+s[1];return i[0]=r,i[1]=n,i[2]=r+e,i[3]=n+e,i}function OS(t,e,s){s&8?(t[1]+=e,t[3]+=e):s&4?(t[1]-=e,t[3]-=e):s&2?(t[0]+=e,t[2]+=e):s&1&&(t[0]-=e,t[2]-=e)}function NS(t,e,s,i){let r=1/0,n=-1/0,o=1/0,a=-1/0;for(let c=0;c<s;c+=e){const l=t[c],h=t[c+1];r=l<r?l:r,n=l>n?l:n,o=h<o?h:o,a=h>a?h:a}return i[0][0]=r,i[0][1]=o,i[1][0]=n,i[1][1]=a,i}function Bs(t,e){for(let s=0;s<e.length;s++)t.push(e[s]);return t}const kS=85.051129;function FS(t,e){const{size:s=2,startIndex:i=0,endIndex:r=t.length,normalize:n=!0}=e||{},o=t.slice(i,r);fu(o,s,0,r-i);const a=lu(o,{size:s,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(n)for(const c of a)du(c,s);return a}function DS(t,e=null,s){const{size:i=2,normalize:r=!0,edgeTypes:n=!1}=s||{};e=e||[];const o=[],a=[];let c=0,l=0;for(let u=0;u<=e.length;u++){const f=e[u]||t.length,p=l,_=BS(t,i,c,f);for(let m=_;m<f;m++)o[l++]=t[m];for(let m=c;m<_;m++)o[l++]=t[m];fu(o,i,p,l),US(o,i,p,l,s==null?void 0:s.maxLatitude),c=f,a[u]=l}a.pop();const h=hu(o,a,{size:i,gridResolution:360,gridOffset:[-180,-180],edgeTypes:n});if(r)for(const u of h)du(u.positions,i);return h}function BS(t,e,s,i){let r=-1,n=-1;for(let o=s+1;o<i;o+=e){const a=Math.abs(t[o]);a>r&&(r=a,n=o-1)}return n}function US(t,e,s,i,r=kS){const n=t[s],o=t[i-e];if(Math.abs(n-o)>180){const a=cs(t,0,e,s);a[0]+=Math.round((o-n)/360)*360,_e(t,a),a[1]=Math.sign(a[1])*r,_e(t,a),a[0]=n,_e(t,a)}}function fu(t,e,s,i){let r=t[0],n;for(let o=s;o<i;o+=e){n=t[o];const a=n-r;(a>180||a<-180)&&(n-=Math.round(a/360)*360),t[o]=r=n}}function du(t,e){let s;const i=t.length/e;for(let n=0;n<i&&(s=t[n*e],(s+180)%360===0);n++);const r=-Math.round(s/360)*360;if(r!==0)for(let n=0;n<i;n++)t[n*e]+=r}function LS(t,e,s,i){let r;if(Array.isArray(t[0])){const n=t.length*e;r=new Array(n);for(let o=0;o<t.length;o++)for(let a=0;a<e;a++)r[o*e+a]=t[o][a]||0}else r=t;return s?lu(r,{size:e,gridResolution:s}):i?FS(r,{size:e}):r}const VS=1,zS=2,Cr=4;class WS extends nu{constructor(e){super({...e,attributes:{positions:{size:3,padding:18,initialize:!0,type:e.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}get(e){return this.attributes[e]}getGeometryFromBuffer(e){return this.normalize?super.getGeometryFromBuffer(e):null}normalizeGeometry(e){return this.normalize?LS(e,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):e}getGeometrySize(e){if(wc(e)){let i=0;for(const r of e)i+=this.getGeometrySize(r);return i}const s=this.getPathLength(e);return s<2?0:this.isClosed(e)?s<3?0:s+2:s}updateGeometryAttributes(e,s){if(s.geometrySize!==0)if(e&&wc(e))for(const i of e){const r=this.getGeometrySize(i);s.geometrySize=r,this.updateGeometryAttributes(i,s),s.vertexStart+=r}else this._updateSegmentTypes(e,s),this._updatePositions(e,s)}_updateSegmentTypes(e,s){const i=this.attributes.segmentTypes,r=e?this.isClosed(e):!1,{vertexStart:n,geometrySize:o}=s;i.fill(0,n,n+o),r?(i[n]=Cr,i[n+o-2]=Cr):(i[n]+=VS,i[n+o-2]+=zS),i[n+o-1]=Cr}_updatePositions(e,s){const{positions:i}=this.attributes;if(!i||!e)return;const{vertexStart:r,geometrySize:n}=s,o=new Array(3);for(let a=r,c=0;c<n;a++,c++)this.getPointOnPath(e,c,o),i[a*3]=o[0],i[a*3+1]=o[1],i[a*3+2]=o[2]}getPathLength(e){return e.length/this.positionSize}getPointOnPath(e,s,i=[]){const{positionSize:r}=this;s*r>=e.length&&(s+=1-e.length/r);const n=s*r;return i[0]=e[n],i[1]=e[n+1],i[2]=r===3&&e[n+2]||0,i}isClosed(e){if(!this.normalize)return!!this.opts.loop;const{positionSize:s}=this,i=e.length-s;return e[0]===e[i]&&e[1]===e[i+1]&&(s===2||e[2]===e[i+2])}}function wc(t){return Array.isArray(t[0])}const Sc=`uniform pathUniforms {
  float widthScale;
  float widthMinPixels;
  float widthMaxPixels;
  float jointType;
  float capType;
  float miterLimit;
  bool billboard;
  highp int widthUnits;
} path;
`,HS={name:"path",vs:Sc,fs:Sc,uniformTypes:{widthScale:"f32",widthMinPixels:"f32",widthMaxPixels:"f32",jointType:"f32",capType:"f32",miterLimit:"f32",billboard:"f32",widthUnits:"i32"}},jS=`#version 300 es
#define SHADER_NAME path-layer-vertex-shader

in vec2 positions;

in float instanceTypes;
in vec3 instanceStartPositions;
in vec3 instanceEndPositions;
in vec3 instanceLeftPositions;
in vec3 instanceRightPositions;
in vec3 instanceLeftPositions64Low;
in vec3 instanceStartPositions64Low;
in vec3 instanceEndPositions64Low;
in vec3 instanceRightPositions64Low;
in float instanceStrokeWidths;
in vec4 instanceColors;
in vec3 instancePickingColors;

uniform float opacity;

out vec4 vColor;
out vec2 vCornerOffset;
out float vMiterLength;
out vec2 vPathPosition;
out float vPathLength;
out float vJointType;

const float EPSILON = 0.001;
const vec3 ZERO_OFFSET = vec3(0.0);

float flipIfTrue(bool flag) {
  return -(float(flag) * 2. - 1.);
}

// calculate line join positions
vec3 getLineJoinOffset(
  vec3 prevPoint, vec3 currPoint, vec3 nextPoint,
  vec2 width
) {
  bool isEnd = positions.x > 0.0;
  // side of the segment - -1: left, 0: center, 1: right
  float sideOfPath = positions.y;
  float isJoint = float(sideOfPath == 0.0);

  vec3 deltaA3 = (currPoint - prevPoint);
  vec3 deltaB3 = (nextPoint - currPoint);

  mat3 rotationMatrix;
  bool needsRotation = !path.billboard && project_needs_rotation(currPoint, rotationMatrix);
  if (needsRotation) {
    deltaA3 = deltaA3 * rotationMatrix;
    deltaB3 = deltaB3 * rotationMatrix;
  }
  vec2 deltaA = deltaA3.xy / width;
  vec2 deltaB = deltaB3.xy / width;

  float lenA = length(deltaA);
  float lenB = length(deltaB);

  vec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);
  vec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);

  vec2 perpA = vec2(-dirA.y, dirA.x);
  vec2 perpB = vec2(-dirB.y, dirB.x);

  // tangent of the corner
  vec2 tangent = dirA + dirB;
  tangent = length(tangent) > 0. ? normalize(tangent) : perpA;
  // direction of the corner
  vec2 miterVec = vec2(-tangent.y, tangent.x);
  // direction of the segment
  vec2 dir = isEnd ? dirA : dirB;
  // direction of the extrusion
  vec2 perp = isEnd ? perpA : perpB;
  // length of the segment
  float L = isEnd ? lenA : lenB;

  // A = angle of the corner
  float sinHalfA = abs(dot(miterVec, perp));
  float cosHalfA = abs(dot(dirA, miterVec));

  // -1: right, 1: left
  float turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);

  // relative position to the corner:
  // -1: inside (smaller side of the angle)
  // 0: center
  // 1: outside (bigger side of the angle)
  float cornerPosition = sideOfPath * turnDirection;

  float miterSize = 1.0 / max(sinHalfA, EPSILON);
  // trim if inside corner extends further than the line segment
  miterSize = mix(
    min(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),
    miterSize,
    step(0.0, cornerPosition)
  );

  vec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))
    * (sideOfPath + isJoint * turnDirection);

  // special treatment for start cap and end cap
  bool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));
  bool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));
  bool isCap = isStartCap || isEndCap;

  // extend out a triangle to envelope the round cap
  if (isCap) {
    offsetVec = mix(perp * sideOfPath, dir * path.capType * 4.0 * flipIfTrue(isStartCap), isJoint);
    vJointType = path.capType;
  } else {
    vJointType = path.jointType;
  }

  // Generate variables for fragment shader
  vPathLength = L;
  vCornerOffset = offsetVec;
  vMiterLength = dot(vCornerOffset, miterVec * turnDirection);
  vMiterLength = isCap ? isJoint : vMiterLength;

  vec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);
  vPathPosition = vec2(
    dot(offsetFromStartOfPath, perp),
    dot(offsetFromStartOfPath, dir)
  );
  geometry.uv = vPathPosition;

  float isValid = step(instanceTypes, 3.5);
  vec3 offset = vec3(offsetVec * width * isValid, 0.0);

  if (needsRotation) {
    offset = rotationMatrix * offset;
  }
  return offset;
}

// In clipspace extrusion, if a line extends behind the camera, clip it to avoid visual artifacts
void clipLine(inout vec4 position, vec4 refPosition) {
  if (position.w < EPSILON) {
    float r = (EPSILON - refPosition.w) / (position.w - refPosition.w);
    position = refPosition + (position - refPosition) * r;
  }
}

void main() {
  geometry.pickingColor = instancePickingColors;

  vColor = vec4(instanceColors.rgb, instanceColors.a * layer.opacity);

  float isEnd = positions.x;

  vec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);
  vec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);

  vec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);
  vec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);

  vec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);
  vec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);

  geometry.worldPosition = currPosition;
  vec2 widthPixels = vec2(clamp(
    project_size_to_pixel(instanceStrokeWidths * path.widthScale, path.widthUnits),
    path.widthMinPixels, path.widthMaxPixels) / 2.0);
  vec3 width;

  if (path.billboard) {
    // Extrude in clipspace
    vec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);
    vec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);
    vec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);

    clipLine(prevPositionScreen, currPositionScreen);
    clipLine(nextPositionScreen, currPositionScreen);
    clipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));

    width = vec3(widthPixels, 0.0);
    DECKGL_FILTER_SIZE(width, geometry);

    vec3 offset = getLineJoinOffset(
      prevPositionScreen.xyz / prevPositionScreen.w,
      currPositionScreen.xyz / currPositionScreen.w,
      nextPositionScreen.xyz / nextPositionScreen.w,
      project_pixel_size_to_clipspace(width.xy)
    );

    DECKGL_FILTER_GL_POSITION(currPositionScreen, geometry);
    gl_Position = vec4(currPositionScreen.xyz + offset * currPositionScreen.w, currPositionScreen.w);
  } else {
    // Extrude in commonspace
    prevPosition = project_position(prevPosition, prevPosition64Low);
    currPosition = project_position(currPosition, currPosition64Low);
    nextPosition = project_position(nextPosition, nextPosition64Low);

    width = vec3(project_pixel_size(widthPixels), 0.0);
    DECKGL_FILTER_SIZE(width, geometry);

    vec3 offset = getLineJoinOffset(prevPosition, currPosition, nextPosition, width.xy);
    geometry.position = vec4(currPosition + offset, 1.0);
    gl_Position = project_common_position_to_clipspace(geometry.position);
    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  }
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`,$S=`#version 300 es
#define SHADER_NAME path-layer-fragment-shader

precision highp float;

in vec4 vColor;
in vec2 vCornerOffset;
in float vMiterLength;
/*
 * vPathPosition represents the relative coordinates of the current fragment on the path segment.
 * vPathPosition.x - position along the width of the path, between [-1, 1]. 0 is the center line.
 * vPathPosition.y - position along the length of the path, between [0, L / width].
 */
in vec2 vPathPosition;
in float vPathLength;
in float vJointType;

out vec4 fragColor;

void main(void) {
  geometry.uv = vPathPosition;

  if (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {
    // if joint is rounded, test distance from the corner
    if (vJointType > 0.5 && length(vCornerOffset) > 1.0) {
      discard;
    }
    // trim miter
    if (vJointType < 0.5 && vMiterLength > path.miterLimit + 1.0) {
      discard;
    }
  }
  fragColor = vColor;

  DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,gu=[0,0,0,255],XS={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:t=>t.path},getColor:{type:"accessor",value:gu},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},Ir={enter:(t,e)=>e.length?e.subarray(e.length-t.length):t};class no extends Ce{getShaders(){return super.getShaders({vs:jS,fs:$S,modules:[Nt,kt,HS]})}get wrapLongitude(){return!1}getBounds(){var e;return(e=this.getAttributeManager())==null?void 0:e.getBounds(["vertexPositions"])}initializeState(){this.getAttributeManager().addInstanced({vertexPositions:{size:3,vertexOffset:1,type:"float64",fp64:this.use64bitPositions(),transition:Ir,accessor:"getPath",update:this.calculatePositions,noAlloc:!0,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:"uint8",update:this.calculateSegmentTypes,noAlloc:!0},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:Ir,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",accessor:"getColor",transition:Ir,defaultValue:gu},instancePickingColors:{size:4,type:"uint8",accessor:(i,{index:r,target:n})=>this.encodePickingColor(i&&i.__source?i.__source.index:r,n)}}),this.setState({pathTesselator:new WS({fp64:this.use64bitPositions()})})}updateState(e){var o;super.updateState(e);const{props:s,changeFlags:i}=e,r=this.getAttributeManager();if(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPath)){const{pathTesselator:a}=this.state,c=s.data.attributes||{};a.updateGeometry({data:s.data,geometryBuffer:c.getPath,buffers:c,normalize:!s._pathType,loop:s._pathType==="loop",getGeometry:s.getPath,positionFormat:s.positionFormat,wrapLongitude:s.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:i.dataChanged}),this.setState({numInstances:a.instanceCount,startIndices:a.vertexStarts}),i.dataChanged||r.invalidateAll()}i.extensionsChanged&&((o=this.state.model)==null||o.destroy(),this.state.model=this._getModel(),r.invalidateAll())}getPickingInfo(e){const s=super.getPickingInfo(e),{index:i}=s,r=this.props.data;return r[0]&&r[0].__source&&(s.object=r.find(n=>n.__source.index===i)),s}disablePickingIndex(e){const s=this.props.data;if(s[0]&&s[0].__source)for(let i=0;i<s.length;i++)s[i].__source.index===e&&this._disablePickingIndex(i);else super.disablePickingIndex(e)}draw({uniforms:e}){const{jointRounded:s,capRounded:i,billboard:r,miterLimit:n,widthUnits:o,widthScale:a,widthMinPixels:c,widthMaxPixels:l}=this.props,h=this.state.model,u={jointType:Number(s),capType:Number(i),billboard:r,widthUnits:We[o],widthScale:a,miterLimit:n,widthMinPixels:c,widthMaxPixels:l};h.shaderInputs.setProps({path:u}),h.draw(this.context.renderPass)}_getModel(){const e=[0,1,2,1,4,2,1,3,4,3,5,4],s=[0,0,0,-1,0,1,1,-1,1,1,1,0];return new ue(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new It({topology:"triangle-list",attributes:{indices:new Uint16Array(e),positions:{value:new Float32Array(s),size:2}}}),isInstanced:!0})}calculatePositions(e){const{pathTesselator:s}=this.state;e.startIndices=s.vertexStarts,e.value=s.get("positions")}calculateSegmentTypes(e){const{pathTesselator:s}=this.state;e.startIndices=s.vertexStarts,e.value=s.get("segmentTypes")}}no.defaultProps=XS;no.layerName="PathLayer";function YS(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var oo={exports:{}};oo.exports=Yi;oo.exports.default=Yi;function Yi(t,e,s){s=s||2;var i=e&&e.length,r=i?e[0]*s:t.length,n=pu(t,0,r,s,!0),o=[];if(!n||n.next===n.prev)return o;var a,c,l,h,u,f,p;if(i&&(n=QS(t,e,n,s)),t.length>80*s){a=l=t[0],c=h=t[1];for(var _=s;_<r;_+=s)u=t[_],f=t[_+1],u<a&&(a=u),f<c&&(c=f),u>l&&(l=u),f>h&&(h=f);p=Math.max(l-a,h-c),p=p!==0?32767/p:0}return ls(n,o,s,a,c,p,0),o}function pu(t,e,s,i,r){var n,o;if(r===In(t,e,s,i)>0)for(n=e;n<s;n+=i)o=Ec(n,t[n],t[n+1],o);else for(n=s-i;n>=e;n-=i)o=Ec(n,t[n],t[n+1],o);return o&&Ki(o,o.next)&&(us(o),o=o.next),o}function tt(t,e){if(!t)return t;e||(e=t);var s=t,i;do if(i=!1,!s.steiner&&(Ki(s,s.next)||X(s.prev,s,s.next)===0)){if(us(s),s=e=s.prev,s===s.next)break;i=!0}else s=s.next;while(i||s!==e);return e}function ls(t,e,s,i,r,n,o){if(t){!o&&n&&iE(t,i,r,n);for(var a=t,c,l;t.prev!==t.next;){if(c=t.prev,l=t.next,n?qS(t,i,r,n):KS(t)){e.push(c.i/s|0),e.push(t.i/s|0),e.push(l.i/s|0),us(t),t=l.next,a=l.next;continue}if(t=l,t===a){o?o===1?(t=ZS(tt(t),e,s),ls(t,e,s,i,r,n,2)):o===2&&JS(t,e,s,i,r,n):ls(tt(t),e,s,i,r,n,1);break}}}}function KS(t){var e=t.prev,s=t,i=t.next;if(X(e,s,i)>=0)return!1;for(var r=e.x,n=s.x,o=i.x,a=e.y,c=s.y,l=i.y,h=r<n?r<o?r:o:n<o?n:o,u=a<c?a<l?a:l:c<l?c:l,f=r>n?r>o?r:o:n>o?n:o,p=a>c?a>l?a:l:c>l?c:l,_=i.next;_!==e;){if(_.x>=h&&_.x<=f&&_.y>=u&&_.y<=p&&yt(r,a,n,c,o,l,_.x,_.y)&&X(_.prev,_,_.next)>=0)return!1;_=_.next}return!0}function qS(t,e,s,i){var r=t.prev,n=t,o=t.next;if(X(r,n,o)>=0)return!1;for(var a=r.x,c=n.x,l=o.x,h=r.y,u=n.y,f=o.y,p=a<c?a<l?a:l:c<l?c:l,_=h<u?h<f?h:f:u<f?u:f,m=a>c?a>l?a:l:c>l?c:l,T=h>u?h>f?h:f:u>f?u:f,S=Pn(p,_,e,s,i),v=Pn(m,T,e,s,i),w=t.prevZ,E=t.nextZ;w&&w.z>=S&&E&&E.z<=v;){if(w.x>=p&&w.x<=m&&w.y>=_&&w.y<=T&&w!==r&&w!==o&&yt(a,h,c,u,l,f,w.x,w.y)&&X(w.prev,w,w.next)>=0||(w=w.prevZ,E.x>=p&&E.x<=m&&E.y>=_&&E.y<=T&&E!==r&&E!==o&&yt(a,h,c,u,l,f,E.x,E.y)&&X(E.prev,E,E.next)>=0))return!1;E=E.nextZ}for(;w&&w.z>=S;){if(w.x>=p&&w.x<=m&&w.y>=_&&w.y<=T&&w!==r&&w!==o&&yt(a,h,c,u,l,f,w.x,w.y)&&X(w.prev,w,w.next)>=0)return!1;w=w.prevZ}for(;E&&E.z<=v;){if(E.x>=p&&E.x<=m&&E.y>=_&&E.y<=T&&E!==r&&E!==o&&yt(a,h,c,u,l,f,E.x,E.y)&&X(E.prev,E,E.next)>=0)return!1;E=E.nextZ}return!0}function ZS(t,e,s){var i=t;do{var r=i.prev,n=i.next.next;!Ki(r,n)&&_u(r,i,i.next,n)&&hs(r,n)&&hs(n,r)&&(e.push(r.i/s|0),e.push(i.i/s|0),e.push(n.i/s|0),us(i),us(i.next),i=t=n),i=i.next}while(i!==t);return tt(i)}function JS(t,e,s,i,r,n){var o=t;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&oE(o,a)){var c=mu(o,a);o=tt(o,o.next),c=tt(c,c.next),ls(o,e,s,i,r,n,0),ls(c,e,s,i,r,n,0);return}a=a.next}o=o.next}while(o!==t)}function QS(t,e,s,i){var r=[],n,o,a,c,l;for(n=0,o=e.length;n<o;n++)a=e[n]*i,c=n<o-1?e[n+1]*i:t.length,l=pu(t,a,c,i,!1),l===l.next&&(l.steiner=!0),r.push(nE(l));for(r.sort(GS),n=0;n<r.length;n++)s=eE(r[n],s);return s}function GS(t,e){return t.x-e.x}function eE(t,e){var s=tE(t,e);if(!s)return e;var i=mu(s,t);return tt(i,i.next),tt(s,s.next)}function tE(t,e){var s=e,i=t.x,r=t.y,n=-1/0,o;do{if(r<=s.y&&r>=s.next.y&&s.next.y!==s.y){var a=s.x+(r-s.y)*(s.next.x-s.x)/(s.next.y-s.y);if(a<=i&&a>n&&(n=a,o=s.x<s.next.x?s:s.next,a===i))return o}s=s.next}while(s!==e);if(!o)return null;var c=o,l=o.x,h=o.y,u=1/0,f;s=o;do i>=s.x&&s.x>=l&&i!==s.x&&yt(r<h?i:n,r,l,h,r<h?n:i,r,s.x,s.y)&&(f=Math.abs(r-s.y)/(i-s.x),hs(s,t)&&(f<u||f===u&&(s.x>o.x||s.x===o.x&&sE(o,s)))&&(o=s,u=f)),s=s.next;while(s!==c);return o}function sE(t,e){return X(t.prev,t,e.prev)<0&&X(e.next,t,t.next)<0}function iE(t,e,s,i){var r=t;do r.z===0&&(r.z=Pn(r.x,r.y,e,s,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next;while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,rE(r)}function rE(t){var e,s,i,r,n,o,a,c,l=1;do{for(s=t,t=null,n=null,o=0;s;){for(o++,i=s,a=0,e=0;e<l&&(a++,i=i.nextZ,!!i);e++);for(c=l;a>0||c>0&&i;)a!==0&&(c===0||!i||s.z<=i.z)?(r=s,s=s.nextZ,a--):(r=i,i=i.nextZ,c--),n?n.nextZ=r:t=r,r.prevZ=n,n=r;s=i}n.nextZ=null,l*=2}while(o>1);return t}function Pn(t,e,s,i,r){return t=(t-s)*r|0,e=(e-i)*r|0,t=(t|t<<8)&16711935,t=(t|t<<4)&252645135,t=(t|t<<2)&858993459,t=(t|t<<1)&1431655765,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,t|e<<1}function nE(t){var e=t,s=t;do(e.x<s.x||e.x===s.x&&e.y<s.y)&&(s=e),e=e.next;while(e!==t);return s}function yt(t,e,s,i,r,n,o,a){return(r-o)*(e-a)>=(t-o)*(n-a)&&(t-o)*(i-a)>=(s-o)*(e-a)&&(s-o)*(n-a)>=(r-o)*(i-a)}function oE(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!aE(t,e)&&(hs(t,e)&&hs(e,t)&&cE(t,e)&&(X(t.prev,t,e.prev)||X(t,e.prev,e))||Ki(t,e)&&X(t.prev,t,t.next)>0&&X(e.prev,e,e.next)>0)}function X(t,e,s){return(e.y-t.y)*(s.x-e.x)-(e.x-t.x)*(s.y-e.y)}function Ki(t,e){return t.x===e.x&&t.y===e.y}function _u(t,e,s,i){var r=Ls(X(t,e,s)),n=Ls(X(t,e,i)),o=Ls(X(s,i,t)),a=Ls(X(s,i,e));return!!(r!==n&&o!==a||r===0&&Us(t,s,e)||n===0&&Us(t,i,e)||o===0&&Us(s,t,i)||a===0&&Us(s,e,i))}function Us(t,e,s){return e.x<=Math.max(t.x,s.x)&&e.x>=Math.min(t.x,s.x)&&e.y<=Math.max(t.y,s.y)&&e.y>=Math.min(t.y,s.y)}function Ls(t){return t>0?1:t<0?-1:0}function aE(t,e){var s=t;do{if(s.i!==t.i&&s.next.i!==t.i&&s.i!==e.i&&s.next.i!==e.i&&_u(s,s.next,t,e))return!0;s=s.next}while(s!==t);return!1}function hs(t,e){return X(t.prev,t,t.next)<0?X(t,e,t.next)>=0&&X(t,t.prev,e)>=0:X(t,e,t.prev)<0||X(t,t.next,e)<0}function cE(t,e){var s=t,i=!1,r=(t.x+e.x)/2,n=(t.y+e.y)/2;do s.y>n!=s.next.y>n&&s.next.y!==s.y&&r<(s.next.x-s.x)*(n-s.y)/(s.next.y-s.y)+s.x&&(i=!i),s=s.next;while(s!==t);return i}function mu(t,e){var s=new Cn(t.i,t.x,t.y),i=new Cn(e.i,e.x,e.y),r=t.next,n=e.prev;return t.next=e,e.prev=t,s.next=r,r.prev=s,i.next=s,s.prev=i,n.next=i,i.prev=n,i}function Ec(t,e,s,i){var r=new Cn(t,e,s);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function us(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Cn(t,e,s){this.i=t,this.x=e,this.y=s,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}Yi.deviation=function(t,e,s,i){var r=e&&e.length,n=r?e[0]*s:t.length,o=Math.abs(In(t,0,n,s));if(r)for(var a=0,c=e.length;a<c;a++){var l=e[a]*s,h=a<c-1?e[a+1]*s:t.length;o-=Math.abs(In(t,l,h,s))}var u=0;for(a=0;a<i.length;a+=3){var f=i[a]*s,p=i[a+1]*s,_=i[a+2]*s;u+=Math.abs((t[f]-t[_])*(t[p+1]-t[f+1])-(t[f]-t[p])*(t[_+1]-t[f+1]))}return o===0&&u===0?0:Math.abs((u-o)/o)};function In(t,e,s,i){for(var r=0,n=e,o=s-i;n<s;n+=i)r+=(t[o]-t[n])*(t[n+1]+t[o+1]),o=n;return r}Yi.flatten=function(t){for(var e=t[0][0].length,s={vertices:[],holes:[],dimensions:e},i=0,r=0;r<t.length;r++){for(var n=0;n<t[r].length;n++)for(var o=0;o<e;o++)s.vertices.push(t[r][n][o]);r>0&&(i+=t[r-1].length,s.holes.push(i))}return s};var lE=oo.exports;const hE=YS(lE),Vs=au.CLOCKWISE,vc=au.COUNTER_CLOCKWISE,Le={isClosed:!0};function uE(t){if(t=t&&t.positions||t,!Array.isArray(t)&&!ArrayBuffer.isView(t))throw new Error("invalid polygon")}function Yt(t){return"positions"in t?t.positions:t}function qs(t){return"holeIndices"in t?t.holeIndices:null}function fE(t){return Array.isArray(t[0])}function dE(t){return t.length>=1&&t[0].length>=2&&Number.isFinite(t[0][0])}function gE(t){const e=t[0],s=t[t.length-1];return e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2]}function pE(t,e,s,i){for(let r=0;r<e;r++)if(t[s+r]!==t[i-e+r])return!1;return!0}function Rc(t,e,s,i,r){let n=e;const o=s.length;for(let a=0;a<o;a++)for(let c=0;c<i;c++)t[n++]=s[a][c]||0;if(!gE(s))for(let a=0;a<i;a++)t[n++]=s[0][a]||0;return Le.start=e,Le.end=n,Le.size=i,cu(t,r,Le),n}function xc(t,e,s,i,r=0,n,o){n=n||s.length;const a=n-r;if(a<=0)return e;let c=e;for(let l=0;l<a;l++)t[c++]=s[r+l];if(!pE(s,i,r,n))for(let l=0;l<i;l++)t[c++]=s[r+l];return Le.start=e,Le.end=c,Le.size=i,cu(t,o,Le),c}function _E(t,e){uE(t);const s=[],i=[];if("positions"in t){const{positions:r,holeIndices:n}=t;if(n){let o=0;for(let a=0;a<=n.length;a++)o=xc(s,o,r,e,n[a-1],n[a],a===0?Vs:vc),i.push(o);return i.pop(),{positions:s,holeIndices:i}}t=r}if(!fE(t))return xc(s,0,t,e,0,s.length,Vs),s;if(!dE(t)){let r=0;for(const[n,o]of t.entries())r=Rc(s,r,o,e,n===0?Vs:vc),i.push(r);return i.pop(),{positions:s,holeIndices:i}}return Rc(s,0,t,e,Vs),s}function Mr(t,e,s){const i=t.length/3;let r=0;for(let n=0;n<i;n++){const o=(n+1)%i;r+=t[n*3+e]*t[o*3+s],r-=t[o*3+e]*t[n*3+s]}return Math.abs(r/2)}function Pc(t,e,s,i){const r=t.length/3;for(let n=0;n<r;n++){const o=n*3,a=t[o+0],c=t[o+1],l=t[o+2];t[o+e]=a,t[o+s]=c,t[o+i]=l}}function mE(t,e,s,i){let r=qs(t);r&&(r=r.map(a=>a/e));let n=Yt(t);const o=i&&e===3;if(s){const a=n.length;n=n.slice();const c=[];for(let l=0;l<a;l+=e){c[0]=n[l],c[1]=n[l+1],o&&(c[2]=n[l+2]);const h=s(c);n[l]=h[0],n[l+1]=h[1],o&&(n[l+2]=h[2])}}if(o){const a=Mr(n,0,1),c=Mr(n,0,2),l=Mr(n,1,2);if(!a&&!c&&!l)return[];a>c&&a>l||(c>l?(s||(n=n.slice()),Pc(n,0,2,1)):(s||(n=n.slice()),Pc(n,2,0,1)))}return hE(n,r,e)}class yE extends nu{constructor(e){const{fp64:s,IndexType:i=Uint32Array}=e;super({...e,attributes:{positions:{size:3,type:s?Float64Array:Float32Array},vertexValid:{type:Uint16Array,size:1},indices:{type:i,size:1}}})}get(e){const{attributes:s}=this;return e==="indices"?s.indices&&s.indices.subarray(0,this.vertexCount):s[e]}updateGeometry(e){super.updateGeometry(e);const s=this.buffers.indices;if(s)this.vertexCount=(s.value||s).length;else if(this.data&&!this.getGeometry)throw new Error("missing indices buffer")}normalizeGeometry(e){if(this.normalize){const s=_E(e,this.positionSize);return this.opts.resolution?hu(Yt(s),qs(s),{size:this.positionSize,gridResolution:this.opts.resolution,edgeTypes:!0}):this.opts.wrapLongitude?DS(Yt(s),qs(s),{size:this.positionSize,maxLatitude:86,edgeTypes:!0}):s}return e}getGeometrySize(e){if(Cc(e)){let s=0;for(const i of e)s+=this.getGeometrySize(i);return s}return Yt(e).length/this.positionSize}getGeometryFromBuffer(e){return this.normalize||!this.buffers.indices?super.getGeometryFromBuffer(e):null}updateGeometryAttributes(e,s){if(e&&Cc(e))for(const i of e){const r=this.getGeometrySize(i);s.geometrySize=r,this.updateGeometryAttributes(i,s),s.vertexStart+=r,s.indexStart=this.indexStarts[s.geometryIndex+1]}else{const i=e;this._updateIndices(i,s),this._updatePositions(i,s),this._updateVertexValid(i,s)}}_updateIndices(e,{geometryIndex:s,vertexStart:i,indexStart:r}){const{attributes:n,indexStarts:o,typedArrayManager:a}=this;let c=n.indices;if(!c||!e)return;let l=r;const h=mE(e,this.positionSize,this.opts.preproject,this.opts.full3d);c=a.allocate(c,r+h.length,{copy:!0});for(let u=0;u<h.length;u++)c[l++]=h[u]+i;o[s+1]=r+h.length,n.indices=c}_updatePositions(e,{vertexStart:s,geometrySize:i}){const{attributes:{positions:r},positionSize:n}=this;if(!r||!e)return;const o=Yt(e);for(let a=s,c=0;c<i;a++,c++){const l=o[c*n],h=o[c*n+1],u=n>2?o[c*n+2]:0;r[a*3]=l,r[a*3+1]=h,r[a*3+2]=u}}_updateVertexValid(e,{vertexStart:s,geometrySize:i}){const{positionSize:r}=this,n=this.attributes.vertexValid,o=e&&qs(e);if(e&&e.edgeTypes?n.set(e.edgeTypes,s):n.fill(1,s,s+i),o)for(let a=0;a<o.length;a++)n[s+o[a]/r-1]=0;n[s+i-1]=0}}function Cc(t){return Array.isArray(t)&&t.length>0&&!Number.isFinite(t[0])}const Ic=`uniform solidPolygonUniforms {
  bool extruded;
  bool isWireframe;
  float elevationScale;
} solidPolygon;
`,bE={name:"solidPolygon",vs:Ic,fs:Ic,uniformTypes:{extruded:"f32",isWireframe:"f32",elevationScale:"f32"}},yu=`
in vec4 fillColors;
in vec4 lineColors;
in vec3 pickingColors;

out vec4 vColor;

struct PolygonProps {
  vec3 positions;
  vec3 positions64Low;
  vec3 normal;
  float elevations;
};

vec3 project_offset_normal(vec3 vector) {
  if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
    project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSETS) {
    // normals generated by the polygon tesselator are in lnglat offsets instead of meters
    return normalize(vector * project.commonUnitsPerWorldUnit);
  }
  return project_normal(vector);
}

void calculatePosition(PolygonProps props) {
  vec3 pos = props.positions;
  vec3 pos64Low = props.positions64Low;
  vec3 normal = props.normal;
  vec4 colors = solidPolygon.isWireframe ? lineColors : fillColors;

  geometry.worldPosition = props.positions;
  geometry.pickingColor = pickingColors;

  if (solidPolygon.extruded) {
    pos.z += props.elevations * solidPolygon.elevationScale;
  }
  gl_Position = project_position_to_clipspace(pos, pos64Low, vec3(0.), geometry.position);

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  if (solidPolygon.extruded) {
  #ifdef IS_SIDE_VERTEX
    normal = project_offset_normal(normal);
  #else
    normal = project_normal(normal);
  #endif
    geometry.normal = normal;
    vec3 lightColor = lighting_getLightColor(colors.rgb, project.cameraPosition, geometry.position.xyz, geometry.normal);
    vColor = vec4(lightColor, colors.a * layer.opacity);
  } else {
    vColor = vec4(colors.rgb, colors.a * layer.opacity);
  }
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`,TE=`#version 300 es
#define SHADER_NAME solid-polygon-layer-vertex-shader

in vec3 vertexPositions;
in vec3 vertexPositions64Low;
in float elevations;

${yu}

void main(void) {
  PolygonProps props;

  props.positions = vertexPositions;
  props.positions64Low = vertexPositions64Low;
  props.elevations = elevations;
  props.normal = vec3(0.0, 0.0, 1.0);

  calculatePosition(props);
}
`,AE=`#version 300 es
#define SHADER_NAME solid-polygon-layer-vertex-shader-side
#define IS_SIDE_VERTEX

in vec2 positions;

in vec3 vertexPositions;
in vec3 nextVertexPositions;
in vec3 vertexPositions64Low;
in vec3 nextVertexPositions64Low;
in float elevations;
in float instanceVertexValid;

${yu}

void main(void) {
  if(instanceVertexValid < 0.5){
    gl_Position = vec4(0.);
    return;
  }

  PolygonProps props;

  vec3 pos;
  vec3 pos64Low;
  vec3 nextPos;
  vec3 nextPos64Low;

  #if RING_WINDING_ORDER_CW == 1
    pos = vertexPositions;
    pos64Low = vertexPositions64Low;
    nextPos = nextVertexPositions;
    nextPos64Low = nextVertexPositions64Low;
  #else
    pos = nextVertexPositions;
    pos64Low = nextVertexPositions64Low;
    nextPos = vertexPositions;
    nextPos64Low = vertexPositions64Low;
  #endif

  props.positions = mix(pos, nextPos, positions.x);
  props.positions64Low = mix(pos64Low, nextPos64Low, positions.x);

  props.normal = vec3(
    pos.y - nextPos.y + (pos64Low.y - nextPos64Low.y),
    nextPos.x - pos.x + (nextPos64Low.x - pos64Low.x),
    0.0);

  props.elevations = elevations * positions.y;

  calculatePosition(props);
}
`,wE=`#version 300 es
#define SHADER_NAME solid-polygon-layer-fragment-shader

precision highp float;

in vec4 vColor;

out vec4 fragColor;

void main(void) {
  fragColor = vColor;
  // Fails to compile on some Android devices if geometry is never assigned (#8411)
  geometry.uv = vec2(0.);

  DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,Si=[0,0,0,255],SE={filled:!0,extruded:!1,wireframe:!1,_normalize:!0,_windingOrder:"CW",_full3d:!1,elevationScale:{type:"number",min:0,value:1},getPolygon:{type:"accessor",value:t=>t.polygon},getElevation:{type:"accessor",value:1e3},getFillColor:{type:"accessor",value:Si},getLineColor:{type:"accessor",value:Si},material:!0},zs={enter:(t,e)=>e.length?e.subarray(e.length-t.length):t};class ao extends Ce{getShaders(e){return super.getShaders({vs:e==="top"?TE:AE,fs:wE,defines:{RING_WINDING_ORDER_CW:!this.props._normalize&&this.props._windingOrder==="CCW"?0:1},modules:[Nt,Zl,kt,bE]})}get wrapLongitude(){return!1}getBounds(){var e;return(e=this.getAttributeManager())==null?void 0:e.getBounds(["vertexPositions"])}initializeState(){const{viewport:e}=this.context;let{coordinateSystem:s}=this.props;const{_full3d:i}=this.props;e.isGeospatial&&s===L.DEFAULT&&(s=L.LNGLAT);let r;s===L.LNGLAT&&(i?r=e.projectPosition.bind(e):r=e.projectFlat.bind(e)),this.setState({numInstances:0,polygonTesselator:new yE({preproject:r,fp64:this.use64bitPositions(),IndexType:Uint32Array})});const n=this.getAttributeManager(),o=!0;n.remove(["instancePickingColors"]),n.add({indices:{size:1,isIndexed:!0,update:this.calculateIndices,noAlloc:o},vertexPositions:{size:3,type:"float64",stepMode:"dynamic",fp64:this.use64bitPositions(),transition:zs,accessor:"getPolygon",update:this.calculatePositions,noAlloc:o,shaderAttributes:{nextVertexPositions:{vertexOffset:1}}},instanceVertexValid:{size:1,type:"uint16",stepMode:"instance",update:this.calculateVertexValid,noAlloc:o},elevations:{size:1,stepMode:"dynamic",transition:zs,accessor:"getElevation"},fillColors:{size:this.props.colorFormat.length,type:"unorm8",stepMode:"dynamic",transition:zs,accessor:"getFillColor",defaultValue:Si},lineColors:{size:this.props.colorFormat.length,type:"unorm8",stepMode:"dynamic",transition:zs,accessor:"getLineColor",defaultValue:Si},pickingColors:{size:4,type:"uint8",stepMode:"dynamic",accessor:(a,{index:c,target:l})=>this.encodePickingColor(a&&a.__source?a.__source.index:c,l)}})}getPickingInfo(e){const s=super.getPickingInfo(e),{index:i}=s,r=this.props.data;return r[0]&&r[0].__source&&(s.object=r.find(n=>n.__source.index===i)),s}disablePickingIndex(e){const s=this.props.data;if(s[0]&&s[0].__source)for(let i=0;i<s.length;i++)s[i].__source.index===e&&this._disablePickingIndex(i);else super.disablePickingIndex(e)}draw({uniforms:e}){const{extruded:s,filled:i,wireframe:r,elevationScale:n}=this.props,{topModel:o,sideModel:a,wireframeModel:c,polygonTesselator:l}=this.state,h={extruded:!!s,elevationScale:n,isWireframe:!1};c&&r&&(c.setInstanceCount(l.instanceCount-1),c.shaderInputs.setProps({solidPolygon:{...h,isWireframe:!0}}),c.draw(this.context.renderPass)),a&&i&&(a.setInstanceCount(l.instanceCount-1),a.shaderInputs.setProps({solidPolygon:h}),a.draw(this.context.renderPass)),o&&i&&(o.setVertexCount(l.vertexCount),o.shaderInputs.setProps({solidPolygon:h}),o.draw(this.context.renderPass))}updateState(e){var a;super.updateState(e),this.updateGeometry(e);const{props:s,oldProps:i,changeFlags:r}=e,n=this.getAttributeManager();(r.extensionsChanged||s.filled!==i.filled||s.extruded!==i.extruded)&&((a=this.state.models)==null||a.forEach(c=>c.destroy()),this.setState(this._getModels()),n.invalidateAll())}updateGeometry({props:e,oldProps:s,changeFlags:i}){if(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPolygon)){const{polygonTesselator:n}=this.state,o=e.data.attributes||{};n.updateGeometry({data:e.data,normalize:e._normalize,geometryBuffer:o.getPolygon,buffers:o,getGeometry:e.getPolygon,positionFormat:e.positionFormat,wrapLongitude:e.wrapLongitude,resolution:this.context.viewport.resolution,fp64:this.use64bitPositions(),dataChanged:i.dataChanged,full3d:e._full3d}),this.setState({numInstances:n.instanceCount,startIndices:n.vertexStarts}),i.dataChanged||this.getAttributeManager().invalidateAll()}}_getModels(){const{id:e,filled:s,extruded:i}=this.props;let r,n,o;if(s){const a=this.getShaders("top");a.defines.NON_INSTANCED_MODEL=1;const c=this.getAttributeManager().getBufferLayouts({isInstanced:!1});r=new ue(this.context.device,{...a,id:`${e}-top`,topology:"triangle-list",bufferLayout:c,isIndexed:!0,userData:{excludeAttributes:{instanceVertexValid:!0}}})}if(i){const a=this.getAttributeManager().getBufferLayouts({isInstanced:!0});n=new ue(this.context.device,{...this.getShaders("side"),id:`${e}-side`,bufferLayout:a,geometry:new It({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array([1,0,0,0,1,1,0,1])}}}),isInstanced:!0,userData:{excludeAttributes:{indices:!0}}}),o=new ue(this.context.device,{...this.getShaders("side"),id:`${e}-wireframe`,bufferLayout:a,geometry:new It({topology:"line-strip",attributes:{positions:{size:2,value:new Float32Array([1,0,0,0,0,1,1,1])}}}),isInstanced:!0,userData:{excludeAttributes:{indices:!0}}})}return{models:[n,o,r].filter(Boolean),topModel:r,sideModel:n,wireframeModel:o}}calculateIndices(e){const{polygonTesselator:s}=this.state;e.startIndices=s.indexStarts,e.value=s.get("indices")}calculatePositions(e){const{polygonTesselator:s}=this.state;e.startIndices=s.vertexStarts,e.value=s.get("positions")}calculateVertexValid(e){e.value=this.state.polygonTesselator.get("vertexValid")}}ao.defaultProps=SE;ao.layerName="SolidPolygonLayer";function EE({data:t,getIndex:e,dataRange:s,replace:i}){const{startRow:r=0,endRow:n=1/0}=s,o=t.length;let a=o,c=o;for(let f=0;f<o;f++){const p=e(t[f]);if(a>f&&p>=r&&(a=f),p>=n){c=f;break}}let l=a;const u=c-a!==i.length?t.slice(c):void 0;for(let f=0;f<i.length;f++)t[l++]=i[f];if(u){for(let f=0;f<u.length;f++)t[l++]=u[f];t.length=l}return{startRow:a,endRow:a+i.length}}function vE(t,e){if(!t)return null;const s="startIndices"in t?t.startIndices[e]:e,i=t.featureIds.value[s];return s!==-1?RE(t,i,s):null}function RE(t,e,s){const i={properties:{...t.properties[e]}};for(const r in t.numericProps)i.properties[r]=t.numericProps[r].value[s];return i}function xE(t,e){const s={points:null,lines:null,polygons:null};for(const i in s){const r=t[i].globalFeatureIds.value;s[i]=new Uint8ClampedArray(r.length*3);const n=[];for(let o=0;o<r.length;o++)e(r[o],n),s[i][o*3+0]=n[0],s[i][o*3+1]=n[1],s[i][o*3+2]=n[2]}return s}const Mc=`uniform sdfUniforms {
  float gamma;
  bool enabled;
  float buffer;
  float outlineBuffer;
  vec4 outlineColor;
} sdf;
`,PE={name:"sdf",vs:Mc,fs:Mc,uniformTypes:{gamma:"f32",enabled:"f32",buffer:"f32",outlineBuffer:"f32",outlineColor:"vec4<f32>"}},CE=`#version 300 es
#define SHADER_NAME multi-icon-layer-fragment-shader

precision highp float;

uniform sampler2D iconsTexture;

in vec4 vColor;
in vec2 vTextureCoords;
in vec2 uv;

out vec4 fragColor;

void main(void) {
  geometry.uv = uv;

  if (!bool(picking.isActive)) {
    float alpha = texture(iconsTexture, vTextureCoords).a;
    vec4 color = vColor;

    // if enable sdf (signed distance fields)
    if (sdf.enabled) {
      float distance = alpha;
      alpha = smoothstep(sdf.buffer - sdf.gamma, sdf.buffer + sdf.gamma, distance);

      if (sdf.outlineBuffer > 0.0) {
        float inFill = alpha;
        float inBorder = smoothstep(sdf.outlineBuffer - sdf.gamma, sdf.outlineBuffer + sdf.gamma, distance);
        color = mix(sdf.outlineColor, vColor, inFill);
        alpha = inBorder;
      }
    }

    // Take the global opacity and the alpha from color into account for the alpha component
    float a = alpha * color.a;
    
    if (a < icon.alphaCutoff) {
      discard;
    }

    fragColor = vec4(color.rgb, a * layer.opacity);
  }

  DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,Or=192/256,Oc=[],IE={getIconOffsets:{type:"accessor",value:t=>t.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}};class co extends Xi{getShaders(){const e=super.getShaders();return{...e,modules:[...e.modules,PE],fs:CE}}initializeState(){super.initializeState(),this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:"uint8",size:3,accessor:(s,{index:i,target:r})=>this.encodePickingColor(i,r)}})}updateState(e){super.updateState(e);const{props:s,oldProps:i}=e;let{outlineColor:r}=s;r!==i.outlineColor&&(r=r.map(n=>n/255),r[3]=Number.isFinite(r[3])?r[3]:1,this.setState({outlineColor:r})),!s.sdf&&s.outlineWidth&&U.warn(`${this.id}: fontSettings.sdf is required to render outline`)()}draw(e){const{sdf:s,smoothing:i,outlineWidth:r}=this.props,{outlineColor:n}=this.state,o=r?Math.max(i,Or*(1-r)):-1,a=this.state.model,c={buffer:Or,outlineBuffer:o,gamma:i,enabled:!!s,outlineColor:n};if(a.shaderInputs.setProps({sdf:c}),super.draw(e),s&&r){const{iconManager:l}=this.state;l.getTexture()&&(a.shaderInputs.setProps({sdf:{...c,outlineBuffer:Or}}),a.draw(this.context.renderPass))}}getInstanceOffset(e){return e?Array.from(e).flatMap(s=>super.getInstanceOffset(s)):Oc}getInstanceColorMode(e){return 1}getInstanceIconFrame(e){return e?Array.from(e).flatMap(s=>super.getInstanceIconFrame(s)):Oc}}co.defaultProps=IE;co.layerName="MultiIconLayer";const es=1e20;class ME{constructor({fontSize:e=24,buffer:s=3,radius:i=8,cutoff:r=.25,fontFamily:n="sans-serif",fontWeight:o="normal",fontStyle:a="normal"}={}){this.buffer=s,this.cutoff=r,this.radius=i;const c=this.size=e+s*4,l=this._createCanvas(c),h=this.ctx=l.getContext("2d",{willReadFrequently:!0});h.font=`${a} ${o} ${e}px ${n}`,h.textBaseline="alphabetic",h.textAlign="left",h.fillStyle="black",this.gridOuter=new Float64Array(c*c),this.gridInner=new Float64Array(c*c),this.f=new Float64Array(c),this.z=new Float64Array(c+1),this.v=new Uint16Array(c)}_createCanvas(e){const s=document.createElement("canvas");return s.width=s.height=e,s}draw(e){const{width:s,actualBoundingBoxAscent:i,actualBoundingBoxDescent:r,actualBoundingBoxLeft:n,actualBoundingBoxRight:o}=this.ctx.measureText(e),a=Math.ceil(i),c=0,l=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(o-n))),h=Math.min(this.size-this.buffer,a+Math.ceil(r)),u=l+2*this.buffer,f=h+2*this.buffer,p=Math.max(u*f,0),_=new Uint8ClampedArray(p),m={data:_,width:u,height:f,glyphWidth:l,glyphHeight:h,glyphTop:a,glyphLeft:c,glyphAdvance:s};if(l===0||h===0)return m;const{ctx:T,buffer:S,gridInner:v,gridOuter:w}=this;T.clearRect(S,S,l,h),T.fillText(e,S,S+a);const E=T.getImageData(S,S,l,h);w.fill(es,0,p),v.fill(0,0,p);for(let R=0;R<h;R++)for(let P=0;P<l;P++){const M=E.data[4*(R*l+P)+3]/255;if(M===0)continue;const C=(R+S)*u+P+S;if(M===1)w[C]=0,v[C]=es;else{const I=.5-M;w[C]=I>0?I*I:0,v[C]=I<0?I*I:0}}Nc(w,0,0,u,f,u,this.f,this.v,this.z),Nc(v,S,S,l,h,u,this.f,this.v,this.z);for(let R=0;R<p;R++){const P=Math.sqrt(w[R])-Math.sqrt(v[R]);_[R]=Math.round(255-255*(P/this.radius+this.cutoff))}return m}}function Nc(t,e,s,i,r,n,o,a,c){for(let l=e;l<e+i;l++)kc(t,s*n+l,n,r,o,a,c);for(let l=s;l<s+r;l++)kc(t,l*n+e,1,i,o,a,c)}function kc(t,e,s,i,r,n,o){n[0]=0,o[0]=-es,o[1]=es,r[0]=t[e];for(let a=1,c=0,l=0;a<i;a++){r[a]=t[e+a*s];const h=a*a;do{const u=n[c];l=(r[a]-r[u]+h-u*u)/(a-u)/2}while(l<=o[c]&&--c>-1);c++,n[c]=a,o[c]=l,o[c+1]=es}for(let a=0,c=0;a<i;a++){for(;o[c+1]<a;)c++;const l=n[c],h=a-l;t[e+a*s]=r[l]+h*h}}const OE=32,NE=[];function kE(t){return Math.pow(2,Math.ceil(Math.log2(t)))}function FE({characterSet:t,getFontWidth:e,fontHeight:s,buffer:i,maxCanvasWidth:r,mapping:n={},xOffset:o=0,yOffset:a=0}){let c=0,l=o;const h=s+i*2;for(const u of t)if(!n[u]){const f=e(u);l+f+i*2>r&&(l=0,c++),n[u]={x:l+i,y:a+c*h+i,width:f,height:h,layoutWidth:f,layoutHeight:s},l+=f+i*2}return{mapping:n,xOffset:l,yOffset:a+c*h,canvasHeight:kE(a+(c+1)*h)}}function bu(t,e,s,i){var n;let r=0;for(let o=e;o<s;o++){const a=t[o];r+=((n=i[a])==null?void 0:n.layoutWidth)||0}return r}function Tu(t,e,s,i,r,n){let o=e,a=0;for(let c=e;c<s;c++){const l=bu(t,c,c+1,r);a+l>i&&(o<c&&n.push(c),o=c,a=0),a+=l}return a}function DE(t,e,s,i,r,n){let o=e,a=e,c=e,l=0;for(let h=e;h<s;h++)if((t[h]===" "||t[h+1]===" "||h+1===s)&&(c=h+1),c>a){let u=bu(t,a,c,r);l+u>i&&(o<a&&(n.push(a),o=a,l=0),u>i&&(u=Tu(t,a,c,i,r,n),o=n[n.length-1])),a=c,l+=u}return l}function BE(t,e,s,i,r=0,n){n===void 0&&(n=t.length);const o=[];return e==="break-all"?Tu(t,r,n,s,i,o):DE(t,r,n,s,i,o),o}function UE(t,e,s,i,r,n){let o=0,a=0;for(let c=e;c<s;c++){const l=t[c],h=i[l];h?(a||(a=h.layoutHeight),r[c]=o+h.layoutWidth/2,o+=h.layoutWidth):(U.warn(`Missing character: ${l} (${l.codePointAt(0)})`)(),r[c]=o,o+=OE)}n[0]=o,n[1]=a}function LE(t,e,s,i,r){var T;const n=Array.from(t),o=n.length,a=new Array(o),c=new Array(o),l=new Array(o),h=(s==="break-word"||s==="break-all")&&isFinite(i)&&i>0,u=[0,0],f=[0,0];let p=0,_=0,m=0;for(let S=0;S<=o;S++){const v=n[S];if((v===`
`||S===o)&&(m=S),m>_){const w=h?BE(n,s,i,r,_,m):NE;for(let E=0;E<=w.length;E++){const R=E===0?_:w[E-1],P=E<w.length?w[E]:m;UE(n,R,P,r,a,f);for(let M=R;M<P;M++){const C=n[M],I=((T=r[C])==null?void 0:T.layoutOffsetY)||0;c[M]=p+f[1]/2+I,l[M]=f[0]}p=p+f[1]*e,u[0]=Math.max(u[0],f[0])}_=m}v===`
`&&(a[_]=0,c[_]=0,l[_]=0,_++)}return u[1]=p,{x:a,y:c,rowWidth:l,size:u}}function VE({value:t,length:e,stride:s,offset:i,startIndices:r,characterSet:n}){const o=t.BYTES_PER_ELEMENT,a=s?s/o:1,c=i?i/o:0,l=r[e]||Math.ceil((t.length-c)/a),h=n&&new Set,u=new Array(e);let f=t;if(a>1||c>0){const p=t.constructor;f=new p(l);for(let _=0;_<l;_++)f[_]=t[_*a+c]}for(let p=0;p<e;p++){const _=r[p],m=r[p+1]||l,T=f.subarray(_,m);u[p]=String.fromCodePoint.apply(null,T),h&&T.forEach(h.add,h)}if(h)for(const p of h)n.add(String.fromCodePoint(p));return{texts:u,characterCount:l}}class Au{constructor(e=5){this._cache={},this._order=[],this.limit=e}get(e){const s=this._cache[e];return s&&(this._deleteOrder(e),this._appendOrder(e)),s}set(e,s){this._cache[e]?(this.delete(e),this._cache[e]=s,this._appendOrder(e)):(Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[e]=s,this._appendOrder(e))}delete(e){this._cache[e]&&(delete this._cache[e],this._deleteOrder(e))}_deleteOrder(e){const s=this._order.indexOf(e);s>=0&&this._order.splice(s,1)}_appendOrder(e){this._order.push(e)}}function zE(){const t=[];for(let e=32;e<128;e++)t.push(String.fromCharCode(e));return t}const wt={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:zE(),fontSize:64,buffer:4,sdf:!1,cutoff:.25,radius:12,smoothing:.1},Fc=1024,Dc=.9,Bc=1.2,wu=3;let Ei=new Au(wu);function WE(t,e){let s;typeof e=="string"?s=new Set(Array.from(e)):s=new Set(e);const i=Ei.get(t);if(!i)return s;for(const r in i.mapping)s.has(r)&&s.delete(r);return s}function HE(t,e){for(let s=0;s<t.length;s++)e.data[4*s+3]=t[s]}function Uc(t,e,s,i){t.font=`${i} ${s}px ${e}`,t.fillStyle="#000",t.textBaseline="alphabetic",t.textAlign="left"}function jE(t){U.assert(Number.isFinite(t)&&t>=wu,"Invalid cache limit"),Ei=new Au(t)}class $E{constructor(){this.props={...wt}}get atlas(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){const{fontSize:e,buffer:s}=this.props;return(e*Bc+s*2)/e}setProps(e={}){Object.assign(this.props,e),this._key=this._getKey();const s=WE(this._key,this.props.characterSet),i=Ei.get(this._key);if(i&&s.size===0){this._atlas!==i&&(this._atlas=i);return}const r=this._generateFontAtlas(s,i);this._atlas=r,Ei.set(this._key,r)}_generateFontAtlas(e,s){const{fontFamily:i,fontWeight:r,fontSize:n,buffer:o,sdf:a,radius:c,cutoff:l}=this.props;let h=s&&s.data;h||(h=document.createElement("canvas"),h.width=Fc);const u=h.getContext("2d",{willReadFrequently:!0});Uc(u,i,n,r);const{mapping:f,canvasHeight:p,xOffset:_,yOffset:m}=FE({getFontWidth:T=>u.measureText(T).width,fontHeight:n*Bc,buffer:o,characterSet:e,maxCanvasWidth:Fc,...s&&{mapping:s.mapping,xOffset:s.xOffset,yOffset:s.yOffset}});if(h.height!==p){const T=u.getImageData(0,0,h.width,h.height);h.height=p,u.putImageData(T,0,0)}if(Uc(u,i,n,r),a){const T=new ME({fontSize:n,buffer:o,radius:c,cutoff:l,fontFamily:i,fontWeight:`${r}`});for(const S of e){const{data:v,width:w,height:E,glyphTop:R}=T.draw(S);f[S].width=w,f[S].layoutOffsetY=n*Dc-R;const P=u.createImageData(w,E);HE(v,P),u.putImageData(P,f[S].x,f[S].y)}}else for(const T of e)u.fillText(T,f[T].x,f[T].y+o+n*Dc);return{xOffset:_,yOffset:m,mapping:f,data:h,width:h.width,height:h.height}}_getKey(){const{fontFamily:e,fontWeight:s,fontSize:i,buffer:r,sdf:n,radius:o,cutoff:a}=this.props;return n?`${e} ${s} ${i} ${r} ${o} ${a}`:`${e} ${s} ${i} ${r}`}}const Lc=`uniform textBackgroundUniforms {
  bool billboard;
  float sizeScale;
  float sizeMinPixels;
  float sizeMaxPixels;
  vec4 padding;
  highp int sizeUnits;
  bool stroked;
} textBackground;
`,XE={name:"textBackground",vs:Lc,fs:Lc,uniformTypes:{billboard:"f32",sizeScale:"f32",sizeMinPixels:"f32",sizeMaxPixels:"f32",padding:"vec4<f32>",sizeUnits:"i32",stroked:"f32"}},YE=`#version 300 es
#define SHADER_NAME text-background-layer-vertex-shader

in vec2 positions;

in vec3 instancePositions;
in vec3 instancePositions64Low;
in vec4 instanceRects;
in float instanceSizes;
in float instanceAngles;
in vec2 instancePixelOffsets;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;

out vec4 vFillColor;
out vec4 vLineColor;
out float vLineWidth;
out vec2 uv;
out vec2 dimensions;

vec2 rotate_by_angle(vec2 vertex, float angle) {
  float angle_radian = radians(angle);
  float cos_angle = cos(angle_radian);
  float sin_angle = sin(angle_radian);
  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
  return rotationMatrix * vertex;
}

void main(void) {
  geometry.worldPosition = instancePositions;
  geometry.uv = positions;
  geometry.pickingColor = instancePickingColors;
  uv = positions;
  vLineWidth = instanceLineWidths;

  // convert size in meters to pixels, then scaled and clamp

  // project meters to pixels and clamp to limits
  float sizePixels = clamp(
    project_size_to_pixel(instanceSizes * textBackground.sizeScale, textBackground.sizeUnits),
    textBackground.sizeMinPixels, textBackground.sizeMaxPixels
  );

  dimensions = instanceRects.zw * sizePixels + textBackground.padding.xy + textBackground.padding.zw;

  vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-textBackground.padding.xy, textBackground.padding.zw, positions);
  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);
  pixelOffset += instancePixelOffsets;
  pixelOffset.y *= -1.0;

  if (textBackground.billboard)  {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
    vec3 offset = vec3(pixelOffset, 0.0);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
  } else {
    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
    DECKGL_FILTER_SIZE(offset_common, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  }

  // Apply opacity to instance color, or return instance picking color
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * layer.opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * layer.opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,KE=`#version 300 es
#define SHADER_NAME text-background-layer-fragment-shader

precision highp float;

in vec4 vFillColor;
in vec4 vLineColor;
in float vLineWidth;
in vec2 uv;
in vec2 dimensions;

out vec4 fragColor;

void main(void) {
  geometry.uv = uv;

  vec2 pixelPosition = uv * dimensions;
  if (textBackground.stroked) {
    float distToEdge = min(
      min(pixelPosition.x, dimensions.x - pixelPosition.x),
      min(pixelPosition.y, dimensions.y - pixelPosition.y)
    );
    float isBorder = smoothedge(distToEdge, vLineWidth);
    fragColor = mix(vFillColor, vLineColor, isBorder);
  } else {
    fragColor = vFillColor;
  }

  DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,qE={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:t=>t.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}};class lo extends Ce{getShaders(){return super.getShaders({vs:YE,fs:KE,modules:[Nt,kt,XE]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){var i;super.updateState(e);const{changeFlags:s}=e;s.extensionsChanged&&((i=this.state.model)==null||i.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){const{billboard:s,sizeScale:i,sizeUnits:r,sizeMinPixels:n,sizeMaxPixels:o,getLineWidth:a}=this.props;let{padding:c}=this.props;c.length<4&&(c=[c[0],c[1],c[0],c[1]]);const l=this.state.model,h={billboard:s,stroked:!!a,padding:c,sizeUnits:We[r],sizeScale:i,sizeMinPixels:n,sizeMaxPixels:o};l.shaderInputs.setProps({textBackground:h}),l.draw(this.context.renderPass)}_getModel(){const e=[0,0,1,0,0,1,1,1];return new ue(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new It({topology:"triangle-strip",vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(e)}}}),isInstanced:!0})}}lo.defaultProps=qE;lo.layerName="TextBackgroundLayer";const Vc={start:1,middle:0,end:-1},zc={top:1,center:0,bottom:-1},Nr=[0,0,0,255],ZE=1,JE={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:Nr},getBorderWidth:{type:"accessor",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:wt.characterSet},fontFamily:wt.fontFamily,fontWeight:wt.fontWeight,lineHeight:ZE,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:Nr},fontSettings:{type:"object",value:{},compare:1},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:t=>t.text},getPosition:{type:"accessor",value:t=>t.position},getColor:{type:"accessor",value:Nr},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}};class ho extends so{constructor(){super(...arguments),this.getBoundingRect=(e,s)=>{let{size:[i,r]}=this.transformParagraph(e,s);const{fontSize:n}=this.state.fontAtlasManager.props;i/=n,r/=n;const{getTextAnchor:o,getAlignmentBaseline:a}=this.props,c=Vc[typeof o=="function"?o(e,s):o],l=zc[typeof a=="function"?a(e,s):a];return[(c-1)*i/2,(l-1)*r/2,i,r]},this.getIconOffsets=(e,s)=>{const{getTextAnchor:i,getAlignmentBaseline:r}=this.props,{x:n,y:o,rowWidth:a,size:[c,l]}=this.transformParagraph(e,s),h=Vc[typeof i=="function"?i(e,s):i],u=zc[typeof r=="function"?r(e,s):r],f=n.length,p=new Array(f*2);let _=0;for(let m=0;m<f;m++){const T=(1-h)*(c-a[m])/2;p[_++]=(h-1)*c/2+T+n[m],p[_++]=(u-1)*l/2+o[m]}return p}}initializeState(){this.state={styleVersion:0,fontAtlasManager:new $E},this.props.maxWidth>0&&U.warn("v8.9 breaking change: TextLayer maxWidth is now relative to text size")()}updateState(e){const{props:s,oldProps:i,changeFlags:r}=e;(r.dataChanged||r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged.getText))&&this._updateText(),(this._updateFontAtlas()||s.lineHeight!==i.lineHeight||s.wordBreak!==i.wordBreak||s.maxWidth!==i.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:e}){return e.object=e.index>=0?this.props.data[e.index]:null,e}_updateFontAtlas(){const{fontSettings:e,fontFamily:s,fontWeight:i}=this.props,{fontAtlasManager:r,characterSet:n}=this.state,o={...e,characterSet:n,fontFamily:s,fontWeight:i};if(!r.mapping)return r.setProps(o),!0;for(const a in o)if(o[a]!==r.props[a])return r.setProps(o),!0;return!1}_updateText(){var c;const{data:e,characterSet:s}=this.props,i=(c=e.attributes)==null?void 0:c.getText;let{getText:r}=this.props,n=e.startIndices,o;const a=s==="auto"&&new Set;if(i&&n){const{texts:l,characterCount:h}=VE({...ArrayBuffer.isView(i)?{value:i}:i,length:e.length,startIndices:n,characterSet:a});o=h,r=(u,{index:f})=>l[f]}else{const{iterable:l,objectInfo:h}=$i(e);n=[0],o=0;for(const u of l){h.index++;const f=Array.from(r(u,h)||"");a&&f.forEach(a.add,a),o+=f.length,n.push(o)}}this.setState({getText:r,startIndices:n,numInstances:o,characterSet:a||s})}transformParagraph(e,s){const{fontAtlasManager:i}=this.state,r=i.mapping,n=this.state.getText,{wordBreak:o,lineHeight:a,maxWidth:c}=this.props,l=n(e,s)||"";return LE(l,a,o,c*i.props.fontSize,r)}renderLayers(){const{startIndices:e,numInstances:s,getText:i,fontAtlasManager:{scale:r,atlas:n,mapping:o},styleVersion:a}=this.state,{data:c,_dataDiff:l,getPosition:h,getColor:u,getSize:f,getAngle:p,getPixelOffset:_,getBackgroundColor:m,getBorderColor:T,getBorderWidth:S,backgroundPadding:v,background:w,billboard:E,fontSettings:R,outlineWidth:P,outlineColor:M,sizeScale:C,sizeUnits:I,sizeMinPixels:k,sizeMaxPixels:O,transitions:F,updateTriggers:D}=this.props,B=this.getSubLayerClass("characters",co),le=this.getSubLayerClass("background",lo);return[w&&new le({getFillColor:m,getLineColor:T,getLineWidth:S,padding:v,getPosition:h,getSize:f,getAngle:p,getPixelOffset:_,billboard:E,sizeScale:C,sizeUnits:I,sizeMinPixels:k,sizeMaxPixels:O,transitions:F&&{getPosition:F.getPosition,getAngle:F.getAngle,getSize:F.getSize,getFillColor:F.getBackgroundColor,getLineColor:F.getBorderColor,getLineWidth:F.getBorderWidth,getPixelOffset:F.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:D.getPosition,getAngle:D.getAngle,getSize:D.getSize,getFillColor:D.getBackgroundColor,getLineColor:D.getBorderColor,getLineWidth:D.getBorderWidth,getPixelOffset:D.getPixelOffset,getBoundingRect:{getText:D.getText,getTextAnchor:D.getTextAnchor,getAlignmentBaseline:D.getAlignmentBaseline,styleVersion:a}}}),{data:c.attributes&&c.attributes.background?{length:c.length,attributes:c.attributes.background}:c,_dataDiff:l,autoHighlight:!1,getBoundingRect:this.getBoundingRect}),new B({sdf:R.sdf,smoothing:Number.isFinite(R.smoothing)?R.smoothing:wt.smoothing,outlineWidth:P/(R.radius||wt.radius),outlineColor:M,iconAtlas:n,iconMapping:o,getPosition:h,getColor:u,getSize:f,getAngle:p,getPixelOffset:_,billboard:E,sizeScale:C*r,sizeUnits:I,sizeMinPixels:k*r,sizeMaxPixels:O*r,transitions:F&&{getPosition:F.getPosition,getAngle:F.getAngle,getColor:F.getColor,getSize:F.getSize,getPixelOffset:F.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{all:D.getText,getPosition:D.getPosition,getAngle:D.getAngle,getColor:D.getColor,getSize:D.getSize,getPixelOffset:D.getPixelOffset,getIconOffsets:{getTextAnchor:D.getTextAnchor,getAlignmentBaseline:D.getAlignmentBaseline,styleVersion:a}}}),{data:c,_dataDiff:l,startIndices:e,numInstances:s,getIconOffsets:this.getIconOffsets,getIcon:i})]}static set fontAtlasCacheLimit(e){jE(e)}}ho.defaultProps=JE;ho.layerName="TextLayer";const Zs={circle:{type:ro,props:{filled:"filled",stroked:"stroked",lineWidthMaxPixels:"lineWidthMaxPixels",lineWidthMinPixels:"lineWidthMinPixels",lineWidthScale:"lineWidthScale",lineWidthUnits:"lineWidthUnits",pointRadiusMaxPixels:"radiusMaxPixels",pointRadiusMinPixels:"radiusMinPixels",pointRadiusScale:"radiusScale",pointRadiusUnits:"radiusUnits",pointAntialiasing:"antialiasing",pointBillboard:"billboard",getFillColor:"getFillColor",getLineColor:"getLineColor",getLineWidth:"getLineWidth",getPointRadius:"getRadius"}},icon:{type:Xi,props:{iconAtlas:"iconAtlas",iconMapping:"iconMapping",iconSizeMaxPixels:"sizeMaxPixels",iconSizeMinPixels:"sizeMinPixels",iconSizeScale:"sizeScale",iconSizeUnits:"sizeUnits",iconAlphaCutoff:"alphaCutoff",iconBillboard:"billboard",getIcon:"getIcon",getIconAngle:"getAngle",getIconColor:"getColor",getIconPixelOffset:"getPixelOffset",getIconSize:"getSize"}},text:{type:ho,props:{textSizeMaxPixels:"sizeMaxPixels",textSizeMinPixels:"sizeMinPixels",textSizeScale:"sizeScale",textSizeUnits:"sizeUnits",textBackground:"background",textBackgroundPadding:"backgroundPadding",textFontFamily:"fontFamily",textFontWeight:"fontWeight",textLineHeight:"lineHeight",textMaxWidth:"maxWidth",textOutlineColor:"outlineColor",textOutlineWidth:"outlineWidth",textWordBreak:"wordBreak",textCharacterSet:"characterSet",textBillboard:"billboard",textFontSettings:"fontSettings",getText:"getText",getTextAngle:"getAngle",getTextColor:"getColor",getTextPixelOffset:"getPixelOffset",getTextSize:"getSize",getTextAnchor:"getTextAnchor",getTextAlignmentBaseline:"getAlignmentBaseline",getTextBackgroundColor:"getBackgroundColor",getTextBorderColor:"getBorderColor",getTextBorderWidth:"getBorderWidth"}}},Js={type:no,props:{lineWidthUnits:"widthUnits",lineWidthScale:"widthScale",lineWidthMinPixels:"widthMinPixels",lineWidthMaxPixels:"widthMaxPixels",lineJointRounded:"jointRounded",lineCapRounded:"capRounded",lineMiterLimit:"miterLimit",lineBillboard:"billboard",getLineColor:"getColor",getLineWidth:"getWidth"}},Mn={type:ao,props:{extruded:"extruded",filled:"filled",wireframe:"wireframe",elevationScale:"elevationScale",material:"material",_full3d:"_full3d",getElevation:"getElevation",getFillColor:"getFillColor",getLineColor:"getLineColor"}};function zt({type:t,props:e}){const s={};for(const i in e)s[i]=t.defaultProps[e[i]];return s}function kr(t,e){const{transitions:s,updateTriggers:i}=t.props,r={updateTriggers:{},transitions:s&&{getPosition:s.geometry}};for(const n in e){const o=e[n];let a=t.props[n];n.startsWith("get")&&(a=t.getSubLayerAccessor(a),r.updateTriggers[o]=i[n],s&&(r.transitions[o]=s[n])),r[o]=a}return r}function QE(t){if(Array.isArray(t))return t;switch(U.assert(t.type,"GeoJSON does not have type"),t.type){case"Feature":return[t];case"FeatureCollection":return U.assert(Array.isArray(t.features),"GeoJSON does not have features array"),t.features;default:return[{geometry:t}]}}function Wc(t,e,s={}){const i={pointFeatures:[],lineFeatures:[],polygonFeatures:[],polygonOutlineFeatures:[]},{startRow:r=0,endRow:n=t.length}=s;for(let o=r;o<n;o++){const a=t[o],{geometry:c}=a;if(c)if(c.type==="GeometryCollection"){U.assert(Array.isArray(c.geometries),"GeoJSON does not have geometries array");const{geometries:l}=c;for(let h=0;h<l.length;h++){const u=l[h];Hc(u,i,e,a,o)}}else Hc(c,i,e,a,o)}return i}function Hc(t,e,s,i,r){const{type:n,coordinates:o}=t,{pointFeatures:a,lineFeatures:c,polygonFeatures:l,polygonOutlineFeatures:h}=e;if(!ev(n,o)){U.warn(`${n} coordinates are malformed`)();return}switch(n){case"Point":a.push(s({geometry:t},i,r));break;case"MultiPoint":o.forEach(u=>{a.push(s({geometry:{type:"Point",coordinates:u}},i,r))});break;case"LineString":c.push(s({geometry:t},i,r));break;case"MultiLineString":o.forEach(u=>{c.push(s({geometry:{type:"LineString",coordinates:u}},i,r))});break;case"Polygon":l.push(s({geometry:t},i,r)),o.forEach(u=>{h.push(s({geometry:{type:"LineString",coordinates:u}},i,r))});break;case"MultiPolygon":o.forEach(u=>{l.push(s({geometry:{type:"Polygon",coordinates:u}},i,r)),u.forEach(f=>{h.push(s({geometry:{type:"LineString",coordinates:f}},i,r))})});break}}const GE={Point:1,MultiPoint:2,LineString:2,MultiLineString:3,Polygon:3,MultiPolygon:4};function ev(t,e){let s=GE[t];for(U.assert(s,`Unknown GeoJSON type ${t}`);e&&--s>0;)e=e[0];return e&&Number.isFinite(e[0])}function Su(){return{points:{},lines:{},polygons:{},polygonsOutline:{}}}function Ws(t){return t.geometry.coordinates}function tv(t,e){const s=Su(),{pointFeatures:i,lineFeatures:r,polygonFeatures:n,polygonOutlineFeatures:o}=t;return s.points.data=i,s.points._dataDiff=e.pointFeatures&&(()=>e.pointFeatures),s.points.getPosition=Ws,s.lines.data=r,s.lines._dataDiff=e.lineFeatures&&(()=>e.lineFeatures),s.lines.getPath=Ws,s.polygons.data=n,s.polygons._dataDiff=e.polygonFeatures&&(()=>e.polygonFeatures),s.polygons.getPolygon=Ws,s.polygonsOutline.data=o,s.polygonsOutline._dataDiff=e.polygonOutlineFeatures&&(()=>e.polygonOutlineFeatures),s.polygonsOutline.getPath=Ws,s}function sv(t,e){const s=Su(),{points:i,lines:r,polygons:n}=t,o=xE(t,e);return s.points.data={length:i.positions.value.length/i.positions.size,attributes:{...i.attributes,getPosition:i.positions,instancePickingColors:{size:3,value:o.points}},properties:i.properties,numericProps:i.numericProps,featureIds:i.featureIds},s.lines.data={length:r.pathIndices.value.length-1,startIndices:r.pathIndices.value,attributes:{...r.attributes,getPath:r.positions,instancePickingColors:{size:3,value:o.lines}},properties:r.properties,numericProps:r.numericProps,featureIds:r.featureIds},s.lines._pathType="open",s.polygons.data={length:n.polygonIndices.value.length-1,startIndices:n.polygonIndices.value,attributes:{...n.attributes,getPolygon:n.positions,pickingColors:{size:3,value:o.polygons}},properties:n.properties,numericProps:n.numericProps,featureIds:n.featureIds},s.polygons._normalize=!1,n.triangles&&(s.polygons.data.attributes.indices=n.triangles.value),s.polygonsOutline.data={length:n.primitivePolygonIndices.value.length-1,startIndices:n.primitivePolygonIndices.value,attributes:{...n.attributes,getPath:n.positions,instancePickingColors:{size:3,value:o.polygons}},properties:n.properties,numericProps:n.numericProps,featureIds:n.featureIds},s.polygonsOutline._pathType="open",s}const iv=["points","linestrings","polygons"],rv={...zt(Zs.circle),...zt(Zs.icon),...zt(Zs.text),...zt(Js),...zt(Mn),stroked:!0,filled:!0,extruded:!1,wireframe:!1,_full3d:!1,iconAtlas:{type:"object",value:null},iconMapping:{type:"object",value:{}},getIcon:{type:"accessor",value:t=>t.properties.icon},getText:{type:"accessor",value:t=>t.properties.text},pointType:"circle",getRadius:{deprecatedFor:"getPointRadius"}};class vi extends so{initializeState(){this.state={layerProps:{},features:{},featuresDiff:{}}}updateState({props:e,changeFlags:s}){if(!s.dataChanged)return;const{data:i}=this.props,r=i&&"points"in i&&"polygons"in i&&"lines"in i;this.setState({binary:r}),r?this._updateStateBinary({props:e,changeFlags:s}):this._updateStateJSON({props:e,changeFlags:s})}_updateStateBinary({props:e,changeFlags:s}){const i=sv(e.data,this.encodePickingColor);this.setState({layerProps:i})}_updateStateJSON({props:e,changeFlags:s}){const i=QE(e.data),r=this.getSubLayerRow.bind(this);let n={};const o={};if(Array.isArray(s.dataChanged)){const c=this.state.features;for(const l in c)n[l]=c[l].slice(),o[l]=[];for(const l of s.dataChanged){const h=Wc(i,r,l);for(const u in c)o[u].push(EE({data:n[u],getIndex:f=>f.__source.index,dataRange:l,replace:h[u]}))}}else n=Wc(i,r);const a=tv(n,o);this.setState({features:n,featuresDiff:o,layerProps:a})}getPickingInfo(e){const s=super.getPickingInfo(e),{index:i,sourceLayer:r}=s;return s.featureType=iv.find(n=>r.id.startsWith(`${this.id}-${n}-`)),i>=0&&r.id.startsWith(`${this.id}-points-text`)&&this.state.binary&&(s.index=this.props.data.points.globalFeatureIds.value[i]),s}_updateAutoHighlight(e){const s=`${this.id}-points-`,i=e.featureType==="points";for(const r of this.getSubLayers())r.id.startsWith(s)===i&&r.updateAutoHighlight(e)}_renderPolygonLayer(){var o;const{extruded:e,wireframe:s}=this.props,{layerProps:i}=this.state,r="polygons-fill",n=this.shouldRenderSubLayer(r,(o=i.polygons)==null?void 0:o.data)&&this.getSubLayerClass(r,Mn.type);if(n){const a=kr(this,Mn.props),c=e&&s;return c||delete a.getLineColor,a.updateTriggers.lineColors=c,new n(a,this.getSubLayerProps({id:r,updateTriggers:a.updateTriggers}),i.polygons)}return null}_renderLineLayers(){var c,l;const{extruded:e,stroked:s}=this.props,{layerProps:i}=this.state,r="polygons-stroke",n="linestrings",o=!e&&s&&this.shouldRenderSubLayer(r,(c=i.polygonsOutline)==null?void 0:c.data)&&this.getSubLayerClass(r,Js.type),a=this.shouldRenderSubLayer(n,(l=i.lines)==null?void 0:l.data)&&this.getSubLayerClass(n,Js.type);if(o||a){const h=kr(this,Js.props);return[o&&new o(h,this.getSubLayerProps({id:r,updateTriggers:h.updateTriggers}),i.polygonsOutline),a&&new a(h,this.getSubLayerProps({id:n,updateTriggers:h.updateTriggers}),i.lines)]}return null}_renderPointLayers(){var a;const{pointType:e}=this.props,{layerProps:s,binary:i}=this.state;let{highlightedObjectIndex:r}=this.props;!i&&Number.isFinite(r)&&(r=s.points.data.findIndex(c=>c.__source.index===r));const n=new Set(e.split("+")),o=[];for(const c of n){const l=`points-${c}`,h=Zs[c],u=h&&this.shouldRenderSubLayer(l,(a=s.points)==null?void 0:a.data)&&this.getSubLayerClass(l,h.type);if(u){const f=kr(this,h.props);let p=s.points;if(c==="text"&&i){const{instancePickingColors:_,...m}=p.data.attributes;p={...p,data:{...p.data,attributes:m}}}o.push(new u(f,this.getSubLayerProps({id:l,updateTriggers:f.updateTriggers,highlightedObjectIndex:r}),p))}}return o}renderLayers(){const{extruded:e}=this.props,s=this._renderPolygonLayer(),i=this._renderLineLayers(),r=this._renderPointLayers();return[!e&&s,i,r,e&&s]}getSubLayerAccessor(e){const{binary:s}=this.state;return!s||typeof e!="function"?super.getSubLayerAccessor(e):(i,r)=>{const{data:n,index:o}=r,a=vE(n,o);return e(a,r)}}}vi.layerName="GeoJsonLayer";vi.defaultProps=rv;const nv="https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_50m_admin_0_scale_rank.geojson",jc="https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_10m_airports.geojson",ov={latitude:51.47,longitude:.45,zoom:4,bearing:0,pitch:30};new Gn({initialViewState:ov,controller:{touchRotate:!0},layers:[new vi({id:"base-map",data:nv,stroked:!0,filled:!0,lineWidthMinPixels:2,opacity:.4,getLineColor:[60,60,60],getFillColor:[200,200,200]}),new vi({id:"airports",data:jc,filled:!0,pointRadiusMinPixels:2,pointRadiusScale:2e3,getPointRadius:t=>11-t.properties.scalerank,getFillColor:[200,0,80,180],pickable:!0,autoHighlight:!0,onClick:t=>t.object&&alert(`${t.object.properties.name} (${t.object.properties.abbrev})`)}),new io({id:"arcs",data:jc,dataTransform:t=>t.features.filter(e=>e.properties.scalerank<4),getSourcePosition:t=>[-.4531566,51.4709959],getTargetPosition:t=>t.geometry.coordinates,getSourceColor:[0,128,200],getTargetColor:[200,0,80],getWidth:1})]});
