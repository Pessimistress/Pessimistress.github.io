(function(){"use strict";function A(n,r,t,a){var e=0,a=a===void 0?{}:a,x=a.loop===void 0?null:a.loop,o=a.palette===void 0?null:a.palette;if(r<=0||t<=0||r>65535||t>65535)throw new Error("Width/Height invalid.");function v(d){var c=d.length;if(c<2||c>256||c&c-1)throw new Error("Invalid code/color length, must be power of 2 and 2 .. 256.");return c}n[e++]=71,n[e++]=73,n[e++]=70,n[e++]=56,n[e++]=57,n[e++]=97;var s=0,f=0;if(o!==null){for(var l=v(o);l>>=1;)++s;if(l=1<<s,--s,a.background!==void 0){if(f=a.background,f>=l)throw new Error("Background index out of range.");if(f===0)throw new Error("Background index explicitly passed as 0.")}}if(n[e++]=r&255,n[e++]=r>>8&255,n[e++]=t&255,n[e++]=t>>8&255,n[e++]=(o!==null?128:0)|s,n[e++]=f,n[e++]=0,o!==null)for(var w=0,g=o.length;w<g;++w){var u=o[w];n[e++]=u>>16&255,n[e++]=u>>8&255,n[e++]=u&255}if(x!==null){if(x<0||x>65535)throw new Error("Loop count invalid.");n[e++]=33,n[e++]=255,n[e++]=11,n[e++]=78,n[e++]=69,n[e++]=84,n[e++]=83,n[e++]=67,n[e++]=65,n[e++]=80,n[e++]=69,n[e++]=50,n[e++]=46,n[e++]=48,n[e++]=3,n[e++]=1,n[e++]=x&255,n[e++]=x>>8&255,n[e++]=0}var p=!1;this.addFrame=function(d,c,_,y,O,i){if(p===!0&&(--e,p=!1),i=i===void 0?{}:i,d<0||c<0||d>65535||c>65535)throw new Error("x/y invalid.");if(_<=0||y<=0||_>65535||y>65535)throw new Error("Width/Height invalid.");if(O.length<_*y)throw new Error("Not enough pixels for the frame size.");var C=!0,m=i.palette;if(m==null&&(C=!1,m=o),m==null)throw new Error("Must supply either a local or global palette.");for(var W=v(m),F=0;W>>=1;)++F;W=1<<F;var I=i.delay===void 0?0:i.delay,k=i.disposal===void 0?0:i.disposal;if(k<0||k>3)throw new Error("Disposal out of range.");var D=!1,B=0;if(i.transparent!==void 0&&i.transparent!==null&&(D=!0,B=i.transparent,B<0||B>=W))throw new Error("Transparent color index.");if((k!==0||D||I!==0)&&(n[e++]=33,n[e++]=249,n[e++]=4,n[e++]=k<<2|(D===!0?1:0),n[e++]=I&255,n[e++]=I>>8&255,n[e++]=B,n[e++]=0),n[e++]=44,n[e++]=d&255,n[e++]=d>>8&255,n[e++]=c&255,n[e++]=c>>8&255,n[e++]=_&255,n[e++]=_>>8&255,n[e++]=y&255,n[e++]=y>>8&255,n[e++]=C===!0?128|F-1:0,C===!0)for(var G=0,R=m.length;G<R;++G){var P=m[G];n[e++]=P>>16&255,n[e++]=P>>8&255,n[e++]=P&255}return e=H(n,e,F<2?2:F,O),e},this.end=function(){return p===!1&&(n[e++]=59,p=!0),e},this.getOutputBuffer=function(){return n},this.setOutputBuffer=function(d){n=d},this.getOutputBufferPosition=function(){return e},this.setOutputBufferPosition=function(d){e=d}}function H(n,r,t,h){n[r++]=t;var e=r++,a=1<<t,x=a-1,o=a+1,v=o+1,s=t+1,f=0,l=0;function w(i){for(;f>=i;)n[r++]=l&255,l>>=8,f-=8,r===e+256&&(n[e]=255,e=r++)}function g(i){l|=i<<f,f+=s,w(8)}var u=h[0]&x,p={};g(a);for(var d=1,c=h.length;d<c;++d){var _=h[d]&x,y=u<<8|_,O=p[y];if(O===void 0){for(l|=u<<f,f+=s;f>=8;)n[r++]=l&255,l>>=8,f-=8,r===e+256&&(n[e]=255,e=r++);v===4096?(g(a),v=o+1,s=t+1,p={}):(v>=1<<s&&++s,p[y]=v++),u=_}else u=O}return g(u),g(o),w(1),e+1===r?n[e]=0:(n[e]=r-e-1,n[r++]=0),r}function L(n){const{width:r,height:t,frameCount:h}=n;let e=h;const a=new Uint8Array((r*t+1024)*h),o=new OffscreenCanvas(r,t).getContext("2d",{willReadFrequently:!0}),v={loop:n.loopCount,palette:n.palette},s=new A(a,r,t,v);return{addFrame:l=>{o.drawImage(l.data,0,0);const w=o.getImageData(0,0,r,t),g=M(w,l.palette),u={delay:l.delay,palette:l.isPaletteGlobal?void 0:l.palette};s.addFrame(0,0,r,t,g,u),e--},done:()=>e===0,buffer:()=>a.subarray(0,s.end())}}function M(n,r){const t={};for(let e=0;e<r.length;e++)t[r[e]]=e;const h=new Uint8Array(n.width*n.height);for(let e=0;e<h.length;e++){const a=n.data[e*4],x=n.data[e*4+1],o=n.data[e*4+2],v=(a<<16)+(x<<8)+o;h[e]=t[v]}return h}let E=null;self.onmessage=async n=>{if(console.log(n.data.type,performance.now()),n.data.type==="metadata"){const r=n.data.value;E=L(r)}else if(E){const r=n.data.value;if(E.addFrame(r),r.data.close(),E.done()){const t=E.buffer();self.postMessage({buffer:t},{transfer:[t.buffer]})}}}})();
