(function(){"use strict";function J(e){var a=0;if(e[a++]!==71||e[a++]!==73||e[a++]!==70||e[a++]!==56||(e[a++]+1&253)!==56||e[a++]!==97)throw new Error("Invalid GIF 87a/89a header.");var r=e[a++]|e[a++]<<8,t=e[a++]|e[a++]<<8,l=e[a++],n=l>>7,c=l&7,o=1<<c+1;e[a++],e[a++];var s=null,h=null;n&&(s=a,h=o,a+=o*3);var x=!0,g=[],w=0,f=null,k=0,m=null;for(this.width=r,this.height=t;x&&a<e.length;)switch(e[a++]){case 33:switch(e[a++]){case 255:if(e[a]!==11||e[a+1]==78&&e[a+2]==69&&e[a+3]==84&&e[a+4]==83&&e[a+5]==67&&e[a+6]==65&&e[a+7]==80&&e[a+8]==69&&e[a+9]==50&&e[a+10]==46&&e[a+11]==48&&e[a+12]==3&&e[a+13]==1&&e[a+16]==0)a+=14,m=e[a++]|e[a++]<<8,a++;else for(a+=12;;){var i=e[a++];if(!(i>=0))throw Error("Invalid block size");if(i===0)break;a+=i}break;case 249:if(e[a++]!==4||e[a+4]!==0)throw new Error("Invalid graphics extension block.");var _=e[a++];w=e[a++]|e[a++]<<8,f=e[a++],_&1||(f=null),k=_>>2&7,a++;break;case 254:for(;;){var i=e[a++];if(!(i>=0))throw Error("Invalid block size");if(i===0)break;a+=i}break;default:throw new Error("Unknown graphic control label: 0x"+e[a-1].toString(16))}break;case 44:var y=e[a++]|e[a++]<<8,d=e[a++]|e[a++]<<8,I=e[a++]|e[a++]<<8,U=e[a++]|e[a++]<<8,z=e[a++],X=z>>7,Y=z>>6&1,$=z&7,O=1<<$+1,R=s,L=h,N=!1;if(X){var N=!0;R=a,L=O,a+=O*3}var Z=a;for(a++;;){var i=e[a++];if(!(i>=0))throw Error("Invalid block size");if(i===0)break;a+=i}g.push({x:y,y:d,width:I,height:U,has_local_palette:N,palette_offset:R,palette_size:L,data_offset:Z,data_length:a-Z,transparent_index:f,interlaced:!!Y,delay:w,disposal:k});break;case 59:x=!1;break;default:throw new Error("Unknown gif block: 0x"+e[a-1].toString(16))}this.numFrames=function(){return g.length},this.loopCount=function(){return m},this.frameInfo=function(F){if(F<0||F>=g.length)throw new Error("Frame index out of range.");return g[F]},this.decodeAndBlitFrameRGBA=function(F,E,j){var v=this.frameInfo(F),q=v.width*v.height,B=new Uint8Array(q);K(e,v.data_offset,B,q);var A=v.palette_offset,b=v.palette_size;j&&j.set(e.slice(A,A+b*3));var D=v.transparent_index;D===null&&(D=256);var C=v.width,P=r-C,S=C,H=(v.y*r+v.x)*4,aa=((v.y+v.height)*r+v.x)*4,p=H,W=P*4;v.interlaced===!0&&(W+=r*4*7);for(var u=8,M=0,ea=B.length;M<ea;++M){var G=B[M];if(S===0&&(p+=W,S=C,p>=aa&&(W=P*4+r*4*(u-1),p=H+(C+P)*(u<<1),u>>=1)),G===D)p+=4;else{var ra=e[A+G*3],ta=e[A+G*3+1],na=e[A+G*3+2];E[p++]=ra,E[p++]=ta,E[p++]=na,E[p++]=255}--S}}}function K(e,a,r,t){for(var l=e[a++],n=1<<l,c=n+1,o=c+1,s=l+1,h=(1<<s)-1,x=0,g=0,w=0,f=e[a++],k=new Int32Array(4096),m=null;;){for(;x<16&&f!==0;)g|=e[a++]<<x,x+=8,f===1?f=e[a++]:--f;if(x<s)break;var i=g&h;if(g>>=s,x-=s,i===n){o=c+1,s=l+1,h=(1<<s)-1,m=null;continue}else if(i===c)break;for(var _=i<o?i:m,y=0,d=_;d>n;)d=k[d]>>8,++y;var I=d,U=w+y+(_!==i?1:0);if(U>t){console.log("Warning, gif stream longer than expected.");return}r[w++]=I,w+=y;var z=w;for(_!==i&&(r[w++]=I),d=_;y--;)d=k[d],r[--z]=d&255,d>>=8;m!==null&&o<4096&&(k[o++]=m<<8|I,o>=h+1&&s<12&&(++s,h=h<<1|1)),m=i}return w!==t&&console.log("Warning, gif stream shorter than expected."),r}async function*Q(e){const a=new OffscreenCanvas(e.width,e.height),r=a.getContext("2d");let t=null,l=null;const n=new ImageData(e.width,e.height);for(let c=0;c<e.numFrames();c++){const o=e.frameInfo(c);if(t)switch(t.disposal){case 0:case 1:break;case 2:r.clearRect(t.x,t.y,t.width,t.height);break;case 3:if(!l)throw new Error("No previous frame to restore");r.drawImage(l.data,0,0);break}const s=new Uint8ClampedArray(o.palette_size*3);e.decodeAndBlitFrameRGBA(c,n.data,s),r.putImageData(n,0,0,o.x,o.y,o.width,o.height);const h={index:c,data:await createImageBitmap(a),delay:o.delay,palette:T(s),isPaletteGlobal:!o.has_local_palette};yield h,(l==null||o.disposal!==3)&&(l=h),t=o}}function T(e){const a=new Uint32Array(e.length/3);for(let r=0;r<a.length;r++){const t=e[r*3],l=e[r*3+1],n=e[r*3+2];a[r]=(t<<16)+(l<<8)+n}return a}async function V(e,a){const r=e.getReader(),t=new Uint8Array(a);let l=0;for(;;){const n=await r.read();if(n.value&&(t.set(n.value,l),l+=n.value.length),n.done)break}return new J(t)}self.onmessage=async e=>{const{size:a,stream:r}=e.data,t=await V(r,a),l={width:t.width,height:t.height,frameCount:t.numFrames(),loopCount:t.loopCount()};self.postMessage({type:"metadata",value:l});for await(const n of Q(t))self.postMessage({type:"frame",value:n},{transfer:[n.data,n.palette.buffer]})}})();
