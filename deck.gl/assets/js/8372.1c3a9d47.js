"use strict";(self.webpackChunkproject_website=self.webpackChunkproject_website||[]).push([[8372],{87427:(t,e,i)=>{i.d(e,{u:()=>Et});var s=i(10786),r=i(66757);const n="3.3.1",o={COMPOSITE:"cmpt",POINT_CLOUD:"pnts",BATCHED_3D_MODEL:"b3dm",INSTANCED_3D_MODEL:"i3dm",GEOMETRY:"geom",VECTOR:"vect",GLTF:"glTF"};Object.keys(o);var a=i(87346);function h(t,e,i){(0,a.h)(t instanceof ArrayBuffer);const s=new TextDecoder("utf8"),r=new Uint8Array(t,e,i);return s.decode(r)}var l=i(42481);const c={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DOUBLE:5130},u={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,...c};var d=i(59122),p=i(4942);const f={[c.DOUBLE]:Float64Array,[c.FLOAT]:Float32Array,[c.UNSIGNED_SHORT]:Uint16Array,[c.UNSIGNED_INT]:Uint32Array,[c.UNSIGNED_BYTE]:Uint8Array,[c.BYTE]:Int8Array,[c.SHORT]:Int16Array,[c.INT]:Int32Array},m={DOUBLE:c.DOUBLE,FLOAT:c.FLOAT,UNSIGNED_SHORT:c.UNSIGNED_SHORT,UNSIGNED_INT:c.UNSIGNED_INT,UNSIGNED_BYTE:c.UNSIGNED_BYTE,BYTE:c.BYTE,SHORT:c.SHORT,INT:c.INT},y="Failed to convert GL type";class T{static fromTypedArray(t){t=ArrayBuffer.isView(t)?t.constructor:t;for(const e in f){if(f[e]===t)return e}throw new Error(y)}static fromName(t){const e=m[t];if(!e)throw new Error(y);return e}static getArrayType(t){switch(t){case c.UNSIGNED_SHORT_5_6_5:case c.UNSIGNED_SHORT_4_4_4_4:case c.UNSIGNED_SHORT_5_5_5_1:return Uint16Array;default:const e=f[t];if(!e)throw new Error(y);return e}}static getByteSize(t){return T.getArrayType(t).BYTES_PER_ELEMENT}static validate(t){return Boolean(T.getArrayType(t))}static createTypedArray(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3?arguments[3]:void 0;void 0===s&&(s=(e.byteLength-i)/T.getByteSize(t));return new(T.getArrayType(t))(e,i,s)}}class _{constructor(t,e){(0,p.Z)(this,"json",void 0),(0,p.Z)(this,"buffer",void 0),(0,p.Z)(this,"featuresLength",0),(0,p.Z)(this,"_cachedTypedArrays",{}),this.json=t,this.buffer=e}getExtension(t){return this.json.extensions&&this.json.extensions[t]}hasProperty(t){return Boolean(this.json[t])}getGlobalProperty(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:u.UNSIGNED_INT,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;const s=this.json[t];return s&&Number.isFinite(s.byteOffset)?this._getTypedArrayFromBinary(t,e,i,1,s.byteOffset):s}getPropertyArray(t,e,i){const s=this.json[t];return s&&Number.isFinite(s.byteOffset)?("componentType"in s&&(e=T.fromName(s.componentType)),this._getTypedArrayFromBinary(t,e,i,this.featuresLength,s.byteOffset)):this._getTypedArrayFromArray(t,e,s)}getProperty(t,e,i,s,r){const n=this.json[t];if(!n)return n;const o=this.getPropertyArray(t,e,i);if(1===i)return o[s];for(let a=0;a<i;++a)r[a]=o[i*s+a];return r}_getTypedArrayFromBinary(t,e,i,s,r){const n=this._cachedTypedArrays;let o=n[t];return o||(o=T.createTypedArray(e,this.buffer.buffer,this.buffer.byteOffset+r,s*i),n[t]=o),o}_getTypedArrayFromArray(t,e,i){const s=this._cachedTypedArrays;let r=s[t];return r||(r=T.createTypedArray(e,i),s[t]=r),r}}const g={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},b={SCALAR:(t,e)=>t[e],VEC2:(t,e)=>[t[2*e+0],t[2*e+1]],VEC3:(t,e)=>[t[3*e+0],t[3*e+1],t[3*e+2]],VEC4:(t,e)=>[t[4*e+0],t[4*e+1],t[4*e+2],t[4*e+3]],MAT2:(t,e)=>[t[4*e+0],t[4*e+1],t[4*e+2],t[4*e+3]],MAT3:(t,e)=>[t[9*e+0],t[9*e+1],t[9*e+2],t[9*e+3],t[9*e+4],t[9*e+5],t[9*e+6],t[9*e+7],t[9*e+8]],MAT4:(t,e)=>[t[16*e+0],t[16*e+1],t[16*e+2],t[16*e+3],t[16*e+4],t[16*e+5],t[16*e+6],t[16*e+7],t[16*e+8],t[16*e+9],t[16*e+10],t[16*e+11],t[16*e+12],t[16*e+13],t[16*e+14],t[16*e+15]]},v={SCALAR:(t,e,i)=>{e[i]=t},VEC2:(t,e,i)=>{e[2*i+0]=t[0],e[2*i+1]=t[1]},VEC3:(t,e,i)=>{e[3*i+0]=t[0],e[3*i+1]=t[1],e[3*i+2]=t[2]},VEC4:(t,e,i)=>{e[4*i+0]=t[0],e[4*i+1]=t[1],e[4*i+2]=t[2],e[4*i+3]=t[3]},MAT2:(t,e,i)=>{e[4*i+0]=t[0],e[4*i+1]=t[1],e[4*i+2]=t[2],e[4*i+3]=t[3]},MAT3:(t,e,i)=>{e[9*i+0]=t[0],e[9*i+1]=t[1],e[9*i+2]=t[2],e[9*i+3]=t[3],e[9*i+4]=t[4],e[9*i+5]=t[5],e[9*i+6]=t[6],e[9*i+7]=t[7],e[9*i+8]=t[8],e[9*i+9]=t[9]},MAT4:(t,e,i)=>{e[16*i+0]=t[0],e[16*i+1]=t[1],e[16*i+2]=t[2],e[16*i+3]=t[3],e[16*i+4]=t[4],e[16*i+5]=t[5],e[16*i+6]=t[6],e[16*i+7]=t[7],e[16*i+8]=t[8],e[16*i+9]=t[9],e[16*i+10]=t[10],e[16*i+11]=t[11],e[16*i+12]=t[12],e[16*i+13]=t[13],e[16*i+14]=t[14],e[16*i+15]=t[15]}};const w=t=>void 0!==t;function E(t,e,i){if(!e)return null;let s=t.getExtension("3DTILES_batch_table_hierarchy");const r=e.HIERARCHY;return r&&(console.warn("3D Tile Parser: HIERARCHY is deprecated. Use 3DTILES_batch_table_hierarchy."),e.extensions=e.extensions||{},e.extensions["3DTILES_batch_table_hierarchy"]=r,s=r),s?function(t,e){let i,s,r;const n=t.instancesLength,o=t.classes;let a,h=t.classIds,l=t.parentCounts,c=t.parentIds,u=n;w(h.byteOffset)&&(h.componentType=defaultValue(h.componentType,GL.UNSIGNED_SHORT),h.type=AttributeType.SCALAR,r=getBinaryAccessor(h),h=r.createArrayBufferView(e.buffer,e.byteOffset+h.byteOffset,n));if(w(l))for(w(l.byteOffset)&&(l.componentType=defaultValue(l.componentType,GL.UNSIGNED_SHORT),l.type=AttributeType.SCALAR,r=getBinaryAccessor(l),l=r.createArrayBufferView(e.buffer,e.byteOffset+l.byteOffset,n)),a=new Uint16Array(n),u=0,i=0;i<n;++i)a[i]=u,u+=l[i];w(c)&&w(c.byteOffset)&&(c.componentType=defaultValue(c.componentType,GL.UNSIGNED_SHORT),c.type=AttributeType.SCALAR,r=getBinaryAccessor(c),c=r.createArrayBufferView(e.buffer,e.byteOffset+c.byteOffset,u));const d=o.length;for(i=0;i<d;++i){const t=o[i].length,s=o[i].instances,r=getBinaryProperties(t,s,e);o[i].instances=combine(r,s)}const p=new Array(d).fill(0),f=new Uint16Array(n);for(i=0;i<n;++i)s=h[i],f[i]=p[s],++p[s];const m={classes:o,classIds:h,classIndexes:f,parentCounts:l,parentIndexes:a,parentIds:c};return function(t){const e=t.classIds,i=e.length;for(let s=0;s<i;++s)A(t,s,stack)}(m),m}(s,i):null}function S(t,e,i){if(!t)return;const s=t.parentCounts;return t.parentIds?i(t,e):s>0?function(t,e,i){const s=t.classIds,r=t.parentCounts,n=t.parentIds,o=t.parentIndexes,a=s.length,h=scratchVisited;h.length=Math.max(h.length,a);const l=++marker,c=scratchStack;c.length=0,c.push(e);for(;c.length>0;){if(h[e=c.pop()]===l)continue;h[e]=l;const s=i(t,e);if(w(s))return s;const a=r[e],u=o[e];for(let t=0;t<a;++t){const i=n[u+t];i!==e&&c.push(i)}}return null}(t,e,i):function(t,e,i){let s=!0;for(;s;){const r=i(t,e);if(w(r))return r;const n=t.parentIds[e];s=n!==e,e=n}throw new Error("traverseHierarchySingleParent")}(t,e,i)}function A(t,e,i){const s=t.parentCounts,r=t.parentIds,n=t.parentIndexes,o=t.classIds.length;if(!w(r))return;assert(e<o,"Parent index ".concat(e," exceeds the total number of instances: ").concat(o)),assert(-1===i.indexOf(e),"Circular dependency detected in the batch table hierarchy."),i.push(e);const a=w(s)?s[e]:1,h=w(s)?n[e]:e;for(let l=0;l<a;++l){const s=r[h+l];s!==e&&A(t,s,i)}i.pop(e)}function Z(t){return null!=t}const N=(t,e)=>t,O={HIERARCHY:!0,extensions:!0,extras:!0};class I{constructor(t,e,i){var s;let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};(0,p.Z)(this,"json",void 0),(0,p.Z)(this,"binary",void 0),(0,p.Z)(this,"featureCount",void 0),(0,p.Z)(this,"_extensions",void 0),(0,p.Z)(this,"_properties",void 0),(0,p.Z)(this,"_binaryProperties",void 0),(0,p.Z)(this,"_hierarchy",void 0),(0,a.h)(i>=0),this.json=t||{},this.binary=e,this.featureCount=i,this._extensions=(null===(s=this.json)||void 0===s?void 0:s.extensions)||{},this._properties={};for(const n in this.json)O[n]||(this._properties[n]=this.json[n]);this._binaryProperties=this._initializeBinaryProperties(),r["3DTILES_batch_table_hierarchy"]&&(this._hierarchy=E(this,this.json,this.binary))}getExtension(t){return this.json&&this.json.extensions&&this.json.extensions[t]}memorySizeInBytes(){return 0}isClass(t,e){if(this._checkBatchId(t),(0,a.h)("string"==typeof e,e),this._hierarchy){return Z(S(this._hierarchy,t,((t,i)=>{const s=t.classIds[i];return t.classes[s].name===e})))}return!1}isExactClass(t,e){return(0,a.h)("string"==typeof e,e),this.getExactClassName(t)===e}getExactClassName(t){if(this._checkBatchId(t),this._hierarchy){const e=this._hierarchy.classIds[t];return this._hierarchy.classes[e].name}}hasProperty(t,e){return this._checkBatchId(t),(0,a.h)("string"==typeof e,e),Z(this._properties[e])||this._hasPropertyInHierarchy(t,e)}getPropertyNames(t,e){this._checkBatchId(t),(e=Z(e)?e:[]).length=0;const i=Object.keys(this._properties);return e.push(...i),this._hierarchy&&this._getPropertyNamesInHierarchy(t,e),e}getProperty(t,e){if(this._checkBatchId(t),(0,a.h)("string"==typeof e,e),this._binaryProperties){const i=this._binaryProperties[e];if(Z(i))return this._getBinaryProperty(i,t)}const i=this._properties[e];if(Z(i))return N(i[t]);if(this._hierarchy){const i=this._getHierarchyProperty(t,e);if(Z(i))return i}}setProperty(t,e,i){const s=this.featureCount;if(this._checkBatchId(t),(0,a.h)("string"==typeof e,e),this._binaryProperties){const s=this._binaryProperties[e];if(s)return void this._setBinaryProperty(s,t,i)}if(this._hierarchy&&this._setHierarchyProperty(this,t,e,i))return;let r=this._properties[e];Z(r)||(this._properties[e]=new Array(s),r=this._properties[e]),r[t]=N(i)}_checkBatchId(t){if(!(t>=0&&t<this.featureCount))throw new Error("batchId not in range [0, featureCount - 1].")}_getBinaryProperty(t,e){return t.unpack(t.typedArray,e)}_setBinaryProperty(t,e,i){t.pack(i,t.typedArray,e)}_initializeBinaryProperties(){let t=null;for(const e in this._properties){const i=this._properties[e],s=this._initializeBinaryProperty(e,i);s&&(t=t||{},t[e]=s)}return t}_initializeBinaryProperty(t,e){if("byteOffset"in e){const i=e;(0,a.h)(this.binary,"Property ".concat(t," requires a batch table binary.")),(0,a.h)(i.type,"Property ".concat(t," requires a type."));const s=function(t,e,i,s){const{componentType:r}=t;(0,a.h)(t.componentType);const n="string"==typeof r?T.fromName(r):r,o=g[t.type],h=b[t.type],l=v[t.type];return i+=t.byteOffset,{values:T.createTypedArray(n,e,i,o*s),type:n,size:o,unpacker:h,packer:l}}(i,this.binary.buffer,0|this.binary.byteOffset,this.featureCount);return{typedArray:s.values,componentCount:s.size,unpack:s.unpacker,pack:s.packer}}return null}_hasPropertyInHierarchy(t,e){if(!this._hierarchy)return!1;const i=S(this._hierarchy,t,((t,i)=>{const s=t.classIds[i];return Z(t.classes[s].instances[e])}));return Z(i)}_getPropertyNamesInHierarchy(t,e){S(this._hierarchy,t,((t,i)=>{const s=t.classIds[i],r=t.classes[s].instances;for(const n in r)r.hasOwnProperty(n)&&-1===e.indexOf(n)&&e.push(n)}))}_getHierarchyProperty(t,e){return S(this._hierarchy,t,((t,i)=>{const s=t.classIds[i],r=t.classes[s],n=t.classIndexes[i],o=r.instances[e];return Z(o)?Z(o.typedArray)?this._getBinaryProperty(o,n):N(o[n]):null}))}_setHierarchyProperty(t,e,i,s){const r=S(this._hierarchy,e,((t,r)=>{const n=t.classIds[r],o=t.classes[n],h=t.classIndexes[r],l=o.instances[i];return!!Z(l)&&((0,a.h)(r===e,'Inherited property "'.concat(i,'" is read-only.')),Z(l.typedArray)?this._setBinaryProperty(l,h,s):l[h]=N(s),!0)}));return Z(r)}}const C=4;function R(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const s=new DataView(e);if(t.magic=s.getUint32(i,!0),i+=C,t.version=s.getUint32(i,!0),i+=C,t.byteLength=s.getUint32(i,!0),i+=C,1!==t.version)throw new Error("3D Tile Version ".concat(t.version," not supported"));return i}const x=4,M="b3dm tile in legacy format.";function D(t,e,i){const s=new DataView(e);let r;t.header=t.header||{};let n=s.getUint32(i,!0);i+=x;let o=s.getUint32(i,!0);i+=x;let a=s.getUint32(i,!0);i+=x;let h=s.getUint32(i,!0);return i+=x,a>=570425344?(i-=2*x,r=n,a=o,h=0,n=0,o=0,console.warn(M)):h>=570425344&&(i-=x,r=a,a=n,h=o,n=0,o=0,console.warn(M)),t.header.featureTableJsonByteLength=n,t.header.featureTableBinaryByteLength=o,t.header.batchTableJsonByteLength=a,t.header.batchTableBinaryByteLength=h,t.header.batchLength=r,i}function P(t,e,i,s){return i=function(t,e,i,s){const{featureTableJsonByteLength:r,featureTableBinaryByteLength:n,batchLength:o}=t.header;if(t.featureTableJson={BATCH_LENGTH:o||0},r>0){const s=h(e,i,r);t.featureTableJson=JSON.parse(s)}return i+=r,t.featureTableBinary=new Uint8Array(e,i,n),i+=n,i}(t,e,i),i=function(t,e,i,s){const{batchTableJsonByteLength:r,batchTableBinaryByteLength:n}=t.header;if(r>0){const s=h(e,i,r);t.batchTableJson=JSON.parse(s),i+=r,n>0&&(t.batchTableBinary=new Uint8Array(e,i,n),t.batchTableBinary=new Uint8Array(t.batchTableBinary),i+=n)}return i}(t,e,i),i}function U(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0,0];const i=t>>11&31,s=t>>5&63,r=31&t;return e[0]=i<<3,e[1]=s<<2,e[2]=r<<3,e}function L(t,e,i){if(!(e||t&&t.batchIds&&i))return null;const{batchIds:s,isRGB565:r,pointCount:n}=t;if(s&&i){const t=new Uint8ClampedArray(3*n);for(let e=0;e<n;e++){const r=s[e],n=i.getProperty(r,"dimensions").map((t=>255*t));t[3*e]=n[0],t[3*e+1]=n[1],t[3*e+2]=n[2]}return{type:u.UNSIGNED_BYTE,value:t,size:3,normalized:!0}}if(r){const t=new Uint8ClampedArray(3*n);for(let i=0;i<n;i++){const s=U(e[i]);t[3*i]=s[0],t[3*i+1]=s[1],t[3*i+2]=s[2]}return{type:u.UNSIGNED_BYTE,value:t,size:3,normalized:!0}}return e&&e.length===3*n?{type:u.UNSIGNED_BYTE,value:e,size:3,normalized:!0}:{type:u.UNSIGNED_BYTE,value:e,size:4,normalized:!0}}var V=i(36212),B=i(28835);new V.Z,new d.Z,new V.Z,new V.Z,new Uint8Array(1);function z(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:255;return(0,B.uZ)(t,0,e)/e*2-1}function F(t){return t<0?-1:1}function G(t,e,i,s){if(function(t,e){if(!t)throw new Error("math.gl assertion failed. ".concat(e))}(s),t<0||t>i||e<0||e>i)throw new Error("x and y must be unsigned normalized integers between 0 and ".concat(i));if(s.x=z(t,i),s.y=z(e,i),s.z=1-(Math.abs(s.x)+Math.abs(s.y)),s.z<0){const t=s.x;s.x=(1-Math.abs(s.y))*F(t),s.y=(1-Math.abs(t))*F(s.y)}return s.normalize()}function q(t,e,i){return G(t,e,255,i)}const H=new d.Z;function k(t,e,i){return t.isQuantized?i["3d-tiles"]&&i["3d-tiles"].decodeQuantizedPositions?(t.isQuantized=!1,function(t,e){const i=new d.Z,s=new Float32Array(3*t.pointCount);for(let r=0;r<t.pointCount;r++)i.set(e[3*r],e[3*r+1],e[3*r+2]).scale(1/t.quantizedRange).multiply(t.quantizedVolumeScale).add(t.quantizedVolumeOffset).toArray(s,3*r);return s}(t,e)):{type:u.UNSIGNED_SHORT,value:e,size:3,normalized:!0}:e}async function Q(t,e,i,s,r){i=P(t,e,i=D(t,e,i=R(t,e,i))),function(t){t.attributes={positions:null,colors:null,normals:null,batchIds:null},t.isQuantized=!1,t.isTranslucent=!1,t.isRGB565=!1,t.isOctEncoded16P=!1}(t);const{featureTable:n,batchTable:o}=function(t){const e=new _(t.featureTableJson,t.featureTableBinary),i=e.getGlobalProperty("POINTS_LENGTH");if(!Number.isFinite(i))throw new Error("POINTS_LENGTH must be defined");e.featuresLength=i,t.featuresLength=i,t.pointsLength=i,t.pointCount=i,t.rtcCenter=e.getGlobalProperty("RTC_CENTER",u.FLOAT,3);const s=function(t,e){let i=null;if(!t.batchIds&&e.hasProperty("BATCH_ID")&&(t.batchIds=e.getPropertyArray("BATCH_ID",u.UNSIGNED_SHORT,1),t.batchIds)){const s=e.getGlobalProperty("BATCH_LENGTH");if(!s)throw new Error("Global property: BATCH_LENGTH must be defined when BATCH_ID is defined.");const{batchTableJson:r,batchTableBinary:n}=t;i=new I(r,n,s)}return i}(t,e);return{featureTable:e,batchTable:s}}(t);return await async function(t,e,i,s,r){let n,o,a;const h=t.batchTableJson&&t.batchTableJson.extensions&&t.batchTableJson.extensions["3DTILES_draco_point_compression"];h&&(a=h.properties);const c=e.getExtension("3DTILES_draco_point_compression");if(c){o=c.properties;const e=c.byteOffset,i=c.byteLength;if(!o||!Number.isFinite(e)||!i)throw new Error("Draco properties, byteOffset, and byteLength must be defined");n=t.featureTableBinary.slice(e,e+i),t.hasPositions=Number.isFinite(o.POSITION),t.hasColors=Number.isFinite(o.RGB)||Number.isFinite(o.RGBA),t.hasNormals=Number.isFinite(o.NORMAL),t.hasBatchIds=Number.isFinite(o.BATCH_ID),t.isTranslucent=Number.isFinite(o.RGBA)}if(!n)return!0;const u={buffer:n,properties:{...o,...a},featureTableProperties:o,batchTableProperties:a,dequantizeInShader:!1};return await async function(t,e,i,s){const{parse:r}=s,n={...i,draco:{...i.draco,extraAttributes:e.batchTableProperties||{}}};delete n["3d-tiles"];const o=await r(e.buffer,l.VJ,n),a=o.attributes.POSITION&&o.attributes.POSITION.value,h=o.attributes.COLOR_0&&o.attributes.COLOR_0.value,c=o.attributes.NORMAL&&o.attributes.NORMAL.value,u=o.attributes.BATCH_ID&&o.attributes.BATCH_ID.value,p=a&&o.attributes.POSITION.value.quantization,f=c&&o.attributes.NORMAL.value.quantization;if(p){const e=o.POSITION.data.quantization,i=e.range;t.quantizedVolumeScale=new d.Z(i,i,i),t.quantizedVolumeOffset=new d.Z(e.minValues),t.quantizedRange=(1<<e.quantizationBits)-1,t.isQuantizedDraco=!0}f&&(t.octEncodedRange=(1<<o.NORMAL.data.quantization.quantizationBits)-1,t.isOctEncodedDraco=!0);const m={};if(e.batchTableProperties)for(const l of Object.keys(e.batchTableProperties))o.attributes[l]&&o.attributes[l].value&&(m[l.toLowerCase()]=o.attributes[l].value);t.attributes={positions:a,colors:L(t,h,void 0),normals:c,batchIds:u,...m}}(t,u,s,r)}(t,n,0,s,r),function(t,e,i){if(!t.attributes.positions)if(e.hasProperty("POSITION"))t.attributes.positions=e.getPropertyArray("POSITION",u.FLOAT,3);else if(e.hasProperty("POSITION_QUANTIZED")){const s=e.getPropertyArray("POSITION_QUANTIZED",u.UNSIGNED_SHORT,3);if(t.isQuantized=!0,t.quantizedRange=65535,t.quantizedVolumeScale=e.getGlobalProperty("QUANTIZED_VOLUME_SCALE",u.FLOAT,3),!t.quantizedVolumeScale)throw new Error("QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");if(t.quantizedVolumeOffset=e.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",u.FLOAT,3),!t.quantizedVolumeOffset)throw new Error("QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");t.attributes.positions=k(t,s,i)}if(!t.attributes.positions)throw new Error("Either POSITION or POSITION_QUANTIZED must be defined.")}(t,n,s),function(t,e,i){if(!t.attributes.colors){let s=null;e.hasProperty("RGBA")?(s=e.getPropertyArray("RGBA",u.UNSIGNED_BYTE,4),t.isTranslucent=!0):e.hasProperty("RGB")?s=e.getPropertyArray("RGB",u.UNSIGNED_BYTE,3):e.hasProperty("RGB565")&&(s=e.getPropertyArray("RGB565",u.UNSIGNED_SHORT,1),t.isRGB565=!0),t.attributes.colors=L(t,s,i)}e.hasProperty("CONSTANT_RGBA")&&(t.constantRGBA=e.getGlobalProperty("CONSTANT_RGBA",u.UNSIGNED_BYTE,4))}(t,n,o),function(t,e){if(!t.attributes.normals){let i=null;e.hasProperty("NORMAL")?i=e.getPropertyArray("NORMAL",u.FLOAT,3):e.hasProperty("NORMAL_OCT16P")&&(i=e.getPropertyArray("NORMAL_OCT16P",u.UNSIGNED_BYTE,2),t.isOctEncoded16P=!0),t.attributes.normals=function(t,e){if(!e)return null;if(t.isOctEncoded16P){const i=new Float32Array(3*t.pointsLength);for(let s=0;s<t.pointsLength;s++)q(e[2*s],e[2*s+1],H),H.toArray(i,3*s);return{type:u.FLOAT,size:2,value:i}}return{type:u.FLOAT,size:2,value:e}}(t,i)}}(t,n),i}var j=i(661),Y=i(51637);const J={URI:0,EMBEDDED:1};function W(t,e,i,s){t.rotateYtoZ=!0;const r=t.byteOffset+t.byteLength-i;if(0===r)throw new Error("glTF byte length must be greater than 0.");return t.gltfUpAxis=s["3d-tiles"]&&s["3d-tiles"].assetGltfUpAxis?s["3d-tiles"].assetGltfUpAxis:"Y",t.gltfArrayBuffer=(0,Y.qv)(e,i,r),t.gltfByteOffset=0,t.gltfByteLength=r,i%4==0||console.warn("".concat(t.type,": embedded glb is not aligned to a 4-byte boundary.")),t.byteOffset+t.byteLength}async function X(t,e,i,s){const r=i["3d-tiles"]||{};if(function(t,e,i){switch(e){case J.URI:const e=new Uint8Array(t.gltfArrayBuffer,t.gltfByteOffset),i=(new TextDecoder).decode(e);t.gltfUrl=i.replace(/[\s\0]+$/,""),delete t.gltfArrayBuffer,delete t.gltfByteOffset,delete t.gltfByteLength;break;case J.EMBEDDED:break;default:throw new Error("b3dm: Illegal glTF format field")}}(t,e),r.loadGLTF){const{parse:e,fetch:r}=s;t.gltfUrl&&(t.gltfArrayBuffer=await r(t.gltfUrl,i),t.gltfByteOffset=0),t.gltfArrayBuffer&&(t.gltf=await e(t.gltfArrayBuffer,j.E,i,s),delete t.gltfArrayBuffer,delete t.gltfByteOffset,delete t.gltfByteLength)}}async function $(t,e,i,s,r){var n;i=function(t,e,i,s,r){i=R(t,e,i),i=D(t,e,i),i=P(t,e,i),i=W(t,e,i,s);const n=new _(t.featureTableJson,t.featureTableBinary);return t.rtcCenter=n.getGlobalProperty("RTC_CENTER",u.FLOAT,3),i}(t,e,i,s),await X(t,J.EMBEDDED,s,r);const o=null==t||null===(n=t.gltf)||void 0===n?void 0:n.extensions;return o&&o.CESIUM_RTC&&(t.rtcCenter=o.CESIUM_RTC.center),i}var K=i(41737),tt=i(41855),et=i(76450),it=i(73253);async function st(t,e,i,s,r){return i=function(t,e,i,s,r){if(i=R(t,e,i),1!==t.version)throw new Error("Instanced 3D Model version ".concat(t.version," is not supported"));i=D(t,e,i);const n=new DataView(e);if(t.gltfFormat=n.getUint32(i,!0),i+=4,i=P(t,e,i),i=W(t,e,i,s),0===t.featureTableJsonByteLength)throw new Error("i3dm parser: featureTableJsonByteLength is zero.");const o=new _(t.featureTableJson,t.featureTableBinary),a=o.getGlobalProperty("INSTANCES_LENGTH");if(o.featuresLength=a,!Number.isFinite(a))throw new Error("i3dm parser: INSTANCES_LENGTH must be defined");t.eastNorthUp=o.getGlobalProperty("EAST_NORTH_UP"),t.rtcCenter=o.getGlobalProperty("RTC_CENTER",u.FLOAT,3);new I(t.batchTableJson,t.batchTableBinary,a);return function(t,e,i,s){const r={instances:new Array(s),batchTable:t._batchTable,cull:!1,url:void 0,gltf:void 0,basePath:void 0,incrementallyLoadTextures:!1,forwardAxis:[1,0,0]},n=r.instances,o=new d.Z,a=new d.Z,h=new d.Z,l=new d.Z,c=new K.Z,p=new tt.Z,f=new d.Z,m={},y=new et.Z,T=[],_=[],g=new d.Z,b=new d.Z;for(let d=0;d<s;d++){let i;if(e.hasProperty("POSITION"))i=e.getProperty("POSITION",u.FLOAT,3,d,o);else if(e.hasProperty("POSITION_QUANTIZED")){i=e.getProperty("POSITION_QUANTIZED",u.UNSIGNED_SHORT,3,d,o);const t=e.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",u.FLOAT,3,g);if(!t)throw new Error("i3dm parser: QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");const s=e.getGlobalProperty("QUANTIZED_VOLUME_SCALE",u.FLOAT,3,b);if(!s)throw new Error("i3dm parser: QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");const r=65535;for(let e=0;e<3;e++)i[e]=i[e]/r*s[e]+t[e]}if(!i)throw new Error("i3dm: POSITION or POSITION_QUANTIZED must be defined for each instance.");o.copy(i),m.translation=o,t.normalUp=e.getProperty("NORMAL_UP",u.FLOAT,3,d,T),t.normalRight=e.getProperty("NORMAL_RIGHT",u.FLOAT,3,d,_);const s=!1;if(t.normalUp){if(!t.normalRight)throw new Error("i3dm: Custom orientation requires both NORMAL_UP and NORMAL_RIGHT.");t.hasCustomOrientation=!0}else{if(t.octNormalUp=e.getProperty("NORMAL_UP_OCT32P",u.UNSIGNED_SHORT,2,T),t.octNormalRight=e.getProperty("NORMAL_RIGHT_OCT32P",u.UNSIGNED_SHORT,2,_),t.octNormalUp){if(!t.octNormalRight)throw new Error("i3dm: oct-encoded orientation requires NORMAL_UP_OCT32P and NORMAL_RIGHT_OCT32P");throw new Error("i3dm: oct-encoded orientation not implemented")}t.eastNorthUp?(it.H.WGS84.eastNorthUpToFixedFrame(o,y),y.getRotationMatrix3(c)):c.identity()}s&&(l.copy(a).cross(h).normalize(),c.setColumn(0,a),c.setColumn(1,h),c.setColumn(2,l)),p.fromMatrix3(c),m.rotation=p,f.set(1,1,1);const r=e.getProperty("SCALE",u.FLOAT,1,d);Number.isFinite(r)&&f.multiplyByScalar(r);const v=e.getProperty("SCALE_NON_UNIFORM",u.FLOAT,3,d,T);v&&f.scale(v),m.scale=f;let w=e.getProperty("BATCH_ID",u.UNSIGNED_SHORT,1,d);void 0===w&&(w=d);const E=(new et.Z).fromQuaternion(m.rotation);y.identity(),y.translate(m.translation),y.multiplyRight(E),y.scale(m.scale);const S=y.clone();n[d]={modelMatrix:S,batchId:w}}t.instances=n}(t,o,0,a),i}(t,e,i,s),await X(t,t.gltfFormat,s,r),i}async function rt(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};switch(r.byteOffset=e,r.type=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const i=new DataView(t);return"".concat(String.fromCharCode(i.getUint8(e+0))).concat(String.fromCharCode(i.getUint8(e+1))).concat(String.fromCharCode(i.getUint8(e+2))).concat(String.fromCharCode(i.getUint8(e+3)))}(t,e),r.type){case o.COMPOSITE:return await async function(t,e,i,s,r,n){i=R(t,e,i);const o=new DataView(e);for(t.tilesLength=o.getUint32(i,!0),i+=4,t.tiles=[];t.tiles.length<t.tilesLength&&t.byteLength-i>12;){const o={};t.tiles.push(o),i=await n(e,i,s,r,o)}return i}(r,t,e,i,s,rt);case o.BATCHED_3D_MODEL:return await $(r,t,e,i,s);case o.GLTF:return await async function(t,e,i,s){t.rotateYtoZ=!0,t.gltfUpAxis=i["3d-tiles"]&&i["3d-tiles"].assetGltfUpAxis?i["3d-tiles"].assetGltfUpAxis:"Y";const{parse:r}=s;t.gltf=await r(e,j.E,i,s)}(r,t,i,s);case o.INSTANCED_3D_MODEL:return await st(r,t,e,i,s);case o.POINT_CLOUD:return await Q(r,t,e,i,s);default:throw new Error("3DTileLoader: unknown type ".concat(r.type))}}const nt=1952609651,ot=1;async function at(t,e,i,s){const r=t[e].bufferView,n=t.bufferViews[r],o=t.buffers[n.buffer];if(null==s||!s.url||!s.fetch)throw new Error("Url is not provided");if(!s.fetch)throw new Error("fetch is not provided");if(o.uri){const t=function(t,e){if(e.startsWith("http")){const i=new URL(t,e);return decodeURI(i.toString())}const i="http://".concat(e),s=new URL(t,i);return"/".concat(s.host).concat(s.pathname)}(o.uri,null==s?void 0:s.url),e=await s.fetch(t),i=await e.arrayBuffer();return new Uint8Array(i,n.byteOffset,n.byteLength)}return new Uint8Array(i,n.byteOffset,n.byteLength)}function ht(t){const e=new DataView(t);return e.getUint32(0,!0)+2**32*e.getUint32(4,!0)}const lt={id:"3d-tiles-subtree",name:"3D Tiles Subtree",module:"3d-tiles",version:n,extensions:["subtree"],mimeTypes:["application/octet-stream"],tests:["subtree"],parse:async function(t,e,i){if(new Uint32Array(t.slice(0,4))[0]!==nt)throw new Error("Wrong subtree file magic number");if(new Uint32Array(t.slice(4,8))[0]!==ot)throw new Error("Wrong subtree file verson, must be 1");const s=ht(t.slice(8,16)),r=new Uint8Array(t,24,s),n=new TextDecoder("utf8").decode(r),o=JSON.parse(n),a=ht(t.slice(16,24));let h=new ArrayBuffer(0);return a&&(h=t.slice(24+s)),"bufferView"in o.tileAvailability&&(o.tileAvailability.explicitBitstream=await at(o,"tileAvailability",h,i)),"bufferView"in o.contentAvailability&&(o.contentAvailability.explicitBitstream=await at(o,"contentAvailability",h,i)),"bufferView"in o.childSubtreeAvailability&&(o.childSubtreeAvailability.explicitBitstream=await at(o,"childSubtreeAvailability",h,i)),o},options:{}};var ct=i(96742);const ut={QUADTREE:4,OCTREE:8};async function dt(t){const{options:e,parentData:i={mortonIndex:0,x:0,y:0,z:0},childIndex:s=0,globalData:r={level:0,mortonIndex:0,x:0,y:0,z:0}}=t;let{subtree:n,level:o=0}=t;const{subdivisionScheme:a,subtreeLevels:h,maximumLevel:l,contentUrlTemplate:c,subtreesUriTemplate:u,basePath:d}=e,p={children:[],lodMetricValue:0,contentUrl:""},f=ut[a],m=1&s,y=s>>1&1,T=s>>2&1,_=(f**o-1)/(f-1);let g=mt(i.mortonIndex,s),b=_+g,v=mt(i.x,m),w=mt(i.y,y),E=mt(i.z,T),S=!1;o+1>h&&(S=pt(n.childSubtreeAvailability,g));const A=mt(r.x,v),Z=mt(r.y,w),N=mt(r.z,E),O=o+r.level;if(S){const t=yt("".concat(d,"/").concat(u),O,A,Z,N);n=await(0,ct.z)(t,lt),r.mortonIndex=g,r.x=v,r.y=w,r.z=E,r.level=o,g=0,b=0,v=0,w=0,E=0,o=0}if(!pt(n.tileAvailability,b)||o>l)return p;pt(n.contentAvailability,b)&&(p.contentUrl=yt(c,O,A,Z,N));const I=o+1,C={mortonIndex:g,x:v,y:w,z:E};for(let R=0;R<f;R++){const t=await dt({subtree:n,options:e,parentData:C,childIndex:R,level:I,globalData:r});if(t.contentUrl||t.children.length){const i=ft(t,O+1,{childTileX:v,childTileY:w,childTileZ:E},e);p.children.push(i)}}return p}function pt(t,e){return"constant"in t?Boolean(t.constant):!!t.explicitBitstream&&function(t,e){const i=Math.floor(t/8),s=t%8;return 1==(e[i]>>s&1)}(e,t.explicitBitstream)}function ft(t,e,i,s){const{basePath:r,refine:n,getRefine:o,lodMetricType:a,getTileType:h,rootLodMetricValue:l,rootBoundingVolume:c}=s,u=t.contentUrl&&t.contentUrl.replace("".concat(r,"/"),""),d=l/2**e,p=function(t,e,i){if(e.region){const{childTileX:s,childTileY:r,childTileZ:n}=i,[o,a,h,l,c,u]=e.region,d=2**t,p=(h-o)/d,f=(l-a)/d,m=(u-c)/d,[y,T]=[o+p*s,o+p*(s+1)],[_,g]=[a+f*r,a+f*(r+1)],[b,v]=[c+m*n,c+m*(n+1)];return{region:[y,_,T,g,b,v]}}return console.warn("Unsupported bounding volume type: ",e),null}(e,c,i);return{children:t.children,contentUrl:t.contentUrl,content:{uri:u},id:t.contentUrl,refine:o(n),type:h(t),lodMetricType:a,lodMetricValue:d,geometricError:d,transform:t.transform,boundingVolume:p}}function mt(t,e){return parseInt(t.toString(2)+e.toString(2),2)}function yt(t,e,i,s,r){const n=function(t){const e={};for(const i in t)e["{".concat(i,"}")]=t[i];return e}({level:e,x:i,y:s,z:r});return t.replace(/{level}|{x}|{y}|{z}/gi,(t=>n[t]))}function Tt(t){if(!t.contentUrl)return r.R7.EMPTY;const e=t.contentUrl.split(".").pop();switch(e){case"pnts":return r.R7.POINTCLOUD;case"i3dm":case"b3dm":case"glb":case"gltf":return r.R7.SCENEGRAPH;default:return e}}function _t(t){switch(t){case"REPLACE":case"replace":return r.F$.REPLACE;case"ADD":case"add":return r.F$.ADD;default:return t}}function gt(t,e){if(/^[a-z][0-9a-z+.-]*:/i.test(e)){const i=new URL(t,"".concat(e,"/"));return decodeURI(i.toString())}return t.startsWith("/")?t:"".concat(e,"/").concat(t)}function bt(t,e){if(!t)return null;if(t.content){const i=t.content.uri||t.content.url;t.contentUrl=gt(i,e.basePath)}return t.id=t.contentUrl,t.lodMetricType=r.ci.GEOMETRIC_ERROR,t.lodMetricValue=t.geometricError,t.transformMatrix=t.transform,t.type=Tt(t),t.refine=_t(t.refine),t}async function vt(t,e,i,s){var n;const o=e.basePath,{subdivisionScheme:a,maximumLevel:h,subtreeLevels:l,subtrees:{uri:c}}=i,u=gt(yt(c,0,0,0,0),o),d=await(0,ct.z)(u,lt,s),p=gt(t.content.uri,o),f=null==e||null===(n=e.root)||void 0===n?void 0:n.refine,m=t.geometricError,y=t.boundingVolume,T={contentUrlTemplate:p,subtreesUriTemplate:c,subdivisionScheme:a,subtreeLevels:l,maximumLevel:h,refine:f,basePath:o,lodMetricType:r.ci.GEOMETRIC_ERROR,rootLodMetricValue:m,rootBoundingVolume:y,getTileType:Tt,getRefine:_t};return await async function(t,e,i){if(!t)return null;t.lodMetricType=r.ci.GEOMETRIC_ERROR,t.lodMetricValue=t.geometricError,t.transformMatrix=t.transform;const{children:s,contentUrl:n}=await dt({subtree:e,options:i});n&&(t.contentUrl=n,t.content={uri:n.replace("".concat(i.basePath,"/"),"")});return t.refine=_t(t.refine),t.type=Tt(t),t.children=s,t.id=t.contentUrl,t}(t,d,T)}function wt(t){var e;return(null==t||null===(e=t.extensions)||void 0===e?void 0:e["3DTILES_implicit_tiling"])||(null==t?void 0:t.implicitTiling)}const Et={id:"3d-tiles",name:"3D Tiles",module:"3d-tiles",version:n,extensions:["cmpt","pnts","b3dm","i3dm"],mimeTypes:["application/octet-stream"],tests:["cmpt","pnts","b3dm","i3dm"],parse:async function(t,e,i){const n=e["3d-tiles"]||{};let o;o="auto"===n.isTileset?i.url&&-1!==i.url.indexOf(".json"):n.isTileset;t=o?await async function(t,e,i){var n;const o=JSON.parse((new TextDecoder).decode(t));return o.loader=e.loader||Et,o.url=i.url,o.basePath=function(t){return s.XX(t.url)}(o),o.root=await async function(t,e){const i=t.basePath;let s;const r=wt(null==t?void 0:t.root);s=r&&t.root?await vt(t.root,t,r,e):bt(t.root,t);const n=[];for(n.push(s);n.length>0;){const s=(n.pop()||{}).children||[];for(let r of s){const s=wt(r);s?r=await vt(r,t,s,e):bt(r,{basePath:i}),n.push(r)}}return s}(o,e),o.type=r.i3.TILES3D,o.lodMetricType=r.ci.GEOMETRIC_ERROR,o.lodMetricValue=(null===(n=o.root)||void 0===n?void 0:n.lodMetricValue)||0,o}(t,e,i):await async function(t,e,i){const s={content:{featureIds:null}},r=0;return await rt(t,r,e,i,s.content),s.content}(t,e,i);return t},options:{"3d-tiles":{loadGLTF:!0,decodeQuantizedPositions:!1,isTileset:"auto",assetGltfUpAxis:null}}}},66757:(t,e,i)=>{i.d(e,{F$:()=>r,Qb:()=>s,R7:()=>n,ci:()=>a,fB:()=>h,i3:()=>o});const s={UNLOADED:0,LOADING:1,PROCESSING:2,READY:3,EXPIRED:4,FAILED:5},r={ADD:1,REPLACE:2},n={EMPTY:"empty",SCENEGRAPH:"scenegraph",POINTCLOUD:"pointcloud",MESH:"mesh"},o={I3S:"I3S",TILES3D:"TILES3D"},a={GEOMETRIC_ERROR:"geometricError",MAX_SCREEN_THRESHOLD:"maxScreenThreshold"},h={NOT_COMPUTED:-1,USE_OPTIMIZATION:1,SKIP_OPTIMIZATION:0}},20427:(t,e,i)=>{i.d(e,{u:()=>Tt});var s=i(4942),r=i(76450),n=i(59122),o=i(73253),a=i(23881),h=i(87346),l=i(10786),c=i(64174);class u{constructor(t,e,i){(0,s.Z)(this,"item",void 0),(0,s.Z)(this,"previous",void 0),(0,s.Z)(this,"next",void 0),this.item=t,this.previous=e,this.next=i}}class d{constructor(){(0,s.Z)(this,"head",null),(0,s.Z)(this,"tail",null),(0,s.Z)(this,"_length",0)}get length(){return this._length}add(t){const e=new u(t,this.tail,null);return this.tail?(this.tail.next=e,this.tail=e):(this.head=e,this.tail=e),++this._length,e}remove(t){t&&(t.previous&&t.next?(t.previous.next=t.next,t.next.previous=t.previous):t.previous?(t.previous.next=null,this.tail=t.previous):t.next?(t.next.previous=null,this.head=t.next):(this.head=null,this.tail=null),t.next=null,t.previous=null,--this._length)}splice(t,e){t!==e&&(this.remove(e),this._insert(t,e))}_insert(t,e){const i=t.next;t.next=e,this.tail===t?this.tail=e:i.previous=e,e.next=i,e.previous=t,++this._length}}function p(t){return null!=t}class f{constructor(){(0,s.Z)(this,"_list",void 0),(0,s.Z)(this,"_sentinel",void 0),(0,s.Z)(this,"_trimTiles",void 0),this._list=new d,this._sentinel=this._list.add("sentinel"),this._trimTiles=!1}reset(){this._list.splice(this._list.tail,this._sentinel)}touch(t){const e=t._cacheNode;p(e)&&this._list.splice(this._sentinel,e)}add(t,e,i){p(e._cacheNode)||(e._cacheNode=this._list.add(e),i&&i(t,e))}unloadTile(t,e,i){const s=e._cacheNode;p(s)&&(this._list.remove(s),e._cacheNode=void 0,i&&i(t,e))}unloadTiles(t,e){const i=this._trimTiles;this._trimTiles=!1;const s=this._list,r=1024*t.maximumMemoryUsage*1024,n=this._sentinel;let o=s.head;for(;o!==n&&(t.gpuMemoryUsageInBytes>r||i);){const i=o.item;o=o.next,this.unloadTile(t,i,e)}}trim(){this._trimTiles=!0}}var m=i(37695);const y=new n.Z,T=new n.Z,_=new m.Mh([new m.JO,new m.JO,new m.JO,new m.JO,new m.JO,new m.JO]);function g(t,e){const{cameraDirection:i,cameraUp:s,height:r}=t,{metersPerUnit:a}=t.distanceScales,h=v(t,t.center),l=o.H.WGS84.eastNorthUpToFixedFrame(h),c=t.unprojectPosition(t.cameraPosition),u=o.H.WGS84.cartographicToCartesian(c,new n.Z),d=new n.Z(l.transformAsVector(new n.Z(i).scale(a))).normalize(),p=new n.Z(l.transformAsVector(new n.Z(s).scale(a))).normalize();!function(t){const e=t.getFrustumPlanes(),i=b(e.near,t.cameraPosition),s=v(t,i),r=v(t,t.cameraPosition,T);let n=0;_.planes[n++].fromPointNormal(s,y.copy(s).subtract(r));for(const o in e){if("near"===o)continue;const r=v(t,b(e[o],i,T),T);_.planes[n++].fromPointNormal(r,y.copy(s).subtract(r))}}(t);const f=t.constructor,{longitude:m,latitude:g,width:w,bearing:E,zoom:S}=t;return{camera:{position:u,direction:d,up:p},viewport:t,topDownViewport:new f({longitude:m,latitude:g,height:r,width:w,bearing:E,zoom:S,pitch:0}),height:r,cullingVolume:_,frameNumber:e,sseDenominator:1.15}}function b(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new n.Z;const s=t.normal.dot(e);return i.copy(t.normal).scale(t.distance-s).add(e),i}function v(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new n.Z;const s=t.unprojectPosition(e);return o.H.WGS84.cartographicToCartesian(s,i)}const w=6378137,E=6378137,S=6356752.314245179,A=new n.Z;function Z(t,e){if(t instanceof m.F7){const{halfAxes:i}=t,s=function(t){t.getColumn(0,A);const e=t.getColumn(1),i=t.getColumn(2),s=A.add(e).add(i);return s.len()}(i);return Math.log2(S/(s+e[2]))}if(t instanceof m.KM){const{radius:i}=t;return Math.log2(S/(i+e[2]))}if(t.width&&t.height){const{width:e,height:i}=t;return(Math.log2(w/e)+Math.log2(E/i))/2}return 1}function N(t,e,i){const s=o.H.WGS84.cartographicToCartesian([t.xmax,t.ymax,t.zmax],new n.Z),r=Math.sqrt(Math.pow(s[0]-i[0],2)+Math.pow(s[1]-i[1],2)+Math.pow(s[2]-i[2],2));return Math.log2(S/(r+e[2]))}var O=i(96742),I=i(66757),C=i(28835),R=i(41855),x=i(41737);function M(t){return null!=t}const D=new n.Z,P=new n.Z,U=new n.Z;function L(t,e,i){if((0,h.h)(t,"3D Tile: boundingVolume must be defined"),t.box)return function(t,e,i){const s=new n.Z(t[0],t[1],t[2]);e.transform(s,s);let r=[];if(10===t.length){const e=t.slice(3,6),i=new R.Z;i.fromArray(t,6);const s=new n.Z([1,0,0]),o=new n.Z([0,1,0]),a=new n.Z([0,0,1]);s.transformByQuaternion(i),s.scale(e[0]),o.transformByQuaternion(i),o.scale(e[1]),a.transformByQuaternion(i),a.scale(e[2]),r=[...s.toArray(),...o.toArray(),...a.toArray()]}else r=[...t.slice(3,6),...t.slice(6,9),...t.slice(9,12)];const o=e.transformAsVector(r.slice(0,3)),a=e.transformAsVector(r.slice(3,6)),h=e.transformAsVector(r.slice(6,9)),l=new x.Z([o[0],o[1],o[2],a[0],a[1],a[2],h[0],h[1],h[2]]);if(M(i))return i.center=s,i.halfAxes=l,i;return new m.F7(s,l)}(t.box,e,i);if(t.region){const[e,i,s,a,h,l]=t.region,c=o.H.WGS84.cartographicToCartesian([(0,C.RW)(e),(0,C.RW)(a),h],P),u=o.H.WGS84.cartographicToCartesian([(0,C.RW)(s),(0,C.RW)(i),l],U),d=(new n.Z).addVectors(c,u).multiplyScalar(.5),p=(new n.Z).subVectors(c,u).len()/2;return V([d[0],d[1],d[2],p],new r.Z)}if(t.sphere)return V(t.sphere,e,i);throw new Error("3D Tile: boundingVolume must contain a sphere, region, or box")}function V(t,e,i){const s=new n.Z(t[0],t[1],t[2]);e.transform(s,s);const r=e.getScale(D),o=Math.max(Math.max(r[0],r[1]),r[2]),a=t[3]*o;return M(i)?(i.center=s,i.radius=a,i):new m.KM(s,a)}new n.Z,new n.Z,new r.Z,new n.Z,new n.Z,new n.Z;function B(t,e){if(t.dynamicScreenSpaceError&&t.dynamicScreenSpaceErrorComputedDensity){const i=t.dynamicScreenSpaceErrorComputedDensity,s=t.dynamicScreenSpaceErrorFactor,r=function(t,e){const i=t*e;return 1-Math.exp(-i*i)}(e,i)*s;return r}return 0}const z=new n.Z,F=new n.Z,G=new n.Z,q=new n.Z,H=new n.Z,k=new r.Z,Q=new r.Z;function j(t,e){const{topDownViewport:i}=e,s=t.header.mbs[1],r=t.header.mbs[0],n=t.header.mbs[2],a=t.header.mbs[3],h=[...t.boundingVolume.center],l=i.unprojectPosition(i.cameraPosition);o.H.WGS84.cartographicToCartesian(l,z),F.copy(z).subtract(h).normalize(),o.H.WGS84.eastNorthUpToFixedFrame(h,k),Q.copy(k).invert(),G.copy(z).transform(Q);const c=Math.sqrt(G[0]*G[0]+G[1]*G[1]),u=c*c/G[2];q.copy([G[0],G[1],u]);const d=q.transform(k).subtract(h).normalize(),p=F.cross(d).normalize().scale(a).add(h),f=o.H.WGS84.cartesianToCartographic(p),m=i.project([r,s,n]),y=i.project(f);return H.copy(m).subtract(y).magnitude()}class Y{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;(0,s.Z)(this,"_map",new Map),(0,s.Z)(this,"_array",void 0),(0,s.Z)(this,"_length",void 0),this._array=new Array(t),this._length=t}get length(){return this._length}set length(t){this._length=t,t>this._array.length&&(this._array.length=t)}get values(){return this._array}get(t){return(0,h.h)(t<this._array.length),this._array[t]}set(t,e){(0,h.h)(t>=0),t>=this.length&&(this.length=t+1),this._map.has(this._array[t])&&this._map.delete(this._array[t]),this._array[t]=e,this._map.set(e,t)}delete(t){const e=this._map.get(t);e>=0&&(this._array.splice(e,1),this._map.delete(t),this.length--)}peek(){return this._array[this._length-1]}push(t){if(!this._map.has(t)){const e=this.length++;this._array[e]=t,this._map.set(t,e)}}pop(){const t=this._array[--this.length];return this._map.delete(t),t}reserve(t){(0,h.h)(t>=0),t>this._array.length&&(this._array.length=t)}resize(t){(0,h.h)(t>=0),this.length=t}trim(t){null==t&&(t=this.length),this._array.length=t}reset(){this._array=[],this._map=new Map,this._length=0}find(t){return this._map.has(t)}}const J={loadSiblings:!1,skipLevelOfDetail:!1,maximumScreenSpaceError:2,updateTransforms:!0,onTraversalEnd:()=>{},viewportTraversersMap:{},basePath:""};class W{traversalFinished(t){return!0}constructor(t){(0,s.Z)(this,"options",void 0),(0,s.Z)(this,"root",void 0),(0,s.Z)(this,"requestedTiles",void 0),(0,s.Z)(this,"selectedTiles",void 0),(0,s.Z)(this,"emptyTiles",void 0),(0,s.Z)(this,"lastUpdate",(new Date).getTime()),(0,s.Z)(this,"updateDebounceTime",1e3),(0,s.Z)(this,"_traversalStack",void 0),(0,s.Z)(this,"_emptyTraversalStack",void 0),(0,s.Z)(this,"_frameNumber",void 0),this.options={...J,...t},this._traversalStack=new Y,this._emptyTraversalStack=new Y,this._frameNumber=null,this.root=null,this.selectedTiles={},this.requestedTiles={},this.emptyTiles={}}traverse(t,e,i){this.root=t,this.options={...this.options,...i},this.reset(),this.updateTile(t,e),this._frameNumber=e.frameNumber,this.executeTraversal(t,e)}reset(){this.requestedTiles={},this.selectedTiles={},this.emptyTiles={},this._traversalStack.reset(),this._emptyTraversalStack.reset()}executeTraversal(t,e){const i=this._traversalStack;for(t._selectionDepth=1,i.push(t);i.length>0;){const t=i.pop();let s=!1;this.canTraverse(t,e)&&(this.updateChildTiles(t,e),s=this.updateAndPushChildren(t,e,i,t.hasRenderContent?t._selectionDepth+1:t._selectionDepth));const r=t.parent,n=Boolean(!r||r._shouldRefine),o=!s;t.hasRenderContent?t.refine===I.F$.ADD?(this.loadTile(t,e),this.selectTile(t,e)):t.refine===I.F$.REPLACE&&(this.loadTile(t,e),o&&this.selectTile(t,e)):(this.emptyTiles[t.id]=t,this.loadTile(t,e),o&&this.selectTile(t,e)),this.touchTile(t,e),t._shouldRefine=s&&n}const s=(new Date).getTime();(this.traversalFinished(e)||s-this.lastUpdate>this.updateDebounceTime)&&(this.lastUpdate=s,this.options.onTraversalEnd(e))}updateChildTiles(t,e){const i=t.children;for(const s of i)this.updateTile(s,e);return!0}updateAndPushChildren(t,e,i,s){const{loadSiblings:r,skipLevelOfDetail:n}=this.options,o=t.children;o.sort(this.compareDistanceToCamera.bind(this));const a=t.refine===I.F$.REPLACE&&t.hasRenderContent&&!n;let h=!1,l=!0;for(const c of o)if(c._selectionDepth=s,c.isVisibleAndInRequestVolume?(i.find(c)&&i.delete(c),i.push(c),h=!0):(a||r)&&(this.loadTile(c,e),this.touchTile(c,e)),a){let t;if(t=!!c._inRequestVolume&&(c.hasRenderContent?c.contentAvailable:this.executeEmptyTraversal(c,e)),l=l&&t,!l)return!1}return h||(l=!1),l}updateTile(t,e){this.updateTileVisibility(t,e)}selectTile(t,e){this.shouldSelectTile(t)&&(t._selectedFrame=e.frameNumber,this.selectedTiles[t.id]=t)}loadTile(t,e){this.shouldLoadTile(t)&&(t._requestedFrame=e.frameNumber,t._priority=t._getPriority(),this.requestedTiles[t.id]=t)}touchTile(t,e){t.tileset._cache.touch(t),t._touchedFrame=e.frameNumber}canTraverse(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return!!t.hasChildren&&(t.hasTilesetContent?!t.contentExpired:!(!s&&!t.isVisibleAndInRequestVolume)&&this.shouldRefine(t,e,i))}shouldLoadTile(t){return t.hasUnloadedContent||t.contentExpired}shouldSelectTile(t){return t.contentAvailable&&!this.options.skipLevelOfDetail}shouldRefine(t,e,i){let s=t._screenSpaceError;return i&&(s=t.getScreenSpaceError(e,!0)),s>this.options.maximumScreenSpaceError}updateTileVisibility(t,e){const i=[];if(this.options.viewportTraversersMap)for(const s in this.options.viewportTraversersMap){this.options.viewportTraversersMap[s]===e.viewport.id&&i.push(s)}else i.push(e.viewport.id);t.updateVisibility(e,i)}compareDistanceToCamera(t,e){return t._distanceToCamera-e._distanceToCamera}anyChildrenVisible(t,e){let i=!1;for(const s of t.children)s.updateVisibility(e),i=i||s.isVisibleAndInRequestVolume;return i}executeEmptyTraversal(t,e){let i=!0;const s=this._emptyTraversalStack;for(s.push(t);s.length>0&&i;){const t=s.pop();this.updateTile(t,e),t.isVisibleAndInRequestVolume||this.loadTile(t,e),this.touchTile(t,e);if(!t.hasRenderContent&&this.canTraverse(t,e,!1,!0)){const e=t.children;for(const t of e)s.find(t)&&s.delete(t),s.push(t)}else t.contentAvailable||(i=!1)}return i}}const X=new n.Z;class ${constructor(t,e,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";(0,s.Z)(this,"tileset",void 0),(0,s.Z)(this,"header",void 0),(0,s.Z)(this,"id",void 0),(0,s.Z)(this,"url",void 0),(0,s.Z)(this,"parent",void 0),(0,s.Z)(this,"refine",void 0),(0,s.Z)(this,"type",void 0),(0,s.Z)(this,"contentUrl",void 0),(0,s.Z)(this,"lodMetricType",void 0),(0,s.Z)(this,"lodMetricValue",void 0),(0,s.Z)(this,"boundingVolume",void 0),(0,s.Z)(this,"content",void 0),(0,s.Z)(this,"contentState",void 0),(0,s.Z)(this,"gpuMemoryUsageInBytes",void 0),(0,s.Z)(this,"children",void 0),(0,s.Z)(this,"depth",void 0),(0,s.Z)(this,"viewportIds",void 0),(0,s.Z)(this,"transform",void 0),(0,s.Z)(this,"extensions",void 0),(0,s.Z)(this,"implicitTiling",void 0),(0,s.Z)(this,"userData",void 0),(0,s.Z)(this,"computedTransform",void 0),(0,s.Z)(this,"hasEmptyContent",void 0),(0,s.Z)(this,"hasTilesetContent",void 0),(0,s.Z)(this,"traverser",void 0),(0,s.Z)(this,"_cacheNode",void 0),(0,s.Z)(this,"_frameNumber",void 0),(0,s.Z)(this,"_lodJudge",void 0),(0,s.Z)(this,"_expireDate",void 0),(0,s.Z)(this,"_expiredContent",void 0),(0,s.Z)(this,"_shouldRefine",void 0),(0,s.Z)(this,"_distanceToCamera",void 0),(0,s.Z)(this,"_centerZDepth",void 0),(0,s.Z)(this,"_screenSpaceError",void 0),(0,s.Z)(this,"_visibilityPlaneMask",void 0),(0,s.Z)(this,"_visible",void 0),(0,s.Z)(this,"_inRequestVolume",void 0),(0,s.Z)(this,"_stackLength",void 0),(0,s.Z)(this,"_selectionDepth",void 0),(0,s.Z)(this,"_touchedFrame",void 0),(0,s.Z)(this,"_visitedFrame",void 0),(0,s.Z)(this,"_selectedFrame",void 0),(0,s.Z)(this,"_requestedFrame",void 0),(0,s.Z)(this,"_priority",void 0),(0,s.Z)(this,"_contentBoundingVolume",void 0),(0,s.Z)(this,"_viewerRequestVolume",void 0),(0,s.Z)(this,"_initialTransform",void 0),this.header=e,this.tileset=t,this.id=n||e.id,this.url=e.url,this.parent=i,this.refine=this._getRefine(e.refine),this.type=e.type,this.contentUrl=e.contentUrl,this.lodMetricType="geometricError",this.lodMetricValue=0,this.boundingVolume=null,this.content=null,this.contentState=I.Qb.UNLOADED,this.gpuMemoryUsageInBytes=0,this.children=[],this.hasEmptyContent=!1,this.hasTilesetContent=!1,this.depth=0,this.viewportIds=[],this.userData={},this.extensions=null,this._priority=0,this._touchedFrame=0,this._visitedFrame=0,this._selectedFrame=0,this._requestedFrame=0,this._screenSpaceError=0,this._cacheNode=null,this._frameNumber=null,this._cacheNode=null,this.traverser=new W({}),this._shouldRefine=!1,this._distanceToCamera=0,this._centerZDepth=0,this._visible=void 0,this._inRequestVolume=!1,this._stackLength=0,this._selectionDepth=0,this._initialTransform=new r.Z,this.transform=new r.Z,this._initializeLodMetric(e),this._initializeTransforms(e),this._initializeBoundingVolumes(e),this._initializeContent(e),this._initializeRenderingState(e),this._lodJudge=null,this._expireDate=null,this._expiredContent=null,this.implicitTiling=null,Object.seal(this)}destroy(){this.header=null}isDestroyed(){return null===this.header}get selected(){return this._selectedFrame===this.tileset._frameNumber}get isVisible(){return this._visible}get isVisibleAndInRequestVolume(){return this._visible&&this._inRequestVolume}get hasRenderContent(){return!this.hasEmptyContent&&!this.hasTilesetContent}get hasChildren(){return this.children.length>0||this.header.children&&this.header.children.length>0}get contentReady(){return this.contentState===I.Qb.READY||this.hasEmptyContent}get contentAvailable(){return Boolean(this.contentReady&&this.hasRenderContent||this._expiredContent&&!this.contentFailed)}get hasUnloadedContent(){return this.hasRenderContent&&this.contentUnloaded}get contentUnloaded(){return this.contentState===I.Qb.UNLOADED}get contentExpired(){return this.contentState===I.Qb.EXPIRED}get contentFailed(){return this.contentState===I.Qb.FAILED}get distanceToCamera(){return this._distanceToCamera}get screenSpaceError(){return this._screenSpaceError}getScreenSpaceError(t,e){switch(this.tileset.type){case I.i3.I3S:return j(this,t);case I.i3.TILES3D:return function(t,e,i){const s=t.tileset,r=t.parent&&t.parent.lodMetricValue||t.lodMetricValue,n=i?r:t.lodMetricValue;if(0===n)return 0;const o=Math.max(t._distanceToCamera,1e-7),{height:a,sseDenominator:h}=e,{viewDistanceScale:l}=s.options;let c=n*a*(l||1)/(o*h);return c-=B(s,o),c}(this,t,e);default:throw new Error("Unsupported tileset type")}}unselect(){this._selectedFrame=0}_getPriority(){const t=this.tileset._traverser,{skipLevelOfDetail:e}=t.options,i=this.refine===I.F$.ADD||e;if(i&&!this.isVisible&&void 0!==this._visible)return-1;if(this.tileset._frameNumber-this._touchedFrame>=1)return-1;if(this.contentState===I.Qb.UNLOADED)return-1;const s=this.parent,r=s&&(!i||0===this._screenSpaceError||s.hasTilesetContent)?s._screenSpaceError:this._screenSpaceError,n=t.root?t.root._screenSpaceError:0;return Math.max(n-r,0)}async loadContent(){if(this.hasEmptyContent)return!1;if(this.content)return!0;this.contentExpired&&(this._expireDate=null),this.contentState=I.Qb.LOADING;const t=await this.tileset._requestScheduler.scheduleRequest(this.id,this._getPriority.bind(this));if(!t)return this.contentState=I.Qb.UNLOADED,!1;try{const t=this.tileset.getTileUrl(this.contentUrl),e=this.tileset.loader,i={...this.tileset.loadOptions,[e.id]:{...this.tileset.loadOptions[e.id],isTileset:"json"===this.type,...this._getLoaderSpecificOptions(e.id)}};return this.content=await(0,O.z)(t,e,i),this.tileset.options.contentLoader&&await this.tileset.options.contentLoader(this),this._isTileset()&&this.tileset._initializeTileHeaders(this.content,this),this.contentState=I.Qb.READY,this._onContentLoaded(),!0}catch(e){throw this.contentState=I.Qb.FAILED,e}finally{t.done()}}unloadContent(){return this.content&&this.content.destroy&&this.content.destroy(),this.content=null,this.header.content&&this.header.content.destroy&&this.header.content.destroy(),this.header.content=null,this.contentState=I.Qb.UNLOADED,!0}updateVisibility(t,e){if(this._frameNumber===t.frameNumber)return;const i=this.parent,s=i?i._visibilityPlaneMask:m.Mh.MASK_INDETERMINATE;if(this.tileset._traverser.options.updateTransforms){const t=i?i.computedTransform:this.tileset.modelMatrix;this._updateTransform(t)}this._distanceToCamera=this.distanceToTile(t),this._screenSpaceError=this.getScreenSpaceError(t,!1),this._visibilityPlaneMask=this.visibility(t,s),this._visible=this._visibilityPlaneMask!==m.Mh.MASK_OUTSIDE,this._inRequestVolume=this.insideViewerRequestVolume(t),this._frameNumber=t.frameNumber,this.viewportIds=e}visibility(t,e){const{cullingVolume:i}=t,{boundingVolume:s}=this;return i.computeVisibilityWithPlaneMask(s,e)}contentVisibility(){return!0}distanceToTile(t){const e=this.boundingVolume;return Math.sqrt(Math.max(e.distanceSquaredTo(t.camera.position),0))}cameraSpaceZDepth(t){let{camera:e}=t;const i=this.boundingVolume;return X.subVectors(i.center,e.position),e.direction.dot(X)}insideViewerRequestVolume(t){const e=this._viewerRequestVolume;return!e||e.distanceSquaredTo(t.camera.position)<=0}updateExpiration(){if(null!=this._expireDate&&this.contentReady&&!this.hasEmptyContent){const t=Date.now();Date.lessThan(this._expireDate,t)&&(this.contentState=I.Qb.EXPIRED,this._expiredContent=this.content)}}get extras(){return this.header.extras}_initializeLodMetric(t){"lodMetricType"in t?this.lodMetricType=t.lodMetricType:(this.lodMetricType=this.parent&&this.parent.lodMetricType||this.tileset.lodMetricType,console.warn("3D Tile: Required prop lodMetricType is undefined. Using parent lodMetricType")),"lodMetricValue"in t?this.lodMetricValue=t.lodMetricValue:(this.lodMetricValue=this.parent&&this.parent.lodMetricValue||this.tileset.lodMetricValue,console.warn("3D Tile: Required prop lodMetricValue is undefined. Using parent lodMetricValue"))}_initializeTransforms(t){this.transform=t.transform?new r.Z(t.transform):new r.Z;const e=this.parent,i=this.tileset,s=e&&e.computedTransform?e.computedTransform.clone():i.modelMatrix.clone();this.computedTransform=new r.Z(s).multiplyRight(this.transform);const n=e&&e._initialTransform?e._initialTransform.clone():new r.Z;this._initialTransform=new r.Z(n).multiplyRight(this.transform)}_initializeBoundingVolumes(t){this._contentBoundingVolume=null,this._viewerRequestVolume=null,this._updateBoundingVolume(t)}_initializeContent(t){this.content={_tileset:this.tileset,_tile:this},this.hasEmptyContent=!0,this.contentState=I.Qb.UNLOADED,this.hasTilesetContent=!1,t.contentUrl&&(this.content=null,this.hasEmptyContent=!1)}_initializeRenderingState(t){this.depth=t.level||(this.parent?this.parent.depth+1:0),this._shouldRefine=!1,this._distanceToCamera=0,this._centerZDepth=0,this._screenSpaceError=0,this._visibilityPlaneMask=m.Mh.MASK_INDETERMINATE,this._visible=void 0,this._inRequestVolume=!1,this._stackLength=0,this._selectionDepth=0,this._frameNumber=0,this._touchedFrame=0,this._visitedFrame=0,this._selectedFrame=0,this._requestedFrame=0,this._priority=0}_getRefine(t){return t||this.parent&&this.parent.refine||I.F$.REPLACE}_isTileset(){return-1!==this.contentUrl.indexOf(".json")}_onContentLoaded(){switch(this.content&&this.content.type){case"vctr":case"geom":this.tileset._traverser.disableSkipLevelOfDetail=!0}this._isTileset()&&(this.hasTilesetContent=!0)}_updateBoundingVolume(t){this.boundingVolume=L(t.boundingVolume,this.computedTransform,this.boundingVolume);const e=t.content;e&&(e.boundingVolume&&(this._contentBoundingVolume=L(e.boundingVolume,this.computedTransform,this._contentBoundingVolume)),t.viewerRequestVolume&&(this._viewerRequestVolume=L(t.viewerRequestVolume,this.computedTransform,this._viewerRequestVolume)))}_updateTransform(){const t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new r.Z).clone().multiplyRight(this.transform);!t.equals(this.computedTransform)&&(this.computedTransform=t,this._updateBoundingVolume(this.header))}_getLoaderSpecificOptions(t){return"i3s"===t?{...this.tileset.options.i3s,_tileOptions:{attributeUrls:this.header.attributeUrls,textureUrl:this.header.textureUrl,textureFormat:this.header.textureFormat,textureLoaderOptions:this.header.textureLoaderOptions,materialDefinition:this.header.materialDefinition,isDracoGeometry:this.header.isDracoGeometry,mbs:this.header.mbs},_tilesetOptions:{store:this.tileset.tileset.store,attributeStorageInfo:this.tileset.tileset.attributeStorageInfo,fields:this.tileset.tileset.fields},isTileHeader:!1}:{assetGltfUpAxis:(e=this.tileset.tileset).asset&&e.asset.gltfUpAxis||"Y"};var e}}class K extends W{compareDistanceToCamera(t,e){return 0===e._distanceToCamera&&0===t._distanceToCamera?e._centerZDepth-t._centerZDepth:e._distanceToCamera-t._distanceToCamera}updateTileVisibility(t,e){if(super.updateTileVisibility(t,e),!t.isVisibleAndInRequestVolume)return;const i=t.children.length>0;if(t.hasTilesetContent&&i){const i=t.children[0];return this.updateTileVisibility(i,e),void(t._visible=i._visible)}if(this.meetsScreenSpaceErrorEarly(t,e))return void(t._visible=!1);const s=t.refine===I.F$.REPLACE,r=t._optimChildrenWithinParent===I.fB.USE_OPTIMIZATION;s&&r&&i&&!this.anyChildrenVisible(t,e)&&(t._visible=!1)}meetsScreenSpaceErrorEarly(t,e){const{parent:i}=t;return!(!i||i.hasTilesetContent||i.refine!==I.F$.ADD)&&!this.shouldRefine(t,e,!0)}}class tt{constructor(){(0,s.Z)(this,"frameNumberMap",new Map)}register(t,e){const i=this.frameNumberMap.get(t)||new Map,s=i.get(e)||0;i.set(e,s+1),this.frameNumberMap.set(t,i)}deregister(t,e){const i=this.frameNumberMap.get(t);if(!i)return;const s=i.get(e)||1;i.set(e,s-1)}isZero(t,e){var i;return 0===((null===(i=this.frameNumberMap.get(t))||void 0===i?void 0:i.get(e))||0)}}const et="REQUESTED",it="COMPLETED",st="ERROR";class rt{constructor(){(0,s.Z)(this,"_statusMap",void 0),(0,s.Z)(this,"pendingTilesRegister",new tt),this._statusMap={}}add(t,e,i,s){if(!this._statusMap[e]){const{frameNumber:r,viewport:{id:n}}=s;this._statusMap[e]={request:t,callback:i,key:e,frameState:s,status:et},this.pendingTilesRegister.register(n,r),t().then((t=>{this._statusMap[e].status=it;const{frameNumber:i,viewport:{id:r}}=this._statusMap[e].frameState;this.pendingTilesRegister.deregister(r,i),this._statusMap[e].callback(t,s)})).catch((t=>{this._statusMap[e].status=st;const{frameNumber:s,viewport:{id:r}}=this._statusMap[e].frameState;this.pendingTilesRegister.deregister(r,s),i(t)}))}}update(t,e){if(this._statusMap[t]){const{frameNumber:i,viewport:{id:s}}=this._statusMap[t].frameState;this.pendingTilesRegister.deregister(s,i);const{frameNumber:r,viewport:{id:n}}=e;this.pendingTilesRegister.register(n,r),this._statusMap[t].frameState=e}}find(t){return this._statusMap[t]}hasPendingTiles(t,e){return!this.pendingTilesRegister.isZero(t,e)}}class nt extends W{constructor(t){super(t),(0,s.Z)(this,"_tileManager",void 0),this._tileManager=new rt}traversalFinished(t){return!this._tileManager.hasPendingTiles(t.viewport.id,this._frameNumber||0)}shouldRefine(t,e){return t._lodJudge=function(t,e){if(0===t.lodMetricValue||isNaN(t.lodMetricValue))return"DIG";const i=2*j(t,e);return i<2?"OUT":!t.header.children||i<=t.lodMetricValue?"DRAW":t.header.children?"DIG":"OUT"}(t,e),"DIG"===t._lodJudge}updateChildTiles(t,e){const i=t.header.children||[],s=t.children,r=t.tileset;for(const n of i){const i="".concat(n.id,"-").concat(e.viewport.id),o=s&&s.find((t=>t.id===i));if(o)o&&this.updateTile(o,e);else{let s=()=>this._loadTile(n.id,r);this._tileManager.find(i)?this._tileManager.update(i,e):(r.tileset.nodePages&&(s=()=>r.tileset.nodePagesTile.formTileFromNodePages(n.id)),this._tileManager.add(s,i,(e=>this._onTileLoad(e,t,i)),e))}}return!1}async _loadTile(t,e){const{loader:i}=e,s=e.getTileUrl("".concat(e.url,"/nodes/").concat(t)),r={...e.loadOptions,i3s:{...e.loadOptions.i3s,isTileHeader:!0}};return await(0,O.z)(s,i,r)}_onTileLoad(t,e,i){const s=new $(e.tileset,t,e,i);e.children.push(s);const r=this._tileManager.find(s.id).frameState;this.updateTile(s,r),this._frameNumber===r.frameNumber&&(this.traversalFinished(r)||(new Date).getTime()-this.lastUpdate>this.updateDebounceTime)&&this.executeTraversal(s,r)}}const ot={description:"",ellipsoid:o.H.WGS84,modelMatrix:new r.Z,throttleRequests:!0,maxRequests:64,maximumMemoryUsage:32,maximumTilesSelected:0,debounceTime:0,onTileLoad:()=>{},onTileUnload:()=>{},onTileError:()=>{},onTraversalComplete:t=>t,contentLoader:void 0,viewDistanceScale:1,maximumScreenSpaceError:8,loadTiles:!0,updateTransforms:!0,viewportTraversersMap:null,loadOptions:{fetch:{}},attributions:[],basePath:"",i3s:{}},at="Tiles In Tileset(s)",ht="Tiles In Memory",lt="Tiles In View",ct="Tiles To Render",ut="Tiles Loaded",dt="Tiles Loading",pt="Tiles Unloaded",ft="Failed Tile Loads",mt="Points/Vertices",yt="Tile Memory Use";class Tt{constructor(t,e){(0,s.Z)(this,"options",void 0),(0,s.Z)(this,"loadOptions",void 0),(0,s.Z)(this,"type",void 0),(0,s.Z)(this,"tileset",void 0),(0,s.Z)(this,"loader",void 0),(0,s.Z)(this,"url",void 0),(0,s.Z)(this,"basePath",void 0),(0,s.Z)(this,"modelMatrix",void 0),(0,s.Z)(this,"ellipsoid",void 0),(0,s.Z)(this,"lodMetricType",void 0),(0,s.Z)(this,"lodMetricValue",void 0),(0,s.Z)(this,"refine",void 0),(0,s.Z)(this,"root",void 0),(0,s.Z)(this,"roots",void 0),(0,s.Z)(this,"asset",void 0),(0,s.Z)(this,"description",void 0),(0,s.Z)(this,"properties",void 0),(0,s.Z)(this,"extras",void 0),(0,s.Z)(this,"attributions",void 0),(0,s.Z)(this,"credits",void 0),(0,s.Z)(this,"stats",void 0),(0,s.Z)(this,"contentFormats",{draco:!1,meshopt:!1,dds:!1,ktx2:!1}),(0,s.Z)(this,"traverseCounter",void 0),(0,s.Z)(this,"geometricError",void 0),(0,s.Z)(this,"selectedTiles",void 0),(0,s.Z)(this,"updatePromise",null),(0,s.Z)(this,"tilesetInitializationPromise",void 0),(0,s.Z)(this,"cartographicCenter",void 0),(0,s.Z)(this,"cartesianCenter",void 0),(0,s.Z)(this,"zoom",void 0),(0,s.Z)(this,"boundingVolume",void 0),(0,s.Z)(this,"gpuMemoryUsageInBytes",void 0),(0,s.Z)(this,"dynamicScreenSpaceErrorComputedDensity",void 0),(0,s.Z)(this,"_traverser",void 0),(0,s.Z)(this,"_cache",void 0),(0,s.Z)(this,"_requestScheduler",void 0),(0,s.Z)(this,"_frameNumber",void 0),(0,s.Z)(this,"_queryParamsString",void 0),(0,s.Z)(this,"_queryParams",void 0),(0,s.Z)(this,"_extensionsUsed",void 0),(0,s.Z)(this,"_tiles",void 0),(0,s.Z)(this,"_pendingCount",void 0),(0,s.Z)(this,"lastUpdatedVieports",void 0),(0,s.Z)(this,"_requestedTiles",void 0),(0,s.Z)(this,"_emptyTiles",void 0),(0,s.Z)(this,"frameStateData",void 0),(0,s.Z)(this,"maximumMemoryUsage",void 0),(0,h.h)(t),this.options={...ot,...e},this.tileset=t,this.loader=t.loader,this.type=t.type,this.url=t.url,this.basePath=t.basePath||l.XX(this.url),this.modelMatrix=this.options.modelMatrix,this.ellipsoid=this.options.ellipsoid,this.lodMetricType=t.lodMetricType,this.lodMetricValue=t.lodMetricValue,this.refine=t.root.refine,this.loadOptions=this.options.loadOptions||{},this.root=null,this.roots={},this.cartographicCenter=null,this.cartesianCenter=null,this.zoom=1,this.boundingVolume=null,this.traverseCounter=0,this.geometricError=0,this._traverser=this._initializeTraverser(),this._cache=new f,this._requestScheduler=new c.Z({throttleRequests:this.options.throttleRequests,maxRequests:this.options.maxRequests}),this._frameNumber=0,this._pendingCount=0,this._tiles={},this.selectedTiles=[],this._emptyTiles=[],this._requestedTiles=[],this.frameStateData={},this.lastUpdatedVieports=null,this._queryParams={},this._queryParamsString="",this.maximumMemoryUsage=this.options.maximumMemoryUsage||32,this.gpuMemoryUsageInBytes=0,this.stats=new a.Z({id:this.url}),this._initializeStats(),this._extensionsUsed=void 0,this.dynamicScreenSpaceErrorComputedDensity=0,this.extras=null,this.asset={},this.credits={},this.description=this.options.description||"",this.tilesetInitializationPromise=this._initializeTileSet(t)}destroy(){this._destroy()}isLoaded(){return 0===this._pendingCount&&0!==this._frameNumber&&0===this._requestedTiles.length}get tiles(){return Object.values(this._tiles)}get frameNumber(){return this._frameNumber}get queryParams(){return this._queryParamsString||(this._queryParamsString=function(t){const e=[];for(const i of Object.keys(t))e.push("".concat(i,"=").concat(t[i]));switch(e.length){case 0:return"";case 1:return"?".concat(e[0]);default:return"?".concat(e.join("&"))}}(this._queryParams)),this._queryParamsString}setProps(t){this.options={...this.options,...t}}setOptions(t){this.options={...this.options,...t}}getTileUrl(t){return t.startsWith("data:")?t:"".concat(t).concat(this.queryParams)}hasExtension(t){return Boolean(this._extensionsUsed&&this._extensionsUsed.indexOf(t)>-1)}update(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.tilesetInitializationPromise.then((()=>{!t&&this.lastUpdatedVieports?t=this.lastUpdatedVieports:this.lastUpdatedVieports=t,t&&this.doUpdate(t)}))}async selectTiles(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return await this.tilesetInitializationPromise,t&&(this.lastUpdatedVieports=t),this.updatePromise||(this.updatePromise=new Promise((t=>{setTimeout((()=>{this.lastUpdatedVieports&&this.doUpdate(this.lastUpdatedVieports),t(this._frameNumber),this.updatePromise=null}),this.options.debounceTime)}))),this.updatePromise}doUpdate(t){if("loadTiles"in this.options&&!this.options.loadTiles)return;if(this.traverseCounter>0)return;const e=t instanceof Array?t:[t];this._cache.reset(),this._frameNumber++,this.traverseCounter=e.length;const i=[];for(const s of e){const t=s.id;this._needTraverse(t)?i.push(t):this.traverseCounter--}for(const s of e){const t=s.id;if(this.roots[t]||(this.roots[t]=this._initializeTileHeaders(this.tileset,null)),!i.includes(t))continue;const e=g(s,this._frameNumber);this._traverser.traverse(this.roots[t],e,this.options)}}_needTraverse(t){let e=t;return this.options.viewportTraversersMap&&(e=this.options.viewportTraversersMap[t]),e===t}_onTraversalEnd(t){const e=t.viewport.id;this.frameStateData[e]||(this.frameStateData[e]={selectedTiles:[],_requestedTiles:[],_emptyTiles:[]});const i=this.frameStateData[e],s=Object.values(this._traverser.selectedTiles),[r,n]=function(t,e,i){if(0===i||t.length<=i)return[t,[]];const s=[],{longitude:r,latitude:n}=e.viewport;for(const[l,c]of t.entries()){const[t,e]=c.header.mbs,i=Math.abs(r-t),o=Math.abs(n-e),a=Math.sqrt(o*o+i*i);s.push([l,a])}const o=s.sort(((t,e)=>t[1]-e[1])),a=[];for(let l=0;l<i;l++)a.push(t[o[l][0]]);const h=[];for(let l=i;l<o.length;l++)h.push(t[o[l][0]]);return[a,h]}(s,t,this.options.maximumTilesSelected);i.selectedTiles=r;for(const o of n)o.unselect();i._requestedTiles=Object.values(this._traverser.requestedTiles),i._emptyTiles=Object.values(this._traverser.emptyTiles),this.traverseCounter--,this.traverseCounter>0||this._updateTiles()}_updateTiles(){this.selectedTiles=[],this._requestedTiles=[],this._emptyTiles=[];for(const t in this.frameStateData){const e=this.frameStateData[t];this.selectedTiles=this.selectedTiles.concat(e.selectedTiles),this._requestedTiles=this._requestedTiles.concat(e._requestedTiles),this._emptyTiles=this._emptyTiles.concat(e._emptyTiles)}this.selectedTiles=this.options.onTraversalComplete(this.selectedTiles);for(const t of this.selectedTiles)this._tiles[t.id]=t;this._loadTiles(),this._unloadTiles(),this._updateStats()}_tilesChanged(t,e){if(t.length!==e.length)return!0;const i=new Set(t.map((t=>t.id))),s=new Set(e.map((t=>t.id)));let r=t.filter((t=>!s.has(t.id))).length>0;return r=r||e.filter((t=>!i.has(t.id))).length>0,r}_loadTiles(){for(const t of this._requestedTiles)t.contentUnloaded&&this._loadTile(t)}_unloadTiles(){this._cache.unloadTiles(this,((t,e)=>t._unloadTile(e)))}_updateStats(){let t=0,e=0;for(const i of this.selectedTiles)i.contentAvailable&&i.content&&(t++,i.content.pointCount?e+=i.content.pointCount:e+=i.content.vertexCount);this.stats.get(lt).count=this.selectedTiles.length,this.stats.get(ct).count=t,this.stats.get(mt).count=e}async _initializeTileSet(t){this.type===I.i3.I3S&&(this.calculateViewPropsI3S(),t.root=await t.root),this.root=this._initializeTileHeaders(t,null),this.type===I.i3.TILES3D&&(this._initializeTiles3DTileset(t),this.calculateViewPropsTiles3D()),this.type===I.i3.I3S&&this._initializeI3STileset()}calculateViewPropsI3S(){var t;const e=this.tileset.fullExtent;if(e){const{xmin:t,xmax:i,ymin:s,ymax:r,zmin:a,zmax:h}=e;return this.cartographicCenter=new n.Z(t+(i-t)/2,s+(r-s)/2,a+(h-a)/2),this.cartesianCenter=o.H.WGS84.cartographicToCartesian(this.cartographicCenter,new n.Z),void(this.zoom=N(e,this.cartographicCenter,this.cartesianCenter))}const i=null===(t=this.tileset.store)||void 0===t?void 0:t.extent;if(i){const[t,e,s,r]=i;return this.cartographicCenter=new n.Z(t+(s-t)/2,e+(r-e)/2,0),this.cartesianCenter=o.H.WGS84.cartographicToCartesian(this.cartographicCenter,new n.Z),void(this.zoom=function(t,e,i){const[s,r,n,o]=t;return N({xmin:s,xmax:n,ymin:r,ymax:o,zmin:0,zmax:0},e,i)}(i,this.cartographicCenter,this.cartesianCenter))}console.warn("Extent is not defined in the tileset header"),this.cartographicCenter=new n.Z,this.zoom=1}calculateViewPropsTiles3D(){const t=this.root;(0,h.h)(t);const{center:e}=t.boundingVolume;if(!e)return console.warn("center was not pre-calculated for the root tile"),this.cartographicCenter=new n.Z,void(this.zoom=1);0!==e[0]||0!==e[1]||0!==e[2]?this.cartographicCenter=o.H.WGS84.cartesianToCartographic(e,new n.Z):this.cartographicCenter=new n.Z(0,0,-o.H.WGS84.radii[0]),this.cartesianCenter=e,this.zoom=Z(t.boundingVolume,this.cartographicCenter)}_initializeStats(){this.stats.get(at),this.stats.get(dt),this.stats.get(ht),this.stats.get(lt),this.stats.get(ct),this.stats.get(ut),this.stats.get(pt),this.stats.get(ft),this.stats.get(mt),this.stats.get(yt,"memory")}_initializeTileHeaders(t,e){const i=new $(this,t.root,e);if(e&&(e.children.push(i),i.depth=e.depth+1),this.type===I.i3.TILES3D){const t=[];for(t.push(i);t.length>0;){const e=t.pop();this.stats.get(at).incrementCount();const i=e.header.children||[];for(const s of i){const i=new $(this,s,e);e.children.push(i),i.depth=e.depth+1,t.push(i)}}}return i}_initializeTraverser(){let t;switch(this.type){case I.i3.TILES3D:t=K;break;case I.i3.I3S:t=nt;break;default:t=W}return new t({basePath:this.basePath,onTraversalEnd:this._onTraversalEnd.bind(this)})}_destroyTileHeaders(t){this._destroySubtree(t)}async _loadTile(t){let e;try{this._onStartTileLoading(),e=await t.loadContent()}catch(i){this._onTileLoadError(t,i)}finally{this._onEndTileLoading(),this._onTileLoad(t,e)}}_onTileLoadError(t,e){this.stats.get(ft).incrementCount();const i=e.message||e.toString(),s=t.url;console.error("A 3D tile failed to load: ".concat(t.url," ").concat(i)),this.options.onTileError(t,i,s)}_onTileLoad(t,e){if(e){if(this.type===I.i3.I3S){var i,s;const t=(null===(i=this.tileset)||void 0===i||null===(s=i.nodePagesTile)||void 0===s?void 0:s.nodesInNodePages)||0;this.stats.get(at).reset(),this.stats.get(at).addCount(t)}t&&t.content&&function(t,e){(0,h.h)(t),(0,h.h)(e);const{rtcCenter:i,gltfUpAxis:s}=e,{computedTransform:a,boundingVolume:{center:l}}=t;let c=new r.Z(a);switch(i&&c.translate(i),s){case"Z":default:break;case"Y":const t=(new r.Z).rotateX(Math.PI/2);c=c.multiplyRight(t);break;case"X":const e=(new r.Z).rotateY(-Math.PI/2);c=c.multiplyRight(e)}e.isQuantized&&c.translate(e.quantizedVolumeOffset).scale(e.quantizedVolumeScale);const u=new n.Z(l);e.cartesianModelMatrix=c,e.cartesianOrigin=u;const d=o.H.WGS84.cartesianToCartographic(u,new n.Z),p=o.H.WGS84.eastNorthUpToFixedFrame(u).invert();e.cartographicModelMatrix=p.multiplyRight(c),e.cartographicOrigin=d,e.coordinateSystem||(e.modelMatrix=e.cartographicModelMatrix)}(t,t.content),this.updateContentTypes(t),this._addTileToCache(t),this.options.onTileLoad(t)}}updateContentTypes(t){if(this.type===I.i3.I3S)switch(t.header.isDracoGeometry&&(this.contentFormats.draco=!0),t.header.textureFormat){case"dds":this.contentFormats.dds=!0;break;case"ktx2":this.contentFormats.ktx2=!0}else if(this.type===I.i3.TILES3D){var e;const{extensionsRemoved:i=[]}=(null===(e=t.content)||void 0===e?void 0:e.gltf)||{};i.includes("KHR_draco_mesh_compression")&&(this.contentFormats.draco=!0),i.includes("EXT_meshopt_compression")&&(this.contentFormats.meshopt=!0),i.includes("KHR_texture_basisu")&&(this.contentFormats.ktx2=!0)}}_onStartTileLoading(){this._pendingCount++,this.stats.get(dt).incrementCount()}_onEndTileLoading(){this._pendingCount--,this.stats.get(dt).decrementCount()}_addTileToCache(t){this._cache.add(this,t,(e=>e._updateCacheStats(t)))}_updateCacheStats(t){this.stats.get(ut).incrementCount(),this.stats.get(ht).incrementCount(),this.gpuMemoryUsageInBytes+=t.content.byteLength||0,this.stats.get(yt).count=this.gpuMemoryUsageInBytes}_unloadTile(t){this.gpuMemoryUsageInBytes-=t.content&&t.content.byteLength||0,this.stats.get(ht).decrementCount(),this.stats.get(pt).incrementCount(),this.stats.get(yt).count=this.gpuMemoryUsageInBytes,this.options.onTileUnload(t),t.unloadContent()}_destroy(){const t=[];for(this.root&&t.push(this.root);t.length>0;){const e=t.pop();for(const i of e.children)t.push(i);this._destroyTile(e)}this.root=null}_destroySubtree(t){const e=t,i=[];for(i.push(e);i.length>0;){t=i.pop();for(const e of t.children)i.push(e);t!==e&&this._destroyTile(t)}e.children=[]}_destroyTile(t){this._cache.unloadTile(this,t),this._unloadTile(t),t.destroy()}_initializeTiles3DTileset(t){if(this.asset=t.asset,!this.asset)throw new Error("Tileset must have an asset property.");if("0.0"!==this.asset.version&&"1.0"!==this.asset.version)throw new Error("The tileset must be 3D Tiles version 0.0 or 1.0.");"tilesetVersion"in this.asset&&(this._queryParams.v=this.asset.tilesetVersion),this.credits={attributions:this.options.attributions||[]},this.description=this.options.description||"",this.properties=t.properties,this.geometricError=t.geometricError,this._extensionsUsed=t.extensionsUsed,this.extras=t.extras}_initializeI3STileset(){this.loadOptions.i3s&&"token"in this.loadOptions.i3s&&(this._queryParams.token=this.loadOptions.i3s.token)}}},36212:(t,e,i)=>{i.d(e,{Z:()=>h});var s=i(14021),r=i(28835),n=i(84106),o=i(31437),a=i(426);class h extends s.Z{constructor(t=0,e=0){super(2),(0,r.kJ)(t)&&1===arguments.length?this.copy(t):(r.vc.debug&&((0,n.u5)(t),(0,n.u5)(e)),this[0]=t,this[1]=e)}set(t,e){return this[0]=t,this[1]=e,this.check()}copy(t){return this[0]=t[0],this[1]=t[1],this.check()}fromObject(t){return r.vc.debug&&((0,n.u5)(t.x),(0,n.u5)(t.y)),this[0]=t.x,this[1]=t.y,this.check()}toObject(t){return t.x=this[0],t.y=this[1],t}get ELEMENTS(){return 2}horizontalAngle(){return Math.atan2(this.y,this.x)}verticalAngle(){return Math.atan2(this.x,this.y)}transform(t){return this.transformAsPoint(t)}transformAsPoint(t){return o.fF(this,this,t),this.check()}transformAsVector(t){return(0,a.pb)(this,this,t),this.check()}transformByMatrix3(t){return o.kK(this,this,t),this.check()}transformByMatrix2x3(t){return o.iu(this,this,t),this.check()}transformByMatrix2(t){return o.c(this,this,t),this.check()}}},73253:(t,e,i)=>{i.d(e,{H:()=>D});var s=i(4942),r=i(59122),n=i(39119),o=i(79332),a=i(76450),h=i(28835),l=i(77160);const c=6378137,u=6378137,d=6356752.314245179;Math.max(c,u,d);function p(t){return t}new r.Z;function f(t,e=[],i=p){return"longitude"in t?(e[0]=i(t.longitude),e[1]=i(t.latitude),e[2]=t.height):"x"in t?(e[0]=i(t.x),e[1]=i(t.y),e[2]=t.z):(e[0]=i(t[0]),e[1]=i(t[1]),e[2]=t[2]),e}function m(t,e,i=p){return"longitude"in e?(e.longitude=i(t[0]),e.latitude=i(t[1]),e.height=t[2]):"x"in e?(e.x=i(t[0]),e.y=i(t[1]),e.z=t[2]):(e[0]=i(t[0]),e[1]=i(t[1]),e[2]=t[2]),e}const y=new r.Z,T=new r.Z,_=new r.Z;const g=1e-14,b=new r.Z,v={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},w={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},E={east:new r.Z,north:new r.Z,up:new r.Z,west:new r.Z,south:new r.Z,down:new r.Z},S=new r.Z,A=new r.Z,Z=new r.Z;function N(t,e,i,s,r,n){const a=v[e]&&v[e][i];let l,c,u;(0,o.Z)(a&&(!s||s===a));const d=b.copy(r);if((0,h.fS)(d.x,0,g)&&(0,h.fS)(d.y,0,g)){const t=Math.sign(d.z);l=S.fromArray(w[e]),"east"!==e&&"west"!==e&&l.scale(t),c=A.fromArray(w[i]),"east"!==i&&"west"!==i&&c.scale(t),u=Z.fromArray(w[s]),"east"!==s&&"west"!==s&&u.scale(t)}else{const{up:r,east:n,north:o}=E;n.set(-d.y,d.x,0).normalize(),t.geodeticSurfaceNormal(d,r),o.copy(r).cross(n);const{down:a,west:h,south:p}=E;a.copy(r).scale(-1),h.copy(n).scale(-1),p.copy(o).scale(-1),l=E[e],c=E[i],u=E[s]}return n[0]=l.x,n[1]=l.y,n[2]=l.z,n[3]=0,n[4]=c.x,n[5]=c.y,n[6]=c.z,n[7]=0,n[8]=u.x,n[9]=u.y,n[10]=u.z,n[11]=0,n[12]=d.x,n[13]=d.y,n[14]=d.z,n[15]=1,n}const O=new r.Z,I=new r.Z,C=new r.Z,R=new r.Z,x=new r.Z,M=new r.Z;class D{constructor(t=0,e=0,i=0){(0,s.Z)(this,"radii",void 0),(0,s.Z)(this,"radiiSquared",void 0),(0,s.Z)(this,"radiiToTheFourth",void 0),(0,s.Z)(this,"oneOverRadii",void 0),(0,s.Z)(this,"oneOverRadiiSquared",void 0),(0,s.Z)(this,"minimumRadius",void 0),(0,s.Z)(this,"maximumRadius",void 0),(0,s.Z)(this,"centerToleranceSquared",n.Z.EPSILON1),(0,s.Z)(this,"squaredXOverSquaredZ",void 0),(0,o.Z)(t>=0),(0,o.Z)(e>=0),(0,o.Z)(i>=0),this.radii=new r.Z(t,e,i),this.radiiSquared=new r.Z(t*t,e*e,i*i),this.radiiToTheFourth=new r.Z(t*t*t*t,e*e*e*e,i*i*i*i),this.oneOverRadii=new r.Z(0===t?0:1/t,0===e?0:1/e,0===i?0:1/i),this.oneOverRadiiSquared=new r.Z(0===t?0:1/(t*t),0===e?0:1/(e*e),0===i?0:1/(i*i)),this.minimumRadius=Math.min(t,e,i),this.maximumRadius=Math.max(t,e,i),0!==this.radiiSquared.z&&(this.squaredXOverSquaredZ=this.radiiSquared.x/this.radiiSquared.z),Object.freeze(this)}equals(t){return this===t||Boolean(t&&this.radii.equals(t.radii))}toString(){return this.radii.toString()}cartographicToCartesian(t,e=[0,0,0]){const i=I,s=C,[,,r]=t;this.geodeticSurfaceNormalCartographic(t,i),s.copy(this.radiiSquared).scale(i);const n=Math.sqrt(i.dot(s));return s.scale(1/n),i.scale(r),s.add(i),s.to(e)}cartesianToCartographic(t,e=[0,0,0]){M.from(t);const i=this.scaleToGeodeticSurface(M,R);if(!i)return;const s=this.geodeticSurfaceNormal(i,I),r=x;r.copy(M).subtract(i);const n=Math.atan2(s.y,s.x),o=Math.asin(s.z),a=Math.sign(l.AK(r,M))*l.kE(r);return m([n,o,a],e,h.vc._cartographicRadians?p:h.Ux)}eastNorthUpToFixedFrame(t,e=new a.Z){return N(this,"east","north","up",t,e)}localFrameToFixedFrame(t,e,i,s,r=new a.Z){return N(this,t,e,i,s,r)}geocentricSurfaceNormal(t,e=[0,0,0]){return O.from(t).normalize().to(e)}geodeticSurfaceNormalCartographic(t,e=[0,0,0]){const i=function(t,e=[]){return f(t,e,h.vc._cartographicRadians?p:h.Yr)}(t),s=i[0],r=i[1],n=Math.cos(r);return O.set(n*Math.cos(s),n*Math.sin(s),Math.sin(r)).normalize(),O.to(e)}geodeticSurfaceNormal(t,e=[0,0,0]){return O.from(t).scale(this.oneOverRadiiSquared).normalize().to(e)}scaleToGeodeticSurface(t,e){return function(t,e,i=[]){const{oneOverRadii:s,oneOverRadiiSquared:r,centerToleranceSquared:o}=e;y.from(t);const a=y.x,h=y.y,l=y.z,c=s.x,u=s.y,d=s.z,p=a*a*c*c,f=h*h*u*u,m=l*l*d*d,g=p+f+m,b=Math.sqrt(1/g);if(!Number.isFinite(b))return;const v=T;if(v.copy(t).scale(b),g<o)return v.to(i);const w=r.x,E=r.y,S=r.z,A=_;A.set(v.x*w*2,v.y*E*2,v.z*S*2);let Z,N,O,I,C=(1-b)*y.len()/(.5*A.len()),R=0;do{C-=R,Z=1/(1+C*w),N=1/(1+C*E),O=1/(1+C*S);const t=Z*Z,e=N*N,i=O*O;I=p*t+f*e+m*i-1,R=I/(-2*(p*(t*Z)*w+f*(e*N)*E+m*(i*O)*S))}while(Math.abs(I)>n.Z.EPSILON12);return y.scale([Z,N,O]).to(i)}(t,this,e)}scaleToGeocentricSurface(t,e=[0,0,0]){R.from(t);const i=R.x,s=R.y,r=R.z,n=this.oneOverRadiiSquared,o=1/Math.sqrt(i*i*n.x+s*s*n.y+r*r*n.z);return R.multiplyScalar(o).to(e)}transformPositionToScaledSpace(t,e=[0,0,0]){return R.from(t).scale(this.oneOverRadii).to(e)}transformPositionFromScaledSpace(t,e=[0,0,0]){return R.from(t).scale(this.radii).to(e)}getSurfaceNormalIntersectionWithZAxis(t,e=0,i=[0,0,0]){(0,o.Z)((0,h.fS)(this.radii.x,this.radii.y,n.Z.EPSILON15)),(0,o.Z)(this.radii.z>0),R.from(t);const s=R.z*(1-this.squaredXOverSquaredZ);if(!(Math.abs(s)>=this.radii.z-e))return R.set(0,0,s).to(i)}}(0,s.Z)(D,"WGS84",new D(c,u,d))}}]);